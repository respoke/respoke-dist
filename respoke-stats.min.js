/*! Copyright (c) 2014, D.C.S. LLC. All Rights Reserved. Licensed Software. */
!function(e){"use strict";"function"==typeof define&&define.amd?define(["respoke"],e):"object"==typeof exports?e(require("respoke")):e(respoke)}(function(e){"use strict";e.MediaStats=function(e){function n(e,t){return Object.keys(t).forEach(function(o){var r;"string"==typeof t[o]?(e[t[o]]=e[o],delete e[o]):"object"==typeof t[o]&&(r=o,t[o].newname&&(e[t[o].newname]=e[o],r=t[o].newname,delete e[o]),t[o].members&&n(e[r],t[o].members))}),e.connection&&(e.connection.foundIncomingNetworkPaths="true"===e.connection.foundIncomingNetworkPaths,e.connection.foundOutgoingNetworkPaths="true"===e.connection.foundOutgoingNetworkPaths),e}e=JSON.parse(JSON.stringify(e||{}));var t={cons:{newname:"connection",members:{googChannelId:"channelId",googLocalAddress:"localHost",googRemoteAddress:"remoteHost",googLocalCandidateType:"localMediaPath",googRemoteCandidateType:"remoteMediaPath",googReadable:"foundIncomingNetworkPaths",googRtt:"roundTripTime",googTransportType:"transport",googWritable:"foundOutgoingNetworkPaths"}},localaudio:{members:{googCodecName:"codec",bytesSent:"totalBytesSent",packetsSent:"totalPacketsSent"}},localvideo:{members:{googCodecName:"codec",bytesSent:"totalBytesSent",packetsSent:"totalPacketsSent"}},remoteaudio:{members:{googCodecName:"codec",bytesReceived:"totalBytesReceived",packetsReceived:"totalPacketsReceived"}},remotevideo:{members:{googCodecName:"codec",bytesReceived:"totalBytesReceived",packetsReceived:"totalPacketsReceived"}}};return n(e,t)},e.MediaStatsParser=function(n){function t(e,n){return e&&e.slice&&e.slice(0,n.length)===n}function o(){var o={};return a&&a.remoteDescription&&a.remoteDescription.sdp&&a.localDescription&&a.localDescription.sdp?(o={remote:a.remoteDescription.sdp,local:a.localDescription.sdp},Object.keys(o).forEach(function(e){var n=o[e],r=n.split("\r\n"),i=null;Object.keys(r).forEach(function(n){var o=r[n],s=null,a=null;t(o,"m=")?i=o.substring(2,7):t(o,"a=ssrc:")&&(s=o.split(" "),a=s[0].substring("a=ssrc:".length),u[e+i]&&(u[e+i].match.value=a))})}),n.onStats?c=setInterval(function(){i.getStats().done(n.onStats,function(n){e.log.error("error in getStats",n.message,n.stack)})},l):e.log.warn("Not starting stats, no onStats callback provided."),void 0):(e.log.warn("missing info."),void 0)}function r(e){var n=e,t=n.result(),o={state:{iceGatheringState:a.icegatheringState,iceConnectionState:a.iceConnectionState}};return Object.keys(u).forEach(function(e){var n={},r=u[e],i=t.filter(function(e){var n=e.type===r.type,t=e.stat(r.match.key)===r.match.value;return n&&t});i.length>0&&(i[0].timestamp&&(o.timestamp=i[0].timestamp,o.periodLength=o.timestamp-s.timestamp),r.keys.forEach(function(t){var o=parseInt(i[0].stat(t),10);n[t]=isNaN(o)?i[0].stat(t):o,d[t]&&s&&s[e]&&-1===[null,void 0].indexOf(s[e][t])&&(n["period"+t.charAt(0).toUpperCase()+t.slice(1)]=n[t]-s[e][t])})),o[e]=n}),s=o,o}n=n||{};var i=e.Class(n);i.className="respoke.MediaStatsParser";var s=!1,a=n.peerConnection;delete n.peerConnection;var c=0,l=n.interval||5e3,u={cons:{type:"googCandidatePair",match:{key:"googActiveConnection",value:"true"},keys:["googWritable","googReadable","googTransportType","googLocalCandidateType","googRemoteCandidateType","googRemoteAddress","googLocalAddress","googRtt","googChannelId"]},localaudio:{type:"ssrc",match:{key:"ssrc",value:""},keys:["audioInputLevel","packetsSent","bytesSent","transportId","googCodecName"]},remoteaudio:{type:"ssrc",match:{key:"ssrc",value:""},keys:["audioOutputLevel","packetsReceived","packetsLost","bytesReceived","transportId"]},remotevideo:{type:"ssrc",match:{key:"ssrc",value:""},keys:["packetsReceived","packetsLost","bytesReceived","transportId"]},localvideo:{type:"ssrc",match:{key:"ssrc",value:""},keys:["packetsSent","bytesSent","transportId","googCodecName"]}},d={packetsSent:!0,bytesSent:!0,packetsReceived:!0,bytesReceived:!0};return i.getStats=function(n){n=n||{};var t=e.Q.defer(),o=e.handlePromise(t.promise,n.onSuccess,n.onError),i=[];return a.getStats?(navigator.mozGetUserMedia&&i.push(null),i.push(function(n){t.resolve(e.MediaStats(r(n)))}),i.push(function(n){e.log.error(n),t.reject(new Error("Can't get stats."))}),a.getStats.apply(a,i),o):(t.reject(new Error("no peer connection getStats()")),o)},i.stopStats=function(){clearInterval(c)},o(),i}});
//# sourceMappingURL=respoke-stats.min.map