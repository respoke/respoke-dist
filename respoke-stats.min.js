/*! Copyright (c) 2014, Digium, Inc. All Rights Reserved. MIT Licensed. For all details and documentation: https://www.respoke.io */
!function(e){"use strict";"function"==typeof define&&define.amd?define(["respoke"],e):e("object"==typeof exports?require("respoke"):respoke)}(function(e){"use strict";e.MediaStats=function(e){function t(e,n){return Object.keys(n).forEach(function(o){var r;"string"==typeof n[o]?(e[n[o]]=e[o],delete e[o]):"object"==typeof n[o]&&(r=o,n[o].newname&&(e[n[o].newname]=e[o],r=n[o].newname,delete e[o]),n[o].members&&t(e[r],n[o].members))}),e.connection&&(e.connection.foundIncomingNetworkPaths="true"===e.connection.foundIncomingNetworkPaths,e.connection.foundOutgoingNetworkPaths="true"===e.connection.foundOutgoingNetworkPaths),e}e=JSON.parse(JSON.stringify(e||{}));var n={cons:{newname:"connection",members:{googChannelId:"channelId",googLocalAddress:"localHost",googRemoteAddress:"remoteHost",googLocalCandidateType:"localMediaPath",googRemoteCandidateType:"remoteMediaPath",googReadable:"foundIncomingNetworkPaths",googRtt:"roundTripTime",googTransportType:"transport",googWritable:"foundOutgoingNetworkPaths"}},localaudio:{members:{googCodecName:"codec",bytesSent:"totalBytesSent",packetsSent:"totalPacketsSent"}},localvideo:{members:{googCodecName:"codec",bytesSent:"totalBytesSent",packetsSent:"totalPacketsSent"}},remoteaudio:{members:{googCodecName:"codec",bytesReceived:"totalBytesReceived",packetsReceived:"totalPacketsReceived"}},remotevideo:{members:{googCodecName:"codec",bytesReceived:"totalBytesReceived",packetsReceived:"totalPacketsReceived"}}};return t(e,n)},e.MediaStatsParser=function(t){function n(e,t){return e&&e.slice&&e.slice(0,t.length)===t}function o(){var o={};return s&&s.remoteDescription&&s.remoteDescription.sdp&&s.localDescription&&s.localDescription.sdp?(o={remote:s.remoteDescription.sdp,local:s.localDescription.sdp},Object.keys(o).forEach(function(e){var t=o[e],r=t.split("\r\n"),i=null;Object.keys(r).forEach(function(t){var o=r[t],a=null,s=null;n(o,"m=")?i=o.substring(2,7):n(o,"a=ssrc:")&&(a=o.split(" "),s=a[0].substring("a=ssrc:".length),l[e+i]&&0===l[e+i].match.value.length&&(l[e+i].match.value=s))})}),void(t.onStats?c=setInterval(function(){i.getStats().done(t.onStats,function(t){e.log.error("error in getStats",t.message,t.stack)})},u):e.log.warn("Not starting stats, no onStats callback provided."))):void e.log.warn("missing info.")}function r(e){var t=e,n=t.result(),o={state:{iceGatheringState:s.icegatheringState,iceConnectionState:s.iceConnectionState}};return Object.keys(l).forEach(function(e){var t={},r=l[e],i=n.filter(function(e){var t=e.type===r.type,n=e.stat(r.match.key)===r.match.value;return t&&n});i.length>0&&(i[0].timestamp&&(o.timestamp=i[0].timestamp,o.periodLength=o.timestamp-a.timestamp),r.keys.forEach(function(n){var o=parseInt(i[0].stat(n),10);t[n]=isNaN(o)?i[0].stat(n):o,d[n]&&a&&a[e]&&-1===[null,void 0].indexOf(a[e][n])&&(t["period"+n.charAt(0).toUpperCase()+n.slice(1)]=t[n]-a[e][n])})),o[e]=t}),a=o,o}t=t||{};var i=e.Class(t);i.className="respoke.MediaStatsParser";var a=!1,s=t.peerConnection;delete t.peerConnection;var c=0,u=t.interval||5e3,l={cons:{type:"googCandidatePair",match:{key:"googActiveConnection",value:"true"},keys:["googWritable","googReadable","googTransportType","googLocalCandidateType","googRemoteCandidateType","googRemoteAddress","googLocalAddress","googRtt","googChannelId"]},localaudio:{type:"ssrc",match:{key:"ssrc",value:""},keys:["audioInputLevel","packetsSent","bytesSent","transportId","googCodecName"]},remoteaudio:{type:"ssrc",match:{key:"ssrc",value:""},keys:["audioOutputLevel","packetsReceived","packetsLost","bytesReceived","transportId"]},remotevideo:{type:"ssrc",match:{key:"ssrc",value:""},keys:["packetsReceived","packetsLost","bytesReceived","transportId"]},localvideo:{type:"ssrc",match:{key:"ssrc",value:""},keys:["packetsSent","bytesSent","transportId","googCodecName"]}},d={packetsSent:!0,bytesSent:!0,packetsReceived:!0,bytesReceived:!0};return i.getStats=function(t){t=t||{};var n=e.Q.defer(),o=e.handlePromise(n.promise,t.onSuccess,t.onError),i=[];return s.getStats?(navigator.mozGetUserMedia&&i.push(null),i.push(function(t){n.resolve(e.MediaStats(r(t)))}),i.push(function(t){e.log.error(t),n.reject(new Error("Can't get stats."))}),s.getStats.apply(s,i),o):(n.reject(new Error("no peer connection getStats()")),o)},i.stopStats=function(){clearInterval(c)},o(),i}});
//# sourceMappingURL=respoke-stats.min.map