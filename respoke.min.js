/*! Copyright (c) 2014, Digium, Inc. All Rights Reserved. MIT Licensed.For details and documentation visit https://www.respoke.io */
(function webpackUniversalModuleDefinition(root,factory){if(typeof exports==="object"&&typeof module==="object")module.exports=factory();else if(typeof define==="function"&&define.amd)define([],factory);else if(typeof exports==="object")exports["respoke"]=factory();else root["respoke"]=factory()})(this,function(){return function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId])return installedModules[moduleId].exports;var module=installedModules[moduleId]={exports:{},id:moduleId,loaded:false};modules[moduleId].call(module.exports,module,module.exports,__webpack_require__);module.loaded=true;return module.exports}__webpack_require__.m=modules;__webpack_require__.c=installedModules;__webpack_require__.p="";return __webpack_require__(0)}([function(module,exports,__webpack_require__){module.exports=__webpack_require__(1)},function(module,exports,__webpack_require__){(function(global){"use strict";var log=__webpack_require__(2);log.setLevel(log.levels.WARN);var originalFactory=log.methodFactory;log.methodFactory=function logMethodFactory(methodName,logLevel){var logMethod=originalFactory(methodName,logLevel);var errorReporter;errorReporter=function(){};return function(message){var args=Array.prototype.slice.call(arguments);var reporterMessage=args.join(" ");args.unshift("[Respoke]");logMethod.apply(this,args);errorReporter(reporterMessage)}};__webpack_require__(3);var EventEmitter=__webpack_require__(4);var respoke=module.exports=EventEmitter({ridiculous:false,buildNumber:"v1.51.0",streams:[],Q:__webpack_require__(6)});respoke.Q.longStackSupport=true;respoke.Q.stackJumpLimit=5;respoke.Q.longStackJumpLimit=20;respoke.Q.stopUnhandledRejectionTracking();respoke.instances={};respoke.needsChromeExtension=!!(window.chrome&&!window.opera&&navigator.webkitGetUserMedia);respoke.needsFirefoxExtension=window.webrtcDetectedBrowser==="firefox";respoke.hasChromeExtension=false;respoke.hasFirefoxExtension=false;respoke.chooseDesktopMedia=function(){log.warn("Screen sharing is not implemented for this browser.")};respoke.isNwjs=function(){var gui;var isNwjs=!!(typeof process!=="undefined"&&typeof global!=="undefined"&&global.window&&global.window.nwDispatcher);if(isNwjs){gui=window.nwDispatcher.requireNwGui();gui.Screen.Init();respoke.chooseDesktopMedia=function(data,callback){if(!callback&&typeof data==="function"){callback=data;data=null}var mediaSources=data&&data.source?[data.source]:["window","screen"];gui.Screen.chooseDesktopMedia(mediaSources,function(sourceId){callback({type:"respoke-source-id",sourceId:sourceId})})}}return isNwjs}();respoke.extEvent=function(type,data){var evt=document.createEvent("CustomEvent");evt.initCustomEvent(type,true,true,data);return evt};respoke.version=respoke.buildNumber+"";respoke.log=log;respoke.Class=__webpack_require__(5);respoke.EventEmitter=EventEmitter;respoke.Client=__webpack_require__(7);respoke.Connection=__webpack_require__(8);respoke.Endpoint=__webpack_require__(9);respoke.TextMessage=__webpack_require__(10);respoke.SignalingMessage=__webpack_require__(11);respoke.Group=__webpack_require__(12);respoke.SignalingChannel=__webpack_require__(13);respoke.DirectConnection=__webpack_require__(17);respoke.PeerConnection=__webpack_require__(18);respoke.CallState=__webpack_require__(20);respoke.Call=__webpack_require__(21);respoke.LocalMedia=__webpack_require__(22);respoke.RemoteMedia=__webpack_require__(23);respoke.Conference=__webpack_require__(24);function chromeScreenSharingExtensionReady(evt){var data=evt.detail;if(data.available!==true){return}respoke.hasChromeExtension=true;respoke.chooseDesktopMedia=function(params,callback){if(!callback){throw new Error("Can't choose desktop media without callback parameter.")}function sourceIdListener(evt){var data=evt.detail;respoke.screenSourceId=data.sourceId;callback(data);document.removeEventListener("respoke-source-id",sourceIdListener)}document.dispatchEvent(respoke.extEvent("ct-respoke-source-id",{source:params.source?[params.source]:["screen","window"]}));document.addEventListener("respoke-source-id",sourceIdListener)};respoke.fire("extension-loaded",{type:"screen-sharing"});log.info("Respoke Screen Share Chrome extension available for use.")}document.addEventListener("respoke-available",chromeScreenSharingExtensionReady);document.addEventListener("respoke-chrome-screen-sharing-available",chromeScreenSharingExtensionReady);document.addEventListener("respoke-firefox-screen-sharing-available",function(evt){var data=evt.detail;if(data!=="available"){return}respoke.hasFirefoxExtension=true;respoke.fire("extension-loaded",{type:"screen-sharing"});log.info("Respoke Screen Share Firefox extension available for use.")});respoke.connect=function(params){var client=respoke.Client(params);client.connect(params);return client};respoke.getClient=function(id){if(id===undefined){log.debug("Can't call getClient with no client ID.",(new Error).stack)}if(!respoke.instances[id]){log.debug("No client instance with id",id)}return respoke.instances[id]};respoke.createClient=function(params){var client;params=params||{};if(params.instanceId){client=respoke.getClient(params.instanceId);if(client){return client}}return respoke.Client(params)};respoke.callOnce=function(func){return function(){var called=false;return function(){if(called===false){func.apply(null,arguments);called=true}}}()};respoke.makeGUID=function(){var chars="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");var uuid=new Array(36);var rnd=0;var r;for(var i=0;i<36;i+=1){if(i===8||i===13||i===18||i===23){uuid[i]="-"}else if(i===14){uuid[i]="4"}else{if(rnd<=2){rnd=33554432+Math.random()*16777216|0}r=rnd&15;rnd=rnd>>4;uuid[i]=chars[i===19?r&3|8:r]}}return uuid.join("")};respoke.handlePromise=function(promise,onSuccess,onError){var returnUndef=false;if(onSuccess||onError){returnUndef=true}onSuccess=typeof onSuccess==="function"?onSuccess:function(){};onError=typeof onError==="function"?onError:function(){};promise.done(onSuccess,onError);return returnUndef?undefined:promise};respoke.hasUserMedia=function(){return(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia)instanceof Function};respoke.hasRTCPeerConnection=function(){return(window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection)instanceof Function};respoke.hasWebsocket=function(){return(window.WebSocket||window.webkitWebSocket||window.MozWebSocket)instanceof Function};respoke.hasScreenShare=function(){return respoke.hasChromeExtension||respoke.hasFirefoxExtension};respoke.clone=function(source){if(source){return JSON.parse(JSON.stringify(source))}return source};respoke.isEqual=function(a,b){var aKeys;var i;if(a&&b&&a.hasOwnProperty("length")&&b.hasOwnProperty("length")&&a.splice&&b.splice){if(a.length!==b.length){return false}for(i=0;i<a.length;i+=1){if(!respoke.isEqual(a[i],b[i])){return false}}return true}if(typeof a==="object"&&typeof b==="object"&&Object.keys(a).length===Object.keys(b).length){aKeys=Object.keys(a);for(i=0;i<aKeys.length;i+=1){if(!respoke.isEqual(a[aKeys[i]],b[aKeys[i]])){return false}}return true}return a===b};respoke.sdpStreamCount=function(sdp){var matches;var resolvedMatches={};if(!sdp){throw new Error("respoke.sdpHasAudio called with no parameters.")}matches=sdp.match(/mslabel:(.*)/gi);if(!matches){return 0}matches.forEach(function(line){resolvedMatches[line]=true});return Object.keys(resolvedMatches).length};respoke.sdpHasAudio=function(sdp){if(!sdp){throw new Error("respoke.sdpHasAudio called with no parameters.")}return sdp.indexOf("m=audio")!==-1&&sdp.indexOf("a=recvonly")===-1};respoke.sdpHasVideo=function(sdp){if(!sdp){throw new Error("respoke.sdpHasVideo called with no parameters.")}return sdp.indexOf("m=video")!==-1&&sdp.indexOf("a=recvonly")===-1};respoke.sdpHasDataChannel=function(sdp){if(!sdp){throw new Error("respoke.sdpHasDataChannel called with no parameters.")}return sdp.indexOf("m=application")!==-1};respoke.sdpHasSendOnly=function(sdp){if(!sdp){throw new Error("respoke.sdpHasSendOnly called with no parameters.")}return sdp.indexOf("a=sendonly")!==-1};respoke.sdpHasReceiveOnly=function(sdp){if(!sdp){throw new Error("respoke.sdpHasReceiveOnly called with no parameters.")}return sdp.indexOf("a=recvonly")!==-1};respoke.constraintsHasAudio=function(constraints){if(!constraints){throw new Error("respoke.constraintsHasAudio called with no parameters.")}return constraints.audio===true};respoke.constraintsHasVideo=function(constraints){if(!constraints){throw new Error("respoke.constraintsHasVideo called with no parameters.")}return constraints.video===true||typeof constraints.video==="object"};respoke.constraintsHasScreenShare=function(constraints){if(!constraints){throw new Error("respoke.constraintsHasScreenShare called with no parameters.")}return constraints.video&&constraints.video.mandatory&&(constraints.video.mandatory.chromeMediaSource||constraints.video.mediaSource)};respoke.convertConstraints=function(constraints,defaults){constraints=constraints||[];defaults=defaults||[];if(!constraints.splice){if(typeof constraints==="object"){constraints=[constraints]}else{constraints=[]}}if(constraints.length===0&&defaults.length>0){return defaults}return constraints};respoke.queueFactory=function(){var queue=[];queue.trigger=function(action){if(!action){throw new Error("Trigger function requires an action parameter.")}function safeAction(item){try{action(item)}catch(err){log.error("Error calling queue action.",err)}}queue.forEach(safeAction);queue.length=0;queue.push=safeAction};return queue};respoke.getScreenShareConstraints=function(params){params=params||{};var screenConstraint=params.constraints||{audio:false,video:{mandatory:{},optional:[]}};screenConstraint.audio=false;screenConstraint.video=typeof screenConstraint.video==="object"?screenConstraint.video:{};screenConstraint.video.optional=Array.isArray(screenConstraint.video.optional)?screenConstraint.video.optional:[];screenConstraint.video.mandatory=typeof screenConstraint.video.mandatory==="object"?screenConstraint.video.mandatory:{};if(respoke.needsChromeExtension||respoke.isNwjs){screenConstraint.audio=false;screenConstraint.video.mandatory.chromeMediaSource="desktop";screenConstraint.video.mandatory.maxWidth=typeof screenConstraint.video.mandatory.maxWidth==="number"?screenConstraint.video.mandatory.maxWidth:2e3;screenConstraint.video.mandatory.maxHeight=typeof screenConstraint.video.mandatory.maxHeight==="number"?screenConstraint.video.mandatory.maxHeight:2e3;if(screenConstraint.video.optional.length>0){screenConstraint.video.optional.forEach(function(thing){thing.googTemporalLayeredScreencast=true})}else{screenConstraint.video.optional[0]={googTemporalLayeredScreencast:true}}}else{screenConstraint.video.mediaSource=params.source||"screen"}return screenConstraint};respoke.getScreenShareMedia=function(params){params=params||{};var deferred=respoke.Q.defer();var criteria={source:params.source,constraints:respoke.clone(params.constraints)};var localMedia=respoke.LocalMedia({hasScreenShare:true,constraints:respoke.getScreenShareConstraints(criteria),source:params.source,element:params.element});localMedia.start().done(function(){deferred.resolve(localMedia)},function(err){deferred.reject(err)});return respoke.handlePromise(deferred.promise,params.onSuccess,params.onError)}}).call(exports,function(){return this}())},function(module,exports,__webpack_require__){var __WEBPACK_AMD_DEFINE_FACTORY__,__WEBPACK_AMD_DEFINE_RESULT__;(function(root,definition){if(typeof module==="object"&&module.exports&&"function"==="function"){module.exports=definition()}else if(true){!(__WEBPACK_AMD_DEFINE_FACTORY__=definition,__WEBPACK_AMD_DEFINE_RESULT__=typeof __WEBPACK_AMD_DEFINE_FACTORY__==="function"?__WEBPACK_AMD_DEFINE_FACTORY__.call(exports,__webpack_require__,exports,module):__WEBPACK_AMD_DEFINE_FACTORY__,__WEBPACK_AMD_DEFINE_RESULT__!==undefined&&(module.exports=__WEBPACK_AMD_DEFINE_RESULT__))}else{root.log=definition()}})(this,function(){var self={};var noop=function(){};var undefinedType="undefined";function realMethod(methodName){if(typeof console===undefinedType){return false}else if(console[methodName]!==undefined){return bindMethod(console,methodName)}else if(console.log!==undefined){return bindMethod(console,"log")}else{return noop}}function bindMethod(obj,methodName){var method=obj[methodName];if(typeof method.bind==="function"){return method.bind(obj)}else{try{return Function.prototype.bind.call(method,obj)}catch(e){return function(){return Function.prototype.apply.apply(method,[obj,arguments])}}}}function enableLoggingWhenConsoleArrives(methodName,level){return function(){if(typeof console!==undefinedType){replaceLoggingMethods(level);self[methodName].apply(self,arguments)}}}var logMethods=["trace","debug","info","warn","error"];function replaceLoggingMethods(level){for(var i=0;i<logMethods.length;i++){var methodName=logMethods[i];self[methodName]=i<level?noop:self.methodFactory(methodName,level)}}function persistLevelIfPossible(levelNum){var levelName=(logMethods[levelNum]||"silent").toUpperCase();try{window.localStorage["loglevel"]=levelName;return}catch(ignore){}try{window.document.cookie="loglevel="+levelName+";"}catch(ignore){}}function loadPersistedLevel(){var storedLevel;try{storedLevel=window.localStorage["loglevel"]}catch(ignore){}if(typeof storedLevel===undefinedType){try{storedLevel=/loglevel=([^;]+)/.exec(window.document.cookie)[1]}catch(ignore){}}if(self.levels[storedLevel]===undefined){storedLevel="WARN"}self.setLevel(self.levels[storedLevel])}self.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5};self.methodFactory=function(methodName,level){return realMethod(methodName)||enableLoggingWhenConsoleArrives(methodName,level)};self.setLevel=function(level){if(typeof level==="string"&&self.levels[level.toUpperCase()]!==undefined){level=self.levels[level.toUpperCase()]}if(typeof level==="number"&&level>=0&&level<=self.levels.SILENT){persistLevelIfPossible(level);replaceLoggingMethods(level);if(typeof console===undefinedType&&level<self.levels.SILENT){return"No console available for logging"}}else{throw"log.setLevel() called with invalid level: "+level}};self.enableAll=function(){self.setLevel(self.levels.TRACE)};self.disableAll=function(){self.setLevel(self.levels.SILENT)};var _log=typeof window!==undefinedType?window.log:undefined;self.noConflict=function(){if(typeof window!==undefinedType&&window.log===self){window.log=_log}return self};loadPersistedLevel();return self})},function(module,exports){/*!
	 *  Copyright (c) 2014 The WebRTC project authors. All Rights Reserved.
	 *
	 *  Use of this source code is governed by a BSD-style license
	 *  that can be found in the LICENSE file in the same directory as
	 *  this source file.
	 * @ignore
	 */
"use strict";var RTCPeerConnection=null;var getUserMedia=null;var attachMediaStream=null;var reattachMediaStream=null;var webrtcDetectedBrowser=null;var webrtcDetectedVersion=null;function trace(text){if(text[text.length-1]==="\n"){text=text.substring(0,text.length-1)}console.log((window.performance.now()/1e3).toFixed(3)+": "+text)}function maybeFixConfiguration(pcConfig){if(!pcConfig){return}for(var i=0;i<pcConfig.iceServers.length;i++){if(pcConfig.iceServers[i].hasOwnProperty("urls")){pcConfig.iceServers[i].url=pcConfig.iceServers[i].urls;delete pcConfig.iceServers[i].urls}}}if(navigator.mozGetUserMedia){console.log("This appears to be Firefox");webrtcDetectedBrowser="firefox";webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10);RTCPeerConnection=function(pcConfig,pcConstraints){maybeFixConfiguration(pcConfig);return new mozRTCPeerConnection(pcConfig,pcConstraints)};window.RTCSessionDescription=mozRTCSessionDescription;window.RTCIceCandidate=mozRTCIceCandidate;getUserMedia=navigator.mozGetUserMedia.bind(navigator);navigator.getUserMedia=getUserMedia;window.createIceServer=function(url,username,password){var iceServer=null;var urlParts=url.split(":");if(urlParts[0].indexOf("stun")===0){iceServer={url:url}}else if(urlParts[0].indexOf("turn")===0){if(webrtcDetectedVersion<27){var turnUrlParts=url.split("?");if(turnUrlParts.length===1||turnUrlParts[1].indexOf("transport=udp")===0){iceServer={url:turnUrlParts[0],credential:password,username:username}}}else{iceServer={url:url,credential:password,username:username}}}return iceServer};window.createIceServers=function(urls,username,password){var iceServers=[];for(var i=0;i<urls.length;i++){var iceServer=window.createIceServer(urls[i],username,password);if(iceServer!==null){iceServers.push(iceServer)}}return iceServers};attachMediaStream=function(element,stream){element.mozSrcObject=stream;setTimeout(function(){element.play()},100)};reattachMediaStream=function(to,from){to.mozSrcObject=from.mozSrcObject}}else if(navigator.webkitGetUserMedia){console.log("This appears to be Chrome");webrtcDetectedBrowser="chrome";var result=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);if(result!==null){webrtcDetectedVersion=parseInt(result[2],10)}else{webrtcDetectedVersion=999}window.createIceServer=function(url,username,password){var iceServer=null;var urlParts=url.split(":");if(urlParts[0].indexOf("stun")===0){iceServer={url:url}}else if(urlParts[0].indexOf("turn")===0){iceServer={url:url,credential:password,username:username}}return iceServer};window.createIceServers=function(urls,username,password){var iceServers=[];if(webrtcDetectedVersion>=34){iceServers={urls:urls,credential:password,username:username}}else{for(var i=0;i<urls.length;i++){var iceServer=window.createIceServer(urls[i],username,password);if(iceServer!==null){iceServers.push(iceServer)}}}return iceServers};RTCPeerConnection=function(pcConfig,pcConstraints){if(webrtcDetectedVersion<34){maybeFixConfiguration(pcConfig)}return new webkitRTCPeerConnection(pcConfig,pcConstraints)};getUserMedia=navigator.webkitGetUserMedia.bind(navigator);navigator.getUserMedia=getUserMedia;attachMediaStream=function(element,stream){if(typeof element.srcObject!=="undefined"){element.srcObject=stream}else if(typeof element.mozSrcObject!=="undefined"){element.mozSrcObject=stream}else if(typeof element.src!=="undefined"){element.src=URL.createObjectURL(stream)}else{console.log("Error attaching stream to element.")}};reattachMediaStream=function(to,from){to.src=from.src}}else{console.log("Browser does not appear to be WebRTC-capable")}window.RTCPeerConnection=RTCPeerConnection;window.getUserMedia=getUserMedia;window.attachMediaStream=attachMediaStream;window.reattachMediaStream=reattachMediaStream;window.webrtcDetectedBrowser=webrtcDetectedBrowser;window.webrtcDetectedVersion=webrtcDetectedVersion},function(module,exports,__webpack_require__){var log=__webpack_require__(2);var respokeClass=__webpack_require__(5);var callOnce=function(func){"use strict";return function(){var called=false;return function(){if(!called){func.apply(null,arguments);called=true}}}()};var EventEmitter=module.exports=function(params){"use strict";params=params||{};var that=respokeClass(params);that.className="respoke.EventEmitter";var eventList={};that.once=function(eventType,listener,isInternal){var string=listener.toString();listener=callOnce(listener);listener.toString=function(){return string};listener.once=true;that.listen(eventType,listener,isInternal)};that.listen=function(eventType,listener,isInternal){if(listener===undefined){return}var invalidEventType=typeof eventType!=="string"||!eventType;var invalidListener=typeof listener!=="function";if(invalidEventType||invalidListener){log.error("Invalid request to add event listener to",eventType,listener);return}eventList[eventType]=eventList[eventType]||[];listener.isInternal=!!isInternal;var toString=function(fn){return fn.toString()};var isNotAlreadyAdded=eventList[eventType].map(toString).indexOf(listener.toString())===-1;if(isNotAlreadyAdded){eventList[eventType].push(listener)}else{log.warn("Not adding duplicate listener to",eventType,listener)}};that.ignore=function(eventType,listener){if(eventType===undefined){eventList={};return}if(listener===undefined||!eventList[eventType]){eventList[eventType]=[];return}for(var i=eventList[eventType].length-1;i>=0;i-=1){if(listener===eventList[eventType][i]){eventList[eventType].splice(i,1);return}}};that.fire=function(eventType,evt){var args=null;var count=0;var toRemove=[];var i;evt=evt||{};evt.name=eventType;evt.target=that;if(!eventType){return}if(!eventList[eventType]){log.debug("fired "+that.className+"#"+eventType+" 0 listeners called with params",evt);return}for(i=0;i<eventList[eventType].length;i+=1){var listener=eventList[eventType][i];if(typeof listener==="function"){setTimeout(listenerBuilder(listener,evt,eventType));count+=1;if(listener.once===true){toRemove.push(i)}}}for(i=toRemove.length-1;i>=0;i-=1){eventList[eventType].splice(toRemove[i],1)}log.debug("fired "+that.className+"#"+eventType+" "+count+" listeners called with params",evt)};function listenerBuilder(listener,evt,eventType){return function(){try{listener.call(that,evt)}catch(e){log.error("Error in "+that.className+"#"+eventType,e.message,e.stack)}}}that.hasListeners=function(eventType){if(eventType===undefined){throw new Error("Missing required parameter event type.")}if(!eventList[eventType]){return false}return!eventList[eventType].every(function eachListener(listener){return listener.isInternal})};return that}},function(module,exports){module.exports=function(params){"use strict";params=params||{};var that=params.that||{};that.className="respoke.Class";delete params.that;delete that.client;Object.keys(params).forEach(function copyParam(name){that[name]=params[name]});return that}},function(module,exports,__webpack_require__){/*!
	 *
	 * Copyright 2009-2012 Kris Kowal under the terms of the MIT
	 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
	 *
	 * With parts by Tyler Close
	 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
	 * at http://www.opensource.org/licenses/mit-license.html
	 * Forked at ref_send.js version: 2009-05-11
	 *
	 * With parts by Mark Miller
	 * Copyright (C) 2011 Google Inc.
	 *
	 * Licensed under the Apache License, Version 2.0 (the "License");
	 * you may not use this file except in compliance with the License.
	 * You may obtain a copy of the License at
	 *
	 * http://www.apache.org/licenses/LICENSE-2.0
	 *
	 * Unless required by applicable law or agreed to in writing, software
	 * distributed under the License is distributed on an "AS IS" BASIS,
	 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
	 * See the License for the specific language governing permissions and
	 * limitations under the License.
	 *
	 */
(function(definition){"use strict";if(typeof bootstrap==="function"){bootstrap("promise",definition)}else if(true){module.exports=definition()}else if(typeof define==="function"&&define.amd){define(definition)}else if(typeof ses!=="undefined"){if(!ses.ok()){return}else{ses.makeQ=definition}}else if(typeof self!=="undefined"){self.Q=definition()}else{throw new Error("This environment was not anticipated by Q. Please file a bug.")}})(function(){"use strict";var hasStacks=false;try{throw new Error}catch(e){hasStacks=!!e.stack}var qStartingLine=captureLine();var qFileName;var noop=function(){};var nextTick=function(){var head={task:void 0,next:null};var tail=head;var flushing=false;var requestTick=void 0;var isNodeJS=false;var laterQueue=[];function flush(){var task,domain;while(head.next){head=head.next;task=head.task;head.task=void 0;domain=head.domain;if(domain){head.domain=void 0;domain.enter()}runSingle(task,domain)}while(laterQueue.length){task=laterQueue.pop();runSingle(task)}flushing=false}function runSingle(task,domain){try{task()}catch(e){if(isNodeJS){if(domain){domain.exit()}setTimeout(flush,0);if(domain){domain.enter()}throw e}else{setTimeout(function(){throw e},0)}}if(domain){domain.exit()}}nextTick=function(task){tail=tail.next={task:task,domain:isNodeJS&&process.domain,next:null};if(!flushing){flushing=true;requestTick()}};if(typeof process==="object"&&process.toString()==="[object process]"&&process.nextTick){isNodeJS=true;requestTick=function(){process.nextTick(flush)}}else if(typeof setImmediate==="function"){if(typeof window!=="undefined"){requestTick=setImmediate.bind(window,flush)}else{requestTick=function(){setImmediate(flush)}}}else if(typeof MessageChannel!=="undefined"){var channel=new MessageChannel;channel.port1.onmessage=function(){requestTick=requestPortTick;channel.port1.onmessage=flush;flush()};var requestPortTick=function(){channel.port2.postMessage(0)};requestTick=function(){setTimeout(flush,0);requestPortTick()}}else{requestTick=function(){setTimeout(flush,0)}}nextTick.runAfter=function(task){laterQueue.push(task);if(!flushing){flushing=true;requestTick()}};return nextTick}();var call=Function.call;function uncurryThis(f){return function(){return call.apply(f,arguments)}}var array_slice=uncurryThis(Array.prototype.slice);var array_reduce=uncurryThis(Array.prototype.reduce||function(callback,basis){var index=0,length=this.length;if(arguments.length===1){do{if(index in this){basis=this[index++];break}if(++index>=length){throw new TypeError}}while(1)}for(;index<length;index++){if(index in this){basis=callback(basis,this[index],index)}}return basis});var array_indexOf=uncurryThis(Array.prototype.indexOf||function(value){for(var i=0;i<this.length;i++){if(this[i]===value){return i}}return-1});var array_map=uncurryThis(Array.prototype.map||function(callback,thisp){var self=this;var collect=[];array_reduce(self,function(undefined,value,index){collect.push(callback.call(thisp,value,index,self))},void 0);return collect});var object_create=Object.create||function(prototype){function Type(){}Type.prototype=prototype;return new Type};var object_hasOwnProperty=uncurryThis(Object.prototype.hasOwnProperty);var object_keys=Object.keys||function(object){var keys=[];for(var key in object){if(object_hasOwnProperty(object,key)){keys.push(key)}}return keys};var object_toString=uncurryThis(Object.prototype.toString);function isObject(value){return value===Object(value)}function isStopIteration(exception){return object_toString(exception)==="[object StopIteration]"||exception instanceof QReturnValue}var QReturnValue;if(typeof ReturnValue!=="undefined"){QReturnValue=ReturnValue}else{QReturnValue=function(value){this.value=value}}var STACK_JUMP_SEPARATOR="From previous event:";function makeStackTraceLong(error,promise){if(hasStacks&&promise.stack&&typeof error==="object"&&error!==null&&error.stack&&error.stack.indexOf(STACK_JUMP_SEPARATOR)===-1){var stacks=[];for(var p=promise;!!p;p=p.source){if(p.stack){stacks.unshift(p.stack)}}stacks.unshift(error.stack);var concatedStacks=stacks.join("\n"+STACK_JUMP_SEPARATOR+"\n");error.stack=filterStackString(concatedStacks)}}function filterStackString(stackString){var lines=stackString.split("\n");var desiredLines=[];for(var i=0;i<lines.length;++i){var line=lines[i];if(!isInternalFrame(line)&&!isNodeFrame(line)&&line){desiredLines.push(line)}}return desiredLines.join("\n")}function isNodeFrame(stackLine){return stackLine.indexOf("(module.js:")!==-1||stackLine.indexOf("(node.js:")!==-1}function getFileNameAndLineNumber(stackLine){var attempt1=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(stackLine);if(attempt1){return[attempt1[1],Number(attempt1[2])]}var attempt2=/at ([^ ]+):(\d+):(?:\d+)$/.exec(stackLine);if(attempt2){return[attempt2[1],Number(attempt2[2])]}var attempt3=/.*@(.+):(\d+)$/.exec(stackLine);if(attempt3){return[attempt3[1],Number(attempt3[2])]}}function isInternalFrame(stackLine){var fileNameAndLineNumber=getFileNameAndLineNumber(stackLine);if(!fileNameAndLineNumber){return false}var fileName=fileNameAndLineNumber[0];var lineNumber=fileNameAndLineNumber[1];return fileName===qFileName&&lineNumber>=qStartingLine&&lineNumber<=qEndingLine}function captureLine(){if(!hasStacks){return}try{throw new Error}catch(e){var lines=e.stack.split("\n");var firstLine=lines[0].indexOf("@")>0?lines[1]:lines[2];var fileNameAndLineNumber=getFileNameAndLineNumber(firstLine);if(!fileNameAndLineNumber){return}qFileName=fileNameAndLineNumber[0];return fileNameAndLineNumber[1]}}function deprecate(callback,name,alternative){return function(){if(typeof console!=="undefined"&&typeof console.warn==="function"){console.warn(name+" is deprecated, use "+alternative+" instead.",new Error("").stack)}return callback.apply(callback,arguments)}}function Q(value){if(value instanceof Promise){return value}if(isPromiseAlike(value)){return coerce(value)}else{return fulfill(value)}}Q.resolve=Q;Q.nextTick=nextTick;Q.longStackSupport=false;if(typeof process==="object"&&process&&process.env&&process.env.Q_DEBUG){Q.longStackSupport=true}Q.defer=defer;function defer(){var messages=[],progressListeners=[],resolvedPromise;var deferred=object_create(defer.prototype);var promise=object_create(Promise.prototype);promise.promiseDispatch=function(resolve,op,operands){var args=array_slice(arguments);if(messages){messages.push(args);if(op==="when"&&operands[1]){progressListeners.push(operands[1])}}else{Q.nextTick(function(){resolvedPromise.promiseDispatch.apply(resolvedPromise,args)})}};promise.valueOf=function(){if(messages){return promise}var nearerValue=nearer(resolvedPromise);if(isPromise(nearerValue)){resolvedPromise=nearerValue}return nearerValue};promise.inspect=function(){if(!resolvedPromise){return{state:"pending"}}return resolvedPromise.inspect()};if(Q.longStackSupport&&hasStacks){try{throw new Error}catch(e){promise.stack=e.stack.substring(e.stack.indexOf("\n")+1)}}function become(newPromise){resolvedPromise=newPromise;promise.source=newPromise;array_reduce(messages,function(undefined,message){Q.nextTick(function(){newPromise.promiseDispatch.apply(newPromise,message)})},void 0);messages=void 0;progressListeners=void 0}deferred.promise=promise;deferred.resolve=function(value){if(resolvedPromise){return}become(Q(value))};deferred.fulfill=function(value){if(resolvedPromise){return}become(fulfill(value))};deferred.reject=function(reason){if(resolvedPromise){return}become(reject(reason))};deferred.notify=function(progress){if(resolvedPromise){return}array_reduce(progressListeners,function(undefined,progressListener){Q.nextTick(function(){progressListener(progress)})},void 0)};return deferred}defer.prototype.makeNodeResolver=function(){var self=this;return function(error,value){if(error){self.reject(error)}else if(arguments.length>2){self.resolve(array_slice(arguments,1))}else{self.resolve(value)}}};Q.Promise=promise;Q.promise=promise;function promise(resolver){if(typeof resolver!=="function"){throw new TypeError("resolver must be a function.")}var deferred=defer();try{resolver(deferred.resolve,deferred.reject,deferred.notify)}catch(reason){deferred.reject(reason)}return deferred.promise}promise.race=race;promise.all=all;promise.reject=reject;promise.resolve=Q;Q.passByCopy=function(object){return object};Promise.prototype.passByCopy=function(){return this};Q.join=function(x,y){return Q(x).join(y)};Promise.prototype.join=function(that){return Q([this,that]).spread(function(x,y){if(x===y){return x}else{throw new Error("Can't join: not the same: "+x+" "+y)}})};Q.race=race;function race(answerPs){return promise(function(resolve,reject){for(var i=0,len=answerPs.length;i<len;i++){Q(answerPs[i]).then(resolve,reject)}})}Promise.prototype.race=function(){return this.then(Q.race)};Q.makePromise=Promise;function Promise(descriptor,fallback,inspect){if(fallback===void 0){fallback=function(op){return reject(new Error("Promise does not support operation: "+op))}}if(inspect===void 0){inspect=function(){return{state:"unknown"}}}var promise=object_create(Promise.prototype);promise.promiseDispatch=function(resolve,op,args){var result;try{if(descriptor[op]){result=descriptor[op].apply(promise,args)}else{result=fallback.call(promise,op,args)}}catch(exception){result=reject(exception)}if(resolve){resolve(result)}};promise.inspect=inspect;if(inspect){var inspected=inspect();if(inspected.state==="rejected"){promise.exception=inspected.reason}promise.valueOf=function(){var inspected=inspect();if(inspected.state==="pending"||inspected.state==="rejected"){return promise}return inspected.value}}return promise}Promise.prototype.toString=function(){return"[object Promise]"};Promise.prototype.then=function(fulfilled,rejected,progressed){var self=this;var deferred=defer();var done=false;function _fulfilled(value){try{return typeof fulfilled==="function"?fulfilled(value):value}catch(exception){return reject(exception)}}function _rejected(exception){if(typeof rejected==="function"){makeStackTraceLong(exception,self);try{return rejected(exception)}catch(newException){return reject(newException)}}return reject(exception)}function _progressed(value){return typeof progressed==="function"?progressed(value):value}Q.nextTick(function(){self.promiseDispatch(function(value){if(done){return}done=true;deferred.resolve(_fulfilled(value))},"when",[function(exception){if(done){return}done=true;deferred.resolve(_rejected(exception))}])});self.promiseDispatch(void 0,"when",[void 0,function(value){var newValue;var threw=false;try{newValue=_progressed(value)}catch(e){threw=true;if(Q.onerror){Q.onerror(e)}else{throw e}}if(!threw){deferred.notify(newValue)}}]);return deferred.promise};Q.tap=function(promise,callback){return Q(promise).tap(callback)};Promise.prototype.tap=function(callback){callback=Q(callback);return this.then(function(value){return callback.fcall(value).thenResolve(value)})};Q.when=when;function when(value,fulfilled,rejected,progressed){return Q(value).then(fulfilled,rejected,progressed)}Promise.prototype.thenResolve=function(value){return this.then(function(){return value})};Q.thenResolve=function(promise,value){return Q(promise).thenResolve(value)};Promise.prototype.thenReject=function(reason){return this.then(function(){throw reason})};Q.thenReject=function(promise,reason){return Q(promise).thenReject(reason)};Q.nearer=nearer;function nearer(value){if(isPromise(value)){var inspected=value.inspect();if(inspected.state==="fulfilled"){return inspected.value}}return value}Q.isPromise=isPromise;function isPromise(object){return object instanceof Promise}Q.isPromiseAlike=isPromiseAlike;function isPromiseAlike(object){return isObject(object)&&typeof object.then==="function"}Q.isPending=isPending;function isPending(object){return isPromise(object)&&object.inspect().state==="pending"}Promise.prototype.isPending=function(){return this.inspect().state==="pending"};Q.isFulfilled=isFulfilled;function isFulfilled(object){return!isPromise(object)||object.inspect().state==="fulfilled"}Promise.prototype.isFulfilled=function(){return this.inspect().state==="fulfilled"};Q.isRejected=isRejected;function isRejected(object){return isPromise(object)&&object.inspect().state==="rejected"}Promise.prototype.isRejected=function(){return this.inspect().state==="rejected"};var unhandledReasons=[];var unhandledRejections=[];var reportedUnhandledRejections=[];var trackUnhandledRejections=true;function resetUnhandledRejections(){unhandledReasons.length=0;unhandledRejections.length=0;if(!trackUnhandledRejections){trackUnhandledRejections=true}}function trackRejection(promise,reason){if(!trackUnhandledRejections){return}if(typeof process==="object"&&typeof process.emit==="function"){Q.nextTick.runAfter(function(){if(array_indexOf(unhandledRejections,promise)!==-1){process.emit("unhandledRejection",reason,promise);reportedUnhandledRejections.push(promise)}})}unhandledRejections.push(promise);if(reason&&typeof reason.stack!=="undefined"){unhandledReasons.push(reason.stack)}else{unhandledReasons.push("(no stack) "+reason)}}function untrackRejection(promise){if(!trackUnhandledRejections){return}var at=array_indexOf(unhandledRejections,promise);if(at!==-1){if(typeof process==="object"&&typeof process.emit==="function"){Q.nextTick.runAfter(function(){var atReport=array_indexOf(reportedUnhandledRejections,promise);if(atReport!==-1){process.emit("rejectionHandled",unhandledReasons[at],promise);reportedUnhandledRejections.splice(atReport,1)}})}unhandledRejections.splice(at,1);unhandledReasons.splice(at,1)}}Q.resetUnhandledRejections=resetUnhandledRejections;Q.getUnhandledReasons=function(){return unhandledReasons.slice()};Q.stopUnhandledRejectionTracking=function(){resetUnhandledRejections();trackUnhandledRejections=false};resetUnhandledRejections();Q.reject=reject;function reject(reason){var rejection=Promise({when:function(rejected){if(rejected){untrackRejection(this)}return rejected?rejected(reason):this}},function fallback(){return this},function inspect(){return{state:"rejected",reason:reason}});trackRejection(rejection,reason);return rejection}Q.fulfill=fulfill;function fulfill(value){return Promise({when:function(){return value},get:function(name){return value[name]},set:function(name,rhs){value[name]=rhs},"delete":function(name){delete value[name]},post:function(name,args){if(name===null||name===void 0){return value.apply(void 0,args)}else{return value[name].apply(value,args)}},apply:function(thisp,args){return value.apply(thisp,args)},keys:function(){return object_keys(value)}},void 0,function inspect(){return{state:"fulfilled",value:value}})}function coerce(promise){var deferred=defer();Q.nextTick(function(){try{promise.then(deferred.resolve,deferred.reject,deferred.notify)}catch(exception){deferred.reject(exception)}});return deferred.promise}Q.master=master;function master(object){return Promise({isDef:function(){}},function fallback(op,args){return dispatch(object,op,args)},function(){return Q(object).inspect()})}Q.spread=spread;function spread(value,fulfilled,rejected){return Q(value).spread(fulfilled,rejected)}Promise.prototype.spread=function(fulfilled,rejected){return this.all().then(function(array){return fulfilled.apply(void 0,array)},rejected)};Q.async=async;function async(makeGenerator){return function(){function continuer(verb,arg){var result;if(typeof StopIteration==="undefined"){try{result=generator[verb](arg)}catch(exception){return reject(exception)}if(result.done){return Q(result.value)}else{return when(result.value,callback,errback)}}else{try{result=generator[verb](arg)}catch(exception){if(isStopIteration(exception)){return Q(exception.value)}else{return reject(exception)}}return when(result,callback,errback)}}var generator=makeGenerator.apply(this,arguments);var callback=continuer.bind(continuer,"next");var errback=continuer.bind(continuer,"throw");return callback()}}Q.spawn=spawn;function spawn(makeGenerator){Q.done(Q.async(makeGenerator)())}Q["return"]=_return;function _return(value){throw new QReturnValue(value)}Q.promised=promised;function promised(callback){return function(){return spread([this,all(arguments)],function(self,args){return callback.apply(self,args)})}}Q.dispatch=dispatch;function dispatch(object,op,args){return Q(object).dispatch(op,args)}Promise.prototype.dispatch=function(op,args){var self=this;var deferred=defer();Q.nextTick(function(){self.promiseDispatch(deferred.resolve,op,args)});return deferred.promise};Q.get=function(object,key){return Q(object).dispatch("get",[key])};Promise.prototype.get=function(key){return this.dispatch("get",[key])};Q.set=function(object,key,value){return Q(object).dispatch("set",[key,value])};Promise.prototype.set=function(key,value){return this.dispatch("set",[key,value])};Q.del=Q["delete"]=function(object,key){return Q(object).dispatch("delete",[key])};Promise.prototype.del=Promise.prototype["delete"]=function(key){return this.dispatch("delete",[key])};Q.mapply=Q.post=function(object,name,args){return Q(object).dispatch("post",[name,args])};Promise.prototype.mapply=Promise.prototype.post=function(name,args){return this.dispatch("post",[name,args])};Q.send=Q.mcall=Q.invoke=function(object,name){return Q(object).dispatch("post",[name,array_slice(arguments,2)])};Promise.prototype.send=Promise.prototype.mcall=Promise.prototype.invoke=function(name){return this.dispatch("post",[name,array_slice(arguments,1)])};Q.fapply=function(object,args){return Q(object).dispatch("apply",[void 0,args])};Promise.prototype.fapply=function(args){return this.dispatch("apply",[void 0,args])};Q["try"]=Q.fcall=function(object){return Q(object).dispatch("apply",[void 0,array_slice(arguments,1)])};Promise.prototype.fcall=function(){return this.dispatch("apply",[void 0,array_slice(arguments)])};Q.fbind=function(object){var promise=Q(object);var args=array_slice(arguments,1);return function fbound(){return promise.dispatch("apply",[this,args.concat(array_slice(arguments))])}};Promise.prototype.fbind=function(){var promise=this;var args=array_slice(arguments);return function fbound(){return promise.dispatch("apply",[this,args.concat(array_slice(arguments))])}};Q.keys=function(object){return Q(object).dispatch("keys",[])};Promise.prototype.keys=function(){return this.dispatch("keys",[])};Q.all=all;function all(promises){return when(promises,function(promises){var pendingCount=0;var deferred=defer();array_reduce(promises,function(undefined,promise,index){var snapshot;if(isPromise(promise)&&(snapshot=promise.inspect()).state==="fulfilled"){promises[index]=snapshot.value}else{++pendingCount;when(promise,function(value){promises[index]=value;if(--pendingCount===0){deferred.resolve(promises)}},deferred.reject,function(progress){deferred.notify({index:index,value:progress})})}},void 0);if(pendingCount===0){deferred.resolve(promises)}return deferred.promise})}Promise.prototype.all=function(){return all(this)};Q.any=any;function any(promises){if(promises.length===0){return Q.resolve()}var deferred=Q.defer();var pendingCount=0;array_reduce(promises,function(prev,current,index){var promise=promises[index];pendingCount++;when(promise,onFulfilled,onRejected,onProgress);function onFulfilled(result){deferred.resolve(result)}function onRejected(){pendingCount--;if(pendingCount===0){deferred.reject(new Error("Can't get fulfillment value from any promise, all "+"promises were rejected."))}}function onProgress(progress){deferred.notify({index:index,value:progress})}},undefined);return deferred.promise}Promise.prototype.any=function(){return any(this)};Q.allResolved=deprecate(allResolved,"allResolved","allSettled");function allResolved(promises){return when(promises,function(promises){promises=array_map(promises,Q);return when(all(array_map(promises,function(promise){return when(promise,noop,noop)})),function(){return promises})})}Promise.prototype.allResolved=function(){return allResolved(this)};Q.allSettled=allSettled;function allSettled(promises){return Q(promises).allSettled()}Promise.prototype.allSettled=function(){return this.then(function(promises){return all(array_map(promises,function(promise){promise=Q(promise);function regardless(){return promise.inspect()}return promise.then(regardless,regardless)}))})};Q.fail=Q["catch"]=function(object,rejected){return Q(object).then(void 0,rejected)};Promise.prototype.fail=Promise.prototype["catch"]=function(rejected){return this.then(void 0,rejected)};Q.progress=progress;function progress(object,progressed){return Q(object).then(void 0,void 0,progressed)}Promise.prototype.progress=function(progressed){return this.then(void 0,void 0,progressed)};Q.fin=Q["finally"]=function(object,callback){return Q(object)["finally"](callback)};Promise.prototype.fin=Promise.prototype["finally"]=function(callback){callback=Q(callback);return this.then(function(value){return callback.fcall().then(function(){return value})},function(reason){return callback.fcall().then(function(){throw reason})})};Q.done=function(object,fulfilled,rejected,progress){return Q(object).done(fulfilled,rejected,progress)};Promise.prototype.done=function(fulfilled,rejected,progress){var onUnhandledError=function(error){Q.nextTick(function(){makeStackTraceLong(error,promise);if(Q.onerror){Q.onerror(error)}else{throw error}})};var promise=fulfilled||rejected||progress?this.then(fulfilled,rejected,progress):this;if(typeof process==="object"&&process&&process.domain){onUnhandledError=process.domain.bind(onUnhandledError)}promise.then(void 0,onUnhandledError)};Q.timeout=function(object,ms,error){return Q(object).timeout(ms,error)};Promise.prototype.timeout=function(ms,error){var deferred=defer();var timeoutId=setTimeout(function(){if(!error||"string"===typeof error){error=new Error(error||"Timed out after "+ms+" ms");error.code="ETIMEDOUT"}deferred.reject(error)},ms);this.then(function(value){clearTimeout(timeoutId);deferred.resolve(value)},function(exception){clearTimeout(timeoutId);deferred.reject(exception)},deferred.notify);return deferred.promise};Q.delay=function(object,timeout){if(timeout===void 0){timeout=object;object=void 0}return Q(object).delay(timeout)};Promise.prototype.delay=function(timeout){return this.then(function(value){var deferred=defer();setTimeout(function(){deferred.resolve(value)},timeout);return deferred.promise})};Q.nfapply=function(callback,args){return Q(callback).nfapply(args)};Promise.prototype.nfapply=function(args){var deferred=defer();var nodeArgs=array_slice(args);nodeArgs.push(deferred.makeNodeResolver());this.fapply(nodeArgs).fail(deferred.reject);return deferred.promise};Q.nfcall=function(callback){var args=array_slice(arguments,1);return Q(callback).nfapply(args)};Promise.prototype.nfcall=function(){var nodeArgs=array_slice(arguments);var deferred=defer();nodeArgs.push(deferred.makeNodeResolver());this.fapply(nodeArgs).fail(deferred.reject);return deferred.promise};Q.nfbind=Q.denodeify=function(callback){var baseArgs=array_slice(arguments,1);return function(){var nodeArgs=baseArgs.concat(array_slice(arguments));var deferred=defer();nodeArgs.push(deferred.makeNodeResolver());Q(callback).fapply(nodeArgs).fail(deferred.reject);return deferred.promise}};Promise.prototype.nfbind=Promise.prototype.denodeify=function(){var args=array_slice(arguments);args.unshift(this);return Q.denodeify.apply(void 0,args)};Q.nbind=function(callback,thisp){var baseArgs=array_slice(arguments,2);return function(){var nodeArgs=baseArgs.concat(array_slice(arguments));var deferred=defer();nodeArgs.push(deferred.makeNodeResolver());function bound(){return callback.apply(thisp,arguments)}Q(bound).fapply(nodeArgs).fail(deferred.reject);return deferred.promise}};Promise.prototype.nbind=function(){var args=array_slice(arguments,0);args.unshift(this);return Q.nbind.apply(void 0,args)};Q.nmapply=Q.npost=function(object,name,args){return Q(object).npost(name,args)};Promise.prototype.nmapply=Promise.prototype.npost=function(name,args){var nodeArgs=array_slice(args||[]);var deferred=defer();nodeArgs.push(deferred.makeNodeResolver());this.dispatch("post",[name,nodeArgs]).fail(deferred.reject);return deferred.promise};Q.nsend=Q.nmcall=Q.ninvoke=function(object,name){var nodeArgs=array_slice(arguments,2);var deferred=defer();nodeArgs.push(deferred.makeNodeResolver());Q(object).dispatch("post",[name,nodeArgs]).fail(deferred.reject);return deferred.promise};Promise.prototype.nsend=Promise.prototype.nmcall=Promise.prototype.ninvoke=function(name){var nodeArgs=array_slice(arguments,1);var deferred=defer();nodeArgs.push(deferred.makeNodeResolver());this.dispatch("post",[name,nodeArgs]).fail(deferred.reject);return deferred.promise};Q.nodeify=nodeify;function nodeify(object,nodeback){return Q(object).nodeify(nodeback)}Promise.prototype.nodeify=function(nodeback){if(nodeback){this.then(function(value){Q.nextTick(function(){nodeback(null,value)})},function(error){Q.nextTick(function(){nodeback(error)})})}else{return this}};var qEndingLine=captureLine();return Q})},function(module,exports,__webpack_require__){var Q=__webpack_require__(6);var respoke=__webpack_require__(1);var log=respoke.log;module.exports=function(params){"use strict";params=params||{};var instanceId=params.instanceId||respoke.makeGUID();params.instanceId=instanceId;var that=respoke.EventEmitter(params);respoke.instances[instanceId]=that;delete that.instanceId;that.connectTries=0;that.className="respoke.Client";var host=window.location.hostname;var port=window.location.port;var clientSettings={};delete that.appId;delete that.baseURL;delete that.developmentMode;delete that.token;delete that.resolveEndpointPresence;var groups=[];var endpoints=[];that.calls=[];log.debug("Client ID is ",instanceId);var signalingChannel=respoke.SignalingChannel({instanceId:instanceId,clientSettings:clientSettings});that.presence=params.presence||"unavailable";that.getPresence=function(){return that.presence};function saveParameters(params){Object.keys(params).forEach(function eachParam(key){if(["onSuccess","onError","reconnect","presence"].indexOf(key)===-1&&params[key]!==undefined){clientSettings[key]=params[key]}});clientSettings.developmentMode=!!clientSettings.developmentMode;clientSettings.enableCallDebugReport=typeof clientSettings.enableCallDebugReport==="boolean"?clientSettings.enableCallDebugReport:true;if(typeof clientSettings.connectTimeoutMillis!=="number"){clientSettings.connectTimeoutMillis=1e4}if(typeof params.reconnect!=="boolean"){clientSettings.reconnect=typeof clientSettings.developmentMode==="boolean"?clientSettings.developmentMode:false}else{clientSettings.reconnect=!!params.reconnect}}saveParameters(params);that.connect=function(params){var promise;var retVal;params=params||{};log.debug("Client.connect");that.connectTries+=1;saveParameters(params);that.presence=params.presence||that.presence;that.endpointId=clientSettings.endpointId;promise=actuallyConnect(params);retVal=respoke.handlePromise(promise,params.onSuccess,params.onError);promise.then(function successHandler(){that.fire("connect")});return retVal};function actuallyConnect(params){params=params||{};var deferred=Q.defer();if(!clientSettings.token&&(!clientSettings.appId||!clientSettings.endpointId||clientSettings.developmentMode!==true)){deferred.reject(new Error("Must pass either endpointID & appId & developmentMode=true, or a token, "+"to client.connect()."));return deferred.promise}signalingChannel.open({actuallyConnect:actuallyConnect,endpointId:that.endpointId,token:clientSettings.token}).then(function successHandler(){return signalingChannel.authenticate()}).done(function successHandler(){if(that.presence){that.setPresence({presence:that.presence})}that.listen("call",clientSettings.onCall);that.listen("direct-connection",clientSettings.onDirectConnection);that.listen("join",clientSettings.onJoin);that.listen("leave",clientSettings.onLeave);that.listen("message",clientSettings.onMessage);that.listen("connect",clientSettings.onConnect);that.listen("disconnect",clientSettings.onDisconnect);that.listen("disconnect",function(){that.calls.forEach(function(call){call.hangup({signal:false})})},true);that.listen("reconnect",clientSettings.onReconnect);log.info("logged in as "+that.endpointId,that);deferred.resolve()},function errorHandler(err){deferred.reject(err);if(err.message&&err.message.match(/Connection limit exceeded/)){log.error("You have reached the connection limit on the account associated with this appId. "+"Please upgrade your account from the developer portal at https://portal.respoke.io "+"if you need more concurrent connections.",err)}else{log.error(err.message,err.stack)}});return deferred.promise}that.disconnect=function(params){params=params||{};var deferred=Q.defer();var retVal=respoke.handlePromise(deferred.promise,params.onSuccess,params.onError);try{that.verifyConnected()}catch(e){deferred.reject(e);return retVal}var leaveGroups=groups.map(function eachGroup(group){if(group.isJoined()){return group.leave()}});Q.all(leaveGroups).fin(function successHandler(){return signalingChannel.close()}).fin(function finallyHandler(){that.presence="unavailable";endpoints=[];groups=[];that.fire("disconnect");deferred.resolve()}).done();return retVal};that.setPresence=function(params){var promise;var retVal;params=params||{};params.presence=params.presence||"available";try{that.verifyConnected()}catch(e){promise=Q.reject(e);return respoke.handlePromise(promise,params.onSuccess,params.onError)}log.info("sending my presence update "+params.presence);promise=signalingChannel.sendPresence({presence:params.presence}).then(function successHandler(p){that.presence=params.presence;that.fire("presence",{presence:that.presence})});retVal=respoke.handlePromise(promise,params.onSuccess,params.onError);return retVal};that.getCall=function(params){var call=null;var methods={screenshare:"startScreenShare",did:"startPhoneCall",web:"startCall",sip:"startSIPCall",conference:"joinConference"};var callParams={};params.fromType=params.type||"web";var switchType=params.type;that.calls.every(function findCall(one){if(params.id&&one.id===params.id){call=one;return false}if(!params.id&&params.endpointId&&one.remoteEndpoint.id===params.endpointId){call=one;return false}return true});if(call||params.create!==true){return call}callParams.id=params.id;callParams.caller=false;callParams.fromType="web";callParams.callerId=params.callerId;callParams.target=params.target;if(params.target==="conference"){callParams.id=params.conferenceId;switchType=params.target}else if(params.target==="screenshare"){switchType=params.target}switch(switchType){case"screenshare":case"web":callParams.toType="web";callParams.endpointId=params.endpointId;break;case"did":callParams.number=params.endpointId;callParams.toType="did";break;case"sip":callParams.uri=params.endpointId;callParams.toType="sip";break}try{call=that[methods[params.type]](callParams)}catch(e){log.error("Couldn't create Call.",e.message,e.stack)}return call};function addCall(evt){log.debug("addCall");if(!evt.call){throw new Error("Can't add call without a call parameter.")}if(that.calls.indexOf(evt.call)===-1){that.calls.push(evt.call)}evt.call.listen("hangup",function(){removeCall({call:evt.call})})}function removeCall(evt){var match=0;if(!evt.call){throw new Error("Can't remove call without a call parameter.")}for(var i=that.calls.length-1;i>=0;i-=1){if(that.calls[i].id===evt.call.id){that.calls.splice(i,1);match+=1}}if(match!==1){log.warn("Something went wrong.",match,"calls were removed!")}}that.setOnline=function(params){var promise;params=params||{};params.presence=params.presence||"available";try{that.verifyConnected()}catch(e){promise=Q.reject(e);return respoke.handlePromise(promise,params.onSuccess,params.onError)}return that.setPresence(params)};that.setOffline=function(params){var promise;params=params||{};params.presence=params.presence||"unavailable";try{that.verifyConnected()}catch(e){promise=Q.reject(e);return respoke.handlePromise(promise,params.onSuccess,params.onError)}return that.setPresence(params)};that.sendMessage=function(params){var promise;var retVal;var endpoint;try{that.verifyConnected();
}catch(e){promise=Q.reject(e);retVal=respoke.handlePromise(promise,params.onSuccess,params.onError);return retVal}endpoint=that.getEndpoint({skipPresence:true,id:params.endpointId});delete params.endpointId;return endpoint.sendMessage(params)};that.joinConference=function(params){var conference=null;var recipient;params=params||{};params.open=!!params.open;that.verifyConnected();if(!params.id){params.id=respoke.makeGUID()}recipient={id:params.id};if(params.open){params.key=undefined}else if(!params.key){params.key=respoke.makeGUID()}params.instanceId=instanceId;params.target="conference";params.constraints=respoke.convertConstraints(params.constraints,[{video:false,audio:true,mandatory:{},optional:[]}]);params.signalOffer=function(signalParams){var onSuccess=signalParams.onSuccess;var onError=signalParams.onError;delete signalParams.onSuccess;delete signalParams.onError;signalParams.signalType="offer";signalParams.target=params.target;signalParams.id=params.id;signalParams.key=params.key;signalParams.open=params.open;signalParams.recipient=recipient;signalParams.toType="conference";signalingChannel.sendSDP(signalParams).done(onSuccess,onError)};params.signalAnswer=function(signalParams){var onSuccess=signalParams.onSuccess;var onError=signalParams.onError;delete signalParams.onSuccess;delete signalParams.onError;signalParams.signalType="answer";signalParams.target=params.target;signalParams.recipient=recipient;signalParams.sessionId=signalParams.call.sessionId;signalParams.toType="conference";signalingChannel.sendSDP(signalParams).then(onSuccess,onError).done(null,function errorHandler(err){signalParams.call.hangup({signal:false})})};params.signalConnected=function(signalParams){signalParams.target=params.target;signalParams.connectionId=signalParams.call.connectionId;signalParams.sessionId=signalParams.call.sessionId;signalParams.recipient=recipient;signalParams.toType="conference";signalingChannel.sendConnected(signalParams).done(null,function errorHandler(err){signalParams.call.hangup()})};params.signalModify=function(signalParams){signalParams.target=params.target;signalParams.recipient=recipient;signalParams.sessionId=signalParams.call.sessionId;signalParams.toType="conference";signalingChannel.sendModify(signalParams).done()};params.signalCandidate=function(signalParams){signalParams.target=params.target;signalParams.recipient=recipient;signalParams.sessionId=signalParams.call.sessionId;signalParams.toType="conference";return signalingChannel.sendCandidate(signalParams)};params.signalHangup=function(signalParams){signalParams.target=params.target;signalParams.recipient=recipient;signalParams.sessionId=signalParams.call.sessionId;signalParams.toType="conference";signalingChannel.sendHangup(signalParams).done()};params.signalReport=function(signalParams){log.debug("Sending debug report",signalParams.report);signalingChannel.sendReport(signalParams).done()};params.signalingChannel=signalingChannel;conference=respoke.Conference(params);addCall({call:conference.call});return conference};that.startScreenShare=function(params){that.verifyConnected();var endpoint=that.getEndpoint({skipPresence:true,id:params.endpointId});delete params.endpointId;return endpoint.startScreenShare(params)};that.startCall=function(params){that.verifyConnected();var endpoint=that.getEndpoint({skipPresence:true,id:params.endpointId});delete params.endpointId;return endpoint.startCall(params)};that.startAudioCall=function(params){that.verifyConnected();var endpoint=that.getEndpoint({skipPresence:true,id:params.endpointId});delete params.endpointId;return endpoint.startAudioCall(params)};that.startVideoCall=function(params){that.verifyConnected();var endpoint=that.getEndpoint({skipPresence:true,id:params.endpointId});delete params.endpointId;return endpoint.startVideoCall(params)};that.startPhoneCall=function(params){var promise;var call=null;var recipient={};params=params||{};params.constraints=[{video:false,audio:true,mandatory:{},optional:[]}];that.verifyConnected();if(!params.number){throw new Error("Can't start a phone call without a number.")}if(typeof params.caller!=="boolean"){params.caller=true}recipient.id=params.number;params.instanceId=instanceId;params.remoteEndpoint=recipient;params.toType=params.toType||"did";params.fromType=params.fromType||"web";params.signalOffer=function(signalParams){var onSuccess=signalParams.onSuccess;var onError=signalParams.onError;delete signalParams.onSuccess;delete signalParams.onError;signalParams.signalType="offer";signalParams.target="call";signalParams.recipient=recipient;signalParams.toType=params.toType;signalParams.fromType=params.fromType;if(params.hasOwnProperty("callerId")){signalParams.callerId={number:params.callerId}}signalingChannel.sendSDP(signalParams).done(onSuccess,onError)};params.signalAnswer=function(signalParams){var onSuccess=signalParams.onSuccess;var onError=signalParams.onError;delete signalParams.onSuccess;delete signalParams.onError;signalParams.signalType="answer";signalParams.target="call";signalParams.recipient=recipient;signalParams.toType=params.toType;signalParams.fromType=params.fromType;signalingChannel.sendSDP(signalParams).then(onSuccess,onError).done(null,function errorHandler(err){log.error("Couldn't answer the call.",err.message,err.stack);signalParams.call.hangup({signal:false})})};params.signalConnected=function(signalParams){signalParams.target="call";signalParams.connectionId=signalParams.connectionId;signalParams.recipient=recipient;signalParams.toType=params.toType;signalParams.fromType=params.fromType;signalingChannel.sendConnected(signalParams).done(null,function errorHandler(err){log.error("Couldn't send connected.",err.message,err.stack);signalParams.call.hangup()})};params.signalModify=function(signalParams){signalParams.target="call";signalParams.recipient=recipient;signalParams.toType=params.toType;signalParams.fromType=params.fromType;signalingChannel.sendModify(signalParams).done(null,function errorHandler(err){log.error("Couldn't send modify.",err.message,err.stack)})};params.signalCandidate=function(signalParams){signalParams.target="call";signalParams.recipient=recipient;signalParams.toType=params.toType;signalParams.fromType=params.fromType;return signalingChannel.sendCandidate(signalParams)};params.signalHangup=function(signalParams){signalParams.target="call";signalParams.recipient=recipient;signalParams.toType=params.toType;signalParams.fromType=params.fromType;signalingChannel.sendHangup(signalParams).done(null,function errorHandler(err){log.error("Couldn't send hangup.",err.message,err.stack)})};params.signalReport=function(signalParams){log.debug("Sending debug report",signalParams.report);signalingChannel.sendReport(signalParams)};params.signalingChannel=signalingChannel;call=respoke.Call(params);addCall({call:call});return call};that.startSIPCall=function(params){var promise;var call=null;var recipient={};params=params||{};params.constraints=[{video:false,audio:true,mandatory:{},optional:[]}];that.verifyConnected();if(!params.uri&&!(params.trunk&&params.user)){throw new Error("Can't start a phone call without a SIP URI or a SIP trunk and user.")}if(typeof params.caller!=="boolean"){params.caller=true}params.uri=params.uri||params.trunk+"/"+params.user;recipient.id=params.uri;params.instanceId=instanceId;params.remoteEndpoint=recipient;params.toType=params.toType||"sip";params.fromType=params.fromType||"web";params.signalOffer=function(signalParams){var onSuccess=signalParams.onSuccess;var onError=signalParams.onError;delete signalParams.onSuccess;delete signalParams.onError;signalParams.signalType="offer";signalParams.target="call";signalParams.recipient=recipient;signalParams.toType=params.toType;signalParams.fromType=params.fromType;if(params.hasOwnProperty("callerId")){signalParams.callerId=params.callerId}signalingChannel.sendSDP(signalParams).done(onSuccess,onError)};params.signalAnswer=function(signalParams){var onSuccess=signalParams.onSuccess;var onError=signalParams.onError;delete signalParams.onSuccess;delete signalParams.onError;signalParams.signalType="answer";signalParams.target="call";signalParams.recipient=recipient;signalParams.toType=params.toType;signalParams.fromType=params.fromType;signalingChannel.sendSDP(signalParams).then(onSuccess,onError).done(null,function errorHandler(err){log.error("Couldn't answer the call.",err.message,err.stack);signalParams.call.hangup({signal:false})})};params.signalConnected=function(signalParams){signalParams.target="call";signalParams.connectionId=signalParams.connectionId;signalParams.recipient=recipient;signalParams.toType=params.toType;signalParams.fromType=params.fromType;signalingChannel.sendConnected(signalParams).done(null,function errorHandler(err){log.error("Couldn't send connected.",err.message,err.stack);signalParams.call.hangup()})};params.signalModify=function(signalParams){signalParams.target="call";signalParams.recipient=recipient;signalParams.toType=params.toType;signalParams.fromType=params.fromType;signalingChannel.sendModify(signalParams).done(null,function errorHandler(err){log.error("Couldn't send modify.",err.message,err.stack)})};params.signalCandidate=function(signalParams){signalParams.target="call";signalParams.recipient=recipient;signalParams.toType=params.toType;signalParams.fromType=params.fromType;return signalingChannel.sendCandidate(signalParams)};params.signalHangup=function(signalParams){signalParams.target="call";signalParams.recipient=recipient;signalParams.toType=params.toType;signalParams.fromType=params.fromType;signalingChannel.sendHangup(signalParams).done(null,function errorHandler(err){log.error("Couldn't send hangup.",err.message,err.stack)})};params.signalReport=function(signalParams){log.debug("Sending debug report",signalParams.report);signalingChannel.sendReport(signalParams)};params.signalingChannel=signalingChannel;call=respoke.Call(params);addCall({call:call});return call};that.verifyConnected=function(){if(!signalingChannel.isConnected()){throw new Error("Can't complete request when not connected. Please reconnect!")}};that.isConnected=function(){return signalingChannel.isConnected()};that.join=function(params){var deferred=Q.defer();var retVal=respoke.handlePromise(deferred.promise,params.onSuccess,params.onError);try{that.verifyConnected()}catch(e){deferred.reject(e);return retVal}if(!params.id){deferred.reject(new Error("Can't join a group with no group id."));return retVal}log.trace("requested to join group",params.id);signalingChannel.joinGroup({groupList:[params.id]}).done(function successHandler(){var group;params.signalingChannel=signalingChannel;params.instanceId=instanceId;group=that.getGroup({id:params.id});if(!group){group=respoke.Group(params);that.addGroup(group)}group.listen("join",params.onJoin);group.listen("leave",params.onLeave);group.listen("message",params.onMessage);group.addMember({connection:that.getConnection({endpointId:that.endpointId,connectionId:that.connectionId})});that.fire("join",{group:group});deferred.resolve(group)},function errorHandler(err){deferred.reject(err)});return retVal};that.addGroup=function(newGroup){if(!newGroup||newGroup.className!=="respoke.Group"){throw new Error("Can't add group to internal tracking without a group.")}newGroup.listen("leave",function leaveHandler(evt){var endpointThatLeft=evt.connection.getEndpoint();if(!endpointThatLeft.hasListeners("presence")&&endpointThatLeft.groupConnectionCount===0){endpoints.every(function eachEndpoint(ept,index){if(ept.id===endpointThatLeft.id){endpoints.splice(index,1);return false}return true})}},true);groups.push(newGroup)};that.getGroups=function(){return groups};that.getGroup=function(params){var group;if(!params||!params.id){throw new Error("Can't get a group without group id.")}groups.every(function eachGroup(grp){if(grp.id===params.id){group=grp;return false}return true});if(group){group.listen("join",params.onJoin);group.listen("leave",params.onLeave);group.listen("message",params.onMessage)}return group};that.getEndpoint=function(params){var endpoint;if(!params||!params.id){throw new Error("Can't get an endpoint without endpoint id.")}endpoints.every(function eachEndpoint(ept){if(ept.id===params.id){endpoint=ept;return false}return true});if(!endpoint&&params&&!params.skipCreate){params.instanceId=instanceId;params.signalingChannel=signalingChannel;params.resolveEndpointPresence=clientSettings.resolveEndpointPresence;params.addCall=addCall;endpoint=respoke.Endpoint(params);endpoints.push(endpoint)}if(!endpoint){return}if(params.skipPresence!==true){signalingChannel.registerPresence({endpointList:[endpoint.id]}).done(null,function(err){log.error("Couldn't register for presence on",endpoint.id,err.message)})}endpoint.listen("presence",params.onPresence);endpoint.listen("message",params.onMessage);return endpoint};that.getConnection=function(params){var connection;var endpoint;var endpointsToSearch=endpoints;params=params||{};if(!params.connectionId){throw new Error("Can't get a connection without connection id.")}if(!params.endpointId&&!params.skipCreate){throw new Error("Can't create a connection without endpoint id.")}if(params.endpointId){endpoint=that.getEndpoint({id:params.endpointId,skipPresence:true,skipCreate:params.skipCreate});endpointsToSearch=[];if(endpoint){endpointsToSearch=[endpoint]}}endpointsToSearch.every(function eachEndpoint(ept){connection=ept.getConnection(params);return!connection});if(!connection&&!params.skipCreate){params.instanceId=instanceId;connection=respoke.Connection(params);endpoint.connections.push(connection)}return connection};that.getEndpoints=function(){return endpoints};that.getConferenceParticipants=signalingChannel.getConferenceParticipants;return that}},function(module,exports,__webpack_require__){var respoke=__webpack_require__(1);module.exports=function(params){"use strict";params=params||{};var instanceId=params.instanceId;var that=respoke.EventEmitter(params);var client=respoke.getClient(instanceId);that.id=that.id||that.connectionId;if(!that.id){throw new Error("Can't make a connection without an id.")}delete that.instanceId;delete that.connectionId;that.className="respoke.Connection";that.presence="unavailable";that.getPresence=function(){return that.presence};that.sendMessage=function(params){params=params||{};params.connectionId=that.id;params.ccSelf=typeof params.ccSelf==="boolean"?params.ccSelf:false;return that.getEndpoint().sendMessage(params)};that.startScreenShare=function(params){client.verifyConnected();params.connectionId=that.id;return that.getEndpoint().startScreenShare(params)};that.startCall=function(params){params=params||{};params.connectionId=that.id;return that.getEndpoint().startCall(params)};that.startAudioCall=function(params){client.verifyConnected();params.connectionId=that.id;return that.getEndpoint().startAudioCall(params)};that.startVideoCall=function(params){client.verifyConnected();params.connectionId=that.id;return that.getEndpoint().startVideoCall(params)};that.startDirectConnection=function(params){var retVal;var deferred;params=params||{};try{client.verifyConnected()}catch(err){deferred=respoke.Q.defer();retVal=respoke.handlePromise(deferred.promise,params.onSuccess,params.onError);deferred.reject(err);return retVal}params.connectionId=that.id;return that.getEndpoint().startDirectConnection(params)};that.getEndpoint=function(){return client.getEndpoint({id:that.endpointId,skipPresence:true})};return that}},function(module,exports,__webpack_require__){var Q=__webpack_require__(6);var respoke=__webpack_require__(1);var log=respoke.log;module.exports=function(params){"use strict";params=params||{};var instanceId=params.instanceId;var that=respoke.EventEmitter(params);var client=respoke.getClient(instanceId);var signalingChannel=params.signalingChannel;that.groupConnectionCount=0;var addCall=params.addCall;delete that.signalingChannel;delete that.instanceId;delete that.connectionId;delete that.addCall;that.className="respoke.Endpoint";that.directConnection=null;that.connections=[];client.listen("disconnect",function disconnectHandler(){that.connections=[]});var resolveEndpointPresence=params.resolveEndpointPresence;delete that.resolveEndpointPresence;that.presence="unavailable";that.getPresence=function(){return that.presence};that.setPresence=function(params){var connection;params=params||{};params.presence=params.presence||"available";params.connectionId=params.connectionId||that.connectionId;if(!params.connectionId){throw new Error("Can't set Endpoint presence without a connectionId.")}connection=that.getConnection({connectionId:params.connectionId})||client.getConnection({connectionId:params.connectionId,skipCreate:false,endpointId:that.id});connection.presence=params.presence;that.resolvePresence();that.fire("presence",{presence:that.presence})};that.sendMessage=function(params){var promise;var retVal;params=params||{};params.ccSelf=typeof params.ccSelf==="boolean"?params.ccSelf:true;promise=signalingChannel.sendMessage({ccSelf:params.ccSelf,connectionId:params.connectionId,message:params.message,push:!!params.push,recipient:that});retVal=respoke.handlePromise(promise,params.onSuccess,params.onError);return retVal};that.startAudioCall=function(params){params=params||{};params.constraints=respoke.convertConstraints(params.constraints,[{video:false,audio:true,optional:[],mandatory:{}}]);return that.startCall(params)};that.startVideoCall=function(params){params=params||{};params.constraints=respoke.convertConstraints(params.constraints,[{video:true,audio:true,optional:[],mandatory:{}}]);return that.startCall(params)};that.startScreenShare=function(params){params=params||{};var hasAudio;var addAudio;params.target="screenshare";if(typeof params.caller!=="boolean"){params.caller=true}params.sendOnly=params.caller&&(params.sendOnly||params.sendOnly===undefined);addAudio=!params.sendOnly&&(!params.screenConstraints||params.screenConstraints&&params.screenConstraints.audio);if(params.caller){params.constraints=respoke.convertConstraints(params.constraints);params.constraints.push(respoke.getScreenShareConstraints({constraints:params.screenConstraints}));delete params.screenConstraints;params.constraints.forEach(function(con){if(con.audio){hasAudio=true}});if(addAudio&&!hasAudio){params.constraints.push({audio:true,video:false})}}return that.startCall(params)};that.startCall=function(params){var call=null;params=params||{};params.constraints=respoke.convertConstraints(params.constraints,[{video:true,audio:true,mandatory:{},optional:[]}]);if(params.target!=="screenshare"&&params.constraints[0]&&respoke.constraintsHasScreenShare(params.constraints[0])){return that.startScreenShare(params)}params.target=params.target||"call";log.debug("Endpoint.call",params);client.verifyConnected();if(typeof params.caller!=="boolean"){params.caller=true}if(!that.id){log.error("Can't start a call without endpoint ID!");return}params.instanceId=instanceId;params.remoteEndpoint=that;params.signalOffer=function(signalParams){var onSuccess=signalParams.onSuccess;var onError=signalParams.onError;delete signalParams.onSuccess;delete signalParams.onError;signalParams.signalType="offer";signalParams.target=params.target;signalParams.recipient=that;signalingChannel.sendSDP(signalParams).done(onSuccess,onError)};params.signalAnswer=function(signalParams){var onSuccess=signalParams.onSuccess;var onError=signalParams.onError;delete signalParams.onSuccess;delete signalParams.onError;signalParams.signalType="answer";signalParams.target=params.target;signalParams.recipient=that;signalParams.sessionId=signalParams.call.sessionId;signalingChannel.sendSDP(signalParams).then(onSuccess,onError).done(null,function errorHandler(err){signalParams.call.hangup({signal:false})})};params.signalConnected=function(signalParams){signalParams.target=params.target;signalParams.connectionId=signalParams.call.connectionId;signalParams.sessionId=signalParams.call.sessionId;signalParams.recipient=that;signalingChannel.sendConnected(signalParams).done(null,function errorHandler(err){signalParams.call.hangup()})};params.signalModify=function(signalParams){signalParams.target=params.target;signalParams.recipient=that;signalParams.sessionId=signalParams.call.sessionId;signalingChannel.sendModify(signalParams).done()};params.signalCandidate=function(signalParams){signalParams.target=params.target;signalParams.recipient=that;signalParams.sessionId=signalParams.call.sessionId;return signalingChannel.sendCandidate(signalParams)};params.signalHangup=function(signalParams){signalParams.target=params.target;signalParams.recipient=that;signalParams.sessionId=signalParams.call.sessionId;signalingChannel.sendHangup(signalParams).done()};params.signalReport=function(signalParams){log.debug("Sending debug report",signalParams.report);signalingChannel.sendReport(signalParams).done()};params.signalingChannel=signalingChannel;call=respoke.Call(params);addCall({call:call});return call};that.startDirectConnection=function(params){params=params||{};var deferred=Q.defer();var retVal=respoke.handlePromise(deferred.promise,params.onSuccess,params.onError);var call;try{client.verifyConnected()}catch(err){deferred.reject(err);return retVal}if(that.directConnection||params.create===false){deferred.resolve(that.directConnection);return retVal}if(typeof params.caller!=="boolean"){params.caller=true}if(!that.id){deferred.reject(new Error("Can't start a direct connection without endpoint ID!"));return retVal}params.instanceId=instanceId;params.remoteEndpoint=that;params.signalOffer=function(signalParams){var onSuccess=signalParams.onSuccess;var onError=signalParams.onError;delete signalParams.onSuccess;delete signalParams.onError;signalParams.signalType="offer";signalParams.target="directConnection";signalParams.recipient=that;signalingChannel.sendSDP(signalParams).done(onSuccess,onError)};params.signalConnected=function(signalParams){signalParams.target="directConnection";signalParams.recipient=that;signalingChannel.sendConnected(signalParams).done(null,function errorHandler(err){signalParams.call.hangup()})};params.signalAnswer=function(signalParams){var onSuccess=signalParams.onSuccess;var onError=signalParams.onError;delete signalParams.onSuccess;delete signalParams.onError;signalParams.target="directConnection";signalParams.recipient=that;signalParams.signalType="answer";signalingChannel.sendSDP(signalParams).then(onSuccess,onError).done(null,function errorHandler(err){signalParams.call.hangup({signal:false})})};params.signalCandidate=function(signalParams){signalParams.target="directConnection";signalParams.recipient=that;return signalingChannel.sendCandidate(signalParams)};params.signalHangup=function(signalParams){signalParams.target="directConnection";signalParams.recipient=that;signalingChannel.sendHangup(signalParams).done()};params.signalReport=function(signalParams){signalParams.report.target="directConnection";log.debug("Not sending report");log.debug(signalParams.report)};params.needDirectConnection=true;params.offerOptions={mandatory:{OfferToReceiveAudio:false}};params.signalingChannel=signalingChannel;call=respoke.Call(params);addCall({call:call});call.listen("direct-connection",function directConnectionHandler(evt){that.directConnection=evt.directConnection;if(params.caller!==true){if(!client.hasListeners("direct-connection")&&!client.hasListeners("direct-connection")&&!call.hasListeners("direct-connection")){that.directConnection.reject();deferred.reject(new Error("Got an incoming direct connection with no handlers to accept it!"));return}deferred.resolve(that.directConnection);that.directConnection.listen("close",function closeHandler(evt){that.directConnection=undefined},true)}},true);return retVal};that.resolvePresence=function(){var presenceList=that.connections.map(function(connection){return connection.presence});if(resolveEndpointPresence!==undefined){that.presence=resolveEndpointPresence(presenceList)}else{var options=["chat","available","away","dnd","xa","unavailable"];var idList;idList=that.connections.sort(function sorter(a,b){var indexA=options.indexOf(a.presence);var indexB=options.indexOf(b.presence);indexA=indexA===-1?1e3:indexA;indexB=indexB===-1?1e3:indexB;return indexA<indexB?-1:indexB<indexA?1:0});if(idList[0]){that.presence=idList[0].presence}else{that.presence="unavailable"}}};that.getConnection=function(params){var connection=null;params=params||{};if(that.connections.length===1&&(!params.connectionId||that.connections[0]===params.connectionId)){return that.connections[0]}if(!params||!params.connectionId){throw new Error("Can't find a connection without the connectionId.")}that.connections.every(function eachConnection(conn){if(conn.id===params.connectionId){connection=conn;return false}return true});return connection};that.joinedGroup=function(){++that.groupConnectionCount};that.leftGroup=function(){--that.groupConnectionCount};return that}},function(module,exports){module.exports=function(params){"use strict";params=params||{};var that={};function parse(){if(params.rawMessage){try{that.endpointId=params.rawMessage.header.from;that.originalRecipient=params.rawMessage.header.toOriginal;that.connectionId=params.rawMessage.header.fromConnection;that.timestamp=params.rawMessage.header.timestamp}catch(e){throw new Error(e)}that.message=params.rawMessage.message||params.rawMessage.body;if(params.rawMessage.header.channel){that.recipient=params.rawMessage.header.channel}}else{try{that.to=params.endpointId;that.ccSelf=params.ccSelf;that.toConnection=params.connectionId;that.requestConnectionReply=params.requestConnectionReply===true;that.push=params.push===true}catch(e){throw new Error(e)}that.message=params.message}}parse();return that}},function(module,exports){module.exports=function(params){"use strict";params=params||{};var that={};var required=["recipient","signalType","sessionId","target","signalId"];var allowed=["signalType","sessionId","sessionDescription","iceCandidates","offering","target","signalId","callerId","requesting","reason","error","status","connectionId","version","finalCandidates"];params.version="1.0";function parse(){if(params.rawMessage){try{that=JSON.parse(params.rawMessage.body)}catch(e){that=params.rawMessage.body}that.fromType=params.rawMessage.header.fromType;that.fromEndpoint=params.rawMessage.header.from;that.fromConnection=params.rawMessage.header.fromConnection;that.timestamp=params.rawMessage.header.timestamp;if(!that.target){that.target="call"}}else{required.forEach(function eachAttr(attr){if(params[attr]===0||!params[attr]){throw new Error("Can't build a signaling without "+attr)}});allowed.forEach(function eachAttr(attr){if(params[attr]===0||params[attr]){that[attr]=params[attr]}})}}parse();return that}},function(module,exports,__webpack_require__){var Q=__webpack_require__(6);var respoke=__webpack_require__(1);module.exports=function(params){"use strict";params=params||{};var that=respoke.EventEmitter(params);var instanceId=params.instanceId;var client=respoke.getClient(instanceId);if(!that.id){throw new Error("Can't create a group without an ID.")}var cacheIsValid=false;var signalingChannel=params.signalingChannel;delete params.signalingChannel;that.connections=[];that.className="respoke.Group";that.listen("join",params.onJoin);that.listen("message",params.onMessage);that.listen("leave",params.onLeave);function clearConnections(){that.connections.forEach(function(connection){connection.getEndpoint().leftGroup()});that.connections=[]}client.listen("disconnect",function disconnectHandler(){cacheIsValid=false;clearConnections()},true);delete that.instanceId;delete that.onMessage;delete that.onPresence;delete that.onJoin;delete that.onLeave;that.join=function(){var params={id:that.id};var promise;var deferred;var retVal;cacheIsValid=false;try{validateConnection()}catch(err){deferred=Q.defer();retVal=respoke.handlePromise(deferred.promise,params.onSuccess,params.onError);deferred.reject(err);return retVal}promise=client.join(params);retVal=respoke.handlePromise(promise,params.onSuccess,params.onError);return retVal};that.leave=function(params){params=params||{};var deferred=Q.defer();var retVal=respoke.handlePromise(deferred.promise,params.onSuccess,params.onError);try{validateConnection();validateMembership()}catch(err){deferred.reject(err);return retVal}signalingChannel.leaveGroup({groupList:[that.id]}).done(function successHandler(){clearConnections();deferred.resolve();cacheIsValid=false;client.fire("leave",{group:that})},function errorHandler(err){deferred.reject()});return retVal};that.removeMember=function(params){params=params||{};try{validateConnection();validateMembership()}catch(err){return}if(!params.connectionId){throw new Error("Can't remove a member to the group without it's Connection id.")}cacheIsValid=false;that.connections.every(function eachConnection(conn,index){if(conn.id===params.connectionId){that.connections.splice(index,1);conn.getEndpoint().leftGroup();that.fire("leave",{connection:conn});return false}return true})};that.isJoined=function(){return that.connections.length>0&&!that.connections.every(function(conn){return conn.id!==client.connectionId})};that.addMember=function(params){params=params||{};var absent;validateConnection();if(!params.connection){throw new Error("Can't add a member to the group without it's Connection object.")}cacheIsValid=false;absent=that.connections.every(function eachConnection(conn){return conn.id!==params.connection.id});if(absent){that.connections.push(params.connection);params.connection.getEndpoint().joinedGroup();if(params.skipEvent){return}that.fire("join",{connection:params.connection})}};function validateConnection(){if(!signalingChannel||!signalingChannel.isConnected()){throw new Error("Can't complete request when not connected. Please reconnect!")}}function validateMembership(){if(!that.isJoined()){throw new Error("Not a member of this group anymore.")}}that.sendMessage=function(params){params=params||{};params.id=that.id;var promise;try{validateConnection();validateMembership()}catch(err){promise=Q.reject(err)}return respoke.handlePromise(promise?promise:signalingChannel.publish(params),params.onSuccess,params.onError)};that.getMembers=function(params){params=params||{};var deferred=Q.defer();var retVal=respoke.handlePromise(deferred.promise,params.onSuccess,params.onError);try{validateConnection();validateMembership()}catch(err){deferred.reject(err);return retVal}if(that.connections.length>0&&cacheIsValid){deferred.resolve(that.connections);return retVal}signalingChannel.getGroupMembers({id:that.id}).done(function successHandler(list){var endpointList=[];list.forEach(function eachMember(params){var connection=client.getConnection({endpointId:params.endpointId,connectionId:params.connectionId,skipCreate:true});if(!connection){connection=client.getConnection({endpointId:params.endpointId,connectionId:params.connectionId})}if(endpointList.indexOf(params.endpointId)===-1){endpointList.push(params.endpointId)}that.addMember({connection:connection,skipEvent:true})});cacheIsValid=true;deferred.resolve(that.connections)},function errorHandler(err){deferred.reject(err)});return retVal};that.joinConference=function(params){var conference=null;params=params||{};params.id=that.id;conference=client.joinConference(params);return conference};return that}},function(module,exports,__webpack_require__){"use strict";var Q=__webpack_require__(6);var io=__webpack_require__(14);var respoke=__webpack_require__(1);var template=__webpack_require__(16);var log=respoke.log;var sdkHeaderValue="Respoke.js/"+respoke.version;var billingSuspensionErrorMessage="Can't perform this action: Not Authorized. Your account is suspended due to a "+"billing issue. Please visit the Respoke Developer Portal (https://www.respoke.io) or contact customer support "+"(support@respoke.io) to address this issue.";var suspensionErrorMessage="Canot perform this action: Not Authorized. Your account is suspended. Please visit "+"the Respoke Developer Portal (https://www.respoke.io) or contact customer support (support@respoke.io) to "+"address this issue.";
var now;if(window.performance&&window.performance.now){now=window.performance.now.bind(window.performance)}else if(Date.now){now=Date.now.bind(Date)}else{now=function(){return(new Date).getTime()}}var PendingRequests=function(){var contents=[];var counter=0;var that={};that.add=function(obj){contents[counter]=obj;counter++;return counter};that.remove=function(key){delete contents[key]};that.reset=function(fn){if(fn){contents.forEach(fn)}contents=[]};return that};module.exports=function(params){params=params||{};var instanceId=params.instanceId;var that=respoke.EventEmitter(params);delete that.instanceId;that.className="respoke.SignalingChannel";var client=respoke.getClient(instanceId);var socket=null;var clientSettings=params.clientSettings;delete that.clientSettings;clientSettings.baseURL=clientSettings.baseURL||"https://api.respoke.io";var presenceRegistered={};var actuallyConnect=null;var pendingRequests=PendingRequests();var reconnectTimeout=null;var maxReconnectTimeout=5*60*1e3;var bodySizeLimit=2e4;var appId=null;var endpointId=null;var token=null;var appToken=null;var xhr=new XMLHttpRequest;var routingMethods={};var handlerQueue={message:[],signal:[],presence:[]};var errors={400:"Can't perform this action: missing or invalid parameters.",401:"Can't perform this action: not authenticated.",403:"Can't perform this action: not authorized.",404:"Item not found.",409:"Can't perform this action: item in the wrong state.",429:"API rate limit was exceeded.",500:"Can't perform this action: server problem."};that.isConnected=function(){return!!(socket&&socket.socket.connected)};function isConnecting(){return!!(socket&&socket.socket.connecting)}that.isSendingReport=function(params){return clientSettings.enableCallDebugReport};that.open=function(params){params=params||{};var deferred=Q.defer();log.debug("SignalingChannel.open",params,clientSettings);token=params.token||token;actuallyConnect=typeof params.actuallyConnect==="function"?params.actuallyConnect:actuallyConnect;Q.fcall(function tokenPromise(){if(clientSettings.developmentMode===true&&clientSettings.appId&&params.endpointId){return that.getToken({appId:clientSettings.appId,endpointId:params.endpointId})}return null}).then(function successHandler(newToken){token=newToken||token;return doOpen({token:token})}).done(function successHandler(){deferred.resolve();log.debug("client",client)},function errorHandler(err){deferred.reject(err)});return deferred.promise};that.getToken=function(params){params=params||{};var deferred=Q.defer();log.debug("SignalingChannel.getToken",params);var callParams={path:"/v1/tokens",httpMethod:"POST",parameters:{appId:clientSettings.appId,endpointId:params.endpointId,ttl:60*60*6}};call(callParams).done(function(response){if(response.statusCode===200&&response.body&&response.body.tokenId){token=response.body.tokenId;deferred.resolve(response.body.tokenId);return}var errorMessage="Couldn't get a developer mode token. ";if(isBillingSuspensionUnauthorizedResponse(response)){errorMessage+=billingSuspensionErrorMessage}else if(isSuspensionUnauthorizedResponse(response)){errorMessage+=suspensionErrorMessage}else{errorMessage+=response.error}deferred.reject(buildResponseError(response,errorMessage))},function(err){deferred.reject(new Error("Couldn't get a developer mode token. "+err.message))});return deferred.promise};function doOpen(params){params=params||{};var deferred=Q.defer();log.debug("SignalingChannel.doOpen",params);if(!params.token){deferred.reject(new Error("Can't open connection to Respoke without a token."));return deferred.promise}call({path:"/v1/session-tokens",httpMethod:"POST",parameters:{tokenId:params.token}}).done(function(response){if(response.statusCode===200){appToken=response.body.token;deferred.resolve();log.debug("Signaling connection open to",clientSettings.baseURL);return}var errorMessage="Couldn't authenticate app. ";if(isBillingSuspensionUnauthorizedResponse(response)){errorMessage+=billingSuspensionErrorMessage}else if(isSuspensionUnauthorizedResponse(response)){errorMessage+=suspensionErrorMessage}else{errorMessage+=response.error}deferred.reject(buildResponseError(response,errorMessage))},function(err){log.error("Network call failed:",err.message);deferred.reject(new Error("Couldn't authenticate app. "+err.message))});return deferred.promise}that.close=function(){var deferred=Q.defer();wsCall({path:"/v1/connections/{id}/",httpMethod:"DELETE",urlParams:{id:client.endpointId}}).fin(function finallyHandler(){return call({path:"/v1/session-tokens",httpMethod:"DELETE"})}).fin(function finallyHandler(){if(socket){socket.removeAllListeners();socket.disconnect()}socket=null;deferred.resolve()}).done();return deferred.promise};that.sendPresence=function(params){params=params||{};var deferred=Q.defer();log.debug("Signaling sendPresence");if(!that.isConnected()){deferred.reject(new Error("Can't complete request when not connected. Please reconnect!"));return deferred.promise}wsCall({path:"/v1/presence",httpMethod:"POST",parameters:{presence:{show:params.show,status:params.status,type:params.presence||"available"}}}).done(function successHandler(){deferred.resolve()},function errorHandler(err){deferred.reject(err)});return deferred.promise};that.removeConferenceParticipant=function(params){params=params||{};var deferred=Q.defer();var endpointId=params.endpointId;if(!that.isConnected()){deferred.reject(new Error("Can't complete request when not connected. Please reconnect!"));return deferred.promise}if(!endpointId&&params.connectionId){try{endpointId=client.getConnection({connectionId:params.connectionId}).getEndpoint().id}catch(err){}if(!endpointId){deferred.reject(new Error("conference.removeParticipant can't figure out what endpoint to remove!"));return deferred.promise}}wsCall({httpMethod:"DELETE",path:"/v1/conferences/{id}/participants/{endpointId}",urlParams:{id:params.conferenceId,endpointId:endpointId},parameters:{connectionId:params.connectionId}}).then(function successHandler(){deferred.resolve()},function errorHandler(err){deferred.reject(err)});return deferred.promise};that.destroyConference=function(params){var deferred=Q.defer();if(!that.isConnected()){deferred.reject(new Error("Can't complete request when not connected. Please reconnect!"));return deferred.promise}wsCall({httpMethod:"DELETE",path:"/v1/conferences/{id}/",urlParams:{id:params.conferenceId}}).then(function successHandler(){deferred.resolve()},function errorHandler(err){deferred.reject(err)});return deferred.promise};that.getConferenceParticipants=function(params){params=params||{};var deferred=Q.defer();if(!that.isConnected()){deferred.reject(new Error("Can't complete request when not connected. Please reconnect!"));return deferred.promise}wsCall({httpMethod:"GET",path:"/v1/conferences/{id}/participants/",urlParams:{id:params.id}}).then(function successHandler(participants){deferred.resolve(participants.map(function(par){return client.getConnection({connectionId:par.connectionId,endpointId:par.endpointId})}))},function errorHandler(err){deferred.reject(err)});return deferred.promise};that.getGroup=function(params){params=params||{};var deferred=Q.defer();if(!that.isConnected()){deferred.reject(new Error("Can't complete request when not connected. Please reconnect!"));return deferred.promise}wsCall({httpMethod:"POST",path:"/v1/channels/",parameters:{name:params.name}}).then(function successHandler(group){deferred.resolve(group)},function errorHandler(err){deferred.resolve({id:params.name})});return deferred.promise};that.leaveGroup=function(){var groups={};var deferred=Q.defer();return function(params){params=params||{};params.groupList=params.groupList||[];var toRun=Object.keys(groups).length===0;if(!that.isConnected()){deferred.reject(new Error("Can't complete request when not connected. Please reconnect!"));return deferred.promise}params.groupList.forEach(function(id){if(typeof id==="string"){groups[id]=true}});if(!toRun){return deferred.promise}setTimeout(function(){var groupList=Object.keys(groups);groups={};var saveDeferred=deferred;deferred=Q.defer();if(groupList.length===0){saveDeferred.resolve();return}wsCall({path:"/v1/groups/",parameters:{groups:groupList},httpMethod:"DELETE"}).done(function successHandler(){saveDeferred.resolve()},function errorHandler(err){saveDeferred.reject(err)})});return deferred.promise}}();that.joinGroup=function(){var groups={};var deferred=Q.defer();return function actualJoinGroup(params){params=params||{};params.groupList=params.groupList||[];log.trace("been asked to join groups",params.groupList);var needsToRun=Object.keys(groups).length===0;if(!that.isConnected()){deferred.reject(new Error("Can't complete request when not connected. Please reconnect!"));return deferred.promise}params.groupList.forEach(function(id){if(typeof id==="string"){log.trace("put group",id,"in the join queue");groups[id]=true}});if(!needsToRun){return deferred.promise}setTimeout(function requestJoinsForGroupQueue(){var groupList=Object.keys(groups);log.trace("list of groups to be requested",groupList);groups={};var saveDeferred=deferred;deferred=Q.defer();if(groupList.length===0){log.trace("list of groups was empty so not sending queue");saveDeferred.resolve();return}wsCall({path:"/v1/groups/",parameters:{groups:groupList},httpMethod:"POST"}).done(function successHandler(){saveDeferred.resolve()},function errorHandler(err){saveDeferred.reject(err)})});return deferred.promise}}();that.publish=function(params){params=params||{};var deferred=Q.defer();var message=respoke.TextMessage({endpointId:params.id,message:params.message,push:!!params.push});if(!that.isConnected()){deferred.reject(new Error("Can't complete request when not connected. Please reconnect!"));return deferred.promise}wsCall({path:"/v1/channels/{id}/publish/",urlParams:{id:params.id},httpMethod:"POST",parameters:message}).done(function successHandler(){deferred.resolve()},function errorHandler(err){deferred.reject(err)});return deferred.promise};that.registerPresence=function(){var endpoints={};var deferred=Q.defer();return function(params){params=params||{};params.endpointList=params.endpointList||[];var toRun=Object.keys(endpoints).length===0;if(!that.isConnected()){return Q.reject(new Error("Can't complete request when not connected. Please reconnect!"))}params.endpointList.forEach(function(ep){if(typeof ep==="string"&&presenceRegistered[ep]!==true){endpoints[ep]=true}});if(!toRun){return deferred.promise}setTimeout(function(){var endpointList=Object.keys(endpoints);endpoints={};var saveDeferred=deferred;deferred=Q.defer();if(endpointList.length===0){saveDeferred.resolve();return}wsCall({httpMethod:"POST",path:"/v1/presenceobservers",parameters:{endpointList:endpointList}}).done(function successHandler(){params.endpointList.forEach(function eachId(id){presenceRegistered[id]=true});saveDeferred.resolve()},function(err){saveDeferred.reject(err)})});return deferred.promise}}();that.getGroupMembers=function(params){var deferred=Q.defer();if(!that.isConnected()){deferred.reject(new Error("Can't complete request when not connected. Please reconnect!"));return deferred.promise}if(!params.id){deferred.reject(new Error("Can't get group's endpoints without group ID."));return deferred.promise}return wsCall({path:"/v1/channels/{id}/subscribers/",urlParams:{id:params.id},httpMethod:"GET"})};that.sendMessage=function(params){params=params||{};var deferred=Q.defer();var message=respoke.TextMessage({endpointId:params.recipient.id,ccSelf:params.ccSelf,connectionId:params.connectionId,message:params.message,push:!!params.push});if(!that.isConnected()){deferred.reject(new Error("Can't complete request when not connected. Please reconnect!"));return deferred.promise}wsCall({path:"/v1/messages",httpMethod:"POST",parameters:message}).done(function successHandler(){deferred.resolve()},function errorHandler(err){deferred.reject(err)});return deferred.promise};that.sendACK=function(params){var endpoint;params=params||{};if(!that.isConnected()){return Q.reject(new Error("Can't complete request when not connected. Please reconnect!"))}if(!params.signal){return Q.reject(new Error("Can't send ACK, no signal was given."))}endpoint=client.getEndpoint({id:params.signal.fromEndpoint,skipPresence:true});if(!endpoint){return Q.reject(new Error("Can't send ACK, can't get endpoint."))}return that.sendSignal({recipient:endpoint,signalType:"ack",signalId:params.signal.signalId,sessionId:params.signal.sessionId,target:params.signal.target,ackedSignalType:params.signal.signalType})};that.sendSignal=function(params){params=params||{};var deferred=Q.defer();var signal;var to;var toConnection;var toType;if(!that.isConnected()){deferred.reject(new Error("Can't complete request when not connected. Please reconnect!"));return deferred.promise}if(params.call){params.sessionId=params.call.id;if(params.call.connectionId){params.connectionId=params.call.connectionId}}to=params.recipient.id;toConnection=params.connectionId;toType=params.toType||"web";try{params.signalId=respoke.makeGUID();signal=respoke.SignalingMessage(params)}catch(e){deferred.reject(e);return deferred.promise}wsCall({path:"/v1/signaling",httpMethod:"POST",parameters:{ccSelf:params.ccSelf,signal:JSON.stringify(signal),to:to,toConnection:toConnection,toType:toType}}).done(function successHandler(){deferred.resolve()},function errorHandler(err){deferred.reject(err)});return deferred.promise};that.sendCandidate=function(params){params=params||{};params.signalType="iceCandidates";if(!that.isConnected()){return Q.reject(new Error("Can't complete request when not connected. Please reconnect!"))}if(typeof params.finalCandidates!=="undefined"){log.debug("Sending final",params.iceCandidates.length,"of",params.finalCandidates.length,"ice candidates")}else{log.debug("Sending",params.iceCandidates.length,"ice candidates")}return that.sendSignal(params)};that.sendSDP=function(params){params=params||{};if(!that.isConnected()){return Q.reject(new Error("Can't complete request when not connected. Please reconnect!"))}if(["offer","answer"].indexOf(params.signalType)===-1){return Q.reject("Not an SDP type signal.")}return that.sendSignal(params)};that.sendReport=function(params){params=params||{};var deferred=Q.defer();var message={debugData:params};if(!clientSettings.enableCallDebugReport){log.debug("not sending call debugs - disabled");deferred.resolve();return deferred.promise}if(!that.isConnected()){deferred.reject(new Error("Can't complete request when not connected. Please reconnect!"));return deferred.promise}wsCall({path:"/v1/call-debugs",httpMethod:"POST",parameters:message}).done(function(){deferred.resolve()},function(err){deferred.reject(err)});return deferred.promise};that.sendHangup=function(params){params=params||{};params.signalType="bye";params.ccSelf=true;if(!that.isConnected()){return Q.reject(new Error("Can't complete request when not connected. Please reconnect!"))}return that.sendSignal(params)};that.sendConnected=function(params){params=params||{};params.signalType="connected";if(!that.isConnected()){return Q.reject(new Error("Can't complete request when not connected. Please reconnect!"))}return that.sendSignal(params)};that.sendModify=function(params){params=params||{};params.signalType="modify";if(["initiate","accept","reject"].indexOf(params.action)===-1){return Q.reject("No valid action in modify signal.")}if(!that.isConnected()){return Q.reject(new Error("Can't complete request when not connected. Please reconnect!"))}return that.sendSignal(params)};function firstUpper(str){return str[0].toUpperCase()+str.slice(1)}that.routeSignal=function(signal){var target=null;var method="do";if(signal.signalType!=="iceCandidates"||respoke.ridiculous){log.debug(signal.signalType,signal)}if(signal.target===undefined){throw new Error("target undefined")}Q.fcall(function makePromise(){var endpoint;target=client.getCall({id:signal.sessionId,endpointId:signal.toOriginal||signal.fromEndpoint,target:signal.target,conferenceId:signal.conferenceId,type:signal.fromType,create:signal.target!=="directConnection"&&signal.signalType==="offer",callerId:signal.callerId});if(target){return target}if(signal.target==="directConnection"){endpoint=client.getEndpoint({id:signal.fromEndpoint,skipPresence:true});if(endpoint.directConnection&&endpoint.directConnection.call.id===signal.sessionId){return endpoint.directConnection}return endpoint.startDirectConnection({id:signal.sessionId,create:signal.signalType==="offer",caller:signal.signalType!=="offer"})}}).done(function successHandler(target){if(target){target=target.call||target}if(!target||target.id!==signal.sessionId){log.warn("Couldn't associate signal with a call. This is usually OK.",signal);return}method+=firstUpper(signal.signalType);routingMethods[method]({call:target,signal:signal})},null)};routingMethods.doOffer=function(params){params.call.connectionId=params.signal.fromConnection;params.call.fire("signal-offer",{signal:params.signal})};routingMethods.doConnected=function(params){params.call.fire("signal-connected",{signal:params.signal})};routingMethods.doModify=function(params){params.call.fire("signal-modify",{signal:params.signal})};routingMethods.doAnswer=function(params){params.call.connectionId=params.signal.fromConnection;params.call.fire("signal-answer",{signal:params.signal})};routingMethods.doIceCandidates=function(params){params.call.fire("signal-icecandidates",{signal:params.signal})};routingMethods.doBye=function(params){if(params.call.caller&&params.call.connectionId&&params.call.connectionId!==params.signal.fromConnection){return}params.call.fire("signal-hangup",{signal:params.signal})};routingMethods.doUnknown=function(params){log.error("Don't know what to do with",params.signal.target,"msg of unknown type",params.signal.signalType)};that.addHandler=function(params){if(socket.socket&&socket.socket.open){socket.on(params.type,params.handler)}else{handlerQueue[params.type].push(params.handler)}};var onPubSub=function onPubSub(message){var group;var groupMessage=respoke.TextMessage({rawMessage:message});group=client.getGroup({id:message.header.channel});if(group){group.fire("message",{message:groupMessage})}client.fire("message",{message:groupMessage,group:group||null})};var onJoin=function onJoin(message){var group;var presenceMessage;var endpoint;var connection;if(message.connectionId===client.connectionId){connection=client.getConnection({connectionId:message.connectionId,endpointId:message.endpointId});group=client.getGroup({id:message.header.channel});if(!group){group=respoke.Group({id:message.header.channel,instanceId:instanceId,signalingChannel:that});client.addGroup(group)}if(!group.isJoined()){group.addMember({connection:connection});client.fire("join",{group:group})}}else{endpoint=client.getEndpoint({skipPresence:true,id:message.endpointId,instanceId:instanceId,name:message.endpointId});if(!connection){endpoint.setPresence({connectionId:message.connectionId});connection=client.getConnection({connectionId:message.connectionId,endpointId:message.endpointId})}group=client.getGroup({id:message.header.channel});if(group&&connection){group.addMember({connection:connection})}else{log.error("Can't add endpoint to group:",message,group,endpoint,connection)}}};var onLeave=function onLeave(message){var group;var presenceMessage;var endpoint;if(message.connectionId===client.connectionId){group=client.getGroup({id:message.header.channel});client.fire("leave",{group:group})}else{endpoint=client.getEndpoint({skipPresence:true,id:message.endpointId});endpoint.connections.every(function eachConnection(conn,index){if(conn.id===message.connectionId){endpoint.connections.splice(index,1);return false}return true});group=client.getGroup({id:message.header.channel});if(group){group.removeMember({connectionId:message.connectionId})}}};var onMessage=function onMessage(message){var endpoint;message=respoke.TextMessage({rawMessage:message});if(message.originalRecipient||message.endpointId){endpoint=client.getEndpoint({id:message.originalRecipient||message.endpointId,skipCreate:true})}if(endpoint){endpoint.fire("message",{message:message})}client.fire("message",{endpoint:endpoint||null,message:message})};var generateConnectHandler=function generateConnectHandler(onSuccess,onError){onSuccess=onSuccess||function(){};onError=onError||function(){};return function onConnect(){Object.keys(handlerQueue).forEach(function addEachHandlerType(category){if(!handlerQueue[category]){return}handlerQueue[category].forEach(function addEachHandler(handler){socket.on(category,handler)});handlerQueue[category]=[]});wsCall({path:"/v1/connections",httpMethod:"POST",parameters:{capabilities:{iceFinalCandidates:true}}}).done(function successHandler(res){log.debug("connections result",res);client.endpointId=res.endpointId;client.connectionId=res.id;onSuccess()},onError)}};function onPresence(message){var endpoint;var groups;if(message.header.from===client.endpointId){return}log.debug("socket.on presence",message);endpoint=client.getEndpoint({skipPresence:true,id:message.header.from,instanceId:instanceId,name:message.header.from,connection:message.header.fromConnection});endpoint.setPresence({connectionId:message.header.fromConnection,presence:message.type});if(endpoint.presence==="unavailable"){groups=client.getGroups();if(groups){groups.forEach(function eachGroup(group){group.removeMember({connectionId:message.header.fromConnection})})}}}function reconnect(){if(clientSettings.reconnect!==true){return}clientSettings.reconnect=false;appToken=null;token=null;if(socket){socket.removeAllListeners();socket.disconnect();socket=null}reconnectTimeout=reconnectTimeout===null?2500:2*reconnectTimeout;if(reconnectTimeout>maxReconnectTimeout){reconnectTimeout=maxReconnectTimeout}setTimeout(function doReconnect(){log.debug("Reconnecting...");actuallyConnect().then(function successHandler(){reconnectTimeout=null;log.debug("socket reconnected");return Q.all(client.getGroups().map(function iterGroups(group){client.join({id:group.id,onMessage:clientSettings.onMessage,onJoin:clientSettings.onJoin,onLeave:clientSettings.onLeave}).catch(function(err){log.error("Couldn't rejoin previous group.",{id:group.id,message:err.message,stack:err.stack});throw err})}))}).then(function successHandler(){log.debug("groups rejoined after reconnect");client.fire("reconnect")}).fin(function finHandler(){clientSettings.reconnect=true}).done(null,function errHandler(err){log.error("Couldn't reconnect. Retrying...",{message:err.message,stack:err.stack});reconnect()})},reconnectTimeout)}that.authenticate=function(params){params=params||{};var deferred=Q.defer();var pieces=[];var protocol=null;var host=null;var port=null;if(!appToken){deferred.reject(new Error("Can't open a websocket without an app token."))}pieces=clientSettings.baseURL.split(/:\/\//);protocol=pieces[0];pieces=pieces[1].split(/:/);host=pieces[0];port=pieces[1];var connectParams={"connect timeout":clientSettings.connectTimeoutMillis,"force new connection":true,"sync disconnect on unload":true,reconnect:false,host:host,port:port||"443",protocol:protocol,secure:protocol==="https",query:"__sails_io_sdk_version=0.10.0&app-token="+appToken+"&Respoke-SDK="+sdkHeaderValue};if(that.isConnected()||isConnecting()){return}socket=io.connect(clientSettings.baseURL,connectParams);socket.on("connect",generateConnectHandler(function onSuccess(){deferred.resolve()},function onError(err){deferred.reject(err)}));socket.on("join",onJoin);socket.on("leave",onLeave);socket.on("pubsub",onPubSub);socket.on("message",onMessage);socket.on("presence",onPresence);socket.on("connect_failed",function connectFailedHandler(res){deferred.reject(new Error("WebSocket connection failed."));log.error("Socket.io connect timeout.",res||"");reconnect()});socket.on("error",function errorHandler(res){log.error("Socket.io error.",res||"");reconnect()});that.addHandler({type:"signal",handler:function signalHandler(message){var knownSignals=["offer","answer","connected","modify","iceCandidates","bye"];var signal=respoke.SignalingMessage({rawMessage:message});if(signal.signalType==="ack"){return}if(!signal.target||!signal.signalType||knownSignals.indexOf(signal.signalType)===-1){log.error("Got malformed signal.",signal);throw new Error("Can't route signal without target or type.")}that.routeSignal(signal)}});socket.on("disconnect",function onDisconnect(){log.debug("Socket.io disconnect.");pendingRequests.reset(function(pendingRequest){log.debug("Failing pending requests");pendingRequest.reject(new Error("WebSocket disconnected"))});client.fire("disconnect");reconnect()});return deferred.promise};that.getTurnCredentials=function(){var deferred=Q.defer();if(!that.isConnected()){deferred.reject(new Error("Can't complete request when not connected. Please reconnect!"));return deferred.promise}wsCall({httpMethod:"GET",path:"/v1/turn"}).done(function successHandler(creds){var result=[];if(!creds||!creds.uris){deferred.reject(new Error("Turn credentials empty."));return}creds.uris.forEach(function saveTurnUri(uri){var cred=null;if(!uri){return}cred=createIceServer(uri,creds.username,creds.password);result.push(cred)});if(result.length===0){deferred.reject(new Error("Got no TURN credentials."))}log.debug("TURN creds",result);deferred.resolve(result)},function errorHandler(err){deferred.reject(err)});return deferred.promise};function wsCall(params){params=params||{};var deferred=Q.defer();var start=now();var logRequest=params.path.indexOf("messages")===-1&&params.path.indexOf("signaling")===-1||respoke.ridiculous;var request;var bodyLength=0;if(params.parameters){bodyLength=encodeURI(JSON.stringify(params.parameters)).split(/%..|./).length-1}if(!that.isConnected()){deferred.reject(new Error("Can't complete request when not connected. Please reconnect!"));return deferred.promise}if(!params){deferred.reject(new Error("No params."));return deferred.promise}if(!params.path){deferred.reject(new Error("No request path."));return deferred.promise}if(bodyLength>bodySizeLimit){deferred.reject(new Error("Request body exceeds maximum size of "+bodySizeLimit+" bytes"));return deferred.promise}params.httpMethod=(params.httpMethod||"get").toLowerCase();if(params.urlParams){params.path=template.parse(params.path).expand(params.urlParams)}if(logRequest){log.debug("socket request",{method:params.httpMethod,path:params.path,parameters:params.parameters})}request={method:params.httpMethod,path:params.path,parameters:params.parameters,tries:0,durationMillis:0};request.id=pendingRequests.add(deferred);function handleResponse(response){var thisHandler=this;try{response.body=JSON.parse(response.body)}catch(e){if(typeof response.body!=="object"){deferred.reject(new Error("Server response could not be parsed!"+response.body));return}}if(response.statusCode===429){if(request.tries<3&&deferred.promise.isPending()){setTimeout(function(){start=now();sendWebsocketRequest(request,handleResponse)},1e3)}else{request.durationMillis=now()-start;pendingRequests.remove(request.id);failWebsocketRequest(request,response,"Too many retries after rate limit exceeded.",deferred)}return}request.durationMillis=now()-start;pendingRequests.remove(request.id);if(logRequest){log.debug("socket response",{method:request.method,path:request.path,durationMillis:request.durationMillis,response:response})}if(isBillingSuspensionUnauthorizedResponse(response)){failWebsocketRequest(request,response,billingSuspensionErrorMessage,deferred);return}if(isSuspensionUnauthorizedResponse(response)){failWebsocketRequest(request,response,suspensionErrorMessage,deferred);return}if([200,204,205,302,401,403,404,418].indexOf(thisHandler.status)===-1){failWebsocketRequest(request,response,response.body.error||errors[thisHandler.status]||"Unknown error",deferred);return}deferred.resolve(response.body)}start=now();sendWebsocketRequest(request,handleResponse);return deferred.promise}function failWebsocketRequest(request,response,error,deferred){if(response&&response.body&&response.body.error){deferred.reject(buildResponseError(response,error+" ("+request.method+" "+request.path+")"))}else{deferred.resolve(response.body)}}function sendWebsocketRequest(request,handleResponse){request.tries+=1;socket.emit(request.method,JSON.stringify({url:request.path,data:request.parameters,headers:{"App-Token":appToken,"Respoke-SDK":sdkHeaderValue}}),handleResponse)}function call(params){var deferred=Q.defer();var paramString=null;var uri=null;var response={body:null,statusCode:null};var start=now();uri=clientSettings.baseURL+params.path;if(!params){deferred.reject(new Error("No params."));return}if(!params.httpMethod){deferred.reject(new Error("No HTTP method."));return}if(!params.path){deferred.reject(new Error("No request path."));return}if(params.urlParams){uri=template.parse(uri).expand(params.urlParams)}if(["GET","DELETE"].indexOf(params.httpMethod)>-1){uri+=makeParamString(params.parameters)}xhr.open(params.httpMethod,uri);xhr.setRequestHeader("Respoke-SDK",sdkHeaderValue);if(appToken){xhr.setRequestHeader("App-Token",appToken)}if(["POST","PUT"].indexOf(params.httpMethod)>-1){paramString=JSON.stringify(params.parameters);if(paramString.length>bodySizeLimit){deferred.reject(new Error("Request body exceeds maximum size of "+bodySizeLimit+" bytes"));return}xhr.setRequestHeader("Content-Type","application/json;charset=UTF-8")}else if(["GET","DELETE"].indexOf(params.httpMethod)===-1){deferred.reject(new Error("Illegal HTTP request method "+params.httpMethod));return}log.debug("request",{method:params.httpMethod,uri:uri,params:paramString});try{xhr.send(paramString)}catch(err){deferred.reject(err);return}xhr.onreadystatechange=function(){var durationMillis=now()-start;var limit;var unit;if(this.readyState!==4){return}if(this.status===0){deferred.reject(new Error("Status is 0: Incomplete request, SSL error, or CORS error."));return}response.statusCode=this.status;response.headers=getAllResponseHeaders(this);response.uri=uri;response.params=params.parameters;response.error=errors[this.status];if(this.response){try{response.body=JSON.parse(this.response)}catch(e){response.body=this.response;response.error="Invalid JSON."}}log.debug("response",{method:params.httpMethod,durationMillis:durationMillis,response:response});if([200,204,205,302,401,403,404,418].indexOf(this.status)>-1){deferred.resolve(response)}else if(this.status===429){unit=getResponseHeader(this,"RateLimit-Time-Units");limit=getResponseHeader(this,"RateLimit-Limit");deferred.reject(buildResponseError(response,"Rate limit of "+limit+"/"+unit+" exceeded. Try again in 1 "+unit+"."))}else{deferred.reject(buildResponseError(response,"unexpected response code "+this.status))}};return deferred.promise}function isSuspensionUnauthorizedResponse(response){return response.statusCode===401&&response.body&&response.body.details&&typeof response.body.details.message==="string"&&response.body.details.message.indexOf("suspended")>-1}function isBillingSuspensionUnauthorizedResponse(response){return isSuspensionUnauthorizedResponse(response)&&typeof response.body.details.reason==="string"&&response.body.details.reason.indexOf("billing suspension")>-1}function makeParamString(params){var strings=[];if(!params){return""}Object.keys(params).forEach(function formatParam(name){var value=params[name];if(value instanceof Array){strings.push([name,value.join(",")].join("="))}else if(typeof value!=="object"&&typeof value!=="function"){strings.push([name,value].join("="))}});if(strings.length>0){return"?"+strings.join("&")}else{return""}}function getResponseHeader(xhrResponse,header){try{return xhrResponse.getResponseHeader(header)}catch(e){return null}}function getAllResponseHeaders(xhrResponse){var result={};var headers;var pairs;headers=xhrResponse.getAllResponseHeaders();if(!headers){return result}pairs=headers.split("\r\n");pairs.forEach(function(pair){var key;var val;var index=pair.indexOf(": ");if(index>0){key=pair.substring(0,index);val=pair.substring(index+2);result[key]=val}});return result;
}function buildResponseError(res,message){var requestId=res&&res.headers&&res.headers["Request-Id"];if(requestId){message+=" [Request-Id: "+requestId+"]"}return new Error(message)}return that}},function(module,exports,__webpack_require__){var __WEBPACK_AMD_DEFINE_ARRAY__,__WEBPACK_AMD_DEFINE_RESULT__;(function(module){/*! Socket.IO.js build:0.9.17, development. Copyright(c) 2011 LearnBoost <dev@learnboost.com> MIT Licensed */
var io=false?{}:module.exports;(function(){(function(exports,global){var io=exports;io.version="0.9.17";io.protocol=1;io.transports=[];io.j=[];io.sockets={};io.connect=function(host,details){var uri=io.util.parseUri(host),uuri,socket;if(global&&global.location){uri.protocol=uri.protocol||global.location.protocol.slice(0,-1);uri.host=uri.host||(global.document?global.document.domain:global.location.hostname);uri.port=uri.port||global.location.port}uuri=io.util.uniqueUri(uri);var options={host:uri.host,secure:"https"==uri.protocol,port:uri.port||("https"==uri.protocol?443:80),query:uri.query||""};io.util.merge(options,details);if(options["force new connection"]||!io.sockets[uuri]){socket=new io.Socket(options)}if(!options["force new connection"]&&socket){io.sockets[uuri]=socket}socket=socket||io.sockets[uuri];return socket.of(uri.path.length>1?uri.path:"")}})(true?module.exports:this.io={},this);(function(exports,global){var util=exports.util={};var re=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/;var parts=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];util.parseUri=function(str){var m=re.exec(str||""),uri={},i=14;while(i--){uri[parts[i]]=m[i]||""}return uri};util.uniqueUri=function(uri){var protocol=uri.protocol,host=uri.host,port=uri.port;if("document"in global){host=host||document.domain;port=port||(protocol=="https"&&document.location.protocol!=="https:"?443:document.location.port)}else{host=host||"localhost";if(!port&&protocol=="https"){port=443}}return(protocol||"http")+"://"+host+":"+(port||80)};util.query=function(base,addition){var query=util.chunkQuery(base||""),components=[];util.merge(query,util.chunkQuery(addition||""));for(var part in query){if(query.hasOwnProperty(part)){components.push(part+"="+query[part])}}return components.length?"?"+components.join("&"):""};util.chunkQuery=function(qs){var query={},params=qs.split("&"),i=0,l=params.length,kv;for(;i<l;++i){kv=params[i].split("=");if(kv[0]){query[kv[0]]=kv[1]}}return query};var pageLoaded=false;util.load=function(fn){if("document"in global&&document.readyState==="complete"||pageLoaded){return fn()}util.on(global,"load",fn,false)};util.on=function(element,event,fn,capture){if(element.attachEvent){element.attachEvent("on"+event,fn)}else if(element.addEventListener){element.addEventListener(event,fn,capture)}};util.request=function(xdomain){if(xdomain&&"undefined"!=typeof XDomainRequest&&!util.ua.hasCORS){return new XDomainRequest}if("undefined"!=typeof XMLHttpRequest&&(!xdomain||util.ua.hasCORS)){return new XMLHttpRequest}if(!xdomain){try{return new(window[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(e){}}return null};if("undefined"!=typeof window){util.load(function(){pageLoaded=true})}util.defer=function(fn){if(!util.ua.webkit||"undefined"!=typeof importScripts){return fn()}util.load(function(){setTimeout(fn,100)})};util.merge=function merge(target,additional,deep,lastseen){var seen=lastseen||[],depth=typeof deep=="undefined"?2:deep,prop;for(prop in additional){if(additional.hasOwnProperty(prop)&&util.indexOf(seen,prop)<0){if(typeof target[prop]!=="object"||!depth){target[prop]=additional[prop];seen.push(additional[prop])}else{util.merge(target[prop],additional[prop],depth-1,seen)}}}return target};util.mixin=function(ctor,ctor2){util.merge(ctor.prototype,ctor2.prototype)};util.inherit=function(ctor,ctor2){function f(){}f.prototype=ctor2.prototype;ctor.prototype=new f};util.isArray=Array.isArray||function(obj){return Object.prototype.toString.call(obj)==="[object Array]"};util.intersect=function(arr,arr2){var ret=[],longest=arr.length>arr2.length?arr:arr2,shortest=arr.length>arr2.length?arr2:arr;for(var i=0,l=shortest.length;i<l;i++){if(~util.indexOf(longest,shortest[i]))ret.push(shortest[i])}return ret};util.indexOf=function(arr,o,i){for(var j=arr.length,i=i<0?i+j<0?0:i+j:i||0;i<j&&arr[i]!==o;i++){}return j<=i?-1:i};util.toArray=function(enu){var arr=[];for(var i=0,l=enu.length;i<l;i++)arr.push(enu[i]);return arr};util.ua={};util.ua.hasCORS="undefined"!=typeof XMLHttpRequest&&function(){try{var a=new XMLHttpRequest}catch(e){return false}return a.withCredentials!=undefined}();util.ua.webkit="undefined"!=typeof navigator&&/webkit/i.test(navigator.userAgent);util.ua.iDevice="undefined"!=typeof navigator&&/iPad|iPhone|iPod/i.test(navigator.userAgent)})("undefined"!=typeof io?io:module.exports,this);(function(exports,io){exports.EventEmitter=EventEmitter;function EventEmitter(){}EventEmitter.prototype.on=function(name,fn){if(!this.$events){this.$events={}}if(!this.$events[name]){this.$events[name]=fn}else if(io.util.isArray(this.$events[name])){this.$events[name].push(fn)}else{this.$events[name]=[this.$events[name],fn]}return this};EventEmitter.prototype.addListener=EventEmitter.prototype.on;EventEmitter.prototype.once=function(name,fn){var self=this;function on(){self.removeListener(name,on);fn.apply(this,arguments)}on.listener=fn;this.on(name,on);return this};EventEmitter.prototype.removeListener=function(name,fn){if(this.$events&&this.$events[name]){var list=this.$events[name];if(io.util.isArray(list)){var pos=-1;for(var i=0,l=list.length;i<l;i++){if(list[i]===fn||list[i].listener&&list[i].listener===fn){pos=i;break}}if(pos<0){return this}list.splice(pos,1);if(!list.length){delete this.$events[name]}}else if(list===fn||list.listener&&list.listener===fn){delete this.$events[name]}}return this};EventEmitter.prototype.removeAllListeners=function(name){if(name===undefined){this.$events={};return this}if(this.$events&&this.$events[name]){this.$events[name]=null}return this};EventEmitter.prototype.listeners=function(name){if(!this.$events){this.$events={}}if(!this.$events[name]){this.$events[name]=[]}if(!io.util.isArray(this.$events[name])){this.$events[name]=[this.$events[name]]}return this.$events[name]};EventEmitter.prototype.emit=function(name){if(!this.$events){return false}var handler=this.$events[name];if(!handler){return false}var args=Array.prototype.slice.call(arguments,1);if("function"==typeof handler){handler.apply(this,args)}else if(io.util.isArray(handler)){var listeners=handler.slice();for(var i=0,l=listeners.length;i<l;i++){listeners[i].apply(this,args)}}else{return false}return true}})("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports);(function(exports,nativeJSON){"use strict";if(nativeJSON&&nativeJSON.parse){return exports.JSON={parse:nativeJSON.parse,stringify:nativeJSON.stringify}}var JSON=exports.JSON={};function f(n){return n<10?"0"+n:n}function date(d,key){return isFinite(d.valueOf())?d.getUTCFullYear()+"-"+f(d.getUTCMonth()+1)+"-"+f(d.getUTCDate())+"T"+f(d.getUTCHours())+":"+f(d.getUTCMinutes())+":"+f(d.getUTCSeconds())+"Z":null}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value instanceof Date){value=date(key)}if(typeof rep==="function"){value=rep.call(holder,key,value)}switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null"}gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==="[object Array]"){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||"null"}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";gap=mind;return v}if(rep&&typeof rep==="object"){length=rep.length;for(i=0;i<length;i+=1){if(typeof rep[i]==="string"){k=rep[i];v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}else{for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";gap=mind;return v}}JSON.stringify=function(value,replacer,space){var i;gap="";indent="";if(typeof space==="number"){for(i=0;i<space;i+=1){indent+=" "}}else if(typeof space==="string"){indent=space}rep=replacer;if(replacer&&typeof replacer!=="function"&&(typeof replacer!=="object"||typeof replacer.length!=="number")){throw new Error("JSON.stringify")}return str("",{"":value})};JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v}else{delete value[k]}}}}return reviver.call(holder,key,value)}text=String(text);cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")}})("undefined"!=typeof io?io:module.exports,typeof JSON!=="undefined"?JSON:undefined);(function(exports,io){var parser=exports.parser={};var packets=parser.packets=["disconnect","connect","heartbeat","message","json","event","ack","error","noop"];var reasons=parser.reasons=["transport not supported","client not handshaken","unauthorized"];var advice=parser.advice=["reconnect"];var JSON=io.JSON,indexOf=io.util.indexOf;parser.encodePacket=function(packet){var type=indexOf(packets,packet.type),id=packet.id||"",endpoint=packet.endpoint||"",ack=packet.ack,data=null;switch(packet.type){case"error":var reason=packet.reason?indexOf(reasons,packet.reason):"",adv=packet.advice?indexOf(advice,packet.advice):"";if(reason!==""||adv!=="")data=reason+(adv!==""?"+"+adv:"");break;case"message":if(packet.data!=="")data=packet.data;break;case"event":var ev={name:packet.name};if(packet.args&&packet.args.length){ev.args=packet.args}data=JSON.stringify(ev);break;case"json":data=JSON.stringify(packet.data);break;case"connect":if(packet.qs)data=packet.qs;break;case"ack":data=packet.ackId+(packet.args&&packet.args.length?"+"+JSON.stringify(packet.args):"");break}var encoded=[type,id+(ack=="data"?"+":""),endpoint];if(data!==null&&data!==undefined)encoded.push(data);return encoded.join(":")};parser.encodePayload=function(packets){var decoded="";if(packets.length==1)return packets[0];for(var i=0,l=packets.length;i<l;i++){var packet=packets[i];decoded+=""+packet.length+""+packets[i]}return decoded};var regexp=/([^:]+):([0-9]+)?(\+)?:([^:]+)?:?([\s\S]*)?/;parser.decodePacket=function(data){var pieces=data.match(regexp);if(!pieces)return{};var id=pieces[2]||"",data=pieces[5]||"",packet={type:packets[pieces[1]],endpoint:pieces[4]||""};if(id){packet.id=id;if(pieces[3])packet.ack="data";else packet.ack=true}switch(packet.type){case"error":var pieces=data.split("+");packet.reason=reasons[pieces[0]]||"";packet.advice=advice[pieces[1]]||"";break;case"message":packet.data=data||"";break;case"event":try{var opts=JSON.parse(data);packet.name=opts.name;packet.args=opts.args}catch(e){}packet.args=packet.args||[];break;case"json":try{packet.data=JSON.parse(data)}catch(e){}break;case"connect":packet.qs=data||"";break;case"ack":var pieces=data.match(/^([0-9]+)(\+)?(.*)/);if(pieces){packet.ackId=pieces[1];packet.args=[];if(pieces[3]){try{packet.args=pieces[3]?JSON.parse(pieces[3]):[]}catch(e){}}}break;case"disconnect":case"heartbeat":break}return packet};parser.decodePayload=function(data){if(data.charAt(0)==""){var ret=[];for(var i=1,length="";i<data.length;i++){if(data.charAt(i)==""){ret.push(parser.decodePacket(data.substr(i+1).substr(0,length)));i+=Number(length)+1;length=""}else{length+=data.charAt(i)}}return ret}else{return[parser.decodePacket(data)]}}})("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports);(function(exports,io){exports.Transport=Transport;function Transport(socket,sessid){this.socket=socket;this.sessid=sessid}io.util.mixin(Transport,io.EventEmitter);Transport.prototype.heartbeats=function(){return true};Transport.prototype.onData=function(data){this.clearCloseTimeout();if(this.socket.connected||this.socket.connecting||this.socket.reconnecting){this.setCloseTimeout()}if(data!==""){var msgs=io.parser.decodePayload(data);if(msgs&&msgs.length){for(var i=0,l=msgs.length;i<l;i++){this.onPacket(msgs[i])}}}return this};Transport.prototype.onPacket=function(packet){this.socket.setHeartbeatTimeout();if(packet.type=="heartbeat"){return this.onHeartbeat()}if(packet.type=="connect"&&packet.endpoint==""){this.onConnect()}if(packet.type=="error"&&packet.advice=="reconnect"){this.isOpen=false}this.socket.onPacket(packet);return this};Transport.prototype.setCloseTimeout=function(){if(!this.closeTimeout){var self=this;this.closeTimeout=setTimeout(function(){self.onDisconnect()},this.socket.closeTimeout)}};Transport.prototype.onDisconnect=function(){if(this.isOpen)this.close();this.clearTimeouts();this.socket.onDisconnect();return this};Transport.prototype.onConnect=function(){this.socket.onConnect();return this};Transport.prototype.clearCloseTimeout=function(){if(this.closeTimeout){clearTimeout(this.closeTimeout);this.closeTimeout=null}};Transport.prototype.clearTimeouts=function(){this.clearCloseTimeout();if(this.reopenTimeout){clearTimeout(this.reopenTimeout)}};Transport.prototype.packet=function(packet){this.send(io.parser.encodePacket(packet))};Transport.prototype.onHeartbeat=function(heartbeat){this.packet({type:"heartbeat"})};Transport.prototype.onOpen=function(){this.isOpen=true;this.clearCloseTimeout();this.socket.onOpen()};Transport.prototype.onClose=function(){var self=this;this.isOpen=false;this.socket.onClose();this.onDisconnect()};Transport.prototype.prepareUrl=function(){var options=this.socket.options;return this.scheme()+"://"+options.host+":"+options.port+"/"+options.resource+"/"+io.protocol+"/"+this.name+"/"+this.sessid};Transport.prototype.ready=function(socket,fn){fn.call(this)}})("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports);(function(exports,io,global){exports.Socket=Socket;function Socket(options){this.options={port:80,secure:false,document:"document"in global?document:false,resource:"socket.io",transports:io.transports,"connect timeout":1e4,"try multiple transports":true,reconnect:true,"reconnection delay":500,"reconnection limit":Infinity,"reopen delay":3e3,"max reconnection attempts":10,"sync disconnect on unload":false,"auto connect":true,"flash policy port":10843,manualFlush:false};io.util.merge(this.options,options);this.connected=false;this.open=false;this.connecting=false;this.reconnecting=false;this.namespaces={};this.buffer=[];this.doBuffer=false;if(this.options["sync disconnect on unload"]&&(!this.isXDomain()||io.util.ua.hasCORS)){var self=this;io.util.on(global,"beforeunload",function(){self.disconnectSync()},false)}if(this.options["auto connect"]){this.connect()}}io.util.mixin(Socket,io.EventEmitter);Socket.prototype.of=function(name){if(!this.namespaces[name]){this.namespaces[name]=new io.SocketNamespace(this,name);if(name!==""){this.namespaces[name].packet({type:"connect"})}}return this.namespaces[name]};Socket.prototype.publish=function(){this.emit.apply(this,arguments);var nsp;for(var i in this.namespaces){if(this.namespaces.hasOwnProperty(i)){nsp=this.of(i);nsp.$emit.apply(nsp,arguments)}}};function empty(){}Socket.prototype.handshake=function(fn){var self=this,options=this.options;function complete(data){if(data instanceof Error){self.connecting=false;self.onError(data.message)}else{fn.apply(null,data.split(":"))}}var url=["http"+(options.secure?"s":"")+":/",options.host+":"+options.port,options.resource,io.protocol,io.util.query(this.options.query,"t="+ +new Date)].join("/");if(this.isXDomain()&&!io.util.ua.hasCORS){var insertAt=document.getElementsByTagName("script")[0],script=document.createElement("script");script.src=url+"&jsonp="+io.j.length;insertAt.parentNode.insertBefore(script,insertAt);io.j.push(function(data){complete(data);script.parentNode.removeChild(script)})}else{var xhr=io.util.request();xhr.open("GET",url,true);if(this.isXDomain()){xhr.withCredentials=true}xhr.onreadystatechange=function(){if(xhr.readyState==4){xhr.onreadystatechange=empty;if(xhr.status==200){complete(xhr.responseText)}else if(xhr.status==403){self.onError(xhr.responseText)}else{self.connecting=false;!self.reconnecting&&self.onError(xhr.responseText)}}};xhr.send(null)}};Socket.prototype.getTransport=function(override){var transports=override||this.transports,match;for(var i=0,transport;transport=transports[i];i++){if(io.Transport[transport]&&io.Transport[transport].check(this)&&(!this.isXDomain()||io.Transport[transport].xdomainCheck(this))){return new io.Transport[transport](this,this.sessionid)}}return null};Socket.prototype.connect=function(fn){if(this.connecting){return this}var self=this;self.connecting=true;this.handshake(function(sid,heartbeat,close,transports){self.sessionid=sid;self.closeTimeout=close*1e3;self.heartbeatTimeout=heartbeat*1e3;if(!self.transports)self.transports=self.origTransports=transports?io.util.intersect(transports.split(","),self.options.transports):self.options.transports;self.setHeartbeatTimeout();function connect(transports){if(self.transport)self.transport.clearTimeouts();self.transport=self.getTransport(transports);if(!self.transport)return self.publish("connect_failed");self.transport.ready(self,function(){self.connecting=true;self.publish("connecting",self.transport.name);self.transport.open();if(self.options["connect timeout"]){self.connectTimeoutTimer=setTimeout(function(){if(!self.connected){self.connecting=false;if(self.options["try multiple transports"]){var remaining=self.transports;while(remaining.length>0&&remaining.splice(0,1)[0]!=self.transport.name){}if(remaining.length){connect(remaining)}else{self.publish("connect_failed")}}}},self.options["connect timeout"])}})}connect(self.transports);self.once("connect",function(){clearTimeout(self.connectTimeoutTimer);fn&&typeof fn=="function"&&fn()})});return this};Socket.prototype.setHeartbeatTimeout=function(){clearTimeout(this.heartbeatTimeoutTimer);if(this.transport&&!this.transport.heartbeats())return;var self=this;this.heartbeatTimeoutTimer=setTimeout(function(){self.transport.onClose()},this.heartbeatTimeout)};Socket.prototype.packet=function(data){if(this.connected&&!this.doBuffer){this.transport.packet(data)}else{this.buffer.push(data)}return this};Socket.prototype.setBuffer=function(v){this.doBuffer=v;if(!v&&this.connected&&this.buffer.length){if(!this.options["manualFlush"]){this.flushBuffer()}}};Socket.prototype.flushBuffer=function(){this.transport.payload(this.buffer);this.buffer=[]};Socket.prototype.disconnect=function(){if(this.connected||this.connecting){if(this.open){this.of("").packet({type:"disconnect"})}this.onDisconnect("booted")}return this};Socket.prototype.disconnectSync=function(){var xhr=io.util.request();var uri=["http"+(this.options.secure?"s":"")+":/",this.options.host+":"+this.options.port,this.options.resource,io.protocol,"",this.sessionid].join("/")+"/?disconnect=1";xhr.open("GET",uri,false);xhr.send(null);this.onDisconnect("booted")};Socket.prototype.isXDomain=function(){var port=global.location.port||("https:"==global.location.protocol?443:80);return this.options.host!==global.location.hostname||this.options.port!=port};Socket.prototype.onConnect=function(){if(!this.connected){this.connected=true;this.connecting=false;if(!this.doBuffer){this.setBuffer(false)}this.emit("connect")}};Socket.prototype.onOpen=function(){this.open=true};Socket.prototype.onClose=function(){this.open=false;clearTimeout(this.heartbeatTimeoutTimer)};Socket.prototype.onPacket=function(packet){this.of(packet.endpoint).onPacket(packet)};Socket.prototype.onError=function(err){if(err&&err.advice){if(err.advice==="reconnect"&&(this.connected||this.connecting)){this.disconnect();if(this.options.reconnect){this.reconnect()}}}this.publish("error",err&&err.reason?err.reason:err)};Socket.prototype.onDisconnect=function(reason){var wasConnected=this.connected,wasConnecting=this.connecting;this.connected=false;this.connecting=false;this.open=false;if(wasConnected||wasConnecting){this.transport.close();this.transport.clearTimeouts();if(wasConnected){this.publish("disconnect",reason);if("booted"!=reason&&this.options.reconnect&&!this.reconnecting){this.reconnect()}}}};Socket.prototype.reconnect=function(){this.reconnecting=true;this.reconnectionAttempts=0;this.reconnectionDelay=this.options["reconnection delay"];var self=this,maxAttempts=this.options["max reconnection attempts"],tryMultiple=this.options["try multiple transports"],limit=this.options["reconnection limit"];function reset(){if(self.connected){for(var i in self.namespaces){if(self.namespaces.hasOwnProperty(i)&&""!==i){self.namespaces[i].packet({type:"connect"})}}self.publish("reconnect",self.transport.name,self.reconnectionAttempts)}clearTimeout(self.reconnectionTimer);self.removeListener("connect_failed",maybeReconnect);self.removeListener("connect",maybeReconnect);self.reconnecting=false;delete self.reconnectionAttempts;delete self.reconnectionDelay;delete self.reconnectionTimer;delete self.redoTransports;self.options["try multiple transports"]=tryMultiple}function maybeReconnect(){if(!self.reconnecting){return}if(self.connected){return reset()}if(self.connecting&&self.reconnecting){return self.reconnectionTimer=setTimeout(maybeReconnect,1e3)}if(self.reconnectionAttempts++>=maxAttempts){if(!self.redoTransports){self.on("connect_failed",maybeReconnect);self.options["try multiple transports"]=true;self.transports=self.origTransports;self.transport=self.getTransport();self.redoTransports=true;self.connect()}else{self.publish("reconnect_failed");reset()}}else{if(self.reconnectionDelay<limit){self.reconnectionDelay*=2}self.connect();self.publish("reconnecting",self.reconnectionDelay,self.reconnectionAttempts);self.reconnectionTimer=setTimeout(maybeReconnect,self.reconnectionDelay)}}this.options["try multiple transports"]=false;this.reconnectionTimer=setTimeout(maybeReconnect,this.reconnectionDelay);this.on("connect",maybeReconnect)}})("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports,this);(function(exports,io){exports.SocketNamespace=SocketNamespace;function SocketNamespace(socket,name){this.socket=socket;this.name=name||"";this.flags={};this.json=new Flag(this,"json");this.ackPackets=0;this.acks={}}io.util.mixin(SocketNamespace,io.EventEmitter);SocketNamespace.prototype.$emit=io.EventEmitter.prototype.emit;SocketNamespace.prototype.of=function(){return this.socket.of.apply(this.socket,arguments)};SocketNamespace.prototype.packet=function(packet){packet.endpoint=this.name;this.socket.packet(packet);this.flags={};return this};SocketNamespace.prototype.send=function(data,fn){var packet={type:this.flags.json?"json":"message",data:data};if("function"==typeof fn){packet.id=++this.ackPackets;packet.ack=true;this.acks[packet.id]=fn}return this.packet(packet)};SocketNamespace.prototype.emit=function(name){var args=Array.prototype.slice.call(arguments,1),lastArg=args[args.length-1],packet={type:"event",name:name};if("function"==typeof lastArg){packet.id=++this.ackPackets;packet.ack="data";this.acks[packet.id]=lastArg;args=args.slice(0,args.length-1)}packet.args=args;return this.packet(packet)};SocketNamespace.prototype.disconnect=function(){if(this.name===""){this.socket.disconnect()}else{this.packet({type:"disconnect"});this.$emit("disconnect")}return this};SocketNamespace.prototype.onPacket=function(packet){var self=this;function ack(){self.packet({type:"ack",args:io.util.toArray(arguments),ackId:packet.id})}switch(packet.type){case"connect":this.$emit("connect");break;case"disconnect":if(this.name===""){this.socket.onDisconnect(packet.reason||"booted")}else{this.$emit("disconnect",packet.reason)}break;case"message":case"json":var params=["message",packet.data];if(packet.ack=="data"){params.push(ack)}else if(packet.ack){this.packet({type:"ack",ackId:packet.id})}this.$emit.apply(this,params);break;case"event":var params=[packet.name].concat(packet.args);if(packet.ack=="data")params.push(ack);this.$emit.apply(this,params);break;case"ack":if(this.acks[packet.ackId]){this.acks[packet.ackId].apply(this,packet.args);delete this.acks[packet.ackId]}break;case"error":if(packet.advice){this.socket.onError(packet)}else{if(packet.reason=="unauthorized"){this.$emit("connect_failed",packet.reason)}else{this.$emit("error",packet.reason)}}break}};function Flag(nsp,name){this.namespace=nsp;this.name=name}Flag.prototype.send=function(){this.namespace.flags[this.name]=true;this.namespace.send.apply(this.namespace,arguments)};Flag.prototype.emit=function(){this.namespace.flags[this.name]=true;this.namespace.emit.apply(this.namespace,arguments)}})("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports);(function(exports,io,global){exports.websocket=WS;function WS(socket){io.Transport.apply(this,arguments)}io.util.inherit(WS,io.Transport);WS.prototype.name="websocket";WS.prototype.open=function(){var query=io.util.query(this.socket.options.query),self=this,Socket;if(!Socket){Socket=global.MozWebSocket||global.WebSocket}this.websocket=new Socket(this.prepareUrl()+query);this.websocket.onopen=function(){self.onOpen();self.socket.setBuffer(false)};this.websocket.onmessage=function(ev){self.onData(ev.data)};this.websocket.onclose=function(){self.onClose();self.socket.setBuffer(true)};this.websocket.onerror=function(e){self.onError(e)};return this};if(io.util.ua.iDevice){WS.prototype.send=function(data){var self=this;setTimeout(function(){self.websocket.send(data)},0);return this}}else{WS.prototype.send=function(data){this.websocket.send(data);return this}}WS.prototype.payload=function(arr){for(var i=0,l=arr.length;i<l;i++){this.packet(arr[i])}return this};WS.prototype.close=function(){this.websocket.close();return this};WS.prototype.onError=function(e){this.socket.onError(e)};WS.prototype.scheme=function(){return this.socket.options.secure?"wss":"ws"};WS.check=function(){return"WebSocket"in global&&!("__addTask"in WebSocket)||"MozWebSocket"in global};WS.xdomainCheck=function(){return true};io.transports.push("websocket")})("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this);(function(exports,io){exports.flashsocket=Flashsocket;function Flashsocket(){io.Transport.websocket.apply(this,arguments)}io.util.inherit(Flashsocket,io.Transport.websocket);Flashsocket.prototype.name="flashsocket";Flashsocket.prototype.open=function(){var self=this,args=arguments;WebSocket.__addTask(function(){io.Transport.websocket.prototype.open.apply(self,args)});return this};Flashsocket.prototype.send=function(){var self=this,args=arguments;WebSocket.__addTask(function(){io.Transport.websocket.prototype.send.apply(self,args)});return this};Flashsocket.prototype.close=function(){WebSocket.__tasks.length=0;io.Transport.websocket.prototype.close.call(this);return this};Flashsocket.prototype.ready=function(socket,fn){function init(){var options=socket.options,port=options["flash policy port"],path=["http"+(options.secure?"s":"")+":/",options.host+":"+options.port,options.resource,"static/flashsocket","WebSocketMain"+(socket.isXDomain()?"Insecure":"")+".swf"];if(!Flashsocket.loaded){if(typeof WEB_SOCKET_SWF_LOCATION==="undefined"){WEB_SOCKET_SWF_LOCATION=path.join("/")}if(port!==843){WebSocket.loadFlashPolicyFile("xmlsocket://"+options.host+":"+port)}WebSocket.__initialize();Flashsocket.loaded=true}fn.call(self)}var self=this;if(document.body)return init();io.util.load(init)};Flashsocket.check=function(){if(typeof WebSocket=="undefined"||!("__initialize"in WebSocket)||!swfobject)return false;return swfobject.getFlashPlayerVersion().major>=10};Flashsocket.xdomainCheck=function(){return true};if(typeof window!="undefined"){WEB_SOCKET_DISABLE_AUTO_INITIALIZATION=true}io.transports.push("flashsocket")})("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports);if("undefined"!=typeof window){var swfobject=function(){var D="undefined",r="object",S="Shockwave Flash",W="ShockwaveFlash.ShockwaveFlash",q="application/x-shockwave-flash",R="SWFObjectExprInst",x="onreadystatechange",O=window,j=document,t=navigator,T=false,U=[h],o=[],N=[],I=[],l,Q,E,B,J=false,a=false,n,G,m=true,M=function(){var aa=typeof j.getElementById!=D&&typeof j.getElementsByTagName!=D&&typeof j.createElement!=D,ah=t.userAgent.toLowerCase(),Y=t.platform.toLowerCase(),ae=Y?/win/.test(Y):/win/.test(ah),ac=Y?/mac/.test(Y):/mac/.test(ah),af=/webkit/.test(ah)?parseFloat(ah.replace(/^.*webkit\/(\d+(\.\d+)?).*$/,"$1")):false,X=!+"1",ag=[0,0,0],ab=null;if(typeof t.plugins!=D&&typeof t.plugins[S]==r){ab=t.plugins[S].description;if(ab&&!(typeof t.mimeTypes!=D&&t.mimeTypes[q]&&!t.mimeTypes[q].enabledPlugin)){T=true;X=false;ab=ab.replace(/^.*\s+(\S+\s+\S+$)/,"$1");ag[0]=parseInt(ab.replace(/^(.*)\..*$/,"$1"),10);ag[1]=parseInt(ab.replace(/^.*\.(.*)\s.*$/,"$1"),10);ag[2]=/[a-zA-Z]/.test(ab)?parseInt(ab.replace(/^.*[a-zA-Z]+(.*)$/,"$1"),10):0}}else{if(typeof O[["Active"].concat("Object").join("X")]!=D){try{var ad=new(window[["Active"].concat("Object").join("X")])(W);if(ad){ab=ad.GetVariable("$version");if(ab){X=true;ab=ab.split(" ")[1].split(",");ag=[parseInt(ab[0],10),parseInt(ab[1],10),parseInt(ab[2],10)]}}}catch(Z){}}}return{w3:aa,pv:ag,wk:af,ie:X,win:ae,mac:ac}}(),k=function(){if(!M.w3){return}if(typeof j.readyState!=D&&j.readyState=="complete"||typeof j.readyState==D&&(j.getElementsByTagName("body")[0]||j.body)){f()}if(!J){if(typeof j.addEventListener!=D){j.addEventListener("DOMContentLoaded",f,false)}if(M.ie&&M.win){j.attachEvent(x,function(){if(j.readyState=="complete"){j.detachEvent(x,arguments.callee);f()}});if(O==top){(function(){if(J){return}try{j.documentElement.doScroll("left")}catch(X){setTimeout(arguments.callee,0);return}f()})()}}if(M.wk){(function(){if(J){return}if(!/loaded|complete/.test(j.readyState)){setTimeout(arguments.callee,0);return}f()})()}s(f)}}();function f(){if(J){return}try{var Z=j.getElementsByTagName("body")[0].appendChild(C("span"));Z.parentNode.removeChild(Z)}catch(aa){return}J=true;var X=U.length;for(var Y=0;Y<X;Y++){U[Y]()}}function K(X){if(J){X()}else{U[U.length]=X}}function s(Y){if(typeof O.addEventListener!=D){O.addEventListener("load",Y,false)}else{if(typeof j.addEventListener!=D){j.addEventListener("load",Y,false)}else{if(typeof O.attachEvent!=D){i(O,"onload",Y)}else{if(typeof O.onload=="function"){var X=O.onload;O.onload=function(){X();Y()}}else{O.onload=Y}}}}}function h(){if(T){V()}else{H()}}function V(){var X=j.getElementsByTagName("body")[0];var aa=C(r);aa.setAttribute("type",q);var Z=X.appendChild(aa);if(Z){var Y=0;(function(){if(typeof Z.GetVariable!=D){var ab=Z.GetVariable("$version");if(ab){ab=ab.split(" ")[1].split(",");M.pv=[parseInt(ab[0],10),parseInt(ab[1],10),parseInt(ab[2],10)]}}else{if(Y<10){Y++;setTimeout(arguments.callee,10);return}}X.removeChild(aa);Z=null;H()})()}else{H()}}function H(){var ag=o.length;if(ag>0){for(var af=0;af<ag;af++){var Y=o[af].id;var ab=o[af].callbackFn;var aa={success:false,id:Y};if(M.pv[0]>0){var ae=c(Y);if(ae){if(F(o[af].swfVersion)&&!(M.wk&&M.wk<312)){
w(Y,true);if(ab){aa.success=true;aa.ref=z(Y);ab(aa)}}else{if(o[af].expressInstall&&A()){var ai={};ai.data=o[af].expressInstall;ai.width=ae.getAttribute("width")||"0";ai.height=ae.getAttribute("height")||"0";if(ae.getAttribute("class")){ai.styleclass=ae.getAttribute("class")}if(ae.getAttribute("align")){ai.align=ae.getAttribute("align")}var ah={};var X=ae.getElementsByTagName("param");var ac=X.length;for(var ad=0;ad<ac;ad++){if(X[ad].getAttribute("name").toLowerCase()!="movie"){ah[X[ad].getAttribute("name")]=X[ad].getAttribute("value")}}P(ai,ah,Y,ab)}else{p(ae);if(ab){ab(aa)}}}}}else{w(Y,true);if(ab){var Z=z(Y);if(Z&&typeof Z.SetVariable!=D){aa.success=true;aa.ref=Z}ab(aa)}}}}}function z(aa){var X=null;var Y=c(aa);if(Y&&Y.nodeName=="OBJECT"){if(typeof Y.SetVariable!=D){X=Y}else{var Z=Y.getElementsByTagName(r)[0];if(Z){X=Z}}}return X}function A(){return!a&&F("6.0.65")&&(M.win||M.mac)&&!(M.wk&&M.wk<312)}function P(aa,ab,X,Z){a=true;E=Z||null;B={success:false,id:X};var ae=c(X);if(ae){if(ae.nodeName=="OBJECT"){l=g(ae);Q=null}else{l=ae;Q=X}aa.id=R;if(typeof aa.width==D||!/%$/.test(aa.width)&&parseInt(aa.width,10)<310){aa.width="310"}if(typeof aa.height==D||!/%$/.test(aa.height)&&parseInt(aa.height,10)<137){aa.height="137"}j.title=j.title.slice(0,47)+" - Flash Player Installation";var ad=M.ie&&M.win?["Active"].concat("").join("X"):"PlugIn",ac="MMredirectURL="+O.location.toString().replace(/&/g,"%26")+"&MMplayerType="+ad+"&MMdoctitle="+j.title;if(typeof ab.flashvars!=D){ab.flashvars+="&"+ac}else{ab.flashvars=ac}if(M.ie&&M.win&&ae.readyState!=4){var Y=C("div");X+="SWFObjectNew";Y.setAttribute("id",X);ae.parentNode.insertBefore(Y,ae);ae.style.display="none";(function(){if(ae.readyState==4){ae.parentNode.removeChild(ae)}else{setTimeout(arguments.callee,10)}})()}u(aa,ab,X)}}function p(Y){if(M.ie&&M.win&&Y.readyState!=4){var X=C("div");Y.parentNode.insertBefore(X,Y);X.parentNode.replaceChild(g(Y),X);Y.style.display="none";(function(){if(Y.readyState==4){Y.parentNode.removeChild(Y)}else{setTimeout(arguments.callee,10)}})()}else{Y.parentNode.replaceChild(g(Y),Y)}}function g(ab){var aa=C("div");if(M.win&&M.ie){aa.innerHTML=ab.innerHTML}else{var Y=ab.getElementsByTagName(r)[0];if(Y){var ad=Y.childNodes;if(ad){var X=ad.length;for(var Z=0;Z<X;Z++){if(!(ad[Z].nodeType==1&&ad[Z].nodeName=="PARAM")&&!(ad[Z].nodeType==8)){aa.appendChild(ad[Z].cloneNode(true))}}}}}return aa}function u(ai,ag,Y){var X,aa=c(Y);if(M.wk&&M.wk<312){return X}if(aa){if(typeof ai.id==D){ai.id=Y}if(M.ie&&M.win){var ah="";for(var ae in ai){if(ai[ae]!=Object.prototype[ae]){if(ae.toLowerCase()=="data"){ag.movie=ai[ae]}else{if(ae.toLowerCase()=="styleclass"){ah+=' class="'+ai[ae]+'"'}else{if(ae.toLowerCase()!="classid"){ah+=" "+ae+'="'+ai[ae]+'"'}}}}}var af="";for(var ad in ag){if(ag[ad]!=Object.prototype[ad]){af+='<param name="'+ad+'" value="'+ag[ad]+'" />'}}aa.outerHTML='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"'+ah+">"+af+"</object>";N[N.length]=ai.id;X=c(ai.id)}else{var Z=C(r);Z.setAttribute("type",q);for(var ac in ai){if(ai[ac]!=Object.prototype[ac]){if(ac.toLowerCase()=="styleclass"){Z.setAttribute("class",ai[ac])}else{if(ac.toLowerCase()!="classid"){Z.setAttribute(ac,ai[ac])}}}}for(var ab in ag){if(ag[ab]!=Object.prototype[ab]&&ab.toLowerCase()!="movie"){e(Z,ab,ag[ab])}}aa.parentNode.replaceChild(Z,aa);X=Z}}return X}function e(Z,X,Y){var aa=C("param");aa.setAttribute("name",X);aa.setAttribute("value",Y);Z.appendChild(aa)}function y(Y){var X=c(Y);if(X&&X.nodeName=="OBJECT"){if(M.ie&&M.win){X.style.display="none";(function(){if(X.readyState==4){b(Y)}else{setTimeout(arguments.callee,10)}})()}else{X.parentNode.removeChild(X)}}}function b(Z){var Y=c(Z);if(Y){for(var X in Y){if(typeof Y[X]=="function"){Y[X]=null}}Y.parentNode.removeChild(Y)}}function c(Z){var X=null;try{X=j.getElementById(Z)}catch(Y){}return X}function C(X){return j.createElement(X)}function i(Z,X,Y){Z.attachEvent(X,Y);I[I.length]=[Z,X,Y]}function F(Z){var Y=M.pv,X=Z.split(".");X[0]=parseInt(X[0],10);X[1]=parseInt(X[1],10)||0;X[2]=parseInt(X[2],10)||0;return Y[0]>X[0]||Y[0]==X[0]&&Y[1]>X[1]||Y[0]==X[0]&&Y[1]==X[1]&&Y[2]>=X[2]?true:false}function v(ac,Y,ad,ab){if(M.ie&&M.mac){return}var aa=j.getElementsByTagName("head")[0];if(!aa){return}var X=ad&&typeof ad=="string"?ad:"screen";if(ab){n=null;G=null}if(!n||G!=X){var Z=C("style");Z.setAttribute("type","text/css");Z.setAttribute("media",X);n=aa.appendChild(Z);if(M.ie&&M.win&&typeof j.styleSheets!=D&&j.styleSheets.length>0){n=j.styleSheets[j.styleSheets.length-1]}G=X}if(M.ie&&M.win){if(n&&typeof n.addRule==r){n.addRule(ac,Y)}}else{if(n&&typeof j.createTextNode!=D){n.appendChild(j.createTextNode(ac+" {"+Y+"}"))}}}function w(Z,X){if(!m){return}var Y=X?"visible":"hidden";if(J&&c(Z)){c(Z).style.visibility=Y}else{v("#"+Z,"visibility:"+Y)}}function L(Y){var Z=/[\\\"<>\.;]/;var X=Z.exec(Y)!=null;return X&&typeof encodeURIComponent!=D?encodeURIComponent(Y):Y}var d=function(){if(M.ie&&M.win){window.attachEvent("onunload",function(){var ac=I.length;for(var ab=0;ab<ac;ab++){I[ab][0].detachEvent(I[ab][1],I[ab][2])}var Z=N.length;for(var aa=0;aa<Z;aa++){y(N[aa])}for(var Y in M){M[Y]=null}M=null;for(var X in swfobject){swfobject[X]=null}swfobject=null})}}();return{registerObject:function(ab,X,aa,Z){if(M.w3&&ab&&X){var Y={};Y.id=ab;Y.swfVersion=X;Y.expressInstall=aa;Y.callbackFn=Z;o[o.length]=Y;w(ab,false)}else{if(Z){Z({success:false,id:ab})}}},getObjectById:function(X){if(M.w3){return z(X)}},embedSWF:function(ab,ah,ae,ag,Y,aa,Z,ad,af,ac){var X={success:false,id:ah};if(M.w3&&!(M.wk&&M.wk<312)&&ab&&ah&&ae&&ag&&Y){w(ah,false);K(function(){ae+="";ag+="";var aj={};if(af&&typeof af===r){for(var al in af){aj[al]=af[al]}}aj.data=ab;aj.width=ae;aj.height=ag;var am={};if(ad&&typeof ad===r){for(var ak in ad){am[ak]=ad[ak]}}if(Z&&typeof Z===r){for(var ai in Z){if(typeof am.flashvars!=D){am.flashvars+="&"+ai+"="+Z[ai]}else{am.flashvars=ai+"="+Z[ai]}}}if(F(Y)){var an=u(aj,am,ah);if(aj.id==ah){w(ah,true)}X.success=true;X.ref=an}else{if(aa&&A()){aj.data=aa;P(aj,am,ah,ac);return}else{w(ah,true)}}if(ac){ac(X)}})}else{if(ac){ac(X)}}},switchOffAutoHideShow:function(){m=false},ua:M,getFlashPlayerVersion:function(){return{major:M.pv[0],minor:M.pv[1],release:M.pv[2]}},hasFlashPlayerVersion:F,createSWF:function(Z,Y,X){if(M.w3){return u(Z,Y,X)}else{return undefined}},showExpressInstall:function(Z,aa,X,Y){if(M.w3&&A()){P(Z,aa,X,Y)}},removeSWF:function(X){if(M.w3){y(X)}},createCSS:function(aa,Z,Y,X){if(M.w3){v(aa,Z,Y,X)}},addDomLoadEvent:K,addLoadEvent:s,getQueryParamValue:function(aa){var Z=j.location.search||j.location.hash;if(Z){if(/\?/.test(Z)){Z=Z.split("?")[1]}if(aa==null){return L(Z)}var Y=Z.split("&");for(var X=0;X<Y.length;X++){if(Y[X].substring(0,Y[X].indexOf("="))==aa){return L(Y[X].substring(Y[X].indexOf("=")+1))}}}return""},expressInstallCallback:function(){if(a){var X=c(R);if(X&&l){X.parentNode.replaceChild(l,X);if(Q){w(Q,true);if(M.ie&&M.win){l.style.display="block"}}if(E){E(B)}}a=false}}}}()}(function(){if("undefined"==typeof window||window.WebSocket)return;var console=window.console;if(!console||!console.log||!console.error){console={log:function(){},error:function(){}}}if(!swfobject.hasFlashPlayerVersion("10.0.0")){console.error("Flash Player >= 10.0.0 is required.");return}if(location.protocol=="file:"){console.error("WARNING: web-socket-js doesn't work in file:///... URL "+"unless you set Flash Security Settings properly. "+"Open the page via Web server i.e. http://...")}WebSocket=function(url,protocols,proxyHost,proxyPort,headers){var self=this;self.__id=WebSocket.__nextId++;WebSocket.__instances[self.__id]=self;self.readyState=WebSocket.CONNECTING;self.bufferedAmount=0;self.__events={};if(!protocols){protocols=[]}else if(typeof protocols=="string"){protocols=[protocols]}setTimeout(function(){WebSocket.__addTask(function(){WebSocket.__flash.create(self.__id,url,protocols,proxyHost||null,proxyPort||0,headers||null)})},0)};WebSocket.prototype.send=function(data){if(this.readyState==WebSocket.CONNECTING){throw"INVALID_STATE_ERR: Web Socket connection has not been established"}var result=WebSocket.__flash.send(this.__id,encodeURIComponent(data));if(result<0){return true}else{this.bufferedAmount+=result;return false}};WebSocket.prototype.close=function(){if(this.readyState==WebSocket.CLOSED||this.readyState==WebSocket.CLOSING){return}this.readyState=WebSocket.CLOSING;WebSocket.__flash.close(this.__id)};WebSocket.prototype.addEventListener=function(type,listener,useCapture){if(!(type in this.__events)){this.__events[type]=[]}this.__events[type].push(listener)};WebSocket.prototype.removeEventListener=function(type,listener,useCapture){if(!(type in this.__events))return;var events=this.__events[type];for(var i=events.length-1;i>=0;--i){if(events[i]===listener){events.splice(i,1);break}}};WebSocket.prototype.dispatchEvent=function(event){var events=this.__events[event.type]||[];for(var i=0;i<events.length;++i){events[i](event)}var handler=this["on"+event.type];if(handler)handler(event)};WebSocket.prototype.__handleEvent=function(flashEvent){if("readyState"in flashEvent){this.readyState=flashEvent.readyState}if("protocol"in flashEvent){this.protocol=flashEvent.protocol}var jsEvent;if(flashEvent.type=="open"||flashEvent.type=="error"){jsEvent=this.__createSimpleEvent(flashEvent.type)}else if(flashEvent.type=="close"){jsEvent=this.__createSimpleEvent("close")}else if(flashEvent.type=="message"){var data=decodeURIComponent(flashEvent.message);jsEvent=this.__createMessageEvent("message",data)}else{throw"unknown event type: "+flashEvent.type}this.dispatchEvent(jsEvent)};WebSocket.prototype.__createSimpleEvent=function(type){if(document.createEvent&&window.Event){var event=document.createEvent("Event");event.initEvent(type,false,false);return event}else{return{type:type,bubbles:false,cancelable:false}}};WebSocket.prototype.__createMessageEvent=function(type,data){if(document.createEvent&&window.MessageEvent&&!window.opera){var event=document.createEvent("MessageEvent");event.initMessageEvent("message",false,false,data,null,null,window,null);return event}else{return{type:type,data:data,bubbles:false,cancelable:false}}};WebSocket.CONNECTING=0;WebSocket.OPEN=1;WebSocket.CLOSING=2;WebSocket.CLOSED=3;WebSocket.__flash=null;WebSocket.__instances={};WebSocket.__tasks=[];WebSocket.__nextId=0;WebSocket.loadFlashPolicyFile=function(url){WebSocket.__addTask(function(){WebSocket.__flash.loadManualPolicyFile(url)})};WebSocket.__initialize=function(){if(WebSocket.__flash)return;if(WebSocket.__swfLocation){window.WEB_SOCKET_SWF_LOCATION=WebSocket.__swfLocation}if(!window.WEB_SOCKET_SWF_LOCATION){console.error("[WebSocket] set WEB_SOCKET_SWF_LOCATION to location of WebSocketMain.swf");return}var container=document.createElement("div");container.id="webSocketContainer";container.style.position="absolute";if(WebSocket.__isFlashLite()){container.style.left="0px";container.style.top="0px"}else{container.style.left="-100px";container.style.top="-100px"}var holder=document.createElement("div");holder.id="webSocketFlash";container.appendChild(holder);document.body.appendChild(container);swfobject.embedSWF(WEB_SOCKET_SWF_LOCATION,"webSocketFlash","1","1","10.0.0",null,null,{hasPriority:true,swliveconnect:true,allowScriptAccess:"always"},null,function(e){if(!e.success){console.error("[WebSocket] swfobject.embedSWF failed")}})};WebSocket.__onFlashInitialized=function(){setTimeout(function(){WebSocket.__flash=document.getElementById("webSocketFlash");WebSocket.__flash.setCallerUrl(location.href);WebSocket.__flash.setDebug(!!window.WEB_SOCKET_DEBUG);for(var i=0;i<WebSocket.__tasks.length;++i){WebSocket.__tasks[i]()}WebSocket.__tasks=[]},0)};WebSocket.__onFlashEvent=function(){setTimeout(function(){try{var events=WebSocket.__flash.receiveEvents();for(var i=0;i<events.length;++i){WebSocket.__instances[events[i].webSocketId].__handleEvent(events[i])}}catch(e){console.error(e)}},0);return true};WebSocket.__log=function(message){console.log(decodeURIComponent(message))};WebSocket.__error=function(message){console.error(decodeURIComponent(message))};WebSocket.__addTask=function(task){if(WebSocket.__flash){task()}else{WebSocket.__tasks.push(task)}};WebSocket.__isFlashLite=function(){if(!window.navigator||!window.navigator.mimeTypes){return false}var mimeType=window.navigator.mimeTypes["application/x-shockwave-flash"];if(!mimeType||!mimeType.enabledPlugin||!mimeType.enabledPlugin.filename){return false}return mimeType.enabledPlugin.filename.match(/flashlite/i)?true:false};if(!window.WEB_SOCKET_DISABLE_AUTO_INITIALIZATION){if(window.addEventListener){window.addEventListener("load",function(){WebSocket.__initialize()},false)}else{window.attachEvent("onload",function(){WebSocket.__initialize()})}}})();(function(exports,io,global){exports.XHR=XHR;function XHR(socket){if(!socket)return;io.Transport.apply(this,arguments);this.sendBuffer=[]}io.util.inherit(XHR,io.Transport);XHR.prototype.open=function(){this.socket.setBuffer(false);this.onOpen();this.get();this.setCloseTimeout();return this};XHR.prototype.payload=function(payload){var msgs=[];for(var i=0,l=payload.length;i<l;i++){msgs.push(io.parser.encodePacket(payload[i]))}this.send(io.parser.encodePayload(msgs))};XHR.prototype.send=function(data){this.post(data);return this};function empty(){}XHR.prototype.post=function(data){var self=this;this.socket.setBuffer(true);function stateChange(){if(this.readyState==4){this.onreadystatechange=empty;self.posting=false;if(this.status==200){self.socket.setBuffer(false)}else{self.onClose()}}}function onload(){this.onload=empty;self.socket.setBuffer(false)}this.sendXHR=this.request("POST");if(global.XDomainRequest&&this.sendXHR instanceof XDomainRequest){this.sendXHR.onload=this.sendXHR.onerror=onload}else{this.sendXHR.onreadystatechange=stateChange}this.sendXHR.send(data)};XHR.prototype.close=function(){this.onClose();return this};XHR.prototype.request=function(method){var req=io.util.request(this.socket.isXDomain()),query=io.util.query(this.socket.options.query,"t="+ +new Date);req.open(method||"GET",this.prepareUrl()+query,true);if(method=="POST"){try{if(req.setRequestHeader){req.setRequestHeader("Content-type","text/plain;charset=UTF-8")}else{req.contentType="text/plain"}}catch(e){}}return req};XHR.prototype.scheme=function(){return this.socket.options.secure?"https":"http"};XHR.check=function(socket,xdomain){try{var request=io.util.request(xdomain),usesXDomReq=global.XDomainRequest&&request instanceof XDomainRequest,socketProtocol=socket&&socket.options&&socket.options.secure?"https:":"http:",isXProtocol=global.location&&socketProtocol!=global.location.protocol;if(request&&!(usesXDomReq&&isXProtocol)){return true}}catch(e){}return false};XHR.xdomainCheck=function(socket){return XHR.check(socket,true)}})("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this);(function(exports,io){exports.htmlfile=HTMLFile;function HTMLFile(socket){io.Transport.XHR.apply(this,arguments)}io.util.inherit(HTMLFile,io.Transport.XHR);HTMLFile.prototype.name="htmlfile";HTMLFile.prototype.get=function(){this.doc=new(window[["Active"].concat("Object").join("X")])("htmlfile");this.doc.open();this.doc.write("<html></html>");this.doc.close();this.doc.parentWindow.s=this;var iframeC=this.doc.createElement("div");iframeC.className="socketio";this.doc.body.appendChild(iframeC);this.iframe=this.doc.createElement("iframe");iframeC.appendChild(this.iframe);var self=this,query=io.util.query(this.socket.options.query,"t="+ +new Date);this.iframe.src=this.prepareUrl()+query;io.util.on(window,"unload",function(){self.destroy()})};HTMLFile.prototype._=function(data,doc){data=data.replace(/\\\//g,"/");this.onData(data);try{var script=doc.getElementsByTagName("script")[0];script.parentNode.removeChild(script)}catch(e){}};HTMLFile.prototype.destroy=function(){if(this.iframe){try{this.iframe.src="about:blank"}catch(e){}this.doc=null;this.iframe.parentNode.removeChild(this.iframe);this.iframe=null;CollectGarbage()}};HTMLFile.prototype.close=function(){this.destroy();return io.Transport.XHR.prototype.close.call(this)};HTMLFile.check=function(socket){if(typeof window!="undefined"&&["Active"].concat("Object").join("X")in window){try{var a=new(window[["Active"].concat("Object").join("X")])("htmlfile");return a&&io.Transport.XHR.check(socket)}catch(e){}}return false};HTMLFile.xdomainCheck=function(){return false};io.transports.push("htmlfile")})("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports);(function(exports,io,global){exports["xhr-polling"]=XHRPolling;function XHRPolling(){io.Transport.XHR.apply(this,arguments)}io.util.inherit(XHRPolling,io.Transport.XHR);io.util.merge(XHRPolling,io.Transport.XHR);XHRPolling.prototype.name="xhr-polling";XHRPolling.prototype.heartbeats=function(){return false};XHRPolling.prototype.open=function(){var self=this;io.Transport.XHR.prototype.open.call(self);return false};function empty(){}XHRPolling.prototype.get=function(){if(!this.isOpen)return;var self=this;function stateChange(){if(this.readyState==4){this.onreadystatechange=empty;if(this.status==200){self.onData(this.responseText);self.get()}else{self.onClose()}}}function onload(){this.onload=empty;this.onerror=empty;self.retryCounter=1;self.onData(this.responseText);self.get()}function onerror(){self.retryCounter++;if(!self.retryCounter||self.retryCounter>3){self.onClose()}else{self.get()}}this.xhr=this.request();if(global.XDomainRequest&&this.xhr instanceof XDomainRequest){this.xhr.onload=onload;this.xhr.onerror=onerror}else{this.xhr.onreadystatechange=stateChange}this.xhr.send(null)};XHRPolling.prototype.onClose=function(){io.Transport.XHR.prototype.onClose.call(this);if(this.xhr){this.xhr.onreadystatechange=this.xhr.onload=this.xhr.onerror=empty;try{this.xhr.abort()}catch(e){}this.xhr=null}};XHRPolling.prototype.ready=function(socket,fn){var self=this;io.util.defer(function(){fn.call(self)})};io.transports.push("xhr-polling")})("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this);(function(exports,io,global){var indicator=global.document&&"MozAppearance"in global.document.documentElement.style;exports["jsonp-polling"]=JSONPPolling;function JSONPPolling(socket){io.Transport["xhr-polling"].apply(this,arguments);this.index=io.j.length;var self=this;io.j.push(function(msg){self._(msg)})}io.util.inherit(JSONPPolling,io.Transport["xhr-polling"]);JSONPPolling.prototype.name="jsonp-polling";JSONPPolling.prototype.post=function(data){var self=this,query=io.util.query(this.socket.options.query,"t="+ +new Date+"&i="+this.index);if(!this.form){var form=document.createElement("form"),area=document.createElement("textarea"),id=this.iframeId="socketio_iframe_"+this.index,iframe;form.className="socketio";form.style.position="absolute";form.style.top="0px";form.style.left="0px";form.style.display="none";form.target=id;form.method="POST";form.setAttribute("accept-charset","utf-8");area.name="d";form.appendChild(area);document.body.appendChild(form);this.form=form;this.area=area}this.form.action=this.prepareUrl()+query;function complete(){initIframe();self.socket.setBuffer(false)}function initIframe(){if(self.iframe){self.form.removeChild(self.iframe)}try{iframe=document.createElement('<iframe name="'+self.iframeId+'">')}catch(e){iframe=document.createElement("iframe");iframe.name=self.iframeId}iframe.id=self.iframeId;self.form.appendChild(iframe);self.iframe=iframe}initIframe();this.area.value=io.JSON.stringify(data);try{this.form.submit()}catch(e){}if(this.iframe.attachEvent){iframe.onreadystatechange=function(){if(self.iframe.readyState=="complete"){complete()}}}else{this.iframe.onload=complete}this.socket.setBuffer(true)};JSONPPolling.prototype.get=function(){var self=this,script=document.createElement("script"),query=io.util.query(this.socket.options.query,"t="+ +new Date+"&i="+this.index);if(this.script){this.script.parentNode.removeChild(this.script);this.script=null}script.async=true;script.src=this.prepareUrl()+query;script.onerror=function(){self.onClose()};var insertAt=document.getElementsByTagName("script")[0];insertAt.parentNode.insertBefore(script,insertAt);this.script=script;if(indicator){setTimeout(function(){var iframe=document.createElement("iframe");document.body.appendChild(iframe);document.body.removeChild(iframe)},100)}};JSONPPolling.prototype._=function(msg){this.onData(msg);if(this.isOpen){this.get()}return this};JSONPPolling.prototype.ready=function(socket,fn){var self=this;if(!indicator)return fn.call(this);io.util.load(function(){fn.call(self)})};JSONPPolling.check=function(){return"document"in global};JSONPPolling.xdomainCheck=function(){return true};io.transports.push("jsonp-polling")})("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this);if(true){!(__WEBPACK_AMD_DEFINE_ARRAY__=[],__WEBPACK_AMD_DEFINE_RESULT__=function(){return io}.apply(exports,__WEBPACK_AMD_DEFINE_ARRAY__),__WEBPACK_AMD_DEFINE_RESULT__!==undefined&&(module.exports=__WEBPACK_AMD_DEFINE_RESULT__))}})()}).call(exports,__webpack_require__(15)(module))},function(module,exports){module.exports=function(module){if(!module.webpackPolyfill){module.deprecate=function(){};module.paths=[];module.children=[];module.webpackPolyfill=1}return module}},function(module,exports,__webpack_require__){(function(root,factory){if(true){module.exports=factory()}else if(typeof define==="function"&&define.amd){define([],factory)}else{root.urltemplate=factory()}})(this,function(){function UrlTemplate(){}UrlTemplate.prototype.encodeReserved=function(str){return str.split(/(%[0-9A-Fa-f]{2})/g).map(function(part){if(!/%[0-9A-Fa-f]/.test(part)){part=encodeURI(part)}return part}).join("")};UrlTemplate.prototype.encodeValue=function(operator,value,key){value=operator==="+"||operator==="#"?this.encodeReserved(value):encodeURIComponent(value);if(key){return encodeURIComponent(key)+"="+value}else{return value}};UrlTemplate.prototype.isDefined=function(value){return value!==undefined&&value!==null};UrlTemplate.prototype.isKeyOperator=function(operator){return operator===";"||operator==="&"||operator==="?"};UrlTemplate.prototype.getValues=function(context,operator,key,modifier){var value=context[key],result=[];if(this.isDefined(value)&&value!==""){if(typeof value==="string"||typeof value==="number"||typeof value==="boolean"){value=value.toString();if(modifier&&modifier!=="*"){value=value.substring(0,parseInt(modifier,10))}result.push(this.encodeValue(operator,value,this.isKeyOperator(operator)?key:null))}else{if(modifier==="*"){if(Array.isArray(value)){value.filter(this.isDefined).forEach(function(value){result.push(this.encodeValue(operator,value,this.isKeyOperator(operator)?key:null))},this)}else{Object.keys(value).forEach(function(k){if(this.isDefined(value[k])){result.push(this.encodeValue(operator,value[k],k))}},this)}}else{var tmp=[];if(Array.isArray(value)){value.filter(this.isDefined).forEach(function(value){tmp.push(this.encodeValue(operator,value))},this)}else{Object.keys(value).forEach(function(k){if(this.isDefined(value[k])){tmp.push(encodeURIComponent(k));tmp.push(this.encodeValue(operator,value[k].toString()))}},this)}if(this.isKeyOperator(operator)){result.push(encodeURIComponent(key)+"="+tmp.join(","))}else if(tmp.length!==0){result.push(tmp.join(","))}}}}else{if(operator===";"){result.push(encodeURIComponent(key))}else if(value===""&&(operator==="&"||operator==="?")){result.push(encodeURIComponent(key)+"=")}else if(value===""){result.push("")}}return result};UrlTemplate.prototype.parse=function(template){var that=this;var operators=["+","#",".","/",";","?","&"];return{expand:function(context){return template.replace(/\{([^\{\}]+)\}|([^\{\}]+)/g,function(_,expression,literal){if(expression){var operator=null,values=[];if(operators.indexOf(expression.charAt(0))!==-1){operator=expression.charAt(0);expression=expression.substr(1)}expression.split(/,/g).forEach(function(variable){var tmp=/([^:\*]*)(?::(\d+)|(\*))?/.exec(variable);values.push.apply(values,that.getValues(context,operator,tmp[1],tmp[2]||tmp[3]))});if(operator&&operator!=="+"){var separator=",";if(operator==="?"){separator="&"}else if(operator!=="#"){separator=operator}return(values.length!==0?operator:"")+values.join(separator)}else{return values.join(",")}}else{return that.encodeReserved(literal)}})}}};return new UrlTemplate})},function(module,exports,__webpack_require__){var Q=__webpack_require__(6);var respoke=__webpack_require__(1);var log=respoke.log;module.exports=function(params){"use strict";params=params||{};var instanceId=params.instanceId;var that=respoke.EventEmitter(params);delete that.instanceId;that.className="respoke.DirectConnection";that.id=respoke.makeGUID();if(!that.call.caller){that.call.caller=false}var dataChannel=null;var client=respoke.getClient(instanceId);var pc=params.pc;delete params.pc;function listenDataChannel(evt){dataChannel=evt.channel;dataChannel.onerror=onDataChannelError;dataChannel.onmessage=onDataChannelMessage;if(dataChannel.readyState==="open"){dataChannel.onopen=null;onDataChannelOpen()}else{dataChannel.onopen=onDataChannelOpen}}function saveParameters(params){that.listen("open",params.onOpen);that.listen("close",params.onClose);that.listen("message",params.onMessage);that.listen("start",params.onStart);that.listen("error",params.onError);pc.listen("direct-connection",listenDataChannel,true);pc.listen("stats",function fireStats(evt){that.fire("stats",{stats:evt.stats})},true)}saveParameters(params);delete that.onOpen;delete that.onClose;delete that.onMessage;that.getStats=function(params){if(pc&&pc.getStats){that.listen("stats",params.onStats);delete params.onStats;return pc.getStats(params)}return null};if(!respoke.MediaStats){delete that.getStats}function onDataChannelError(error){that.fire("error",{error:error});that.close()}function onDataChannelMessage(evt){var message;try{message=JSON.parse(evt.data)}catch(e){message=evt.data}that.call.remoteEndpoint.fire("message",{message:message,directConnection:that});that.fire("message",{message:message,endpoint:that.call.remoteEndpoint})}function onDataChannelOpen(evt){that.fire("open")}function onDataChannelClose(evt){that.fire("close")}function createDataChannel(){dataChannel=pc.createDataChannel("respokeDataChannel");dataChannel.binaryType="arraybuffer";dataChannel.onerror=onDataChannelError;dataChannel.onmessage=onDataChannelMessage;dataChannel.onopen=onDataChannelOpen;that.fire("start")}that.accept=function(params){params=params||{};log.debug("DirectConnection.accept");saveParameters(params);log.debug("I am "+(pc.state.caller?"":"not ")+"the caller.");if(pc.state.caller===true){createDataChannel()}that.call.answer();that.fire("accept")};that.close=function(params){params=params||{};log.debug("DirectConnection.close");if(that.call&&that.call.remoteEndpoint){that.call.remoteEndpoint.directConnection=null}if(dataChannel){dataChannel.close()}that.fire("close");that.ignore();if(that.call&&params.skipRemove!==true){that.call.removeDirectConnection()}dataChannel=null;that.call=null;pc=null};that.sendMessage=function(params){var deferred=Q.defer();var retVal=respoke.handlePromise(deferred.promise,params.onSuccess,params.onError);if(that.isActive()){dataChannel.send(JSON.stringify(params.object||{message:params.message}));deferred.resolve()}else{deferred.reject(new Error("dataChannel not in an open state."))}return retVal};that.reject=that.close;that.isActive=function(){return dataChannel&&dataChannel.readyState==="open"};return that}},function(module,exports,__webpack_require__){var Q=__webpack_require__(6);var respoke=__webpack_require__(1);var log=respoke.log;var Statechart=__webpack_require__(19);module.exports=function(params){"use strict";params=params||{};var instanceId=params.instanceId;var that=respoke.EventEmitter(params);delete that.instanceId;that.className="respoke.PeerConnection";var toSendHangup;var pc=null;var defModify;var previewLocalMedia=typeof params.previewLocalMedia==="function"?params.previewLocalMedia:undefined;var candidateReceivingQueue=respoke.queueFactory();var client=respoke.getClient(instanceId);var signalOffer=params.signalOffer;var signalConnected=params.signalConnected;var signalModify=params.signalModify;var signalAnswer=params.signalAnswer;var signalHangup=respoke.callOnce(params.signalHangup);var signalReport=params.signalReport;var signalCandidateOrig=params.signalCandidate;var digitSender=null;var cancellingTones=false;function signalCandidates(params){if(!pc){return Q.resolve()}params.call=that.call;that.report.candidatesSent=that.report.candidatesSent.concat(params.iceCandidates);return signalCandidateOrig(params)}that.sdpExpectedStreamCount=0;var offerOptions=params.offerOptions||{};var pcOptions=params.pcOptions||{optional:[{DtlsSrtpKeyAgreement:true},{RtpDataChannels:false}]};that.report={callStarted:0,callStopped:0,callerendpoint:that.call.caller?client.name:that.call.remoteEndpoint.id,callerconnection:that.call.caller?client.id:that.call.connectionId,calleeendpoint:that.call.caller?that.call.remoteEndpoint.id:client.id,calleeconnection:that.call.caller?that.call.connectionId:client.connectionId,sessionId:that.call.id,lastSDPString:"",sdpsSent:[],sdpsReceived:[],candidatesSent:[],candidatesReceived:[],userAgent:navigator.userAgent,os:navigator.platform};function initOffer(){if(!pc){return}if(that.state.receiveOnly){makeOptionsReceiveOnly(offerOptions)}if(that.state.sendOnly){makeOptionsSendOnly(offerOptions)}log.info("creating offer",offerOptions);pc.createOffer(saveOfferAndSend,function errorHandler(p){log.error("createOffer failed")},offerOptions)}function makeOptionsReceiveOnly(options){if(navigator.webkitGetUserMedia){options.mandatory={OfferToReceiveVideo:true,OfferToReceiveAudio:true,OfferToSendVideo:false,OfferToSendAudio:false}}else{options.offerToReceiveVideo=true;options.offerToReceiveAudio=true;options.offerToSendVideo=false;options.offerToSendAudio=false}}function makeOptionsSendOnly(options){if(navigator.webkitGetUserMedia){options.mandatory={OfferToSendVideo:true,OfferToSendAudio:true,OfferToReceiveVideo:false,OfferToReceiveAudio:false}}else{options.offerToSendVideo=true;options.offerToSendAudio=true;options.offerToReceiveVideo=false;options.offerToReceiveAudio=false}}var localCandidates=[];var localCandidatesComplete=false;var localCandidatesSent=0;var localCandidatesFSM;function localCandidatesRemaining(){return localCandidates.length-localCandidatesSent}function collectLocalIceCandidate(params){if(params&&params.candidate){localCandidates.push(params.candidate)}}function sendRemainingCandidates(){var remainingCandidates=localCandidates.slice(localCandidatesSent);var params={iceCandidates:remainingCandidates};localCandidatesSent+=remainingCandidates.length;if(localCandidatesComplete){params.finalCandidates=localCandidates}signalCandidates(params).finally(function(){localCandidatesFSM.dispatch("iceSent")}).done()}localCandidatesFSM=respoke.Class({that:Object.create(Statechart),initialState:"buffering",states:{buffering:{localIceCandidate:{action:collectLocalIceCandidate},ready:{target:"sending",action:sendRemainingCandidates}},sending:{localIceCandidate:{action:collectLocalIceCandidate},iceSent:[{guard:function(){return localCandidatesRemaining()===0},target:"waiting"},{guard:function(){return localCandidatesRemaining()!==0},action:sendRemainingCandidates}]},waiting:{localIceCandidate:{action:function(params){collectLocalIceCandidate(params);sendRemainingCandidates()},target:"sending"}}}});localCandidatesFSM.run();that.processOffer=function(oOffer){if(!pc){return}log.debug("processOffer",oOffer);that.report.sdpsReceived.push(oOffer);that.report.lastSDPString=oOffer.sdp;that.sdpExpectedStreamCount=respoke.sdpStreamCount(oOffer.sdp);that.call.hasDataChannel=respoke.sdpHasDataChannel(oOffer.sdp);try{pc.setRemoteDescription(new RTCSessionDescription(oOffer),function successHandler(){if(!pc){
return}processReceivingQueue();log.debug("set remote desc of offer succeeded");pc.createAnswer(function successHandler(oSession){that.state.processedRemoteSDP=true;saveAnswerAndSend(oSession)},function errorHandler(err){err=new Error("Error creating SDP answer."+err.message);that.report.callStoppedReason=err.message;that.call.fire("error",{message:err.message});log.error("create answer failed");that.report.callStoppedReason="setRemoteDescription failed at answer.";that.close()})},function errorHandler(err){err=new Error("Error calling setRemoteDescription on offer I received."+err.message);that.report.callStoppedReason=err.message;that.call.fire("error",{message:err.message})})}catch(err){var newErr=new Error("Exception calling setRemoteDescription on offer I received."+err.message);that.report.callStoppedReason=newErr.message;that.call.fire("error",{message:newErr.message})}};function getStats(params){var deferred=Q.defer();var retVal=respoke.handlePromise(deferred.promise,params.onSuccess,params.onError);if(!respoke.MediaStats){deferred.reject(new Error("Statistics module is not loaded."));return retVal}function onConnect(){var stats=respoke.MediaStatsParser({peerConnection:pc,interval:params.interval,onStats:function statsHandler(stats){if(!pc){return}that.fire("stats",{stats:stats})}});that.listen("close",function closeHandler(evt){stats.stopStats()},true);deferred.resolve()}if(!pc){that.once("stream-received",onConnect)}else{onConnect()}return retVal}if(respoke.MediaStats){that.getStats=getStats}that.init=function init(){log.debug("PC.init");if(pc){return}that.report.callStarted=(new Date).getTime();pc=new RTCPeerConnection(that.servers,pcOptions);pc.onicecandidate=onIceCandidate;pc.onnegotiationneeded=onNegotiationNeeded;pc.oniceconnectionstatechange=onIceConnectionStateChange;pc.onaddstream=function onaddstream(evt){that.fire("remote-stream-received",{stream:evt.stream})};pc.onremovestream=function onremovestream(evt){that.fire("remote-stream-removed",{stream:evt.stream})};pc.ondatachannel=function ondatachannel(evt){that.fire("direct-connection",{channel:evt.channel})};that.state.listen("offering:entry",function(evt){if(that.state.caller){initOffer()}})};that.getRemoteStreams=function(){if(!pc){return[]}return pc.getRemoteStreams.apply(pc,Array.prototype.slice.call(arguments))};that.getLocalStreams=function(){if(!pc){return[]}return pc.getLocalStreams.apply(pc,Array.prototype.slice.call(arguments))};that.createDataChannel=function(){if(!pc){return}return pc.createDataChannel.apply(pc,Array.prototype.slice.call(arguments))};that.addStream=function(stream){if(!pc){that.call.fire("error",{message:"Got local stream in a precall state."});return}pc.addStream(stream)};function onIceCandidate(oCan){var candidate=oCan.candidate;if(!pc){return}if(!candidate||!candidate.candidate){if(pc.iceGatheringState==="complete"){localCandidatesComplete=true;localCandidatesFSM.dispatch("localIceCandidate")}return}if(that.forceTurn===true&&candidate.candidate.indexOf("typ relay")===-1){log.debug("Dropping candidate because forceTurn is on.");return}else if(that.disableTurn===true&&candidate.candidate.indexOf("typ relay")!==-1){log.debug("Dropping candidate because disableTurn is on.");return}localCandidatesFSM.dispatch("localIceCandidate",{candidate:candidate})}function onIceConnectionStateChange(evt){if(!pc){return}if(pc.iceConnectionState==="connected"){that.fire("connect")}}function onNegotiationNeeded(){log.warn("Negotiation needed.")}function processReceivingQueue(){candidateReceivingQueue.trigger(function processIce(can){if(!pc){return}pc.addIceCandidate(new RTCIceCandidate(can.candidate),function onSuccess(){log.debug(that.state.caller?"caller":"callee","got a remote candidate.",can.candidate);that.report.candidatesReceived.push(can.candidate)},function onError(e){log.error("Couldn't add ICE candidate: "+e.message,can.candidate)})})}function saveOfferAndSend(oSession){oSession.type="offer";if(!pc){return}log.debug("setting and sending offer",oSession);that.report.sdpsSent.push(oSession);pc.setLocalDescription(oSession,function successHandler(p){oSession.type="offer";signalOffer({call:that.call,sessionDescription:oSession,onSuccess:function(){that.state.sentSDP=true;localCandidatesFSM.dispatch("ready")},onError:function(err){log.error("offer could not be sent",err);that.call.hangup({signal:false})}})},function errorHandler(p){var err=new Error("Error calling setLocalDescription on offer I created.");that.call.fire("error",{message:err.message})})}function saveAnswerAndSend(oSession){if(!pc){return}if(!that.state.caller){that.report.callerconnection=that.call.connectionId}oSession.type="answer";log.debug("setting and sending answer",oSession);that.report.sdpsSent.push(oSession);pc.setLocalDescription(oSession,function successHandler(p){oSession.type="answer";signalAnswer({sessionDescription:oSession,call:that.call,onSuccess:function(){localCandidatesFSM.dispatch("ready")}});that.state.sentSDP=true},function errorHandler(p){var err=new Error("Error calling setLocalDescription on answer I created.");that.call.fire("error",{message:err.message})})}that.sendTones=function(params){var deferred=Q.defer();var retVal=respoke.handlePromise(deferred.promise,params.onSuccess,params.onError);params=typeof params==="object"?params:{};params.duration=params.duration||100;params.gap=params.gap||50;var err;if(!pc){err=new Error("No Peer Connection available")}if(!params.tones){err=new Error("Unable to send tones as none passed in")}if(params.duration>6e3||params.duration<40){err=new Error("Unable to send tones as duration needs to be between 40 and 6000 milliseconds")}if(params.gap<50){err=new Error("Unable to send tones as gap needs to be greater than 50 milliseconds")}if(params.tones&&!params.tones.match(/^([A-D0-9,#*])+$/gi)){err=new Error("Unable to send tones as tones passed in were not in correct format")}if(pc&&!pc.createDTMFSender){err=new Error("Unable to send tones in this browser")}if(err){log.warn(err);deferred.reject(err);return retVal}if(digitSender){err=new Error("Unable to queue tones on audio track as a digitSender already exists");log.warn(err);deferred.reject(err);return retVal}var audioTracks=that.call.outgoingMedia.getAudioTracks();if(!audioTracks||audioTracks.length<1){err=new Error('Could not send tones "'+params.tones+'" because not audio sent yet');log.warn(err);deferred.reject(err);return retVal}digitSender=pc.createDTMFSender(audioTracks[0]);digitSender.ontonechange=function onToneChange(evt){var eventData={tone:evt.tone,duration:digitSender.duration,gap:digitSender.interToneGap};if(evt.tone!==""){that.call.fire("tone-sent",eventData)}if(evt.tone===""){digitSender=null;if(!cancellingTones){deferred.resolve();that.call.fire("tone-sending-complete")}else{cancellingTones=false;deferred.reject(new Error("Tone playback cancelled"))}}};if(!digitSender.canInsertDTMF){err=new Error("Unable to insert tones into audio track");log.warn(err);deferred.reject(err);return retVal}try{digitSender.insertDTMF(params.tones,params.duration,params.gap)}catch(e){err=new Error("Unable to queue tones on audio track due to an error");log.warn(err,params,e);deferred.reject(err);return retVal}log.debug("successfully queued playback of tones",{tones:digitSender.toneBuffer,duration:digitSender.duration,gap:digitSender.interToneGap});return retVal};that.cancelTones=function(params){var deferred=Q.defer();var retVal=respoke.handlePromise(deferred.promise,params.onSuccess,params.onError);var err;if(!pc){err=new Error("No Peer Connection available");log.warn(err);deferred.reject(err);return retVal}if(!digitSender){err=new Error("Unable to queue tones on audio track as a digitSender does not exist");log.warn(err);deferred.reject(err);return retVal}if(!digitSender.canInsertDTMF){err=new Error("Unable to cancel playback of tones as cannot change tones on audio track");log.warn(err);deferred.reject(err);return retVal}cancellingTones=true;var tonesToCancel=digitSender.toneBuffer;try{digitSender.insertDTMF("")}catch(e){err=new Error("Unable to cancel playback of tones");log.warn(err,e);deferred.reject(err);return retVal}deferred.resolve();that.call.fire("tone-sending-cancelled",{cancelledTones:tonesToCancel});return retVal};that.close=function(params){params=params||{};toSendHangup=true;if(that.state.caller===true){if(!that.state.sentSDP){toSendHangup=false}}toSendHangup=typeof params.signal==="boolean"?params.signal:toSendHangup;if(toSendHangup){log.info("sending hangup");signalHangup({call:that.call})}that.report.callStopped=(new Date).getTime();that.fire("close",{sentSignal:toSendHangup});that.ignore();if(pc&&that.report){pc.close()}pc=null;if(that.call.enableCallDebugReport){signalReport({report:that.report})}that.report=null};that.close=respoke.callOnce(that.close);that.isActive=function(){return!!(pc&&["completed","connected","new","checking"].indexOf(pc.iceConnectionState)>-1)};function listenAnswer(evt){if(!pc){return}log.debug("got answer",evt.signal);that.report.sdpsReceived.push(evt.signal.sessionDescription);that.state.sendOnly=respoke.sdpHasReceiveOnly(evt.signal.sessionDescription.sdp);that.sdpExpectedStreamCount=respoke.sdpStreamCount(evt.signal.sessionDescription.sdp);that.report.lastSDPString=evt.signal.sessionDescription.sdp;if(that.state.caller){that.report.calleeconnection=evt.signal.fromConnection}that.call.connectionId=evt.signal.fromConnection;signalConnected({call:that.call});pc.setRemoteDescription(new RTCSessionDescription(evt.signal.sessionDescription),function successHandler(){processReceivingQueue();that.state.dispatch("receiveAnswer")},function errorHandler(p){var newErr=new Error("Exception calling setRemoteDescription on answer I received.");that.report.callStoppedReason=newErr.message;that.call.fire("error",{message:newErr.message});log.error("set remote desc of answer failed",evt.signal.sessionDescription,p);that.report.callStoppedReason="setRemoteDescription failed at answer.";that.close()})}function listenConnected(evt){if(evt.signal.connectionId!==client.connectionId){log.debug("Hanging up because I didn't win the call.",evt.signal,client);that.call.hangup({signal:false})}}that.startModify=function(params){defModify=Q.defer();signalModify({action:"initiate",call:that.call,constraints:params.constraints,directConnection:params.directConnection})};function listenModify(evt){var err;log.debug("PC.listenModify",evt.signal);if(evt.signal.action==="accept"){if(defModify.promise.isPending()){defModify.resolve();that.fire("modify-accept",{signal:evt.signal})}return}else if(evt.signal.action==="reject"){if(defModify.promise.isPending()){err=new Error("Remote party cannot negotiate.");log.debug(err.message);defModify.reject(err);that.fire("modify-reject",{err:err})}return}if(defModify&&defModify.promise.isPending()){err=new Error("Got modify in a negotiating state.");log.debug(err.message);defModify.reject(err);that.fire("modify-reject",{err:err});signalModify({action:"reject",call:that.call});return}defModify=Q.defer();if(!that.state.sentSDP||that.state.isState("idle")){err=new Error("Got modify in a precall state.");that.fire("modify-reject",{err:err});signalModify({action:"reject",call:that.call});defModify.reject(err);return}that.fire("modify-accept",{signal:evt.signal});signalModify({action:"accept",call:that.call});defModify.resolve()}that.addRemoteCandidate=function(params){if(!pc&&(that.state.sentSDP||that.state.receivedSDP)){return}if(!params||!params.candidate||!params.candidate.hasOwnProperty("sdpMLineIndex")){log.warn("addRemoteCandidate got wrong format!",params);return}candidateReceivingQueue.push(params)};that.call.listen("signal-answer",listenAnswer,true);that.call.listen("signal-connected",listenConnected,true);that.call.listen("signal-modify",listenModify,true);return that}},function(module,exports,__webpack_require__){(function(root,factory){"use strict";if(true){module.exports=factory()}else if(typeof define==="function"&&define.amd){define(factory)}else{root.Statechart=factory()}})(this,function(){"use strict";var assert=function(assertion){if(!assertion){throw new Error("Assertion failed.")}};var Statechart={run:function(opt){opt=opt||{};this.debug=opt.debug?opt.debug:function(){};this.construct(this.initialState);this.init(null)},construct:function(initialState){this.myState=this.top();this.mySource=this.state("Initial");this.states.Initial={empty:function(){this.newInitialState(initialState)}};var handled=function(){return null};this.states.TOP={entry:handled,exit:handled,init:handled,empty:handled};this.flatten()},init:function(anEventOrNull){assert(this.myState===this.top()&&this.mySource!==null);var s=this.myState;this.mySource.trigger(anEventOrNull);assert(s.equals(this.myState.superstate()));s=this.myState;s.enter();while(s.init()===null){assert(s.equals(this.myState.superstate()));s=this.myState;s.enter()}},state:function(stateOrName){return stateOrName&&stateOrName instanceof QState?stateOrName:new QState(this,stateOrName)},top:function(stateOrName){return this._topState||(this._topState=new QState(this,"TOP"))},currentState:function(){return this.myState},flatten:function(){this.statesTable=this.statesTable||{};this._flatten(this.states,this.top().name)},_flatten:function(states,parent){if(!states){return}for(var state in states){if(states.hasOwnProperty(state)){this.statesTable[state]=states[state];this.statesTable[state].parent=parent;this._flatten(states[state].states,state)}}},selectState:function(stateName){return this.statesTable[stateName]},dispatchEvent:function(anEvent,state,act){act=act||state[anEvent.type];if(act instanceof Array){for(var i=0;i<act.length;i++){this.dispatchEvent(anEvent,state,act[i])}}if(anEvent.type==="init"&&typeof act==="string"){this.newInitialState(act);return null}if(act instanceof Function){act.call(this,anEvent.args);return null}else if(act){if(!act.guard||act.guard&&act.guard.call(this,anEvent.args)){if(act.action){act.action.call(this,anEvent.args)}if(act.target){this.newState(act.target)}return null}}else{if(state===this.selectState("TOP")){this.handleUnhandledEvent(anEvent);return null}}return this.state(state.parent)},handleUnhandledEvent:function(anEvent){this.debug("Unhandled event: "+anEvent.type);return null},dispatch:function(anEvent,args){if(!anEvent||!(anEvent instanceof QEvent)){anEvent=new QEvent(anEvent,args)}this.mySource=this.myState;while(this.mySource){this.mySource=this.mySource.trigger(anEvent)}},newState:function(aStateName){this.transition(this.state(aStateName))},newInitialState:function(aStateOrName){this.myState=this.state(aStateOrName);return null},transition:function(target){assert(!target.equals(this.top()));var entry=[];var mySource=this.mySource;var s=this.myState;assert(s!==null);assert(mySource!==null);while(!s.equals(mySource)){s=s.exit()||s.superstate()}entry.push(target);if(mySource.equals(target)){mySource.exit();return this.enterVia(target,entry)}var p=target.superstate();if(mySource.equals(p)){return this.enterVia(target,entry)}assert(mySource!==null);var q=mySource.superstate();if(q.equals(p)){mySource.exit();return this.enterVia(target,entry)}if(q.equals(target)){mySource.exit();entry.pop();return this.enterVia(target,entry)}entry.push(p);s=p.superstate();while(s!==null){if(mySource.equals(s)){return this.enterVia(target,entry)}entry.push(s);s=s.superstate()}mySource.exit();var entryLength=entry.length;var lca;for(lca=entryLength-1;lca>=0;lca-=1){if(q.equals(entry[lca])){return this.enterVia(target,entry.slice(0,lca))}}s=q;while(s!==null){for(lca=entryLength-1;lca>=0;lca-=1){if(s.equals(entry[lca])){return this.enterVia(target,entry.slice(0,lca))}}s.exit();s=s.superstate()}},enterVia:function(target,entry){var idx=entry.length;while(idx>0){idx--;entry[idx].enter()}this.myState=target;while(target.init()===null){assert(target.equals(this.myState.superstate()));target=this.myState;target.enter()}}};function QState(fsm,name){this.fsm=fsm;this.name=name}QState.prototype={equals:function(state){return this.name===state.name&&this.fsm===state.fsm},dispatchEvent:function(anEvent,state){return this.fsm.dispatchEvent(anEvent,state)},trigger:function(anEvent){var evt=anEvent||QEventEmpty;var state=this.fsm.selectState(this.name);return this.dispatchEvent(evt,state)},enter:function(){this.fsm.debug("["+this.name+"] enter");return this.trigger(QEventEntry)},exit:function(){this.fsm.debug("["+this.name+"] exit");return this.trigger(QEventExit)},init:function(){this.fsm.debug("["+this.name+"] init");return this.trigger(QEventInit)},superstate:function(){var superstate=this.trigger(QEventEmpty);if(superstate&&superstate instanceof QState){return superstate}superstate=this.fsm.top();if(this.name===superstate.name){return null}return superstate}};function QEvent(type,args){this.type=type;this.args=args}var QEventEntry=new QEvent("entry");var QEventExit=new QEvent("exit");var QEventInit=new QEvent("init");var QEventEmpty=new QEvent("empty");return Statechart})},function(module,exports,__webpack_require__){var respoke=__webpack_require__(1);var log=respoke.log;var Statechart=__webpack_require__(19);var Q=__webpack_require__(6);module.exports=function(params){"use strict";params=params||{};var fsm;var instanceId=params.instanceId;var that=respoke.EventEmitter(params);that.className="respoke.CallState";delete that.instanceId;var client=respoke.getClient(instanceId);var allTimers=[];var answerTimer;var answerTimeout=params.answerTimeout||1e4;var receiveAnswerTimer;var receiveAnswerTimeout=params.receiveAnswerTimeout||6e4;var connectionTimer;var connectionTimeout=params.connectionTimeout||1e4;var modifyTimer;var modifyTimeout=params.modifyTimeout||6e4;var oldRole;var nontransitionEvents=["receiveLocalMedia","receiveRemoteMedia","approve","answer","sentOffer","receiveAnswer"];function assert(condition){if(!condition){throw new Error("Assertion failed.")}}that.hasLocalMediaApproval=false;that.hasLocalMedia=false;that.receivedBye=false;that.isAnswered=false;that.sentSDP=false;that.receivedSDP=false;that.processedRemoteSDP=false;that.needDirectConnection=!!that.needDirectConnection;that.sendOnly=!!that.sendOnly;that.receiveOnly=!!that.receiveOnly;var rejectEvent=[{target:"connected",guard:function(params){if(typeof oldRole==="boolean"){that.caller=oldRole}if(modifyTimer){modifyTimer.clear()}return that.hasMedia()}},{target:"terminated",guard:function(params){params=params||{};that.hangupReason=params.reason||"no media";[answerTimer,receiveAnswerTimer,connectionTimer,modifyTimer].forEach(function(timer){if(timer){timer.clear()}});return!that.hasMedia()}}];function rejectModify(){if(modifyTimer){modifyTimer.clear()}}function clearReceiveAnswerTimer(){that.processedRemoteSDP=true;if(receiveAnswerTimer){receiveAnswerTimer.clear()}}var hangupEvent={target:"terminated",action:function(params){params=params||{};that.signalBye=params.signal;that.hangupReason=that.hangupReason||params.reason||"none"}};function needToObtainMedia(){return that.needDirectConnection!==true&&that.receiveOnly!==true&&that.hasLocalMedia!==true}function needToApproveDirectConnection(params){return that.needDirectConnection===true&&typeof params.previewLocalMedia==="function"}function automaticOffering(params){if(that.caller!==true){return false}if(!that.needDirectConnection&&that.receiveOnly||that.hasLocalMedia){return true}return that.needDirectConnection===true&&typeof params.previewLocalMedia!=="function"}function hasListener(){if(client.hasListeners("call")&&!that.needDirectConnection||client.hasListeners("direct-connection")&&that.needDirectConnection){return true}else{return false}}function createTimer(func,name,time){var id=setTimeout(function(){id=null;log.error(that.caller?"caller's":"callee's",name,"timer expired.");func()},time);log.debug("setting timer",name,"for",time/1e3,"secs");var timer={name:name,clear:function(){if(id===null){return}log.debug("clearing",that.caller?"caller's":"callee's","timer",name);clearTimeout(id);id=null}};allTimers.push(timer);return timer}var stateParams={initialState:"idle",states:{idle:{exit:function(){that.fire("idle:exit")},initiate:[{target:"negotiatingContainer",guard:function(params){assert(typeof params.caller==="boolean");return params.caller===true||hasListener()}},{target:"terminated",guard:function(params){return params.caller!==true&&!hasListener()}}],receiveLocalMedia:function(){that.hasLocalMedia=true},receiveOffer:{action:function(params){that.receivedSDP=true}},hangup:hangupEvent},negotiatingContainer:{init:"preparing",hangup:hangupEvent,modify:rejectModify,receiveLocalMedia:function(){that.hasLocalMedia=true},states:{preparing:{entry:{action:function(){that.hasLocalMediaApproval=false;that.hasLocalMedia=false;that.sentSDP=false;that.receivedSDP=false;that.processedRemoteSDP=false;that.isAnswered=false;if(!that.isModifying()){answerTimer=createTimer(function(){that.dispatch("reject",{reason:"answer own call timer "+that.caller})},"answer own call",that.caller?answerTimeout:receiveAnswerTimeout)}that.fire("preparing:entry")}},exit:function(){that.fire("preparing:exit");if(answerTimer){answerTimer.clear()}},reject:rejectEvent,receiveOffer:{action:function(params){that.receivedSDP=true;if(that.isAnswered){setTimeout(function(){that.dispatch("answer",params)})}}},answer:[{action:function(params){assert(!params.previewLocalMedia||typeof params.previewLocalMedia==="function");that.isAnswered=true;if(typeof params.previewLocalMedia!=="function"){that.hasLocalMediaApproval=true}}},{target:"approvingDeviceAccess",guard:needToObtainMedia},{target:"approvingContent",guard:needToApproveDirectConnection},{target:"offering",guard:automaticOffering},{target:"connecting",guard:function(params){if(!that.receivedSDP){return false}if(needToObtainMedia()||needToApproveDirectConnection(params)||automaticOffering(params)){return false}if(!params.previewLocalMedia||that.receiveOnly){setTimeout(function(){params.approve()})}return that.receiveOnly===true||that.needDirectConnection===true}}]},gettingMedia:{reject:rejectEvent,receiveLocalMedia:[{action:function(){that.hasLocalMedia=true}},{target:"offering",guard:function(params){return that.caller===true&&that.hasLocalMediaApproval===true&&that.hasLocalMedia===true}},{target:"connecting",guard:function(params){return that.caller===false&&that.hasLocalMediaApproval===true&&that.hasLocalMedia===true}}],states:{approvingDeviceAccess:{entry:function(){that.fire("approving-device-access:entry")},approve:[{target:"approvingContent",guard:function(params){return typeof params.previewLocalMedia==="function"}},{target:"connecting",guard:function(params){return that.caller===false&&(that.hasLocalMedia===true||that.needDirectConnection===true)&&typeof params.previewLocalMedia!=="function"}},{target:"offering",guard:function(params){return that.caller===true&&that.hasLocalMedia===true&&typeof params.previewLocalMedia!=="function"}}]},approvingContent:{entry:function(){that.fire("approving-content:entry")},exit:function(){that.fire("approving-content:exit")},approve:[function(params){that.hasLocalMediaApproval=true},{target:"offering",guard:function(params){return that.caller===true&&that.hasLocalMedia===true}},{target:"connecting",guard:function(params){return that.caller===false&&that.hasLocalMedia===true}}]}}},offeringContainer:{init:"offering",reject:rejectEvent,sentOffer:function(){receiveAnswerTimer=createTimer(function(){that.dispatch("reject",{reason:"receive answer timer"})},"receive answer",receiveAnswerTimeout)},states:{offering:{entry:function(){that.fire("offering:entry")},exit:function(){that.fire("offering:exit")},receiveLocalMedia:[function(){that.hasLocalMedia=true},{target:"connected",guard:function(params){return that.needDirectConnection===true}}],receiveRemoteMedia:{target:"connected"},receiveAnswer:[clearReceiveAnswerTimer,{target:"connecting"}]}}},connectingContainer:{init:"connecting",reject:rejectEvent,receiveAnswer:clearReceiveAnswerTimer,states:{connecting:{entry:function(){that.fire("connecting:entry");connectionTimer=createTimer(function(){that.dispatch("reject",{reason:"connection timer"})},"connection",connectionTimeout)},exit:function(){if(connectionTimer){connectionTimer.clear()}if(modifyTimer){modifyTimer.clear()}that.fire("connecting:exit")},receiveLocalMedia:[{action:function(){that.hasLocalMedia=true}},{target:"connected",guard:function(params){return that.needDirectConnection===true&&that.caller===false}}],receiveRemoteMedia:{target:"connected"}}}}}},modifyingContainer:{init:"modifying",reject:rejectEvent,modify:rejectModify,hangup:hangupEvent,states:{modifying:{entry:function(){modifyTimer=createTimer(function(){that.dispatch("reject",{reason:"modify timer"})},"modify for caller",modifyTimeout);that.fire("modifying:entry")},accept:[function(){that.caller=true},{target:"preparing"}],exit:function(){that.fire("modifying:exit")}}}},connectedContainer:{init:"connected",reject:{target:"terminated",action:function(params){that.hangupReason=params.reason||"got reject while connected"}},receiveAnswer:clearReceiveAnswerTimer,hangup:hangupEvent,states:{connected:{entry:function(){oldRole=that.caller;that.needDirectConnection=false;that.fire("connected:entry")},exit:function(){that.fire("connected:exit")},modify:[{target:"preparing",guard:function(params){params=params||{};if(params.receive===true){that.caller=false;modifyTimer=createTimer(function(){that.dispatch("reject",{reason:"modify timer"})},"modify",modifyTimeout);return true}}},{target:"modifying",guard:function(params){params=params||{};return params.receive!==true}}]}}},terminatedContainer:{init:"terminated",states:{terminated:{entry:{action:function(){that.fire("terminated:entry");allTimers.forEach(function(timer){timer.clear()});setTimeout(function(){fsm=null;that.ignore()})}}}}}}};stateParams.that=Object.create(Statechart);fsm=respoke.Class(stateParams);fsm.run({debugOff:function(){var args=Array.prototype.slice.call(arguments);args.splice(0,0,that.caller);log.debug.apply(log,args)}});that.getState=function(){if(!fsm){return"terminated"}return fsm.currentState().name};that.dispatch=function(evt,args){var oldState;var newState;if(!fsm){return}oldState=that.getState();try{fsm.dispatch(evt,args)}catch(err){log.debug("error dispatching",evt,"from",oldState,"with",args,err);throw err}newState=that.getState();if(oldState===newState&&nontransitionEvents.indexOf(evt)===-1){log.debug(that.caller,"Possible bad event "+evt+", no transition occured.")}log.debug(that.caller,"dispatching",evt,"moving from ",oldState,"to",newState,args)};that.isModifying=function(){var modifyingStates=["preparing","modifying","approvingDeviceAccess","approvingMedia","offering"];return modifyingStates.indexOf(that.getState())>-1&&that.hasMedia()};that.isState=function(name){return that.getState()===name};assert(typeof that.hasMedia==="function");assert(typeof that.caller==="boolean");return that}},function(module,exports,__webpack_require__){var Q=__webpack_require__(6);var respoke=__webpack_require__(1);var log=respoke.log;module.exports=function(params){"use strict";params=params||{};var instanceId=params.instanceId;var that=respoke.EventEmitter(params);delete that.instanceId;delete that.outgoingMedia;that.className="respoke.Call";that.caller=!!that.caller;Object.defineProperty(that,"initiator",{configurable:true,enumerable:true,get:function(){log.warn("The call.initiator flag is deprecated. Please use call.caller instead.");return that.caller},set:function(){}});if(!that.caller){delete params.constraints;that.constraints=[]}that.id=that.caller?respoke.makeGUID():that.id;console.log("[Respoke] Creating call. id='"+that.id+"'");if(!that.id){throw new Error("Can't start a new call without a call id.")}var defMedia=Q.defer();var defModify;var previewLocalMedia=params.previewLocalMedia;var client=respoke.getClient(instanceId);var signalingChannel=params.signalingChannel;that.enableCallDebugReport=params.signalingChannel.isSendingReport();var pc=respoke.PeerConnection({instanceId:instanceId,state:respoke.CallState({instanceId:instanceId,caller:that.caller,needDirectConnection:params.needDirectConnection,sendOnly:params.sendOnly,receiveOnly:params.receiveOnly,hasMedia:function(){return that.hasMedia()}}),forceTurn:!!params.forceTurn,call:that,pcOptions:{optional:[{DtlsSrtpKeyAgreement:true},{RtpDataChannels:false}]},offerOptions:params.offerOptions||null,signalOffer:function(args){if(!pc){return}params.signalOffer(args);pc.state.dispatch("sentOffer")},signalConnected:params.signalConnected,signalAnswer:params.signalAnswer,signalModify:params.signalModify,signalHangup:params.signalHangup,signalReport:params.signalReport,signalCandidate:params.signalCandidate});that.outgoingMediaStreams=[];that.outgoingMediaStreams.hasAudio=function(){if(that.outgoingMediaStreams.length===0){return false}return!that.outgoingMediaStreams.every(function(stream){return stream.getAudioTracks().length===0})};that.outgoingMediaStreams.hasVideo=function(){if(that.outgoingMediaStreams.length===0){return false}return!that.outgoingMediaStreams.every(function(stream){return stream.getVideoTracks().length===0})};if(params.outgoingMedia){that.outgoingMediaStreams.push(params.outgoingMedia)}Object.defineProperty(that,"outgoingMedia",{configurable:false,enumerable:true,get:function(){return that.outgoingMediaStreams[0]},set:function(){}});that.incomingMediaStreams=[];that.incomingMediaStreams.hasAudio=function(){if(that.incomingMediaStreams.length===0){return false}return!that.incomingMediaStreams.every(function(stream){return stream.getAudioTracks().length===0})};that.incomingMediaStreams.hasVideo=function(){if(that.incomingMediaStreams.length===0){return false}return!that.incomingMediaStreams.every(function(stream){return stream.getVideoTracks().length===0})};Object.defineProperty(that,"incomingMedia",{configurable:false,enumerable:true,get:function(){return that.incomingMediaStreams[0]},set:function(){}});Object.defineProperty(that,"hasAudio",{configurable:false,enumerable:true,get:that.incomingMediaStreams.hasAudio,set:function(){}});Object.defineProperty(that,"hasVideo",{configurable:false,enumerable:true,get:that.incomingMediaStreams.hasVideo,set:function(){}});delete params.signalingChannel;delete that.signalingChannel;var videoIsMuted=false;var audioIsMuted=false;var directConnection=null;var toSendHangup=null;function init(){log.debug("Call.init");if(defModify!==undefined){defMedia=Q.defer()}pc.init();if(defModify===undefined&&pc.state.needDirectConnection===true){actuallyAddDirectConnection(params)}}function saveParameters(params){var isNewConstraint;if(!pc){return}that.listen("local-stream-received",params.onLocalMedia);that.listen("connect",params.onConnect);that.listen("hangup",params.onHangup);that.listen("allow",params.onAllow);that.listen("answer",params.onAnswer);that.listen("approve",params.onApprove);that.listen("mute",params.onMute);that.listen("requesting-media",params.onRequestingMedia);that.listen("tone-sent",params.onToneSent);that.listen("tone-sending-started",params.onToneSendingStarted);that.listen("tone-sending-cancelled",params.onToneSendingCancelled);previewLocalMedia=typeof params.previewLocalMedia==="function"?params.previewLocalMedia:previewLocalMedia;pc.state.receiveOnly=typeof params.receiveOnly==="boolean"?params.receiveOnly:pc.state.receiveOnly;pc.state.sendOnly=typeof params.sendOnly==="boolean"?params.sendOnly:pc.state.sendOnly;pc.state.needDirectConnection=typeof params.needDirectConnection==="boolean"?params.needDirectConnection:pc.state.needDirectConnection;pc.disableTurn=typeof params.disableTurn==="boolean"?params.disableTurn:!!pc.disableTurn;pc.forceTurn=typeof params.forceTurn==="boolean"?params.forceTurn:!!pc.forceTurn;that.videoLocalElement=params.videoLocalElement?params.videoLocalElement:that.videoLocalElement;that.videoRemoteElement=params.videoRemoteElement?params.videoRemoteElement:that.videoRemoteElement;if(pc.state.receiveOnly){that.outgoingMediaStreams.length=0;that.constraints=[]}else if(params.constraints){
that.constraints=respoke.convertConstraints(params.constraints);updateOutgoingMediaEstimate({constraints:that.constraints[0],source:params.source})}if(pc.state.sendOnly){that.incomingMediaStreams.length=0}else if(params.constraints&&pc.state.caller===true&&that.incomingMediaStreams.length===0){that.constraints=respoke.convertConstraints(params.constraints);updateIncomingMediaEstimate({constraints:params.constraints[0]})}pc.listen("stats",function fireStats(evt){that.fire("stats",{stats:evt.stats})},true);delete that.signalOffer;delete that.signalConnected;delete that.signalAnswer;delete that.signalHangup;delete that.signalReport;delete that.signalCandidate}function buildLocalMedia(constraint){var localMedia;if(pc.state.receiveOnly){return Q.reject(new Error("Shouldn't have requested local media when receiveOnly is true."))}if(constraint.className==="respoke.LocalMedia"){localMedia=constraint}else{localMedia=respoke.LocalMedia({hasScreenShare:respoke.constraintsHasScreenShare(constraint),constraints:constraint,source:params.source});that.outgoingMediaStreams.push(localMedia)}if(respoke.constraintsHasVideo(localMedia.constraints)){localMedia.element=that.videoLocalElement}localMedia.listen("requesting-media",function waitAllowHandler(evt){if(!pc){return}that.fire("requesting-media")},true);localMedia.listen("allow",function allowHandler(evt){if(!pc){return}that.fire("allow");pc.state.dispatch("approve",{previewLocalMedia:previewLocalMedia})},true);return localMedia.start().then(function(){streamReceivedHandler(localMedia)})}that.answer=function(params){params=params||{};log.debug("Call.answer",params);saveParameters(params);pc.listen("remote-stream-received",onRemoteStreamAdded,true);pc.listen("remote-stream-removed",onRemoteStreamRemoved,true);pc.state.once("approving-device-access:entry",function(evt){doAddVideo(params)});pc.state.dispatch("answer",{previewLocalMedia:previewLocalMedia,approve:that.approve});that.fire("answer")};that.accept=that.answer;that.approve=function(){log.debug("Call.approve");that.fire("approve");pc.state.dispatch("approve",{previewLocalMedia:previewLocalMedia});if(defModify&&defModify.promise.isPending()){defModify.resolve(true);defModify=undefined}};function onRemoteStreamRemoved(evt){log.debug("pc event: remote stream removed")}function onRemoteStreamAdded(evt){var hasAudio=false;var hasVideo=false;var hasScreenShare=false;var remoteMedia;if(!pc){return}log.debug("received remote media",evt);if(that.incomingMediaStreams.length===1&&that.incomingMediaStreams[0].temporary===true){that.incomingMediaStreams.length=0}hasAudio=evt.stream.getAudioTracks().length>0;hasVideo=evt.stream.getVideoTracks().length>0;hasScreenShare=hasVideo&&that.target==="screenshare";remoteMedia=respoke.RemoteMedia({element:that.videoRemoteElement,stream:evt.stream,hasScreenShare:hasScreenShare,constraints:{audio:hasAudio,video:hasVideo}});that.incomingMediaStreams.push(remoteMedia);if(that.incomingMediaStreams.length<pc.sdpExpectedStreamCount){return}pc.state.dispatch("receiveRemoteMedia");that.fire("connect",{stream:remoteMedia.stream,element:remoteMedia.element})}function getStats(params){if(pc&&pc.getStats){that.listen("stats",params.onStats);return pc.getStats(params)}return null}if(respoke.MediaStats){that.getStats=getStats}that.getLocalElement=function(){return that.outgoingMediaStreams[0]?that.outgoingMediaStreams[0].element:undefined};that.getRemoteElement=function(){return that.incomingMediaStreams[0]?that.incomingMediaStreams[0].element:undefined};function streamReceivedHandler(localMedia){if(!pc){return}pc.addStream(localMedia.stream);if(typeof previewLocalMedia==="function"&&localMedia.element){previewLocalMedia(localMedia.element,that)}localMedia.listen("stop",function stopHandler(){var idx=that.outgoingMediaStreams.indexOf(localMedia);if(idx>-1){that.outgoingMediaStreams.splice(idx,1)}if(!that.outgoingMediaStreams.length&&!that.incomingMediaStreams.length){that.hangup({reason:"last stream ended"})}});that.fire("local-stream-received",{element:localMedia.element,stream:localMedia});localMedia.listen("mute",function(evt){that.fire("mute",{type:evt.type,muted:evt.muted})})}function doAddVideo(params){log.debug("Call.doAddVideo");saveParameters(params)}that.addVideo=function(params){log.debug("Call.addVideo");params=params||{};if(!params.constraints||!params.constraints.length){params.constraints=[{video:true,audio:true}]}params.instanceId=instanceId;if(!defMedia.promise.isFulfilled()){doAddVideo(params)}else{pc.startModify({constraints:params.constraints});defModify=Q.defer();defModify.promise.then(function modifyAccepted(){doAddVideo(params)})}return defModify.promise};that.addAudio=function(params){params=params||{};if(!params.constraints||!params.constraints.length){params.constraints=[{video:false,audio:true}]}return that.addVideo(params)};that.getDirectConnection=function(){return directConnection||null};that.removeDirectConnection=function(params){params=params||{};log.debug("Call.removeDirectConnection");if(directConnection){directConnection.close({skipRemove:true})}if(!that.hasMedia()){log.debug("Hanging up because there are no local streams.");that.hangup();return}if(params.skipModify===true){return}pc.startModify({directConnection:false});defModify=Q.defer();defModify.promise.done(function onModifySuccess(){defMedia.resolve();defModify=undefined})};that.addDirectConnection=function(params){log.debug("Call.addDirectConnection");pc.startModify({directConnection:true});defModify=Q.defer();return defModify.promise.then(function onModifySuccess(){return actuallyAddDirectConnection(params)},function onModifyError(err){throw err})};function actuallyAddDirectConnection(params){log.debug("Call.actuallyAddDirectConnection",params);params=params||{};defMedia.promise.then(params.onSuccess,params.onError);if(directConnection&&directConnection.isActive()){if(defMedia.promise.isPending()){defMedia.resolve(directConnection)}else{log.warn("Not creating a new direct connection.")}return defMedia.promise}params.instanceId=instanceId;params.pc=pc;params.call=that;directConnection=respoke.DirectConnection(params);directConnection.listen("close",function closeHandler(){if(!that.hasMedia()){log.debug("Hanging up because there are no local streams.");that.hangup()}else{that.removeDirectConnection({skipModify:true})}},true);directConnection.listen("accept",function acceptHandler(){if(pc.state.caller===false){log.debug("Answering as a result of approval.")}else{defMedia.resolve(directConnection)}},true);directConnection.listen("open",function openHandler(){pc.state.dispatch("receiveRemoteMedia")},true);directConnection.listen("error",function errorHandler(err){defMedia.reject(new Error(err))},true);that.remoteEndpoint.directConnection=directConnection;that.fire("direct-connection",{directConnection:directConnection,endpoint:that.remoteEndpoint});client.fire("direct-connection",{directConnection:directConnection,endpoint:that.remoteEndpoint});if(pc.state.caller===true){directConnection.accept()}return defMedia.promise}that.closeDirectConnection=function(){if(directConnection){directConnection.close();directConnection=null}};that.hangup=function(params){if(!pc){return}params=params||{};params.reason=params.reason||"hangup method called.";pc.state.dispatch("hangup",params)};that.hangup=respoke.callOnce(that.hangup);var doHangup=function(){log.debug("hangup",that.caller);that.outgoingMediaStreams.forEach(function(stream){if(stream!==params.outgoingMedia){stream.stop()}});if(directConnection){directConnection.close();directConnection=null}if(pc){pc.close({signal:pc.state.receivedBye?false:pc.state.signalBye})}that.fire("hangup",{reason:pc.state.hangupReason||"No reason specified."});pc.state.ignore();pc.ignore();that.ignore();pc=null};doHangup=respoke.callOnce(doHangup);that.reject=function(){if(!pc){return}pc.state.dispatch("reject",{reason:"call.reject() called"})};that.isActive=function(){return!!(pc&&pc.isActive()&&(that.outgoingMediaStreams.length>0||that.incomingMediaStreams.length>0||directConnection&&directConnection.isActive()))};function listenAnswer(evt){log.debug("listenAnswer",evt.signal);that.hasDataChannel=respoke.sdpHasDataChannel(evt.signal.sessionDescription.sdp);updateIncomingMediaEstimate({sdp:evt.signal.sessionDescription})}function updateIncomingMediaEstimate(params){if(pc.state.sendOnly){that.incomingMediaStreams.length=0;return}if(!params.sdp&&!params.constraints){throw new Error("Can't estimate incoming media without sdp or constraints")}if(that.incomingMediaStreams.length===0){that.incomingMediaStreams.push(respoke.RemoteMedia({hasScreenShare:that.target==="screenshare",temporary:true}))}if(params.sdp){if(that.incomingMediaStreams[0]&&that.incomingMediaStreams[0].temporary){that.incomingMediaStreams[0].setSDP(params.sdp)}}if(params.constraints){if(that.incomingMediaStreams[0]&&that.incomingMediaStreams[0].temporary){that.incomingMediaStreams[0].setConstraints(params.constraints)}}}function updateOutgoingMediaEstimate(params){if(pc.state.receiveOnly){that.outgoingMediaStreams.length=0;that.constraints=[];return}if(!params.sdp&&!params.constraints){throw new Error("Can't estimate outgoing media without sdp or constraints")}if(that.outgoingMediaStreams.length===0){that.outgoingMediaStreams.push(respoke.LocalMedia({instanceId:instanceId,temporary:true,source:params.source}))}if(params.sdp){if(that.outgoingMediaStreams[0]&&that.outgoingMediaStreams[0].temporary){that.outgoingMediaStreams[0].setSDP(params.sdp)}}if(params.constraints){if(that.outgoingMediaStreams[0]&&that.outgoingMediaStreams[0].temporary){that.outgoingMediaStreams[0].setConstraints(params.constraints)}}}function listenOffer(evt){log.debug("listenOffer",evt.signal);var info={};that.sessionId=evt.signal.sessionId;pc.state.receiveOnly=respoke.sdpHasSendOnly(evt.signal.sessionDescription.sdp);pc.state.sendOnly=respoke.sdpHasReceiveOnly(evt.signal.sessionDescription.sdp);pc.state.listen("connecting:entry",function(){if(!pc.state.caller){pc.processOffer(evt.signal.sessionDescription)}});updateIncomingMediaEstimate({sdp:evt.signal.sessionDescription});if(pc.state.sendOnly){updateOutgoingMediaEstimate({constraints:{audio:true,video:true}})}else{updateOutgoingMediaEstimate({sdp:evt.signal.sessionDescription})}if(that.outgoingMedia){log.info("Default outgoingMedia constraints",that.outgoingMedia.constraints)}if(pc.state.isModifying()){if(pc.state.needDirectConnection===true){info.directConnection=directConnection}else if(pc.state.needDirectConnection===false){}else{info.call=that}that.fire("modify",info)}pc.state.dispatch("receiveOffer",{previewLocalMedia:previewLocalMedia,approve:that.approve})}function listenModify(evt){log.debug("Call.listenModify",evt);if(evt.signal.action==="initiate"){defModify=Q.defer();pc.state.dispatch("modify",{receive:true})}}function onModifyAccept(evt){pc.state.dispatch("accept");if(evt.signal.action!=="initiate"){defModify.resolve();defModify=undefined;return}if(evt.signal.directConnection===true){actuallyAddDirectConnection().done(function successHandler(dc){directConnection=dc;directConnection.accept()})}else if(evt.signal.directConnection===false){if(directConnection){that.removeDirectConnection({skipModify:true});defMedia.resolve(false)}}pc.state.needDirectConnection=typeof evt.signal.directConnection==="boolean"?evt.signal.directConnection:null;that.outgoingMedia.constraints=evt.signal.constraints||that.outgoingMedia.constraints}function onModifyReject(evt){if(evt.signal.action!=="initiate"){defMedia.reject(evt.err);defModify.reject(evt.err);defModify=undefined}}that.toggleVideo=function(){if(that.isActive()){if(!videoIsMuted){that.muteVideo()}else{that.unmuteVideo()}}};that.toggleAudio=function(){if(that.isActive()){if(!audioIsMuted){that.muteAudio()}else{that.unmuteAudio()}}};that.hasMedia=function(){var local;var remote;if(!pc||!pc.getLocalStreams){return false}local=pc.getLocalStreams();remote=pc.getRemoteStreams();if(directConnection&&directConnection.isActive()){return true}return local.length>0||remote.length>0};that.muteVideo=function(){if(videoIsMuted){return}that.outgoingMedia.muteVideo();videoIsMuted=true};that.unmuteVideo=function(){if(!videoIsMuted){return}that.outgoingMedia.unmuteVideo();videoIsMuted=false};that.muteAudio=function(){if(audioIsMuted){return}that.outgoingMedia.muteAudio();audioIsMuted=true};that.unmuteAudio=function(){if(!audioIsMuted){return}that.outgoingMedia.unmuteAudio();audioIsMuted=false};that.sendTones=function(params){return pc.sendTones(params)};that.cancelTones=function(params){return pc.cancelTones(params)};function listenHangup(evt){if(!pc){return}pc.report.callStoppedReason=evt.signal.reason||"Remote side hung up";pc.state.receivedBye=true;pc.state.dispatch("hangup",{signal:false,reason:pc.report.callStoppedReason})}pc.state.once("terminated:entry",function(evt){doHangup()},true);that.listen("signal-answer",listenAnswer);that.listen("signal-offer",function(evt){if(pc.state.getState()==="idle"){pc.state.once("preparing:entry",function(){listenOffer(evt)})}else{listenOffer(evt)}},true);that.listen("signal-hangup",listenHangup,true);that.listen("signal-modify",listenModify,true);pc.listen("modify-reject",onModifyReject,true);pc.listen("modify-accept",onModifyAccept,true);that.listen("signal-icecandidates",function onCandidateSignal(evt){if(!pc||!evt.signal.iceCandidates||!evt.signal.iceCandidates.length){return}evt.signal.iceCandidates.forEach(function processCandidate(candidate){if(!pc){return}pc.addRemoteCandidate({candidate:candidate})})},true);that.listen("answer",function(evt){var mediaPromises=[];if(pc.state.receiveOnly||pc.state.needDirectConnection){that.outgoingMediaStreams.length=0;return}if(pc.state.receiveOnly){that.outgoingMediaStreams.length=0;that.constraints=[];return}if(that.constraints.length===0){that.outgoingMediaStreams[0].temporary=undefined}else if(that.outgoingMediaStreams.length>0&&that.outgoingMediaStreams[0].temporary){that.outgoingMediaStreams.shift()}if(params.outgoingMedia){return}if(that.constraints.length>0){that.outgoingMediaStreams.length=0;that.constraints.forEach(function(constraint){mediaPromises.push(buildLocalMedia(constraint))})}else if(that.outgoingMediaStreams.length>0){that.outgoingMediaStreams.forEach(function(stream){mediaPromises.push(buildLocalMedia(stream))})}else{throw new Error("I have no idea what type of media I am supposed to build.")}Q.all(mediaPromises).done(function(){pc.state.dispatch("receiveLocalMedia")},function(err){pc.state.dispatch("reject",{reason:"media stream error"});pc.report.callStoppedReason=err.message;that.fire("error",{reason:err.message})})},true);if(pc.state.needDirectConnection!==true){pc.state.once("preparing:entry",function(){client.fire("call",{endpoint:that.remoteEndpoint,call:that})},true)}pc.state.listen("idle:exit",function(evt){saveParameters(params)});pc.state.listen("preparing:entry",function(evt){init();if(params.outgoingMedia){streamReceivedHandler(params.outgoingMedia);pc.state.dispatch("receiveLocalMedia")}if(pc.state.caller===true){that.answer()}},true);pc.state.listen("connecting:entry",function connectNoMedia(){if(pc.state.sendOnly){that.fire("connect");pc.state.dispatch("receiveRemoteMedia")}});signalingChannel.getTurnCredentials().then(function(result){if(!pc){throw new Error("Already hung up.")}if(!result){log.warn("Relay service not available.");pc.servers={iceServers:[]}}else{pc.servers={iceServers:result}}}).fin(function(){if(!pc){throw new Error("Already hung up.")}pc.state.dispatch("initiate",{caller:that.caller})}).done(null,function(err){if(err.message!=="Already hung up."){log.debug("Unexpected exception",err)}});return that}},function(module,exports,__webpack_require__){var respoke=__webpack_require__(1);var log=respoke.log;var Q=respoke.Q;module.exports=function(params){"use strict";params=params||{};var that=respoke.EventEmitter(params);that.className="respoke.LocalMedia";that.id=respoke.makeGUID();that.element=params.element;var hasScreenShare=params.hasScreenShare;delete params.hasScreenShare;var screenShareSource=params.source;delete params.source;var sdpHasAudio=false;var sdpHasVideo=false;var sdpHasDataChannel=false;var allowTimer=0;var mediaOptions={optional:[{DtlsSrtpKeyAgreement:true},{RtpDataChannels:false}]};that.stream=null;var deferred=Q.defer();function getStream(theConstraints){for(var i=0;i<respoke.streams.length;i++){var s=respoke.streams[i];var sConstraints=respoke.clone(s.constraints);if(sConstraints.video&&sConstraints.video.mandatory&&sConstraints.video.mandatory.chromeMediaSourceId){delete sConstraints.video.mandatory.chromeMediaSourceId}if(respoke.isEqual(sConstraints,theConstraints)){return s.stream}}return null}function removeStream(theConstraints){var toRemoveIndex;for(var i=0;i<respoke.streams.length;i++){var s=respoke.streams[i];if(respoke.isEqual(s.constraints,theConstraints)){toRemoveIndex=i;break}}if(toRemoveIndex!==undefined){respoke.streams.splice(toRemoveIndex,1)}}function onReceiveUserMedia(theStream){that.stream=theStream;clearTimeout(allowTimer);that.fire("allow");log.debug("User gave permission to use media.");log.debug("onReceiveUserMedia");that.element=that.element||document.createElement("video");var aStream=getStream(that.constraints);if(aStream){aStream.numPc+=1;attachMediaStream(that.element,that.stream);that.element.muted=true;that.element.autoplay=true;aStream.addEventListener("ended",that.stop,false);deferred.resolve()}else{that.stream.numPc=1;respoke.streams.push({stream:that.stream,constraints:that.constraints});attachMediaStream(that.element,that.stream);that.element.muted=true;that.element.autoplay=true;that.stream.addEventListener("ended",that.stop,false);deferred.resolve()}}that.getAudioTracks=function(){if(that.stream){return that.stream.getAudioTracks()}return[]};that.getVideoTracks=function(){if(that.stream){return that.stream.getVideoTracks()}return[]};function requestMedia(){var theStream;if(!that.constraints){deferred.reject(new Error("No constraints."));return}if(respoke.useFakeMedia===true){that.constraints.fake=true}theStream=getStream(that.constraints);if(theStream){log.debug("using old stream");onReceiveUserMedia(theStream);return}allowTimer=setTimeout(function delayPermissionsRequest(){that.fire("requesting-media")},500);if(respoke.constraintsHasScreenShare(that.constraints)){if(respoke.isNwjs||respoke.needsChromeExtension&&respoke.hasChromeExtension){respoke.chooseDesktopMedia({source:screenShareSource},function(params){if(!params.sourceId){deferred.reject(new Error("Error trying to get screensharing source: "+params.error));return}that.constraints.video.mandatory.chromeMediaSourceId=params.sourceId;log.debug("Running getUserMedia with constraints",that.constraints);getUserMedia(that.constraints,onReceiveUserMedia,onUserMediaError)});return}else if(respoke.needsFirefoxExtension&&respoke.hasFirefoxExtension){log.debug("Running getUserMedia with constraints",that.constraints);getUserMedia(that.constraints,onReceiveUserMedia,onUserMediaError);return}else{deferred.reject(new Error("Screen sharing not implemented on this platform yet."));return}}log.debug("Running getUserMedia with constraints",that.constraints);getUserMedia(that.constraints,onReceiveUserMedia,onUserMediaError)}function onUserMediaError(p){log.debug("Local media error.",p);var errorMessage=p.code===1?"Permission denied.":"Unknown.";deferred.reject(new Error("Error getting user media: "+errorMessage))}that.isVideoMuted=function(){if(!that.stream||!that.stream.getVideoTracks().length){return undefined}return that.stream.getVideoTracks().every(function(track){return!track.enabled})};that.muteVideo=function(){if(that.isVideoMuted()){return}that.stream.getVideoTracks().forEach(function eachTrack(track){track.enabled=false});that.fire("mute",{type:"video",muted:true})};that.unmuteVideo=function(){if(!that.isVideoMuted()){return}that.stream.getVideoTracks().forEach(function eachTrack(track){track.enabled=true});that.fire("mute",{type:"video",muted:false})};that.isAudioMuted=function(){if(!that.stream||!that.stream.getAudioTracks().length){return undefined}return that.stream.getAudioTracks().every(function(track){return!track.enabled})};that.muteAudio=function(){if(that.isAudioMuted()){return}that.stream.getAudioTracks().forEach(function eachTrack(track){track.enabled=false});that.fire("mute",{type:"audio",muted:true})};that.unmuteAudio=function(){if(!that.isAudioMuted()){return}that.stream.getAudioTracks().forEach(function eachTrack(track){track.enabled=true});that.fire("mute",{type:"audio",muted:false})};that.stop=function(){if(!that.stream){return}that.stream.numPc-=1;if(that.stream.numPc===0){that.stream.getTracks().forEach(function(track){track.stop()});removeStream(that.constraints)}that.stream=null;that.fire("stop")};that.hasScreenShare=function(){if(that.stream){return that.stream.getVideoTracks().length>0&&hasScreenShare}return hasScreenShare};that.hasVideo=function(){if(that.stream){return that.stream.getVideoTracks().length>0}return sdpHasVideo};that.hasAudio=function(){if(that.stream){return that.stream.getAudioTracks().length>0}return sdpHasAudio};that.hasMedia=function(){return!!that.stream};that.setSDP=function(oSession){sdpHasVideo=respoke.sdpHasVideo(oSession.sdp);sdpHasAudio=respoke.sdpHasAudio(oSession.sdp);sdpHasDataChannel=respoke.sdpHasDataChannel(oSession.sdp);if(that.temporary){that.constraints={video:sdpHasVideo,audio:sdpHasAudio,mandatory:{},optional:[]}}};that.setConstraints=function(constraints){that.constraints=constraints;sdpHasVideo=respoke.constraintsHasVideo(that.constraints);sdpHasAudio=respoke.constraintsHasAudio(that.constraints)};that.start=function(params){var retVal;params=params||{};if(that.temporary){deferred.reject(new Error("Temporary local media started!"))}else{requestMedia()}retVal=respoke.handlePromise(deferred.promise,params.onSuccess,params.onError);return retVal};return that}},function(module,exports,__webpack_require__){var respoke=__webpack_require__(1);module.exports=function(params){"use strict";params=params||{};var that=respoke.EventEmitter(params);that.className="respoke.RemoteMedia";that.id=respoke.makeGUID();that.element=params.element||document.createElement("video");var hasScreenShare=params.hasScreenShare;delete params.hasScreenShare;var sdpHasAudio=false;var sdpHasVideo=false;var sdpHasDataChannel=false;var allowTimer=0;var mediaOptions={optional:[{DtlsSrtpKeyAgreement:true},{RtpDataChannels:false}]};var pc=params.pc;delete that.pc;that.stream=params.stream;if(!that.temporary){attachMediaStream(that.element,that.stream);that.element.autoplay=true;setTimeout(that.element.play.bind(that.element))}that.hasScreenShare=function(){if(that.stream){return that.stream.getVideoTracks().length>0&&hasScreenShare}return hasScreenShare};that.hasVideo=function(){if(that.stream){return that.stream.getVideoTracks().length>0}return sdpHasVideo};that.hasAudio=function(){if(that.stream){return that.stream.getAudioTracks().length>0}return sdpHasAudio};that.hasMedia=function(){return!!that.stream};that.setSDP=function(oSession){sdpHasVideo=respoke.sdpHasVideo(oSession.sdp);sdpHasAudio=respoke.sdpHasAudio(oSession.sdp);sdpHasDataChannel=respoke.sdpHasDataChannel(oSession.sdp)};that.setConstraints=function(constraints){that.constraints=constraints;sdpHasVideo=respoke.constraintsHasVideo(that.constraints);sdpHasAudio=respoke.constraintsHasAudio(that.constraints)};that.getAudioTracks=function(){if(that.stream){return that.stream.getAudioTracks()}return[]};that.getVideoTracks=function(){if(that.stream){return that.stream.getVideoTracks()}return[]};that.stop=function(){if(!that.stream){return}that.stream.numPc-=1;if(that.stream.numPc===0){that.stream.getTracks().forEach(function(track){track.stop()})}that.stream=null;that.fire("stop")};that.isVideoMuted=function(){if(!that.stream){return false}return that.stream.getVideoTracks().every(function(track){return!track.enabled})};that.muteVideo=function(){if(that.isVideoMuted()){return}that.stream.getVideoTracks().forEach(function eachTrack(track){track.enabled=false});that.fire("mute",{type:"video",muted:true})};that.unmuteVideo=function(){if(!that.isVideoMuted()){return}that.stream.getVideoTracks().forEach(function eachTrack(track){track.enabled=true});that.fire("mute",{type:"video",muted:false})};that.isAudioMuted=function(){if(!that.stream){return false}return that.stream.getAudioTracks().every(function(track){return!track.enabled})};that.muteAudio=function(){if(that.isAudioMuted()){return}that.stream.getAudioTracks().forEach(function eachTrack(track){track.enabled=false});that.fire("mute",{type:"audio",muted:true})};that.unmuteAudio=function(){if(!that.isAudioMuted()){return}that.stream.getAudioTracks().forEach(function eachTrack(track){track.enabled=true});that.fire("mute",{type:"audio",muted:false})};return that}},function(module,exports,__webpack_require__){var Q=__webpack_require__(6);var respoke=__webpack_require__(1);module.exports=function(params){"use strict";params=params||{};var instanceId=params.instanceId;var signalingChannel=params.signalingChannel;var that=respoke.EventEmitter({id:params.id});that.listen("join",params.onJoin);that.listen("leave",params.onLeave);that.listen("message",params.onMessage);that.listen("mute",params.onMute);that.listen("topic",params.onTopic);that.listen("presenter",params.onPresenter);delete params.onJoin;delete params.onLeave;delete params.onMessage;delete params.onMute;delete params.onTopic;delete params.onPresenter;params.caller=true;params.conferenceId=params.id;delete params.id;params.remoteEndpoint=that;that.call=respoke.Call(params);["mute","hangup","connect","stats","error","local-stream-received","remote-stream-received","requesting-media","approve","allow"].forEach(function(eventName){that.call.listen(eventName,function(evt){evt.call=that.call;that.fire(eventName,evt)})});delete that.instanceId;that.className="respoke.Conference";var client=respoke.getClient(instanceId);that.leave=that.call.hangup;that.muteAudio=that.call.muteAudio;if(respoke.MediaStats){that.getStats=that.call.getStats}that.getParticipants=function(){return signalingChannel.getConferenceParticipants({id:that.id})};that.removeParticipant=function(params){params=params||{};params.conferenceId=that.id;return signalingChannel.removeConferenceParticipant(params)};that.destroy=function(params){return signalingChannel.destroyConference({conferenceId:that.id})};return that}}])});
//# sourceMappingURL=respoke.min.map