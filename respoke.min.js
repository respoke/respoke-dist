/*! Copyright (c) 2014, Digium, Inc. All Rights Reserved. MIT Licensed.For details and documentation visit https://www.respoke.io */
!function(root,factory){"object"==typeof exports&&"object"==typeof module?module.exports=factory():"function"==typeof define&&define.amd?define([],factory):"object"==typeof exports?exports.respoke=factory():root.respoke=factory()}(this,function(){return function(modules){function __webpack_require__(moduleId){if(installedModules[moduleId])return installedModules[moduleId].exports;var module=installedModules[moduleId]={exports:{},id:moduleId,loaded:!1};return modules[moduleId].call(module.exports,module,module.exports,__webpack_require__),module.loaded=!0,module.exports}var installedModules={};return __webpack_require__.m=modules,__webpack_require__.c=installedModules,__webpack_require__.p="",__webpack_require__(0)}([function(module,exports,__webpack_require__){module.exports=__webpack_require__(1)},function(module,exports,__webpack_require__){(function(global){"use strict";function chromeScreenSharingExtensionReady(evt){var data=evt.detail;data.available===!0&&(respoke.hasChromeExtension=!0,respoke.chooseDesktopMedia=function(params,callback){function sourceIdListener(evt){var data=evt.detail;respoke.screenSourceId=data.sourceId,callback(data),document.removeEventListener("respoke-source-id",sourceIdListener)}if(!callback)throw new Error("Can't choose desktop media without callback parameter.");document.dispatchEvent(respoke.extEvent("ct-respoke-source-id",{source:params.source?[params.source]:["screen","window"]})),document.addEventListener("respoke-source-id",sourceIdListener)},respoke.fire("extension-loaded",{type:"screen-sharing"}),log.info("Respoke Screen Share Chrome extension available for use."))}var log=__webpack_require__(2);log.setLevel(log.levels.WARN);var originalFactory=log.methodFactory;log.methodFactory=function(methodName,logLevel){var errorReporter,logMethod=originalFactory(methodName,logLevel);return errorReporter=function(){},function(message){var args=Array.prototype.slice.call(arguments),reporterMessage=args.join(" ");args.unshift("[Respoke]"),logMethod.apply(this,args),errorReporter(reporterMessage)}},__webpack_require__(3);var EventEmitter=__webpack_require__(4),respoke=module.exports=EventEmitter({ridiculous:!1,buildNumber:"v1.47.0",streams:[],Q:__webpack_require__(6)});respoke.Q.longStackSupport=!0,respoke.Q.stackJumpLimit=5,respoke.Q.longStackJumpLimit=20,respoke.Q.stopUnhandledRejectionTracking(),respoke.instances={},respoke.needsChromeExtension=!(!window.chrome||window.opera||!navigator.webkitGetUserMedia),respoke.needsFirefoxExtension="firefox"===window.webrtcDetectedBrowser,respoke.hasChromeExtension=!1,respoke.hasFirefoxExtension=!1,respoke.chooseDesktopMedia=function(){log.warn("Screen sharing is not implemented for this browser.")},respoke.isNwjs=function(){var gui,isNwjs=!("undefined"==typeof process||"undefined"==typeof global||!global.window||!global.window.nwDispatcher);return isNwjs&&(gui=window.nwDispatcher.requireNwGui(),gui.Screen.Init(),respoke.chooseDesktopMedia=function(data,callback){callback||"function"!=typeof data||(callback=data,data=null);var mediaSources=data&&data.source?[data.source]:["window","screen"];gui.Screen.chooseDesktopMedia(mediaSources,function(sourceId){callback({type:"respoke-source-id",sourceId:sourceId})})}),isNwjs}(),respoke.extEvent=function(type,data){var evt=document.createEvent("CustomEvent");return evt.initCustomEvent(type,!0,!0,data),evt},respoke.version=respoke.buildNumber+"",respoke.log=log,respoke.Class=__webpack_require__(5),respoke.EventEmitter=EventEmitter,respoke.Client=__webpack_require__(7),respoke.Connection=__webpack_require__(8),respoke.Endpoint=__webpack_require__(9),respoke.TextMessage=__webpack_require__(10),respoke.SignalingMessage=__webpack_require__(11),respoke.Group=__webpack_require__(12),respoke.SignalingChannel=__webpack_require__(13),respoke.DirectConnection=__webpack_require__(17),respoke.PeerConnection=__webpack_require__(18),respoke.CallState=__webpack_require__(19),respoke.Call=__webpack_require__(21),respoke.LocalMedia=__webpack_require__(22),respoke.RemoteMedia=__webpack_require__(23),respoke.Conference=__webpack_require__(24),document.addEventListener("respoke-available",chromeScreenSharingExtensionReady),document.addEventListener("respoke-chrome-screen-sharing-available",chromeScreenSharingExtensionReady),document.addEventListener("respoke-firefox-screen-sharing-available",function(evt){var data=evt.detail;"available"===data&&(respoke.hasFirefoxExtension=!0,respoke.fire("extension-loaded",{type:"screen-sharing"}),log.info("Respoke Screen Share Firefox extension available for use."))}),respoke.connect=function(params){var client=respoke.Client(params);return client.connect(params),client},respoke.getClient=function(id){return void 0===id&&log.debug("Can't call getClient with no client ID.",(new Error).stack),respoke.instances[id]||log.debug("No client instance with id",id),respoke.instances[id]},respoke.createClient=function(params){var client;return params=params||{},params.instanceId&&(client=respoke.getClient(params.instanceId))?client:respoke.Client(params)},respoke.callOnce=function(func){return function(){var called=!1;return function(){called===!1&&(func.apply(null,arguments),called=!0)}}()},respoke.makeGUID=function(){for(var r,chars="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),uuid=new Array(36),rnd=0,i=0;36>i;i+=1)8===i||13===i||18===i||23===i?uuid[i]="-":14===i?uuid[i]="4":(2>=rnd&&(rnd=33554432+16777216*Math.random()|0),r=15&rnd,rnd>>=4,uuid[i]=chars[19===i?3&r|8:r]);return uuid.join("")},respoke.handlePromise=function(promise,onSuccess,onError){var returnUndef=!1;return(onSuccess||onError)&&(returnUndef=!0),onSuccess="function"==typeof onSuccess?onSuccess:function(){},onError="function"==typeof onError?onError:function(){},promise.done(onSuccess,onError),returnUndef?void 0:promise},respoke.hasUserMedia=function(){return(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia)instanceof Function},respoke.hasRTCPeerConnection=function(){return(window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection)instanceof Function},respoke.hasWebsocket=function(){return(window.WebSocket||window.webkitWebSocket||window.MozWebSocket)instanceof Function},respoke.hasScreenShare=function(){return respoke.hasChromeExtension||respoke.hasFirefoxExtension},respoke.clone=function(source){return source?JSON.parse(JSON.stringify(source)):source},respoke.isEqual=function(a,b){var aKeys,i;if(a&&b&&a.hasOwnProperty("length")&&b.hasOwnProperty("length")&&a.splice&&b.splice){if(a.length!==b.length)return!1;for(i=0;i<a.length;i+=1)if(!respoke.isEqual(a[i],b[i]))return!1;return!0}if("object"==typeof a&&"object"==typeof b&&Object.keys(a).length===Object.keys(b).length){for(aKeys=Object.keys(a),i=0;i<aKeys.length;i+=1)if(!respoke.isEqual(a[aKeys[i]],b[aKeys[i]]))return!1;return!0}return a===b},respoke.sdpStreamCount=function(sdp){var matches,resolvedMatches={};if(!sdp)throw new Error("respoke.sdpHasAudio called with no parameters.");return(matches=sdp.match(/mslabel:(.*)/gi))?(matches.forEach(function(line){resolvedMatches[line]=!0}),Object.keys(resolvedMatches).length):0},respoke.sdpHasAudio=function(sdp){if(!sdp)throw new Error("respoke.sdpHasAudio called with no parameters.");return-1!==sdp.indexOf("m=audio")&&-1===sdp.indexOf("a=recvonly")},respoke.sdpHasVideo=function(sdp){if(!sdp)throw new Error("respoke.sdpHasVideo called with no parameters.");return-1!==sdp.indexOf("m=video")&&-1===sdp.indexOf("a=recvonly")},respoke.sdpHasDataChannel=function(sdp){if(!sdp)throw new Error("respoke.sdpHasDataChannel called with no parameters.");return-1!==sdp.indexOf("m=application")},respoke.sdpHasSendOnly=function(sdp){if(!sdp)throw new Error("respoke.sdpHasSendOnly called with no parameters.");return-1!==sdp.indexOf("a=sendonly")},respoke.sdpHasReceiveOnly=function(sdp){if(!sdp)throw new Error("respoke.sdpHasReceiveOnly called with no parameters.");return-1!==sdp.indexOf("a=recvonly")},respoke.constraintsHasAudio=function(constraints){if(!constraints)throw new Error("respoke.constraintsHasAudio called with no parameters.");return constraints.audio===!0},respoke.constraintsHasVideo=function(constraints){if(!constraints)throw new Error("respoke.constraintsHasVideo called with no parameters.");return constraints.video===!0||"object"==typeof constraints.video},respoke.constraintsHasScreenShare=function(constraints){if(!constraints)throw new Error("respoke.constraintsHasScreenShare called with no parameters.");return constraints.video&&constraints.video.mandatory&&(constraints.video.mandatory.chromeMediaSource||constraints.video.mediaSource)},respoke.convertConstraints=function(constraints,defaults){return constraints=constraints||[],defaults=defaults||[],constraints.splice||(constraints="object"==typeof constraints?[constraints]:[]),0===constraints.length&&defaults.length>0?defaults:constraints},respoke.queueFactory=function(){var queue=[];return queue.trigger=function(action){function safeAction(item){try{action(item)}catch(err){log.error("Error calling queue action.",err)}}if(!action)throw new Error("Trigger function requires an action parameter.");queue.forEach(safeAction),queue.length=0,queue.push=safeAction},queue},respoke.getScreenShareConstraints=function(params){params=params||{};var screenConstraint=params.constraints||{audio:!1,video:{mandatory:{},optional:[]}};return screenConstraint.audio=!1,screenConstraint.video="object"==typeof screenConstraint.video?screenConstraint.video:{},screenConstraint.video.optional=Array.isArray(screenConstraint.video.optional)?screenConstraint.video.optional:[],screenConstraint.video.mandatory="object"==typeof screenConstraint.video.mandatory?screenConstraint.video.mandatory:{},respoke.needsChromeExtension||respoke.isNwjs?(screenConstraint.audio=!1,screenConstraint.video.mandatory.chromeMediaSource="desktop",screenConstraint.video.mandatory.maxWidth="number"==typeof screenConstraint.video.mandatory.maxWidth?screenConstraint.video.mandatory.maxWidth:2e3,screenConstraint.video.mandatory.maxHeight="number"==typeof screenConstraint.video.mandatory.maxHeight?screenConstraint.video.mandatory.maxHeight:2e3,screenConstraint.video.optional.length>0?screenConstraint.video.optional.forEach(function(thing){thing.googTemporalLayeredScreencast=!0}):screenConstraint.video.optional[0]={googTemporalLayeredScreencast:!0}):screenConstraint.video.mediaSource=params.source||"screen",screenConstraint},respoke.getScreenShareMedia=function(params){params=params||{};var deferred=respoke.Q.defer(),criteria={source:params.source,constraints:respoke.clone(params.constraints)},localMedia=respoke.LocalMedia({hasScreenShare:!0,constraints:respoke.getScreenShareConstraints(criteria),source:params.source,element:params.element});return localMedia.start().done(function(){deferred.resolve(localMedia)},function(err){deferred.reject(err)}),respoke.handlePromise(deferred.promise,params.onSuccess,params.onError)}}).call(exports,function(){return this}())},function(module,exports,__webpack_require__){var __WEBPACK_AMD_DEFINE_FACTORY__,__WEBPACK_AMD_DEFINE_RESULT__;!function(root,definition){"object"==typeof module&&module.exports?module.exports=definition():(__WEBPACK_AMD_DEFINE_FACTORY__=definition,__WEBPACK_AMD_DEFINE_RESULT__="function"==typeof __WEBPACK_AMD_DEFINE_FACTORY__?__WEBPACK_AMD_DEFINE_FACTORY__.call(exports,__webpack_require__,exports,module):__WEBPACK_AMD_DEFINE_FACTORY__,!(void 0!==__WEBPACK_AMD_DEFINE_RESULT__&&(module.exports=__WEBPACK_AMD_DEFINE_RESULT__)))}(this,function(){function realMethod(methodName){return typeof console===undefinedType?!1:void 0!==console[methodName]?bindMethod(console,methodName):void 0!==console.log?bindMethod(console,"log"):noop}function bindMethod(obj,methodName){var method=obj[methodName];if("function"==typeof method.bind)return method.bind(obj);try{return Function.prototype.bind.call(method,obj)}catch(e){return function(){return Function.prototype.apply.apply(method,[obj,arguments])}}}function enableLoggingWhenConsoleArrives(methodName,level){return function(){typeof console!==undefinedType&&(replaceLoggingMethods(level),self[methodName].apply(self,arguments))}}function replaceLoggingMethods(level){for(var i=0;i<logMethods.length;i++){var methodName=logMethods[i];self[methodName]=level>i?noop:self.methodFactory(methodName,level)}}function persistLevelIfPossible(levelNum){var levelName=(logMethods[levelNum]||"silent").toUpperCase();try{return void(window.localStorage.loglevel=levelName)}catch(ignore){}try{window.document.cookie="loglevel="+levelName+";"}catch(ignore){}}function loadPersistedLevel(){var storedLevel;try{storedLevel=window.localStorage.loglevel}catch(ignore){}if(typeof storedLevel===undefinedType)try{storedLevel=/loglevel=([^;]+)/.exec(window.document.cookie)[1]}catch(ignore){}void 0===self.levels[storedLevel]&&(storedLevel="WARN"),self.setLevel(self.levels[storedLevel])}var self={},noop=function(){},undefinedType="undefined",logMethods=["trace","debug","info","warn","error"];self.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},self.methodFactory=function(methodName,level){return realMethod(methodName)||enableLoggingWhenConsoleArrives(methodName,level)},self.setLevel=function(level){if("string"==typeof level&&void 0!==self.levels[level.toUpperCase()]&&(level=self.levels[level.toUpperCase()]),!("number"==typeof level&&level>=0&&level<=self.levels.SILENT))throw"log.setLevel() called with invalid level: "+level;return persistLevelIfPossible(level),replaceLoggingMethods(level),typeof console===undefinedType&&level<self.levels.SILENT?"No console available for logging":void 0},self.enableAll=function(){self.setLevel(self.levels.TRACE)},self.disableAll=function(){self.setLevel(self.levels.SILENT)};var _log=typeof window!==undefinedType?window.log:void 0;return self.noConflict=function(){return typeof window!==undefinedType&&window.log===self&&(window.log=_log),self},loadPersistedLevel(),self})},function(module,exports){/*!
	 *  Copyright (c) 2014 The WebRTC project authors. All Rights Reserved.
	 *
	 *  Use of this source code is governed by a BSD-style license
	 *  that can be found in the LICENSE file in the same directory as
	 *  this source file.
	 * @ignore
	 */
"use strict";function maybeFixConfiguration(pcConfig){if(pcConfig)for(var i=0;i<pcConfig.iceServers.length;i++)pcConfig.iceServers[i].hasOwnProperty("urls")&&(pcConfig.iceServers[i].url=pcConfig.iceServers[i].urls,delete pcConfig.iceServers[i].urls)}var RTCPeerConnection=null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,webrtcDetectedVersion=null;if(navigator.mozGetUserMedia)console.log("This appears to be Firefox"),webrtcDetectedBrowser="firefox",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10),RTCPeerConnection=function(pcConfig,pcConstraints){return maybeFixConfiguration(pcConfig),new mozRTCPeerConnection(pcConfig,pcConstraints)},window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,window.createIceServer=function(url,username,password){var iceServer=null,urlParts=url.split(":");if(0===urlParts[0].indexOf("stun"))iceServer={url:url};else if(0===urlParts[0].indexOf("turn"))if(27>webrtcDetectedVersion){var turnUrlParts=url.split("?");(1===turnUrlParts.length||0===turnUrlParts[1].indexOf("transport=udp"))&&(iceServer={url:turnUrlParts[0],credential:password,username:username})}else iceServer={url:url,credential:password,username:username};return iceServer},window.createIceServers=function(urls,username,password){for(var iceServers=[],i=0;i<urls.length;i++){var iceServer=window.createIceServer(urls[i],username,password);null!==iceServer&&iceServers.push(iceServer)}return iceServers},attachMediaStream=function(element,stream){element.mozSrcObject=stream,setTimeout(function(){element.play()},100)},reattachMediaStream=function(to,from){to.mozSrcObject=from.mozSrcObject};else if(navigator.webkitGetUserMedia){console.log("This appears to be Chrome"),webrtcDetectedBrowser="chrome";var result=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);webrtcDetectedVersion=null!==result?parseInt(result[2],10):999,window.createIceServer=function(url,username,password){var iceServer=null,urlParts=url.split(":");return 0===urlParts[0].indexOf("stun")?iceServer={url:url}:0===urlParts[0].indexOf("turn")&&(iceServer={url:url,credential:password,username:username}),iceServer},window.createIceServers=function(urls,username,password){var iceServers=[];if(webrtcDetectedVersion>=34)iceServers={urls:urls,credential:password,username:username};else for(var i=0;i<urls.length;i++){var iceServer=window.createIceServer(urls[i],username,password);null!==iceServer&&iceServers.push(iceServer)}return iceServers},RTCPeerConnection=function(pcConfig,pcConstraints){return 34>webrtcDetectedVersion&&maybeFixConfiguration(pcConfig),new webkitRTCPeerConnection(pcConfig,pcConstraints)},getUserMedia=navigator.webkitGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,attachMediaStream=function(element,stream){"undefined"!=typeof element.srcObject?element.srcObject=stream:"undefined"!=typeof element.mozSrcObject?element.mozSrcObject=stream:"undefined"!=typeof element.src?element.src=URL.createObjectURL(stream):console.log("Error attaching stream to element.")},reattachMediaStream=function(to,from){to.src=from.src}}else console.log("Browser does not appear to be WebRTC-capable");window.RTCPeerConnection=RTCPeerConnection,window.getUserMedia=getUserMedia,window.attachMediaStream=attachMediaStream,window.reattachMediaStream=reattachMediaStream,window.webrtcDetectedBrowser=webrtcDetectedBrowser,window.webrtcDetectedVersion=webrtcDetectedVersion},function(module,exports,__webpack_require__){var log=__webpack_require__(2),respokeClass=__webpack_require__(5),callOnce=function(func){"use strict";return function(){var called=!1;return function(){called||(func.apply(null,arguments),called=!0)}}()};module.exports=function(params){"use strict";function listenerBuilder(listener,evt,eventType){return function(){try{listener.call(that,evt)}catch(e){log.error("Error in "+that.className+"#"+eventType,e.message,e.stack)}}}params=params||{};var that=respokeClass(params);that.className="respoke.EventEmitter";var eventList={};return that.once=function(eventType,listener,isInternal){var string=listener.toString();listener=callOnce(listener),listener.toString=function(){return string},listener.once=!0,that.listen(eventType,listener,isInternal)},that.listen=function(eventType,listener,isInternal){if(void 0!==listener){var invalidEventType="string"!=typeof eventType||!eventType,invalidListener="function"!=typeof listener;if(invalidEventType||invalidListener)return void log.error("Invalid request to add event listener to",eventType,listener);eventList[eventType]=eventList[eventType]||[],listener.isInternal=!!isInternal;var toString=function(fn){return fn.toString()},isNotAlreadyAdded=-1===eventList[eventType].map(toString).indexOf(listener.toString());isNotAlreadyAdded?eventList[eventType].push(listener):log.warn("Not adding duplicate listener to",eventType,listener)}},that.ignore=function(eventType,listener){if(void 0===eventType)return void(eventList={});if(void 0===listener||!eventList[eventType])return void(eventList[eventType]=[]);for(var i=eventList[eventType].length-1;i>=0;i-=1)if(listener===eventList[eventType][i])return void eventList[eventType].splice(i,1)},that.fire=function(eventType,evt){var i,count=0,toRemove=[];if(evt=evt||{},evt.name=eventType,evt.target=that,eventType){if(!eventList[eventType])return void log.debug("fired "+that.className+"#"+eventType+" 0 listeners called with params",evt);for(i=0;i<eventList[eventType].length;i+=1){var listener=eventList[eventType][i];"function"==typeof listener&&(setTimeout(listenerBuilder(listener,evt,eventType)),count+=1,listener.once===!0&&toRemove.push(i))}for(i=toRemove.length-1;i>=0;i-=1)eventList[eventType].splice(toRemove[i],1);log.debug("fired "+that.className+"#"+eventType+" "+count+" listeners called with params",evt)}},that.hasListeners=function(eventType){if(void 0===eventType)throw new Error("Missing required parameter event type.");return eventList[eventType]?!eventList[eventType].every(function(listener){return listener.isInternal}):!1},that}},function(module,exports){module.exports=function(params){"use strict";params=params||{};var that=params.that||{};return that.className="respoke.Class",delete params.that,delete that.client,Object.keys(params).forEach(function(name){that[name]=params[name]}),that}},function(module,exports,__webpack_require__){/*!
	 *
	 * Copyright 2009-2012 Kris Kowal under the terms of the MIT
	 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
	 *
	 * With parts by Tyler Close
	 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
	 * at http://www.opensource.org/licenses/mit-license.html
	 * Forked at ref_send.js version: 2009-05-11
	 *
	 * With parts by Mark Miller
	 * Copyright (C) 2011 Google Inc.
	 *
	 * Licensed under the Apache License, Version 2.0 (the "License");
	 * you may not use this file except in compliance with the License.
	 * You may obtain a copy of the License at
	 *
	 * http://www.apache.org/licenses/LICENSE-2.0
	 *
	 * Unless required by applicable law or agreed to in writing, software
	 * distributed under the License is distributed on an "AS IS" BASIS,
	 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
	 * See the License for the specific language governing permissions and
	 * limitations under the License.
	 *
	 */
!function(definition){"use strict";"function"==typeof bootstrap?bootstrap("promise",definition):module.exports=definition()}(function(){"use strict";function uncurryThis(f){return function(){return call.apply(f,arguments)}}function isObject(value){return value===Object(value)}function isStopIteration(exception){return"[object StopIteration]"===object_toString(exception)||exception instanceof QReturnValue}function makeStackTraceLong(error,promise){if(hasStacks&&promise.stack&&"object"==typeof error&&null!==error&&error.stack&&-1===error.stack.indexOf(STACK_JUMP_SEPARATOR)){for(var stacks=[],p=promise;p;p=p.source)p.stack&&stacks.unshift(p.stack);stacks.unshift(error.stack);var concatedStacks=stacks.join("\n"+STACK_JUMP_SEPARATOR+"\n");error.stack=filterStackString(concatedStacks)}}function filterStackString(stackString){for(var lines=stackString.split("\n"),desiredLines=[],i=0;i<lines.length;++i){var line=lines[i];isInternalFrame(line)||isNodeFrame(line)||!line||desiredLines.push(line)}return desiredLines.join("\n")}function isNodeFrame(stackLine){return-1!==stackLine.indexOf("(module.js:")||-1!==stackLine.indexOf("(node.js:")}function getFileNameAndLineNumber(stackLine){var attempt1=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(stackLine);if(attempt1)return[attempt1[1],Number(attempt1[2])];var attempt2=/at ([^ ]+):(\d+):(?:\d+)$/.exec(stackLine);if(attempt2)return[attempt2[1],Number(attempt2[2])];var attempt3=/.*@(.+):(\d+)$/.exec(stackLine);return attempt3?[attempt3[1],Number(attempt3[2])]:void 0}function isInternalFrame(stackLine){var fileNameAndLineNumber=getFileNameAndLineNumber(stackLine);if(!fileNameAndLineNumber)return!1;var fileName=fileNameAndLineNumber[0],lineNumber=fileNameAndLineNumber[1];return fileName===qFileName&&lineNumber>=qStartingLine&&qEndingLine>=lineNumber}function captureLine(){if(hasStacks)try{throw new Error}catch(e){var lines=e.stack.split("\n"),firstLine=lines[0].indexOf("@")>0?lines[1]:lines[2],fileNameAndLineNumber=getFileNameAndLineNumber(firstLine);if(!fileNameAndLineNumber)return;return qFileName=fileNameAndLineNumber[0],fileNameAndLineNumber[1]}}function deprecate(callback,name,alternative){return function(){return"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn(name+" is deprecated, use "+alternative+" instead.",new Error("").stack),callback.apply(callback,arguments)}}function Q(value){return value instanceof Promise?value:isPromiseAlike(value)?coerce(value):fulfill(value)}function defer(){function become(newPromise){resolvedPromise=newPromise,promise.source=newPromise,array_reduce(messages,function(undefined,message){Q.nextTick(function(){newPromise.promiseDispatch.apply(newPromise,message)})},void 0),messages=void 0,progressListeners=void 0}var resolvedPromise,messages=[],progressListeners=[],deferred=object_create(defer.prototype),promise=object_create(Promise.prototype);if(promise.promiseDispatch=function(resolve,op,operands){var args=array_slice(arguments);messages?(messages.push(args),"when"===op&&operands[1]&&progressListeners.push(operands[1])):Q.nextTick(function(){resolvedPromise.promiseDispatch.apply(resolvedPromise,args)})},promise.valueOf=function(){if(messages)return promise;var nearerValue=nearer(resolvedPromise);return isPromise(nearerValue)&&(resolvedPromise=nearerValue),nearerValue},promise.inspect=function(){return resolvedPromise?resolvedPromise.inspect():{state:"pending"}},Q.longStackSupport&&hasStacks)try{throw new Error}catch(e){promise.stack=e.stack.substring(e.stack.indexOf("\n")+1)}return deferred.promise=promise,deferred.resolve=function(value){resolvedPromise||become(Q(value))},deferred.fulfill=function(value){resolvedPromise||become(fulfill(value))},deferred.reject=function(reason){resolvedPromise||become(reject(reason))},deferred.notify=function(progress){resolvedPromise||array_reduce(progressListeners,function(undefined,progressListener){Q.nextTick(function(){progressListener(progress)})},void 0)},deferred}function promise(resolver){if("function"!=typeof resolver)throw new TypeError("resolver must be a function.");var deferred=defer();try{resolver(deferred.resolve,deferred.reject,deferred.notify)}catch(reason){deferred.reject(reason)}return deferred.promise}function race(answerPs){return promise(function(resolve,reject){for(var i=0,len=answerPs.length;len>i;i++)Q(answerPs[i]).then(resolve,reject)})}function Promise(descriptor,fallback,inspect){void 0===fallback&&(fallback=function(op){return reject(new Error("Promise does not support operation: "+op))}),void 0===inspect&&(inspect=function(){return{state:"unknown"}});var promise=object_create(Promise.prototype);if(promise.promiseDispatch=function(resolve,op,args){var result;try{result=descriptor[op]?descriptor[op].apply(promise,args):fallback.call(promise,op,args)}catch(exception){result=reject(exception)}resolve&&resolve(result)},promise.inspect=inspect,inspect){var inspected=inspect();"rejected"===inspected.state&&(promise.exception=inspected.reason),promise.valueOf=function(){var inspected=inspect();return"pending"===inspected.state||"rejected"===inspected.state?promise:inspected.value}}return promise}function when(value,fulfilled,rejected,progressed){return Q(value).then(fulfilled,rejected,progressed)}function nearer(value){if(isPromise(value)){var inspected=value.inspect();if("fulfilled"===inspected.state)return inspected.value}return value}function isPromise(object){return object instanceof Promise}function isPromiseAlike(object){return isObject(object)&&"function"==typeof object.then}function isPending(object){return isPromise(object)&&"pending"===object.inspect().state}function isFulfilled(object){return!isPromise(object)||"fulfilled"===object.inspect().state}function isRejected(object){return isPromise(object)&&"rejected"===object.inspect().state}function resetUnhandledRejections(){unhandledReasons.length=0,unhandledRejections.length=0,trackUnhandledRejections||(trackUnhandledRejections=!0)}function trackRejection(promise,reason){trackUnhandledRejections&&("object"==typeof process&&"function"==typeof process.emit&&Q.nextTick.runAfter(function(){-1!==array_indexOf(unhandledRejections,promise)&&(process.emit("unhandledRejection",reason,promise),reportedUnhandledRejections.push(promise))}),unhandledRejections.push(promise),reason&&"undefined"!=typeof reason.stack?unhandledReasons.push(reason.stack):unhandledReasons.push("(no stack) "+reason))}function untrackRejection(promise){if(trackUnhandledRejections){var at=array_indexOf(unhandledRejections,promise);-1!==at&&("object"==typeof process&&"function"==typeof process.emit&&Q.nextTick.runAfter(function(){var atReport=array_indexOf(reportedUnhandledRejections,promise);-1!==atReport&&(process.emit("rejectionHandled",unhandledReasons[at],promise),reportedUnhandledRejections.splice(atReport,1))}),unhandledRejections.splice(at,1),unhandledReasons.splice(at,1))}}function reject(reason){var rejection=Promise({when:function(rejected){return rejected&&untrackRejection(this),rejected?rejected(reason):this}},function(){return this},function(){return{state:"rejected",reason:reason}});return trackRejection(rejection,reason),rejection}function fulfill(value){return Promise({when:function(){return value},get:function(name){return value[name]},set:function(name,rhs){value[name]=rhs},"delete":function(name){delete value[name]},post:function(name,args){return null===name||void 0===name?value.apply(void 0,args):value[name].apply(value,args)},apply:function(thisp,args){return value.apply(thisp,args)},keys:function(){return object_keys(value)}},void 0,function(){return{state:"fulfilled",value:value}})}function coerce(promise){var deferred=defer();return Q.nextTick(function(){try{promise.then(deferred.resolve,deferred.reject,deferred.notify)}catch(exception){deferred.reject(exception)}}),deferred.promise}function master(object){return Promise({isDef:function(){}},function(op,args){return dispatch(object,op,args)},function(){return Q(object).inspect()})}function spread(value,fulfilled,rejected){return Q(value).spread(fulfilled,rejected)}function async(makeGenerator){return function(){function continuer(verb,arg){var result;if("undefined"==typeof StopIteration){try{result=generator[verb](arg)}catch(exception){return reject(exception)}return result.done?Q(result.value):when(result.value,callback,errback)}try{result=generator[verb](arg)}catch(exception){return isStopIteration(exception)?Q(exception.value):reject(exception)}return when(result,callback,errback)}var generator=makeGenerator.apply(this,arguments),callback=continuer.bind(continuer,"next"),errback=continuer.bind(continuer,"throw");return callback()}}function spawn(makeGenerator){Q.done(Q.async(makeGenerator)())}function _return(value){throw new QReturnValue(value)}function promised(callback){return function(){return spread([this,all(arguments)],function(self,args){return callback.apply(self,args)})}}function dispatch(object,op,args){return Q(object).dispatch(op,args)}function all(promises){return when(promises,function(promises){var pendingCount=0,deferred=defer();return array_reduce(promises,function(undefined,promise,index){var snapshot;isPromise(promise)&&"fulfilled"===(snapshot=promise.inspect()).state?promises[index]=snapshot.value:(++pendingCount,when(promise,function(value){promises[index]=value,0===--pendingCount&&deferred.resolve(promises)},deferred.reject,function(progress){deferred.notify({index:index,value:progress})}))},void 0),0===pendingCount&&deferred.resolve(promises),deferred.promise})}function any(promises){if(0===promises.length)return Q.resolve();var deferred=Q.defer(),pendingCount=0;return array_reduce(promises,function(prev,current,index){function onFulfilled(result){deferred.resolve(result)}function onRejected(){pendingCount--,0===pendingCount&&deferred.reject(new Error("Can't get fulfillment value from any promise, all promises were rejected."))}function onProgress(progress){deferred.notify({index:index,value:progress})}var promise=promises[index];pendingCount++,when(promise,onFulfilled,onRejected,onProgress)},void 0),deferred.promise}function allResolved(promises){return when(promises,function(promises){return promises=array_map(promises,Q),when(all(array_map(promises,function(promise){return when(promise,noop,noop)})),function(){return promises})})}function allSettled(promises){return Q(promises).allSettled()}function progress(object,progressed){return Q(object).then(void 0,void 0,progressed)}function nodeify(object,nodeback){return Q(object).nodeify(nodeback)}var hasStacks=!1;try{throw new Error}catch(e){hasStacks=!!e.stack}var qFileName,QReturnValue,qStartingLine=captureLine(),noop=function(){},nextTick=function(){function flush(){for(var task,domain;head.next;)head=head.next,task=head.task,head.task=void 0,domain=head.domain,domain&&(head.domain=void 0,domain.enter()),runSingle(task,domain);for(;laterQueue.length;)task=laterQueue.pop(),runSingle(task);flushing=!1}function runSingle(task,domain){try{task()}catch(e){if(isNodeJS)throw domain&&domain.exit(),setTimeout(flush,0),domain&&domain.enter(),e;setTimeout(function(){throw e},0)}domain&&domain.exit()}var head={task:void 0,next:null},tail=head,flushing=!1,requestTick=void 0,isNodeJS=!1,laterQueue=[];if(nextTick=function(task){tail=tail.next={task:task,domain:isNodeJS&&process.domain,next:null},flushing||(flushing=!0,requestTick())},"object"==typeof process&&"[object process]"===process.toString()&&process.nextTick)isNodeJS=!0,requestTick=function(){process.nextTick(flush)};else if("function"==typeof setImmediate)requestTick="undefined"!=typeof window?setImmediate.bind(window,flush):function(){setImmediate(flush)};else if("undefined"!=typeof MessageChannel){var channel=new MessageChannel;channel.port1.onmessage=function(){requestTick=requestPortTick,channel.port1.onmessage=flush,flush()};var requestPortTick=function(){channel.port2.postMessage(0)};requestTick=function(){setTimeout(flush,0),requestPortTick()}}else requestTick=function(){setTimeout(flush,0)};return nextTick.runAfter=function(task){laterQueue.push(task),flushing||(flushing=!0,requestTick())},nextTick}(),call=Function.call,array_slice=uncurryThis(Array.prototype.slice),array_reduce=uncurryThis(Array.prototype.reduce||function(callback,basis){var index=0,length=this.length;if(1===arguments.length)for(;;){if(index in this){basis=this[index++];break}if(++index>=length)throw new TypeError}for(;length>index;index++)index in this&&(basis=callback(basis,this[index],index));return basis}),array_indexOf=uncurryThis(Array.prototype.indexOf||function(value){for(var i=0;i<this.length;i++)if(this[i]===value)return i;return-1}),array_map=uncurryThis(Array.prototype.map||function(callback,thisp){var self=this,collect=[];return array_reduce(self,function(undefined,value,index){collect.push(callback.call(thisp,value,index,self))},void 0),collect}),object_create=Object.create||function(prototype){function Type(){}return Type.prototype=prototype,new Type},object_hasOwnProperty=uncurryThis(Object.prototype.hasOwnProperty),object_keys=Object.keys||function(object){var keys=[];for(var key in object)object_hasOwnProperty(object,key)&&keys.push(key);return keys},object_toString=uncurryThis(Object.prototype.toString);QReturnValue="undefined"!=typeof ReturnValue?ReturnValue:function(value){this.value=value};var STACK_JUMP_SEPARATOR="From previous event:";Q.resolve=Q,Q.nextTick=nextTick,Q.longStackSupport=!1,"object"==typeof process&&process&&process.env&&process.env.Q_DEBUG&&(Q.longStackSupport=!0),Q.defer=defer,defer.prototype.makeNodeResolver=function(){var self=this;return function(error,value){error?self.reject(error):arguments.length>2?self.resolve(array_slice(arguments,1)):self.resolve(value)}},Q.Promise=promise,Q.promise=promise,promise.race=race,promise.all=all,promise.reject=reject,promise.resolve=Q,Q.passByCopy=function(object){return object},Promise.prototype.passByCopy=function(){return this},Q.join=function(x,y){return Q(x).join(y)},Promise.prototype.join=function(that){return Q([this,that]).spread(function(x,y){if(x===y)return x;throw new Error("Can't join: not the same: "+x+" "+y)})},Q.race=race,Promise.prototype.race=function(){return this.then(Q.race)},Q.makePromise=Promise,Promise.prototype.toString=function(){return"[object Promise]"},Promise.prototype.then=function(fulfilled,rejected,progressed){function _fulfilled(value){try{return"function"==typeof fulfilled?fulfilled(value):value}catch(exception){return reject(exception)}}function _rejected(exception){if("function"==typeof rejected){makeStackTraceLong(exception,self);try{return rejected(exception)}catch(newException){return reject(newException)}}return reject(exception)}function _progressed(value){return"function"==typeof progressed?progressed(value):value}var self=this,deferred=defer(),done=!1;return Q.nextTick(function(){self.promiseDispatch(function(value){done||(done=!0,deferred.resolve(_fulfilled(value)))},"when",[function(exception){done||(done=!0,deferred.resolve(_rejected(exception)))}])}),self.promiseDispatch(void 0,"when",[void 0,function(value){var newValue,threw=!1;try{newValue=_progressed(value)}catch(e){if(threw=!0,!Q.onerror)throw e;Q.onerror(e)}threw||deferred.notify(newValue)}]),deferred.promise},Q.tap=function(promise,callback){return Q(promise).tap(callback)},Promise.prototype.tap=function(callback){return callback=Q(callback),this.then(function(value){return callback.fcall(value).thenResolve(value)})},Q.when=when,Promise.prototype.thenResolve=function(value){return this.then(function(){return value})},Q.thenResolve=function(promise,value){return Q(promise).thenResolve(value)},Promise.prototype.thenReject=function(reason){return this.then(function(){throw reason})},Q.thenReject=function(promise,reason){return Q(promise).thenReject(reason)},Q.nearer=nearer,Q.isPromise=isPromise,Q.isPromiseAlike=isPromiseAlike,Q.isPending=isPending,Promise.prototype.isPending=function(){return"pending"===this.inspect().state},Q.isFulfilled=isFulfilled,Promise.prototype.isFulfilled=function(){return"fulfilled"===this.inspect().state},Q.isRejected=isRejected,Promise.prototype.isRejected=function(){return"rejected"===this.inspect().state};var unhandledReasons=[],unhandledRejections=[],reportedUnhandledRejections=[],trackUnhandledRejections=!0;Q.resetUnhandledRejections=resetUnhandledRejections,Q.getUnhandledReasons=function(){return unhandledReasons.slice()},Q.stopUnhandledRejectionTracking=function(){resetUnhandledRejections(),trackUnhandledRejections=!1},resetUnhandledRejections(),Q.reject=reject,Q.fulfill=fulfill,Q.master=master,Q.spread=spread,Promise.prototype.spread=function(fulfilled,rejected){return this.all().then(function(array){return fulfilled.apply(void 0,array)},rejected)},Q.async=async,Q.spawn=spawn,Q["return"]=_return,Q.promised=promised,Q.dispatch=dispatch,Promise.prototype.dispatch=function(op,args){var self=this,deferred=defer();return Q.nextTick(function(){self.promiseDispatch(deferred.resolve,op,args)}),deferred.promise},Q.get=function(object,key){return Q(object).dispatch("get",[key])},Promise.prototype.get=function(key){return this.dispatch("get",[key])},Q.set=function(object,key,value){return Q(object).dispatch("set",[key,value])},Promise.prototype.set=function(key,value){return this.dispatch("set",[key,value])},Q.del=Q["delete"]=function(object,key){return Q(object).dispatch("delete",[key])},Promise.prototype.del=Promise.prototype["delete"]=function(key){return this.dispatch("delete",[key])},Q.mapply=Q.post=function(object,name,args){return Q(object).dispatch("post",[name,args])},Promise.prototype.mapply=Promise.prototype.post=function(name,args){return this.dispatch("post",[name,args])},Q.send=Q.mcall=Q.invoke=function(object,name){return Q(object).dispatch("post",[name,array_slice(arguments,2)])},Promise.prototype.send=Promise.prototype.mcall=Promise.prototype.invoke=function(name){return this.dispatch("post",[name,array_slice(arguments,1)])},Q.fapply=function(object,args){return Q(object).dispatch("apply",[void 0,args])},Promise.prototype.fapply=function(args){return this.dispatch("apply",[void 0,args])},Q["try"]=Q.fcall=function(object){return Q(object).dispatch("apply",[void 0,array_slice(arguments,1)])},Promise.prototype.fcall=function(){return this.dispatch("apply",[void 0,array_slice(arguments)])},Q.fbind=function(object){var promise=Q(object),args=array_slice(arguments,1);return function(){return promise.dispatch("apply",[this,args.concat(array_slice(arguments))])}},Promise.prototype.fbind=function(){var promise=this,args=array_slice(arguments);return function(){return promise.dispatch("apply",[this,args.concat(array_slice(arguments))])}},Q.keys=function(object){return Q(object).dispatch("keys",[])},Promise.prototype.keys=function(){return this.dispatch("keys",[])},Q.all=all,Promise.prototype.all=function(){return all(this)},Q.any=any,Promise.prototype.any=function(){return any(this)},Q.allResolved=deprecate(allResolved,"allResolved","allSettled"),Promise.prototype.allResolved=function(){return allResolved(this)},Q.allSettled=allSettled,Promise.prototype.allSettled=function(){return this.then(function(promises){return all(array_map(promises,function(promise){function regardless(){return promise.inspect()}return promise=Q(promise),promise.then(regardless,regardless)}))})},Q.fail=Q["catch"]=function(object,rejected){return Q(object).then(void 0,rejected)},Promise.prototype.fail=Promise.prototype["catch"]=function(rejected){return this.then(void 0,rejected)},Q.progress=progress,Promise.prototype.progress=function(progressed){return this.then(void 0,void 0,progressed)},Q.fin=Q["finally"]=function(object,callback){return Q(object)["finally"](callback)},Promise.prototype.fin=Promise.prototype["finally"]=function(callback){return callback=Q(callback),this.then(function(value){return callback.fcall().then(function(){return value})},function(reason){return callback.fcall().then(function(){throw reason})})},Q.done=function(object,fulfilled,rejected,progress){return Q(object).done(fulfilled,rejected,progress)},Promise.prototype.done=function(fulfilled,rejected,progress){var onUnhandledError=function(error){Q.nextTick(function(){if(makeStackTraceLong(error,promise),!Q.onerror)throw error;Q.onerror(error)})},promise=fulfilled||rejected||progress?this.then(fulfilled,rejected,progress):this;"object"==typeof process&&process&&process.domain&&(onUnhandledError=process.domain.bind(onUnhandledError)),promise.then(void 0,onUnhandledError)},Q.timeout=function(object,ms,error){return Q(object).timeout(ms,error)},Promise.prototype.timeout=function(ms,error){var deferred=defer(),timeoutId=setTimeout(function(){error&&"string"!=typeof error||(error=new Error(error||"Timed out after "+ms+" ms"),error.code="ETIMEDOUT"),deferred.reject(error)},ms);return this.then(function(value){clearTimeout(timeoutId),deferred.resolve(value)},function(exception){clearTimeout(timeoutId),deferred.reject(exception)},deferred.notify),deferred.promise},Q.delay=function(object,timeout){return void 0===timeout&&(timeout=object,object=void 0),Q(object).delay(timeout)},Promise.prototype.delay=function(timeout){return this.then(function(value){var deferred=defer();return setTimeout(function(){deferred.resolve(value)},timeout),deferred.promise})},Q.nfapply=function(callback,args){return Q(callback).nfapply(args)},Promise.prototype.nfapply=function(args){var deferred=defer(),nodeArgs=array_slice(args);return nodeArgs.push(deferred.makeNodeResolver()),this.fapply(nodeArgs).fail(deferred.reject),deferred.promise},Q.nfcall=function(callback){var args=array_slice(arguments,1);return Q(callback).nfapply(args)},Promise.prototype.nfcall=function(){var nodeArgs=array_slice(arguments),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),this.fapply(nodeArgs).fail(deferred.reject),deferred.promise},Q.nfbind=Q.denodeify=function(callback){var baseArgs=array_slice(arguments,1);return function(){var nodeArgs=baseArgs.concat(array_slice(arguments)),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),Q(callback).fapply(nodeArgs).fail(deferred.reject),deferred.promise}},Promise.prototype.nfbind=Promise.prototype.denodeify=function(){var args=array_slice(arguments);return args.unshift(this),Q.denodeify.apply(void 0,args)},Q.nbind=function(callback,thisp){var baseArgs=array_slice(arguments,2);return function(){function bound(){return callback.apply(thisp,arguments)}var nodeArgs=baseArgs.concat(array_slice(arguments)),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),Q(bound).fapply(nodeArgs).fail(deferred.reject),deferred.promise}},Promise.prototype.nbind=function(){var args=array_slice(arguments,0);return args.unshift(this),Q.nbind.apply(void 0,args)},Q.nmapply=Q.npost=function(object,name,args){return Q(object).npost(name,args)},Promise.prototype.nmapply=Promise.prototype.npost=function(name,args){var nodeArgs=array_slice(args||[]),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),this.dispatch("post",[name,nodeArgs]).fail(deferred.reject),deferred.promise},Q.nsend=Q.nmcall=Q.ninvoke=function(object,name){var nodeArgs=array_slice(arguments,2),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),Q(object).dispatch("post",[name,nodeArgs]).fail(deferred.reject),deferred.promise},Promise.prototype.nsend=Promise.prototype.nmcall=Promise.prototype.ninvoke=function(name){var nodeArgs=array_slice(arguments,1),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),this.dispatch("post",[name,nodeArgs]).fail(deferred.reject),deferred.promise},Q.nodeify=nodeify,Promise.prototype.nodeify=function(nodeback){return nodeback?void this.then(function(value){Q.nextTick(function(){nodeback(null,value)})},function(error){Q.nextTick(function(){nodeback(error)})}):this};var qEndingLine=captureLine();return Q})},function(module,exports,__webpack_require__){var Q=__webpack_require__(6),respoke=__webpack_require__(1),log=respoke.log;module.exports=function(params){"use strict";function saveParameters(params){Object.keys(params).forEach(function(key){-1===["onSuccess","onError","reconnect","presence"].indexOf(key)&&void 0!==params[key]&&(clientSettings[key]=params[key])}),clientSettings.developmentMode=!!clientSettings.developmentMode,clientSettings.enableCallDebugReport="boolean"==typeof clientSettings.enableCallDebugReport?clientSettings.enableCallDebugReport:!0,"number"!=typeof clientSettings.connectTimeoutMillis&&(clientSettings.connectTimeoutMillis=1e4),"boolean"!=typeof params.reconnect?clientSettings.reconnect="boolean"==typeof clientSettings.developmentMode?clientSettings.developmentMode:!1:clientSettings.reconnect=!!params.reconnect}function actuallyConnect(params){params=params||{};var deferred=Q.defer();return clientSettings.token||clientSettings.appId&&clientSettings.endpointId&&clientSettings.developmentMode===!0?(signalingChannel.open({actuallyConnect:actuallyConnect,endpointId:that.endpointId,token:clientSettings.token}).then(function(){return signalingChannel.authenticate()}).done(function(){that.presence&&that.setPresence({presence:that.presence}),that.listen("call",clientSettings.onCall),that.listen("direct-connection",clientSettings.onDirectConnection),that.listen("join",clientSettings.onJoin),that.listen("leave",clientSettings.onLeave),that.listen("message",clientSettings.onMessage),that.listen("connect",clientSettings.onConnect),that.listen("disconnect",clientSettings.onDisconnect),that.listen("disconnect",function(){that.calls.forEach(function(call){call.hangup({signal:!1})})},!0),that.listen("reconnect",clientSettings.onReconnect),log.info("logged in as "+that.endpointId,that),deferred.resolve()},function(err){deferred.reject(err),err.message&&err.message.match(/Connection limit exceeded/)?log.error("You have reached the connection limit on the account associated with this appId. Please upgrade your account from the developer portal at https://portal.respoke.io if you need more concurrent connections.",err):log.error(err.message,err.stack)}),deferred.promise):(deferred.reject(new Error("Must pass either endpointID & appId & developmentMode=true, or a token, to client.connect().")),deferred.promise)}function addCall(evt){if(log.debug("addCall"),!evt.call)throw new Error("Can't add call without a call parameter.");-1===that.calls.indexOf(evt.call)&&that.calls.push(evt.call),evt.call.listen("hangup",function(){removeCall({call:evt.call})})}function removeCall(evt){var match=0;if(!evt.call)throw new Error("Can't remove call without a call parameter.");for(var i=that.calls.length-1;i>=0;i-=1)that.calls[i].id===evt.call.id&&(that.calls.splice(i,1),match+=1);1!==match&&log.warn("Something went wrong.",match,"calls were removed!")}params=params||{};var instanceId=params.instanceId||respoke.makeGUID();params.instanceId=instanceId;var that=respoke.EventEmitter(params);respoke.instances[instanceId]=that,delete that.instanceId,that.connectTries=0,that.className="respoke.Client";var clientSettings=(window.location.hostname,window.location.port,{});delete that.appId,delete that.baseURL,delete that.developmentMode,delete that.token,delete that.resolveEndpointPresence;var groups=[],endpoints=[];that.calls=[],log.debug("Client ID is ",instanceId);var signalingChannel=respoke.SignalingChannel({instanceId:instanceId,clientSettings:clientSettings});return that.presence=params.presence||"unavailable",that.getPresence=function(){return that.presence},saveParameters(params),that.connect=function(params){var promise,retVal;return params=params||{},log.debug("Client.connect"),that.connectTries+=1,saveParameters(params),that.presence=params.presence||that.presence,that.endpointId=clientSettings.endpointId,promise=actuallyConnect(params),retVal=respoke.handlePromise(promise,params.onSuccess,params.onError),promise.then(function(){that.fire("connect")}),retVal},that.disconnect=function(params){params=params||{};var deferred=Q.defer(),retVal=respoke.handlePromise(deferred.promise,params.onSuccess,params.onError);try{that.verifyConnected()}catch(e){return deferred.reject(e),retVal}var leaveGroups=groups.map(function(group){return group.isJoined()?group.leave():void 0});return Q.all(leaveGroups).fin(function(){return signalingChannel.close()}).fin(function(){that.presence="unavailable",endpoints=[],groups=[],that.fire("disconnect"),deferred.resolve()}).done(),retVal},that.setPresence=function(params){var promise,retVal;params=params||{},params.presence=params.presence||"available";try{that.verifyConnected()}catch(e){return promise=Q.reject(e),respoke.handlePromise(promise,params.onSuccess,params.onError)}return log.info("sending my presence update "+params.presence),promise=signalingChannel.sendPresence({presence:params.presence}).then(function(p){that.presence=params.presence,that.fire("presence",{presence:that.presence})}),retVal=respoke.handlePromise(promise,params.onSuccess,params.onError)},that.getCall=function(params){var call=null,methods={screenshare:"startScreenShare",did:"startPhoneCall",web:"startCall",sip:"startSIPCall",conference:"joinConference"},callParams={};params.fromType=params.type||"web";var switchType=params.type;if(that.calls.every(function(one){return params.id&&one.id===params.id?(call=one,!1):!params.id&&params.endpointId&&one.remoteEndpoint.id===params.endpointId?(call=one,!1):!0}),call||params.create!==!0)return call;switch(callParams.id=params.id,callParams.caller=!1,callParams.fromType="web",callParams.callerId=params.callerId,callParams.target=params.target,"conference"===params.target?(callParams.id=params.conferenceId,switchType=params.target):"screenshare"===params.target&&(switchType=params.target),switchType){case"screenshare":case"web":callParams.toType="web",callParams.endpointId=params.endpointId;break;case"did":callParams.number=params.endpointId,callParams.toType="did";break;case"sip":callParams.uri=params.endpointId,callParams.toType="sip"}try{call=that[methods[params.type]](callParams)}catch(e){log.error("Couldn't create Call.",e.message,e.stack)}return call},that.setOnline=function(params){var promise;params=params||{},params.presence=params.presence||"available";try{that.verifyConnected()}catch(e){return promise=Q.reject(e),respoke.handlePromise(promise,params.onSuccess,params.onError)}return that.setPresence(params)},that.setOffline=function(params){var promise;params=params||{},params.presence=params.presence||"unavailable";try{that.verifyConnected()}catch(e){return promise=Q.reject(e),respoke.handlePromise(promise,params.onSuccess,params.onError)}return that.setPresence(params)},that.sendMessage=function(params){var promise,retVal,endpoint;try{that.verifyConnected()}catch(e){return promise=Q.reject(e),retVal=respoke.handlePromise(promise,params.onSuccess,params.onError)}return endpoint=that.getEndpoint({skipPresence:!0,id:params.endpointId}),delete params.endpointId,endpoint.sendMessage(params)},that.joinConference=function(params){var recipient,conference=null;return params=params||{},params.open=!!params.open,that.verifyConnected(),params.id||(params.id=respoke.makeGUID()),recipient={id:params.id},params.open?params.key=void 0:params.key||(params.key=respoke.makeGUID()),params.instanceId=instanceId,params.target="conference",params.constraints=respoke.convertConstraints(params.constraints,[{video:!1,audio:!0,mandatory:{},optional:[]}]),params.signalOffer=function(signalParams){var onSuccess=signalParams.onSuccess,onError=signalParams.onError;delete signalParams.onSuccess,delete signalParams.onError,signalParams.signalType="offer",signalParams.target=params.target,signalParams.id=params.id,signalParams.key=params.key,signalParams.open=params.open,signalParams.recipient=recipient,signalParams.toType="conference",signalingChannel.sendSDP(signalParams).done(onSuccess,onError)},params.signalAnswer=function(signalParams){var onSuccess=signalParams.onSuccess,onError=signalParams.onError;delete signalParams.onSuccess,delete signalParams.onError,signalParams.signalType="answer",signalParams.target=params.target,signalParams.recipient=recipient,
signalParams.sessionId=signalParams.call.sessionId,signalParams.toType="conference",signalingChannel.sendSDP(signalParams).then(onSuccess,onError).done(null,function(err){signalParams.call.hangup({signal:!1})})},params.signalConnected=function(signalParams){signalParams.target=params.target,signalParams.connectionId=signalParams.call.connectionId,signalParams.sessionId=signalParams.call.sessionId,signalParams.recipient=recipient,signalParams.toType="conference",signalingChannel.sendConnected(signalParams).done(null,function(err){signalParams.call.hangup()})},params.signalModify=function(signalParams){signalParams.target=params.target,signalParams.recipient=recipient,signalParams.sessionId=signalParams.call.sessionId,signalParams.toType="conference",signalingChannel.sendModify(signalParams).done()},params.signalCandidate=function(signalParams){signalParams.target=params.target,signalParams.recipient=recipient,signalParams.sessionId=signalParams.call.sessionId,signalParams.toType="conference",signalingChannel.sendCandidate(signalParams).done()},params.signalHangup=function(signalParams){signalParams.target=params.target,signalParams.recipient=recipient,signalParams.sessionId=signalParams.call.sessionId,signalParams.toType="conference",signalingChannel.sendHangup(signalParams).done()},params.signalReport=function(signalParams){log.debug("Sending debug report",signalParams.report),signalingChannel.sendReport(signalParams).done()},params.signalingChannel=signalingChannel,conference=respoke.Conference(params),addCall({call:conference.call}),conference},that.startScreenShare=function(params){that.verifyConnected();var endpoint=that.getEndpoint({skipPresence:!0,id:params.endpointId});return delete params.endpointId,endpoint.startScreenShare(params)},that.startCall=function(params){that.verifyConnected();var endpoint=that.getEndpoint({skipPresence:!0,id:params.endpointId});return delete params.endpointId,endpoint.startCall(params)},that.startAudioCall=function(params){that.verifyConnected();var endpoint=that.getEndpoint({skipPresence:!0,id:params.endpointId});return delete params.endpointId,endpoint.startAudioCall(params)},that.startVideoCall=function(params){that.verifyConnected();var endpoint=that.getEndpoint({skipPresence:!0,id:params.endpointId});return delete params.endpointId,endpoint.startVideoCall(params)},that.startPhoneCall=function(params){var call=null,recipient={};if(params=params||{},params.constraints=[{video:!1,audio:!0,mandatory:{},optional:[]}],that.verifyConnected(),!params.number)throw new Error("Can't start a phone call without a number.");return"boolean"!=typeof params.caller&&(params.caller=!0),recipient.id=params.number,params.instanceId=instanceId,params.remoteEndpoint=recipient,params.toType=params.toType||"did",params.fromType=params.fromType||"web",params.signalOffer=function(signalParams){var onSuccess=signalParams.onSuccess,onError=signalParams.onError;delete signalParams.onSuccess,delete signalParams.onError,signalParams.signalType="offer",signalParams.target="call",signalParams.recipient=recipient,signalParams.toType=params.toType,signalParams.fromType=params.fromType,params.hasOwnProperty("callerId")&&(signalParams.callerId={number:params.callerId}),signalingChannel.sendSDP(signalParams).done(onSuccess,onError)},params.signalAnswer=function(signalParams){var onSuccess=signalParams.onSuccess,onError=signalParams.onError;delete signalParams.onSuccess,delete signalParams.onError,signalParams.signalType="answer",signalParams.target="call",signalParams.recipient=recipient,signalParams.toType=params.toType,signalParams.fromType=params.fromType,signalingChannel.sendSDP(signalParams).then(onSuccess,onError).done(null,function(err){log.error("Couldn't answer the call.",err.message,err.stack),signalParams.call.hangup({signal:!1})})},params.signalConnected=function(signalParams){signalParams.target="call",signalParams.connectionId=signalParams.connectionId,signalParams.recipient=recipient,signalParams.toType=params.toType,signalParams.fromType=params.fromType,signalingChannel.sendConnected(signalParams).done(null,function(err){log.error("Couldn't send connected.",err.message,err.stack),signalParams.call.hangup()})},params.signalModify=function(signalParams){signalParams.target="call",signalParams.recipient=recipient,signalParams.toType=params.toType,signalParams.fromType=params.fromType,signalingChannel.sendModify(signalParams).done(null,function(err){log.error("Couldn't send modify.",err.message,err.stack)})},params.signalCandidate=function(signalParams){signalParams.target="call",signalParams.recipient=recipient,signalParams.toType=params.toType,signalParams.fromType=params.fromType,signalingChannel.sendCandidate(signalParams).done()},params.signalHangup=function(signalParams){signalParams.target="call",signalParams.recipient=recipient,signalParams.toType=params.toType,signalParams.fromType=params.fromType,signalingChannel.sendHangup(signalParams).done(null,function(err){log.error("Couldn't send hangup.",err.message,err.stack)})},params.signalReport=function(signalParams){log.debug("Sending debug report",signalParams.report),signalingChannel.sendReport(signalParams)},params.signalingChannel=signalingChannel,call=respoke.Call(params),addCall({call:call}),call},that.startSIPCall=function(params){var call=null,recipient={};if(params=params||{},params.constraints=[{video:!1,audio:!0,mandatory:{},optional:[]}],that.verifyConnected(),!(params.uri||params.trunk&&params.user))throw new Error("Can't start a phone call without a SIP URI or a SIP trunk and user.");return"boolean"!=typeof params.caller&&(params.caller=!0),params.uri=params.uri||params.trunk+"/"+params.user,recipient.id=params.uri,params.instanceId=instanceId,params.remoteEndpoint=recipient,params.toType=params.toType||"sip",params.fromType=params.fromType||"web",params.signalOffer=function(signalParams){var onSuccess=signalParams.onSuccess,onError=signalParams.onError;delete signalParams.onSuccess,delete signalParams.onError,signalParams.signalType="offer",signalParams.target="call",signalParams.recipient=recipient,signalParams.toType=params.toType,signalParams.fromType=params.fromType,params.hasOwnProperty("callerId")&&(signalParams.callerId=params.callerId),signalingChannel.sendSDP(signalParams).done(onSuccess,onError)},params.signalAnswer=function(signalParams){var onSuccess=signalParams.onSuccess,onError=signalParams.onError;delete signalParams.onSuccess,delete signalParams.onError,signalParams.signalType="answer",signalParams.target="call",signalParams.recipient=recipient,signalParams.toType=params.toType,signalParams.fromType=params.fromType,signalingChannel.sendSDP(signalParams).then(onSuccess,onError).done(null,function(err){log.error("Couldn't answer the call.",err.message,err.stack),signalParams.call.hangup({signal:!1})})},params.signalConnected=function(signalParams){signalParams.target="call",signalParams.connectionId=signalParams.connectionId,signalParams.recipient=recipient,signalParams.toType=params.toType,signalParams.fromType=params.fromType,signalingChannel.sendConnected(signalParams).done(null,function(err){log.error("Couldn't send connected.",err.message,err.stack),signalParams.call.hangup()})},params.signalModify=function(signalParams){signalParams.target="call",signalParams.recipient=recipient,signalParams.toType=params.toType,signalParams.fromType=params.fromType,signalingChannel.sendModify(signalParams).done(null,function(err){log.error("Couldn't send modify.",err.message,err.stack)})},params.signalCandidate=function(signalParams){signalParams.target="call",signalParams.recipient=recipient,signalParams.toType=params.toType,signalParams.fromType=params.fromType,signalingChannel.sendCandidate(signalParams).done()},params.signalHangup=function(signalParams){signalParams.target="call",signalParams.recipient=recipient,signalParams.toType=params.toType,signalParams.fromType=params.fromType,signalingChannel.sendHangup(signalParams).done(null,function(err){log.error("Couldn't send hangup.",err.message,err.stack)})},params.signalReport=function(signalParams){log.debug("Sending debug report",signalParams.report),signalingChannel.sendReport(signalParams)},params.signalingChannel=signalingChannel,call=respoke.Call(params),addCall({call:call}),call},that.verifyConnected=function(){if(!signalingChannel.isConnected())throw new Error("Can't complete request when not connected. Please reconnect!")},that.isConnected=function(){return signalingChannel.isConnected()},that.join=function(params){var deferred=Q.defer(),retVal=respoke.handlePromise(deferred.promise,params.onSuccess,params.onError);try{that.verifyConnected()}catch(e){return deferred.reject(e),retVal}return params.id?(log.trace("requested to join group",params.id),signalingChannel.joinGroup({groupList:[params.id]}).done(function(){var group;params.signalingChannel=signalingChannel,params.instanceId=instanceId,group=that.getGroup({id:params.id}),group||(group=respoke.Group(params),that.addGroup(group)),group.listen("join",params.onJoin),group.listen("leave",params.onLeave),group.listen("message",params.onMessage),group.addMember({connection:that.getConnection({endpointId:that.endpointId,connectionId:that.connectionId})}),that.fire("join",{group:group}),deferred.resolve(group)},function(err){deferred.reject(err)}),retVal):(deferred.reject(new Error("Can't join a group with no group id.")),retVal)},that.addGroup=function(newGroup){if(!newGroup||"respoke.Group"!==newGroup.className)throw new Error("Can't add group to internal tracking without a group.");newGroup.listen("leave",function(evt){var endpointThatLeft=evt.connection.getEndpoint();endpointThatLeft.hasListeners("presence")||0!==endpointThatLeft.groupConnectionCount||endpoints.every(function(ept,index){return ept.id===endpointThatLeft.id?(endpoints.splice(index,1),!1):!0})},!0),groups.push(newGroup)},that.getGroups=function(){return groups},that.getGroup=function(params){var group;if(!params||!params.id)throw new Error("Can't get a group without group id.");return groups.every(function(grp){return grp.id===params.id?(group=grp,!1):!0}),group&&(group.listen("join",params.onJoin),group.listen("leave",params.onLeave),group.listen("message",params.onMessage)),group},that.getEndpoint=function(params){var endpoint;if(!params||!params.id)throw new Error("Can't get an endpoint without endpoint id.");return endpoints.every(function(ept){return ept.id===params.id?(endpoint=ept,!1):!0}),endpoint||!params||params.skipCreate||(params.instanceId=instanceId,params.signalingChannel=signalingChannel,params.resolveEndpointPresence=clientSettings.resolveEndpointPresence,params.addCall=addCall,endpoint=respoke.Endpoint(params),endpoints.push(endpoint)),endpoint?(params.skipPresence!==!0&&signalingChannel.registerPresence({endpointList:[endpoint.id]}).done(null,function(err){log.error("Couldn't register for presence on",endpoint.id,err.message)}),endpoint.listen("presence",params.onPresence),endpoint.listen("message",params.onMessage),endpoint):void 0},that.getConnection=function(params){var connection,endpoint,endpointsToSearch=endpoints;if(params=params||{},!params.connectionId)throw new Error("Can't get a connection without connection id.");if(!params.endpointId&&!params.skipCreate)throw new Error("Can't create a connection without endpoint id.");return params.endpointId&&(endpoint=that.getEndpoint({id:params.endpointId,skipPresence:!0,skipCreate:params.skipCreate}),endpointsToSearch=[],endpoint&&(endpointsToSearch=[endpoint])),endpointsToSearch.every(function(ept){return connection=ept.getConnection(params),!connection}),connection||params.skipCreate||(params.instanceId=instanceId,connection=respoke.Connection(params),endpoint.connections.push(connection)),connection},that.getEndpoints=function(){return endpoints},that}},function(module,exports,__webpack_require__){var respoke=__webpack_require__(1);module.exports=function(params){"use strict";params=params||{};var instanceId=params.instanceId,that=respoke.EventEmitter(params),client=respoke.getClient(instanceId);if(that.id=that.id||that.connectionId,!that.id)throw new Error("Can't make a connection without an id.");return delete that.instanceId,delete that.connectionId,that.className="respoke.Connection",that.presence="unavailable",that.getPresence=function(){return that.presence},that.sendMessage=function(params){return params=params||{},params.connectionId=that.id,params.ccSelf="boolean"==typeof params.ccSelf?params.ccSelf:!1,that.getEndpoint().sendMessage(params)},that.startScreenShare=function(params){return client.verifyConnected(),params.connectionId=that.id,that.getEndpoint().startScreenShare(params)},that.startCall=function(params){return params=params||{},params.connectionId=that.id,that.getEndpoint().startCall(params)},that.startAudioCall=function(params){return client.verifyConnected(),params.connectionId=that.id,that.getEndpoint().startAudioCall(params)},that.startVideoCall=function(params){return client.verifyConnected(),params.connectionId=that.id,that.getEndpoint().startVideoCall(params)},that.startDirectConnection=function(params){var retVal,deferred;params=params||{};try{client.verifyConnected()}catch(err){return deferred=respoke.Q.defer(),retVal=respoke.handlePromise(deferred.promise,params.onSuccess,params.onError),deferred.reject(err),retVal}return params.connectionId=that.id,that.getEndpoint().startDirectConnection(params)},that.getEndpoint=function(){return client.getEndpoint({id:that.endpointId,skipPresence:!0})},that}},function(module,exports,__webpack_require__){var Q=__webpack_require__(6),respoke=__webpack_require__(1),log=respoke.log;module.exports=function(params){"use strict";params=params||{};var instanceId=params.instanceId,that=respoke.EventEmitter(params),client=respoke.getClient(instanceId),signalingChannel=params.signalingChannel;that.groupConnectionCount=0;var addCall=params.addCall;delete that.signalingChannel,delete that.instanceId,delete that.connectionId,delete that.addCall,that.className="respoke.Endpoint",that.directConnection=null,that.connections=[],client.listen("disconnect",function(){that.connections=[]});var resolveEndpointPresence=params.resolveEndpointPresence;return delete that.resolveEndpointPresence,that.presence="unavailable",that.getPresence=function(){return that.presence},that.setPresence=function(params){var connection;if(params=params||{},params.presence=params.presence||"available",params.connectionId=params.connectionId||that.connectionId,!params.connectionId)throw new Error("Can't set Endpoint presence without a connectionId.");connection=that.getConnection({connectionId:params.connectionId})||client.getConnection({connectionId:params.connectionId,skipCreate:!1,endpointId:that.id}),connection.presence=params.presence,that.resolvePresence(),that.fire("presence",{presence:that.presence})},that.sendMessage=function(params){var promise,retVal;return params=params||{},params.ccSelf="boolean"==typeof params.ccSelf?params.ccSelf:!0,promise=signalingChannel.sendMessage({ccSelf:params.ccSelf,connectionId:params.connectionId,message:params.message,push:!!params.push,recipient:that}),retVal=respoke.handlePromise(promise,params.onSuccess,params.onError)},that.startAudioCall=function(params){return params=params||{},params.constraints=respoke.convertConstraints(params.constraints,[{video:!1,audio:!0,optional:[],mandatory:{}}]),that.startCall(params)},that.startVideoCall=function(params){return params=params||{},params.constraints=respoke.convertConstraints(params.constraints,[{video:!0,audio:!0,optional:[],mandatory:{}}]),that.startCall(params)},that.startScreenShare=function(params){params=params||{};var hasAudio,addAudio;return params.target="screenshare","boolean"!=typeof params.caller&&(params.caller=!0),params.sendOnly=params.caller&&(params.sendOnly||void 0===params.sendOnly),addAudio=!params.sendOnly&&(!params.screenConstraints||params.screenConstraints&&params.screenConstraints.audio),params.caller&&(params.constraints=respoke.convertConstraints(params.constraints),params.constraints.push(respoke.getScreenShareConstraints({constraints:params.screenConstraints})),delete params.screenConstraints,params.constraints.forEach(function(con){con.audio&&(hasAudio=!0)}),addAudio&&!hasAudio&&params.constraints.push({audio:!0,video:!1})),that.startCall(params)},that.startCall=function(params){var call=null;return params=params||{},params.constraints=respoke.convertConstraints(params.constraints,[{video:!0,audio:!0,mandatory:{},optional:[]}]),"screenshare"!==params.target&&params.constraints[0]&&respoke.constraintsHasScreenShare(params.constraints[0])?that.startScreenShare(params):(params.target=params.target||"call",log.debug("Endpoint.call",params),client.verifyConnected(),"boolean"!=typeof params.caller&&(params.caller=!0),that.id?(params.instanceId=instanceId,params.remoteEndpoint=that,params.signalOffer=function(signalParams){var onSuccess=signalParams.onSuccess,onError=signalParams.onError;delete signalParams.onSuccess,delete signalParams.onError,signalParams.signalType="offer",signalParams.target=params.target,signalParams.recipient=that,signalingChannel.sendSDP(signalParams).done(onSuccess,onError)},params.signalAnswer=function(signalParams){var onSuccess=signalParams.onSuccess,onError=signalParams.onError;delete signalParams.onSuccess,delete signalParams.onError,signalParams.signalType="answer",signalParams.target=params.target,signalParams.recipient=that,signalParams.sessionId=signalParams.call.sessionId,signalingChannel.sendSDP(signalParams).then(onSuccess,onError).done(null,function(err){signalParams.call.hangup({signal:!1})})},params.signalConnected=function(signalParams){signalParams.target=params.target,signalParams.connectionId=signalParams.call.connectionId,signalParams.sessionId=signalParams.call.sessionId,signalParams.recipient=that,signalingChannel.sendConnected(signalParams).done(null,function(err){signalParams.call.hangup()})},params.signalModify=function(signalParams){signalParams.target=params.target,signalParams.recipient=that,signalParams.sessionId=signalParams.call.sessionId,signalingChannel.sendModify(signalParams).done()},params.signalCandidate=function(signalParams){signalParams.target=params.target,signalParams.recipient=that,signalParams.sessionId=signalParams.call.sessionId,signalingChannel.sendCandidate(signalParams).done()},params.signalHangup=function(signalParams){signalParams.target=params.target,signalParams.recipient=that,signalParams.sessionId=signalParams.call.sessionId,signalingChannel.sendHangup(signalParams).done()},params.signalReport=function(signalParams){log.debug("Sending debug report",signalParams.report),signalingChannel.sendReport(signalParams).done()},params.signalingChannel=signalingChannel,call=respoke.Call(params),addCall({call:call}),call):void log.error("Can't start a call without endpoint ID!"))},that.startDirectConnection=function(params){params=params||{};var call,deferred=Q.defer(),retVal=respoke.handlePromise(deferred.promise,params.onSuccess,params.onError);try{client.verifyConnected()}catch(err){return deferred.reject(err),retVal}return that.directConnection||params.create===!1?(deferred.resolve(that.directConnection),retVal):("boolean"!=typeof params.caller&&(params.caller=!0),that.id?(params.instanceId=instanceId,params.remoteEndpoint=that,params.signalOffer=function(signalParams){var onSuccess=signalParams.onSuccess,onError=signalParams.onError;delete signalParams.onSuccess,delete signalParams.onError,signalParams.signalType="offer",signalParams.target="directConnection",signalParams.recipient=that,signalingChannel.sendSDP(signalParams).done(onSuccess,onError)},params.signalConnected=function(signalParams){signalParams.target="directConnection",signalParams.recipient=that,signalingChannel.sendConnected(signalParams).done(null,function(err){signalParams.call.hangup()})},params.signalAnswer=function(signalParams){var onSuccess=signalParams.onSuccess,onError=signalParams.onError;delete signalParams.onSuccess,delete signalParams.onError,signalParams.target="directConnection",signalParams.recipient=that,signalParams.signalType="answer",signalingChannel.sendSDP(signalParams).then(onSuccess,onError).done(null,function(err){signalParams.call.hangup({signal:!1})})},params.signalCandidate=function(signalParams){signalParams.target="directConnection",signalParams.recipient=that,signalingChannel.sendCandidate(signalParams).done()},params.signalHangup=function(signalParams){signalParams.target="directConnection",signalParams.recipient=that,signalingChannel.sendHangup(signalParams).done()},params.signalReport=function(signalParams){signalParams.report.target="directConnection",log.debug("Not sending report"),log.debug(signalParams.report)},params.needDirectConnection=!0,params.offerOptions={mandatory:{OfferToReceiveAudio:!1}},params.signalingChannel=signalingChannel,call=respoke.Call(params),addCall({call:call}),call.listen("direct-connection",function(evt){if(that.directConnection=evt.directConnection,params.caller!==!0){if(!client.hasListeners("direct-connection")&&!client.hasListeners("direct-connection")&&!call.hasListeners("direct-connection"))return that.directConnection.reject(),void deferred.reject(new Error("Got an incoming direct connection with no handlers to accept it!"));deferred.resolve(that.directConnection),that.directConnection.listen("close",function(evt){that.directConnection=void 0},!0)}},!0),retVal):(deferred.reject(new Error("Can't start a direct connection without endpoint ID!")),retVal))},that.resolvePresence=function(){var presenceList=that.connections.map(function(connection){return connection.presence});if(void 0!==resolveEndpointPresence)that.presence=resolveEndpointPresence(presenceList);else{var idList,options=["chat","available","away","dnd","xa","unavailable"];idList=that.connections.sort(function(a,b){var indexA=options.indexOf(a.presence),indexB=options.indexOf(b.presence);return indexA=-1===indexA?1e3:indexA,indexB=-1===indexB?1e3:indexB,indexB>indexA?-1:indexA>indexB?1:0}),idList[0]?that.presence=idList[0].presence:that.presence="unavailable"}},that.getConnection=function(params){var connection=null;if(params=params||{},1===that.connections.length&&(!params.connectionId||that.connections[0]===params.connectionId))return that.connections[0];if(!params||!params.connectionId)throw new Error("Can't find a connection without the connectionId.");return that.connections.every(function(conn){return conn.id===params.connectionId?(connection=conn,!1):!0}),connection},that.joinedGroup=function(){++that.groupConnectionCount},that.leftGroup=function(){--that.groupConnectionCount},that}},function(module,exports){module.exports=function(params){"use strict";function parse(){if(params.rawMessage){try{that.endpointId=params.rawMessage.header.from,that.originalRecipient=params.rawMessage.header.toOriginal,that.connectionId=params.rawMessage.header.fromConnection,that.timestamp=params.rawMessage.header.timestamp}catch(e){throw new Error(e)}that.message=params.rawMessage.message||params.rawMessage.body,params.rawMessage.header.channel&&(that.recipient=params.rawMessage.header.channel)}else{try{that.to=params.endpointId,that.ccSelf=params.ccSelf,that.toConnection=params.connectionId,that.requestConnectionReply=params.requestConnectionReply===!0,that.push=params.push===!0}catch(e){throw new Error(e)}that.message=params.message}}params=params||{};var that={};return parse(),that}},function(module,exports){module.exports=function(params){"use strict";function parse(){if(params.rawMessage){try{that=JSON.parse(params.rawMessage.body)}catch(e){that=params.rawMessage.body}that.fromType=params.rawMessage.header.fromType,that.fromEndpoint=params.rawMessage.header.from,that.fromConnection=params.rawMessage.header.fromConnection,that.timestamp=params.rawMessage.header.timestamp,that.target||(that.target="call")}else required.forEach(function(attr){if(0===params[attr]||!params[attr])throw new Error("Can't build a signaling without "+attr)}),allowed.forEach(function(attr){(0===params[attr]||params[attr])&&(that[attr]=params[attr])})}params=params||{};var that={},required=["recipient","signalType","sessionId","target","signalId"],allowed=["signalType","sessionId","sessionDescription","iceCandidates","offering","target","signalId","callerId","requesting","reason","error","status","connectionId","version"];return params.version="1.0",parse(),that}},function(module,exports,__webpack_require__){var Q=__webpack_require__(6),respoke=__webpack_require__(1);module.exports=function(params){"use strict";function clearConnections(){that.connections.forEach(function(connection){connection.getEndpoint().leftGroup()}),that.connections=[]}function validateConnection(){if(!signalingChannel||!signalingChannel.isConnected())throw new Error("Can't complete request when not connected. Please reconnect!")}function validateMembership(){if(!that.isJoined())throw new Error("Not a member of this group anymore.")}params=params||{};var that=respoke.EventEmitter(params),instanceId=params.instanceId,client=respoke.getClient(instanceId);if(!that.id)throw new Error("Can't create a group without an ID.");var cacheIsValid=!1,signalingChannel=params.signalingChannel;return delete params.signalingChannel,that.connections=[],that.className="respoke.Group",that.listen("join",params.onJoin),that.listen("message",params.onMessage),that.listen("leave",params.onLeave),client.listen("disconnect",function(){cacheIsValid=!1,clearConnections()},!0),delete that.instanceId,delete that.onMessage,delete that.onPresence,delete that.onJoin,delete that.onLeave,that.join=function(){var promise,deferred,retVal,params={id:that.id};cacheIsValid=!1;try{validateConnection()}catch(err){return deferred=Q.defer(),retVal=respoke.handlePromise(deferred.promise,params.onSuccess,params.onError),deferred.reject(err),retVal}return promise=client.join(params),retVal=respoke.handlePromise(promise,params.onSuccess,params.onError)},that.leave=function(params){params=params||{};var deferred=Q.defer(),retVal=respoke.handlePromise(deferred.promise,params.onSuccess,params.onError);try{validateConnection(),validateMembership()}catch(err){return deferred.reject(err),retVal}return signalingChannel.leaveGroup({groupList:[that.id]}).done(function(){clearConnections(),deferred.resolve(),cacheIsValid=!1,client.fire("leave",{group:that})},function(err){deferred.reject()}),retVal},that.removeMember=function(params){params=params||{};try{validateConnection(),validateMembership()}catch(err){return}if(!params.connectionId)throw new Error("Can't remove a member to the group without it's Connection id.");cacheIsValid=!1,that.connections.every(function(conn,index){return conn.id===params.connectionId?(that.connections.splice(index,1),conn.getEndpoint().leftGroup(),that.fire("leave",{connection:conn}),!1):!0})},that.isJoined=function(){return that.connections.length>0&&!that.connections.every(function(conn){return conn.id!==client.connectionId})},that.addMember=function(params){params=params||{};var absent;if(validateConnection(),!params.connection)throw new Error("Can't add a member to the group without it's Connection object.");if(cacheIsValid=!1,absent=that.connections.every(function(conn){return conn.id!==params.connection.id})){if(that.connections.push(params.connection),params.connection.getEndpoint().joinedGroup(),params.skipEvent)return;that.fire("join",{connection:params.connection})}},that.sendMessage=function(params){params=params||{},params.id=that.id;var promise;try{validateConnection(),validateMembership()}catch(err){promise=Q.reject(err)}return respoke.handlePromise(promise?promise:signalingChannel.publish(params),params.onSuccess,params.onError)},that.getMembers=function(params){params=params||{};var deferred=Q.defer(),retVal=respoke.handlePromise(deferred.promise,params.onSuccess,params.onError);try{validateConnection(),validateMembership()}catch(err){return deferred.reject(err),retVal}return that.connections.length>0&&cacheIsValid?(deferred.resolve(that.connections),retVal):(signalingChannel.getGroupMembers({id:that.id}).done(function(list){var endpointList=[];list.forEach(function(params){var connection=client.getConnection({endpointId:params.endpointId,connectionId:params.connectionId,skipCreate:!0});connection||(connection=client.getConnection({endpointId:params.endpointId,connectionId:params.connectionId})),-1===endpointList.indexOf(params.endpointId)&&endpointList.push(params.endpointId),that.addMember({connection:connection,skipEvent:!0})}),cacheIsValid=!0,deferred.resolve(that.connections)},function(err){deferred.reject(err)}),retVal)},that.joinConference=function(params){var conference=null;return params=params||{},params.id=that.id,conference=client.joinConference(params)},that}},function(module,exports,__webpack_require__){"use strict";var now,Q=__webpack_require__(6),io=__webpack_require__(14),respoke=__webpack_require__(1),template=__webpack_require__(16),log=respoke.log,billingSuspensionErrorMessage="Can't perform this action: Not Authorized. Your account is suspended due to a billing issue. Please visit the Respoke Developer Portal (https://www.respoke.io) or contact customer support (support@respoke.io) to address this issue.",suspensionErrorMessage="Canot perform this action: Not Authorized. Your account is suspended. Please visit the Respoke Developer Portal (https://www.respoke.io) or contact customer support (support@respoke.io) to address this issue.";now=window.performance&&window.performance.now?window.performance.now.bind(window.performance):Date.now?Date.now.bind(Date):function(){return(new Date).getTime()};var PendingRequests=function(){var contents=[],counter=0,that={};return that.add=function(obj){return contents[counter]=obj,counter++,counter},that.remove=function(key){delete contents[key]},that.reset=function(fn){fn&&contents.forEach(fn),contents=[]},that};module.exports=function(params){function isConnecting(){return!(!socket||!socket.socket.connecting)}function doOpen(params){params=params||{};var deferred=Q.defer();return log.debug("SignalingChannel.doOpen",params),params.token?(call({path:"/v1/session-tokens",httpMethod:"POST",parameters:{tokenId:params.token}}).done(function(response){if(200===response.statusCode)return appToken=response.body.token,deferred.resolve(),void log.debug("Signaling connection open to",clientSettings.baseURL);var errorMessage="Couldn't authenticate app. ";errorMessage+=isBillingSuspensionUnauthorizedResponse(response)?billingSuspensionErrorMessage:isSuspensionUnauthorizedResponse(response)?suspensionErrorMessage:response.error,deferred.reject(buildResponseError(response,errorMessage))},function(err){log.error("Network call failed:",err.message),deferred.reject(new Error("Couldn't authenticate app. "+err.message))}),deferred.promise):(deferred.reject(new Error("Can't open connection to Respoke without a token.")),deferred.promise)}function firstUpper(str){return str[0].toUpperCase()+str.slice(1)}function onPresence(message){var endpoint,groups;message.header.from!==client.endpointId&&(log.debug("socket.on presence",message),endpoint=client.getEndpoint({skipPresence:!0,id:message.header.from,instanceId:instanceId,name:message.header.from,connection:message.header.fromConnection}),endpoint.setPresence({connectionId:message.header.fromConnection,presence:message.type}),"unavailable"===endpoint.presence&&(groups=client.getGroups(),groups&&groups.forEach(function(group){group.removeMember({connectionId:message.header.fromConnection})})))}function reconnect(){clientSettings.reconnect===!0&&(clientSettings.reconnect=!1,appToken=null,token=null,socket&&(socket.removeAllListeners(),socket.disconnect(),socket=null),reconnectTimeout=null===reconnectTimeout?2500:2*reconnectTimeout,reconnectTimeout>maxReconnectTimeout&&(reconnectTimeout=maxReconnectTimeout),setTimeout(function(){log.debug("Reconnecting..."),actuallyConnect().then(function(){return reconnectTimeout=null,log.debug("socket reconnected"),
Q.all(client.getGroups().map(function(group){client.join({id:group.id,onMessage:clientSettings.onMessage,onJoin:clientSettings.onJoin,onLeave:clientSettings.onLeave})["catch"](function(err){throw log.error("Couldn't rejoin previous group.",{id:group.id,message:err.message,stack:err.stack}),err})}))}).then(function(){log.debug("groups rejoined after reconnect"),client.fire("reconnect")}).fin(function(){clientSettings.reconnect=!0}).done(null,function(err){log.error("Couldn't reconnect. Retrying...",{message:err.message,stack:err.stack}),reconnect()})},reconnectTimeout))}function wsCall(params){function handleResponse(response){var thisHandler=this;try{response.body=JSON.parse(response.body)}catch(e){if("object"!=typeof response.body)return void deferred.reject(new Error("Server response could not be parsed!"+response.body))}return 429===response.statusCode?void(request.tries<3&&deferred.promise.isPending()?setTimeout(function(){start=now(),sendWebsocketRequest(request,handleResponse)},1e3):(request.durationMillis=now()-start,pendingRequests.remove(request.id),failWebsocketRequest(request,response,"Too many retries after rate limit exceeded.",deferred))):(request.durationMillis=now()-start,pendingRequests.remove(request.id),logRequest&&log.debug("socket response",{method:request.method,path:request.path,durationMillis:request.durationMillis,response:response}),isBillingSuspensionUnauthorizedResponse(response)?void failWebsocketRequest(request,response,billingSuspensionErrorMessage,deferred):isSuspensionUnauthorizedResponse(response)?void failWebsocketRequest(request,response,suspensionErrorMessage,deferred):-1===[200,204,205,302,401,403,404,418].indexOf(thisHandler.status)?void failWebsocketRequest(request,response,response.body.error||errors[thisHandler.status]||"Unknown error",deferred):void deferred.resolve(response.body))}params=params||{};var request,deferred=Q.defer(),start=now(),logRequest=-1===params.path.indexOf("messages")&&-1===params.path.indexOf("signaling")||respoke.ridiculous,bodyLength=0;return params.parameters&&(bodyLength=encodeURI(JSON.stringify(params.parameters)).split(/%..|./).length-1),that.isConnected()?params?params.path?bodyLength>bodySizeLimit?(deferred.reject(new Error("Request body exceeds maximum size of "+bodySizeLimit+" bytes")),deferred.promise):(params.httpMethod=(params.httpMethod||"get").toLowerCase(),params.urlParams&&(params.path=template.parse(params.path).expand(params.urlParams)),logRequest&&log.debug("socket request",{method:params.httpMethod,path:params.path,parameters:params.parameters}),request={method:params.httpMethod,path:params.path,parameters:params.parameters,tries:0,durationMillis:0},request.id=pendingRequests.add(deferred),start=now(),sendWebsocketRequest(request,handleResponse),deferred.promise):(deferred.reject(new Error("No request path.")),deferred.promise):(deferred.reject(new Error("No params.")),deferred.promise):(deferred.reject(new Error("Can't complete request when not connected. Please reconnect!")),deferred.promise)}function failWebsocketRequest(request,response,error,deferred){response&&response.body&&response.body.error?deferred.reject(buildResponseError(response,error+" ("+request.method+" "+request.path+")")):deferred.resolve(response.body)}function sendWebsocketRequest(request,handleResponse){request.tries+=1,socket.emit(request.method,JSON.stringify({url:request.path,data:request.parameters,headers:{"App-Token":appToken}}),handleResponse)}function call(params){var deferred=Q.defer(),paramString=null,uri=null,response={body:null,statusCode:null},start=now();if(uri=clientSettings.baseURL+params.path,!params)return void deferred.reject(new Error("No params."));if(!params.httpMethod)return void deferred.reject(new Error("No HTTP method."));if(!params.path)return void deferred.reject(new Error("No request path."));if(params.urlParams&&(uri=template.parse(uri).expand(params.urlParams)),["GET","DELETE"].indexOf(params.httpMethod)>-1&&(uri+=makeParamString(params.parameters)),xhr.open(params.httpMethod,uri),appToken&&xhr.setRequestHeader("App-Token",appToken),["POST","PUT"].indexOf(params.httpMethod)>-1){if(paramString=JSON.stringify(params.parameters),paramString.length>bodySizeLimit)return void deferred.reject(new Error("Request body exceeds maximum size of "+bodySizeLimit+" bytes"));xhr.setRequestHeader("Content-Type","application/json;charset=UTF-8")}else if(-1===["GET","DELETE"].indexOf(params.httpMethod))return void deferred.reject(new Error("Illegal HTTP request method "+params.httpMethod));log.debug("request",{method:params.httpMethod,uri:uri,params:paramString});try{xhr.send(paramString)}catch(err){return void deferred.reject(err)}return xhr.onreadystatechange=function(){var limit,unit,durationMillis=now()-start;if(4===this.readyState){if(0===this.status)return void deferred.reject(new Error("Status is 0: Incomplete request, SSL error, or CORS error."));if(response.statusCode=this.status,response.headers=getAllResponseHeaders(this),response.uri=uri,response.params=params.parameters,response.error=errors[this.status],this.response)try{response.body=JSON.parse(this.response)}catch(e){response.body=this.response,response.error="Invalid JSON."}log.debug("response",{method:params.httpMethod,durationMillis:durationMillis,response:response}),[200,204,205,302,401,403,404,418].indexOf(this.status)>-1?deferred.resolve(response):429===this.status?(unit=getResponseHeader(this,"RateLimit-Time-Units"),limit=getResponseHeader(this,"RateLimit-Limit"),deferred.reject(buildResponseError(response,"Rate limit of "+limit+"/"+unit+" exceeded. Try again in 1 "+unit+"."))):deferred.reject(buildResponseError(response,"unexpected response code "+this.status))}},deferred.promise}function isSuspensionUnauthorizedResponse(response){return 401===response.statusCode&&response.body&&response.body.details&&"string"==typeof response.body.details.message&&response.body.details.message.indexOf("suspended")>-1}function isBillingSuspensionUnauthorizedResponse(response){return isSuspensionUnauthorizedResponse(response)&&"string"==typeof response.body.details.reason&&response.body.details.reason.indexOf("billing suspension")>-1}function makeParamString(params){var strings=[];return params?(Object.keys(params).forEach(function(name){var value=params[name];value instanceof Array?strings.push([name,value.join(",")].join("=")):"object"!=typeof value&&"function"!=typeof value&&strings.push([name,value].join("="))}),strings.length>0?"?"+strings.join("&"):""):""}function getResponseHeader(xhrResponse,header){try{return xhrResponse.getResponseHeader(header)}catch(e){return null}}function getAllResponseHeaders(xhrResponse){var headers,pairs,result={};return(headers=xhrResponse.getAllResponseHeaders())?(pairs=headers.split("\r\n"),pairs.forEach(function(pair){var key,val,index=pair.indexOf(": ");index>0&&(key=pair.substring(0,index),val=pair.substring(index+2),result[key]=val)}),result):result}function buildResponseError(res,message){var requestId=res&&res.headers&&res.headers["Request-Id"];return requestId&&(message+=" [Request-Id: "+requestId+"]"),new Error(message)}params=params||{};var instanceId=params.instanceId,that=respoke.EventEmitter(params);delete that.instanceId,that.className="respoke.SignalingChannel";var client=respoke.getClient(instanceId),socket=null,clientSettings=params.clientSettings;delete that.clientSettings,clientSettings.baseURL=clientSettings.baseURL||"https://api.respoke.io";var presenceRegistered={},actuallyConnect=null,pendingRequests=PendingRequests(),reconnectTimeout=null,maxReconnectTimeout=3e5,bodySizeLimit=2e4,token=null,appToken=null,xhr=new XMLHttpRequest,routingMethods={},handlerQueue={message:[],signal:[],presence:[]},errors={400:"Can't perform this action: missing or invalid parameters.",401:"Can't perform this action: not authenticated.",403:"Can't perform this action: not authorized.",404:"Item not found.",409:"Can't perform this action: item in the wrong state.",429:"API rate limit was exceeded.",500:"Can't perform this action: server problem."};that.isConnected=function(){return!(!socket||!socket.socket.connected)},that.isSendingReport=function(params){return clientSettings.enableCallDebugReport},that.open=function(params){params=params||{};var deferred=Q.defer();return log.debug("SignalingChannel.open",params,clientSettings),token=params.token||token,actuallyConnect="function"==typeof params.actuallyConnect?params.actuallyConnect:actuallyConnect,Q.fcall(function(){return clientSettings.developmentMode===!0&&clientSettings.appId&&params.endpointId?that.getToken({appId:clientSettings.appId,endpointId:params.endpointId}):null}).then(function(newToken){return token=newToken||token,doOpen({token:token})}).done(function(){deferred.resolve(),log.debug("client",client)},function(err){deferred.reject(err)}),deferred.promise},that.getToken=function(params){params=params||{};var deferred=Q.defer();log.debug("SignalingChannel.getToken",params);var callParams={path:"/v1/tokens",httpMethod:"POST",parameters:{appId:clientSettings.appId,endpointId:params.endpointId,ttl:21600}};return call(callParams).done(function(response){if(200===response.statusCode&&response.body&&response.body.tokenId)return token=response.body.tokenId,void deferred.resolve(response.body.tokenId);var errorMessage="Couldn't get a developer mode token. ";errorMessage+=isBillingSuspensionUnauthorizedResponse(response)?billingSuspensionErrorMessage:isSuspensionUnauthorizedResponse(response)?suspensionErrorMessage:response.error,deferred.reject(buildResponseError(response,errorMessage))},function(err){deferred.reject(new Error("Couldn't get a developer mode token. "+err.message))}),deferred.promise},that.close=function(){var deferred=Q.defer();return wsCall({path:"/v1/connections/{id}/",httpMethod:"DELETE",urlParams:{id:client.endpointId}}).fin(function(){return call({path:"/v1/session-tokens",httpMethod:"DELETE"})}).fin(function(){socket&&(socket.removeAllListeners(),socket.disconnect()),socket=null,deferred.resolve()}).done(),deferred.promise},that.sendPresence=function(params){params=params||{};var deferred=Q.defer();return log.debug("Signaling sendPresence"),that.isConnected()?(wsCall({path:"/v1/presence",httpMethod:"POST",parameters:{presence:{show:params.show,status:params.status,type:params.presence||"available"}}}).done(function(){deferred.resolve()},function(err){deferred.reject(err)}),deferred.promise):(deferred.reject(new Error("Can't complete request when not connected. Please reconnect!")),deferred.promise)},that.removeConferenceParticipant=function(params){params=params||{};var deferred=Q.defer(),endpointId=params.endpointId;if(!that.isConnected())return deferred.reject(new Error("Can't complete request when not connected. Please reconnect!")),deferred.promise;if(!endpointId&&params.connectionId){try{endpointId=client.getConnection({connectionId:params.connectionId}).getEndpoint().id}catch(err){}if(!endpointId)return deferred.reject(new Error("conference.removeParticipant can't figure out what endpoint to remove!")),deferred.promise}return wsCall({httpMethod:"DELETE",path:"/v1/conferences/{id}/participants/{endpointId}",urlParams:{id:params.conferenceId,endpointId:endpointId},parameters:{connectionId:params.connectionId}}).then(function(){deferred.resolve()},function(err){deferred.reject(err)}),deferred.promise},that.destroyConference=function(params){var deferred=Q.defer();return that.isConnected()?(wsCall({httpMethod:"DELETE",path:"/v1/conferences/{id}/",urlParams:{id:params.conferenceId}}).then(function(){deferred.resolve()},function(err){deferred.reject(err)}),deferred.promise):(deferred.reject(new Error("Can't complete request when not connected. Please reconnect!")),deferred.promise)},that.getConferenceParticipants=function(params){params=params||{};var deferred=Q.defer();return that.isConnected()?(wsCall({httpMethod:"GET",path:"/v1/conferences/{id}/participants/",urlParams:{id:params.id}}).then(function(participants){deferred.resolve(participants.map(function(par){return client.getConnection({connectionId:par.connectionId,endpointId:par.endpointId})}))},function(err){deferred.reject(err)}),deferred.promise):(deferred.reject(new Error("Can't complete request when not connected. Please reconnect!")),deferred.promise)},that.getGroup=function(params){params=params||{};var deferred=Q.defer();return that.isConnected()?(wsCall({httpMethod:"POST",path:"/v1/channels/",parameters:{name:params.name}}).then(function(group){deferred.resolve(group)},function(err){deferred.resolve({id:params.name})}),deferred.promise):(deferred.reject(new Error("Can't complete request when not connected. Please reconnect!")),deferred.promise)},that.leaveGroup=function(){var groups={},deferred=Q.defer();return function(params){params=params||{},params.groupList=params.groupList||[];var toRun=0===Object.keys(groups).length;return that.isConnected()?(params.groupList.forEach(function(id){"string"==typeof id&&(groups[id]=!0)}),toRun?(setTimeout(function(){var groupList=Object.keys(groups);groups={};var saveDeferred=deferred;return deferred=Q.defer(),0===groupList.length?void saveDeferred.resolve():void wsCall({path:"/v1/groups/",parameters:{groups:groupList},httpMethod:"DELETE"}).done(function(){saveDeferred.resolve()},function(err){saveDeferred.reject(err)})}),deferred.promise):deferred.promise):(deferred.reject(new Error("Can't complete request when not connected. Please reconnect!")),deferred.promise)}}(),that.joinGroup=function(){var groups={},deferred=Q.defer();return function(params){params=params||{},params.groupList=params.groupList||[],log.trace("been asked to join groups",params.groupList);var needsToRun=0===Object.keys(groups).length;return that.isConnected()?(params.groupList.forEach(function(id){"string"==typeof id&&(log.trace("put group",id,"in the join queue"),groups[id]=!0)}),needsToRun?(setTimeout(function(){var groupList=Object.keys(groups);log.trace("list of groups to be requested",groupList),groups={};var saveDeferred=deferred;return deferred=Q.defer(),0===groupList.length?(log.trace("list of groups was empty so not sending queue"),void saveDeferred.resolve()):void wsCall({path:"/v1/groups/",parameters:{groups:groupList},httpMethod:"POST"}).done(function(){saveDeferred.resolve()},function(err){saveDeferred.reject(err)})}),deferred.promise):deferred.promise):(deferred.reject(new Error("Can't complete request when not connected. Please reconnect!")),deferred.promise)}}(),that.publish=function(params){params=params||{};var deferred=Q.defer(),message=respoke.TextMessage({endpointId:params.id,message:params.message,push:!!params.push});return that.isConnected()?(wsCall({path:"/v1/channels/{id}/publish/",urlParams:{id:params.id},httpMethod:"POST",parameters:message}).done(function(){deferred.resolve()},function(err){deferred.reject(err)}),deferred.promise):(deferred.reject(new Error("Can't complete request when not connected. Please reconnect!")),deferred.promise)},that.registerPresence=function(){var endpoints={},deferred=Q.defer();return function(params){params=params||{},params.endpointList=params.endpointList||[];var toRun=0===Object.keys(endpoints).length;return that.isConnected()?(params.endpointList.forEach(function(ep){"string"==typeof ep&&presenceRegistered[ep]!==!0&&(endpoints[ep]=!0)}),toRun?(setTimeout(function(){var endpointList=Object.keys(endpoints);endpoints={};var saveDeferred=deferred;return deferred=Q.defer(),0===endpointList.length?void saveDeferred.resolve():void wsCall({httpMethod:"POST",path:"/v1/presenceobservers",parameters:{endpointList:endpointList}}).done(function(){params.endpointList.forEach(function(id){presenceRegistered[id]=!0}),saveDeferred.resolve()},function(err){saveDeferred.reject(err)})}),deferred.promise):deferred.promise):Q.reject(new Error("Can't complete request when not connected. Please reconnect!"))}}(),that.getGroupMembers=function(params){var deferred=Q.defer();return that.isConnected()?params.id?wsCall({path:"/v1/channels/{id}/subscribers/",urlParams:{id:params.id},httpMethod:"GET"}):(deferred.reject(new Error("Can't get group's endpoints without group ID.")),deferred.promise):(deferred.reject(new Error("Can't complete request when not connected. Please reconnect!")),deferred.promise)},that.sendMessage=function(params){params=params||{};var deferred=Q.defer(),message=respoke.TextMessage({endpointId:params.recipient.id,ccSelf:params.ccSelf,connectionId:params.connectionId,message:params.message,push:!!params.push});return that.isConnected()?(wsCall({path:"/v1/messages",httpMethod:"POST",parameters:message}).done(function(){deferred.resolve()},function(err){deferred.reject(err)}),deferred.promise):(deferred.reject(new Error("Can't complete request when not connected. Please reconnect!")),deferred.promise)},that.sendACK=function(params){var endpoint;return params=params||{},that.isConnected()?params.signal?(endpoint=client.getEndpoint({id:params.signal.fromEndpoint,skipPresence:!0}),endpoint?that.sendSignal({recipient:endpoint,signalType:"ack",signalId:params.signal.signalId,sessionId:params.signal.sessionId,target:params.signal.target,ackedSignalType:params.signal.signalType}):Q.reject(new Error("Can't send ACK, can't get endpoint."))):Q.reject(new Error("Can't send ACK, no signal was given.")):Q.reject(new Error("Can't complete request when not connected. Please reconnect!"))},that.sendSignal=function(params){params=params||{};var signal,to,toConnection,toType,deferred=Q.defer();if(!that.isConnected())return deferred.reject(new Error("Can't complete request when not connected. Please reconnect!")),deferred.promise;params.call&&(params.sessionId=params.call.id,params.call.connectionId&&(params.connectionId=params.call.connectionId)),to=params.recipient.id,toConnection=params.connectionId,toType=params.toType||"web";try{params.signalId=respoke.makeGUID(),signal=respoke.SignalingMessage(params)}catch(e){return deferred.reject(e),deferred.promise}return wsCall({path:"/v1/signaling",httpMethod:"POST",parameters:{ccSelf:params.ccSelf,signal:JSON.stringify(signal),to:to,toConnection:toConnection,toType:toType}}).done(function(){deferred.resolve()},function(err){deferred.reject(err)}),deferred.promise},that.sendCandidate=function(params){return params=params||{},params.signalType="iceCandidates",that.isConnected()?that.sendSignal(params):Q.reject(new Error("Can't complete request when not connected. Please reconnect!"))},that.sendSDP=function(params){return params=params||{},that.isConnected()?-1===["offer","answer"].indexOf(params.signalType)?Q.reject("Not an SDP type signal."):that.sendSignal(params):Q.reject(new Error("Can't complete request when not connected. Please reconnect!"))},that.sendReport=function(params){params=params||{};var deferred=Q.defer(),message={debugData:params};return clientSettings.enableCallDebugReport?that.isConnected()?(wsCall({path:"/v1/call-debugs",httpMethod:"POST",parameters:message}).done(function(){deferred.resolve()},function(err){deferred.reject(err)}),deferred.promise):(deferred.reject(new Error("Can't complete request when not connected. Please reconnect!")),deferred.promise):(log.debug("not sending call debugs - disabled"),deferred.resolve(),deferred.promise)},that.sendHangup=function(params){return params=params||{},params.signalType="bye",params.ccSelf=!0,that.isConnected()?that.sendSignal(params):Q.reject(new Error("Can't complete request when not connected. Please reconnect!"))},that.sendConnected=function(params){return params=params||{},params.signalType="connected",that.isConnected()?that.sendSignal(params):Q.reject(new Error("Can't complete request when not connected. Please reconnect!"))},that.sendModify=function(params){return params=params||{},params.signalType="modify",-1===["initiate","accept","reject"].indexOf(params.action)?Q.reject("No valid action in modify signal."):that.isConnected()?that.sendSignal(params):Q.reject(new Error("Can't complete request when not connected. Please reconnect!"))},that.routeSignal=function(signal){var target=null,method="do";if(("iceCandidates"!==signal.signalType||respoke.ridiculous)&&log.debug(signal.signalType,signal),void 0===signal.target)throw new Error("target undefined");Q.fcall(function(){var endpoint;return target=client.getCall({id:signal.sessionId,endpointId:signal.toOriginal||signal.fromEndpoint,target:signal.target,conferenceId:signal.conferenceId,type:signal.fromType,create:"directConnection"!==signal.target&&"offer"===signal.signalType,callerId:signal.callerId}),target?target:"directConnection"===signal.target?(endpoint=client.getEndpoint({id:signal.fromEndpoint,skipPresence:!0}),endpoint.directConnection&&endpoint.directConnection.call.id===signal.sessionId?endpoint.directConnection:endpoint.startDirectConnection({id:signal.sessionId,create:"offer"===signal.signalType,caller:"offer"!==signal.signalType})):void 0}).done(function(target){return target&&(target=target.call||target),target&&target.id===signal.sessionId?(method+=firstUpper(signal.signalType),void routingMethods[method]({call:target,signal:signal})):void log.warn("Couldn't associate signal with a call. This is usually OK.",signal)},null)},routingMethods.doOffer=function(params){params.call.connectionId=params.signal.fromConnection,params.call.fire("signal-offer",{signal:params.signal})},routingMethods.doConnected=function(params){params.call.fire("signal-connected",{signal:params.signal})},routingMethods.doModify=function(params){params.call.fire("signal-modify",{signal:params.signal})},routingMethods.doAnswer=function(params){params.call.connectionId=params.signal.fromConnection,params.call.fire("signal-answer",{signal:params.signal})},routingMethods.doIceCandidates=function(params){params.call.fire("signal-icecandidates",{signal:params.signal})},routingMethods.doBye=function(params){params.call.caller&&params.call.connectionId&&params.call.connectionId!==params.signal.fromConnection||params.call.fire("signal-hangup",{signal:params.signal})},routingMethods.doUnknown=function(params){log.error("Don't know what to do with",params.signal.target,"msg of unknown type",params.signal.signalType)},that.addHandler=function(params){socket.socket&&socket.socket.open?socket.on(params.type,params.handler):handlerQueue[params.type].push(params.handler)};var onPubSub=function(message){var group,groupMessage=respoke.TextMessage({rawMessage:message});group=client.getGroup({id:message.header.channel}),group&&group.fire("message",{message:groupMessage}),client.fire("message",{message:groupMessage,group:group||null})},onJoin=function(message){var group,endpoint,connection;message.connectionId===client.connectionId?(connection=client.getConnection({connectionId:message.connectionId,endpointId:message.endpointId}),group=client.getGroup({id:message.header.channel}),group||(group=respoke.Group({id:message.header.channel,instanceId:instanceId,signalingChannel:that}),client.addGroup(group)),group.isJoined()||(group.addMember({connection:connection}),client.fire("join",{group:group}))):(endpoint=client.getEndpoint({skipPresence:!0,id:message.endpointId,instanceId:instanceId,name:message.endpointId}),connection||(endpoint.setPresence({connectionId:message.connectionId}),connection=client.getConnection({connectionId:message.connectionId,endpointId:message.endpointId})),group=client.getGroup({id:message.header.channel}),group&&connection?group.addMember({connection:connection}):log.error("Can't add endpoint to group:",message,group,endpoint,connection))},onLeave=function(message){var group,endpoint;message.connectionId===client.connectionId?(group=client.getGroup({id:message.header.channel}),client.fire("leave",{group:group})):(endpoint=client.getEndpoint({skipPresence:!0,id:message.endpointId}),endpoint.connections.every(function(conn,index){return conn.id===message.connectionId?(endpoint.connections.splice(index,1),!1):!0}),group=client.getGroup({id:message.header.channel}),group&&group.removeMember({connectionId:message.connectionId}))},onMessage=function(message){var endpoint;message=respoke.TextMessage({rawMessage:message}),(message.originalRecipient||message.endpointId)&&(endpoint=client.getEndpoint({id:message.originalRecipient||message.endpointId,skipCreate:!0})),endpoint&&endpoint.fire("message",{message:message}),client.fire("message",{endpoint:endpoint||null,message:message})},generateConnectHandler=function(onSuccess,onError){return onSuccess=onSuccess||function(){},onError=onError||function(){},function(){Object.keys(handlerQueue).forEach(function(category){handlerQueue[category]&&(handlerQueue[category].forEach(function(handler){socket.on(category,handler)}),handlerQueue[category]=[])}),wsCall({path:"/v1/connections",httpMethod:"POST"}).done(function(res){log.debug("connections result",res),client.endpointId=res.endpointId,client.connectionId=res.id,onSuccess()},onError)}};return that.authenticate=function(params){params=params||{};var deferred=Q.defer(),pieces=[],protocol=null,host=null,port=null;appToken||deferred.reject(new Error("Can't open a websocket without an app token.")),pieces=clientSettings.baseURL.split(/:\/\//),protocol=pieces[0],pieces=pieces[1].split(/:/),host=pieces[0],port=pieces[1];var connectParams={"connect timeout":clientSettings.connectTimeoutMillis,"force new connection":!0,"sync disconnect on unload":!0,reconnect:!1,host:host,port:port||"443",protocol:protocol,secure:"https"===protocol,query:"__sails_io_sdk_version=0.10.0&app-token="+appToken};return that.isConnected()||isConnecting()?void 0:(socket=io.connect(clientSettings.baseURL,connectParams),socket.on("connect",generateConnectHandler(function(){deferred.resolve()},function(err){deferred.reject(err)})),socket.on("join",onJoin),socket.on("leave",onLeave),socket.on("pubsub",onPubSub),socket.on("message",onMessage),socket.on("presence",onPresence),socket.on("connect_failed",function(res){deferred.reject(new Error("WebSocket connection failed.")),log.error("Socket.io connect timeout.",res||""),reconnect()}),socket.on("error",function(res){log.error("Socket.io error.",res||""),reconnect()}),that.addHandler({type:"signal",handler:function(message){var knownSignals=["offer","answer","connected","modify","iceCandidates","bye"],signal=respoke.SignalingMessage({rawMessage:message});if("ack"!==signal.signalType){if(!signal.target||!signal.signalType||-1===knownSignals.indexOf(signal.signalType))throw log.error("Got malformed signal.",signal),new Error("Can't route signal without target or type.");that.routeSignal(signal)}}}),socket.on("disconnect",function(){log.debug("Socket.io disconnect."),pendingRequests.reset(function(pendingRequest){log.debug("Failing pending requests"),pendingRequest.reject(new Error("WebSocket disconnected"))}),client.fire("disconnect"),reconnect()}),deferred.promise)},that.getTurnCredentials=function(){var deferred=Q.defer();return that.isConnected()?(wsCall({httpMethod:"GET",path:"/v1/turn"}).done(function(creds){var result=[];return creds&&creds.uris?(creds.uris.forEach(function(uri){var cred=null;uri&&(cred=createIceServer(uri,creds.username,creds.password),result.push(cred))}),0===result.length&&deferred.reject(new Error("Got no TURN credentials.")),log.debug("TURN creds",result),void deferred.resolve(result)):void deferred.reject(new Error("Turn credentials empty."))},function(err){deferred.reject(err)}),deferred.promise):(deferred.reject(new Error("Can't complete request when not connected. Please reconnect!")),deferred.promise)},that}},function(module,exports,__webpack_require__){var __WEBPACK_AMD_DEFINE_ARRAY__,__WEBPACK_AMD_DEFINE_RESULT__;(function(module){/*! Socket.IO.js build:0.9.17, development. Copyright(c) 2011 LearnBoost <dev@learnboost.com> MIT Licensed */
var io=module.exports;!function(){if(function(exports,global){var io=exports;io.version="0.9.17",io.protocol=1,io.transports=[],io.j=[],io.sockets={},io.connect=function(host,details){var uuri,socket,uri=io.util.parseUri(host);global&&global.location&&(uri.protocol=uri.protocol||global.location.protocol.slice(0,-1),uri.host=uri.host||(global.document?global.document.domain:global.location.hostname),uri.port=uri.port||global.location.port),uuri=io.util.uniqueUri(uri);var options={host:uri.host,secure:"https"==uri.protocol,port:uri.port||("https"==uri.protocol?443:80),query:uri.query||""};return io.util.merge(options,details),(options["force new connection"]||!io.sockets[uuri])&&(socket=new io.Socket(options)),!options["force new connection"]&&socket&&(io.sockets[uuri]=socket),socket=socket||io.sockets[uuri],socket.of(uri.path.length>1?uri.path:"")}}(module.exports,this),function(exports,global){var util=exports.util={},re=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,parts=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];util.parseUri=function(str){for(var m=re.exec(str||""),uri={},i=14;i--;)uri[parts[i]]=m[i]||"";return uri},util.uniqueUri=function(uri){var protocol=uri.protocol,host=uri.host,port=uri.port;return"document"in global?(host=host||document.domain,port=port||("https"==protocol&&"https:"!==document.location.protocol?443:document.location.port)):(host=host||"localhost",port||"https"!=protocol||(port=443)),(protocol||"http")+"://"+host+":"+(port||80)},util.query=function(base,addition){var query=util.chunkQuery(base||""),components=[];util.merge(query,util.chunkQuery(addition||""));for(var part in query)query.hasOwnProperty(part)&&components.push(part+"="+query[part]);return components.length?"?"+components.join("&"):""},util.chunkQuery=function(qs){for(var kv,query={},params=qs.split("&"),i=0,l=params.length;l>i;++i)kv=params[i].split("="),kv[0]&&(query[kv[0]]=kv[1]);return query};var pageLoaded=!1;util.load=function(fn){return"document"in global&&"complete"===document.readyState||pageLoaded?fn():void util.on(global,"load",fn,!1)},util.on=function(element,event,fn,capture){element.attachEvent?element.attachEvent("on"+event,fn):element.addEventListener&&element.addEventListener(event,fn,capture)},util.request=function(xdomain){if(xdomain&&"undefined"!=typeof XDomainRequest&&!util.ua.hasCORS)return new XDomainRequest;if("undefined"!=typeof XMLHttpRequest&&(!xdomain||util.ua.hasCORS))return new XMLHttpRequest;if(!xdomain)try{return new(window[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(e){}return null},"undefined"!=typeof window&&util.load(function(){pageLoaded=!0}),util.defer=function(fn){return util.ua.webkit&&"undefined"==typeof importScripts?void util.load(function(){setTimeout(fn,100)}):fn()},util.merge=function(target,additional,deep,lastseen){var prop,seen=lastseen||[],depth="undefined"==typeof deep?2:deep;for(prop in additional)additional.hasOwnProperty(prop)&&util.indexOf(seen,prop)<0&&("object"==typeof target[prop]&&depth?util.merge(target[prop],additional[prop],depth-1,seen):(target[prop]=additional[prop],seen.push(additional[prop])));return target},util.mixin=function(ctor,ctor2){util.merge(ctor.prototype,ctor2.prototype)},util.inherit=function(ctor,ctor2){function f(){}f.prototype=ctor2.prototype,ctor.prototype=new f},util.isArray=Array.isArray||function(obj){return"[object Array]"===Object.prototype.toString.call(obj)},util.intersect=function(arr,arr2){for(var ret=[],longest=arr.length>arr2.length?arr:arr2,shortest=arr.length>arr2.length?arr2:arr,i=0,l=shortest.length;l>i;i++)~util.indexOf(longest,shortest[i])&&ret.push(shortest[i]);return ret},util.indexOf=function(arr,o,i){for(var j=arr.length,i=0>i?0>i+j?0:i+j:i||0;j>i&&arr[i]!==o;i++);return i>=j?-1:i},util.toArray=function(enu){for(var arr=[],i=0,l=enu.length;l>i;i++)arr.push(enu[i]);return arr},util.ua={},util.ua.hasCORS="undefined"!=typeof XMLHttpRequest&&function(){try{var a=new XMLHttpRequest}catch(e){return!1}return void 0!=a.withCredentials}(),util.ua.webkit="undefined"!=typeof navigator&&/webkit/i.test(navigator.userAgent),util.ua.iDevice="undefined"!=typeof navigator&&/iPad|iPhone|iPod/i.test(navigator.userAgent)}("undefined"!=typeof io?io:module.exports,this),function(exports,io){function EventEmitter(){}exports.EventEmitter=EventEmitter,EventEmitter.prototype.on=function(name,fn){return this.$events||(this.$events={}),this.$events[name]?io.util.isArray(this.$events[name])?this.$events[name].push(fn):this.$events[name]=[this.$events[name],fn]:this.$events[name]=fn,this},EventEmitter.prototype.addListener=EventEmitter.prototype.on,EventEmitter.prototype.once=function(name,fn){function on(){self.removeListener(name,on),fn.apply(this,arguments)}var self=this;return on.listener=fn,this.on(name,on),this},EventEmitter.prototype.removeListener=function(name,fn){if(this.$events&&this.$events[name]){var list=this.$events[name];if(io.util.isArray(list)){for(var pos=-1,i=0,l=list.length;l>i;i++)if(list[i]===fn||list[i].listener&&list[i].listener===fn){pos=i;break}if(0>pos)return this;list.splice(pos,1),list.length||delete this.$events[name]}else(list===fn||list.listener&&list.listener===fn)&&delete this.$events[name]}return this},EventEmitter.prototype.removeAllListeners=function(name){return void 0===name?(this.$events={},this):(this.$events&&this.$events[name]&&(this.$events[name]=null),this)},EventEmitter.prototype.listeners=function(name){return this.$events||(this.$events={}),this.$events[name]||(this.$events[name]=[]),io.util.isArray(this.$events[name])||(this.$events[name]=[this.$events[name]]),this.$events[name]},EventEmitter.prototype.emit=function(name){if(!this.$events)return!1;var handler=this.$events[name];if(!handler)return!1;var args=Array.prototype.slice.call(arguments,1);if("function"==typeof handler)handler.apply(this,args);else{if(!io.util.isArray(handler))return!1;for(var listeners=handler.slice(),i=0,l=listeners.length;l>i;i++)listeners[i].apply(this,args)}return!0}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(exports,nativeJSON){"use strict";function f(n){return 10>n?"0"+n:n}function date(d,key){return isFinite(d.valueOf())?d.getUTCFullYear()+"-"+f(d.getUTCMonth()+1)+"-"+f(d.getUTCDate())+"T"+f(d.getUTCHours())+":"+f(d.getUTCMinutes())+":"+f(d.getUTCSeconds())+"Z":null}function quote(string){return escapable.lastIndex=0,escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return"string"==typeof c?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,partial,mind=gap,value=holder[key];switch(value instanceof Date&&(value=date(key)),"function"==typeof rep&&(value=rep.call(holder,key,value)),typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value)return"null";if(gap+=indent,partial=[],"[object Array]"===Object.prototype.toString.apply(value)){for(length=value.length,i=0;length>i;i+=1)partial[i]=str(i,value)||"null";return v=0===partial.length?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]",gap=mind,v}if(rep&&"object"==typeof rep)for(length=rep.length,i=0;length>i;i+=1)"string"==typeof rep[i]&&(k=rep[i],v=str(k,value),v&&partial.push(quote(k)+(gap?": ":":")+v));else for(k in value)Object.prototype.hasOwnProperty.call(value,k)&&(v=str(k,value),v&&partial.push(quote(k)+(gap?": ":":")+v));return v=0===partial.length?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}",gap=mind,v}}if(nativeJSON&&nativeJSON.parse)return exports.JSON={parse:nativeJSON.parse,stringify:nativeJSON.stringify};var JSON=exports.JSON={},cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;JSON.stringify=function(value,replacer,space){var i;if(gap="",indent="","number"==typeof space)for(i=0;space>i;i+=1)indent+=" ";else"string"==typeof space&&(indent=space);if(rep=replacer,replacer&&"function"!=typeof replacer&&("object"!=typeof replacer||"number"!=typeof replacer.length))throw new Error("JSON.stringify");return str("",{"":value})},JSON.parse=function(text,reviver){function walk(holder,key){var k,v,value=holder[key];if(value&&"object"==typeof value)for(k in value)Object.prototype.hasOwnProperty.call(value,k)&&(v=walk(value,k),void 0!==v?value[k]=v:delete value[k]);return reviver.call(holder,key,value)}var j;if(text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof JSON?JSON:void 0),function(exports,io){var parser=exports.parser={},packets=parser.packets=["disconnect","connect","heartbeat","message","json","event","ack","error","noop"],reasons=parser.reasons=["transport not supported","client not handshaken","unauthorized"],advice=parser.advice=["reconnect"],JSON=io.JSON,indexOf=io.util.indexOf;parser.encodePacket=function(packet){var type=indexOf(packets,packet.type),id=packet.id||"",endpoint=packet.endpoint||"",ack=packet.ack,data=null;switch(packet.type){case"error":var reason=packet.reason?indexOf(reasons,packet.reason):"",adv=packet.advice?indexOf(advice,packet.advice):"";(""!==reason||""!==adv)&&(data=reason+(""!==adv?"+"+adv:""));break;case"message":""!==packet.data&&(data=packet.data);break;case"event":var ev={name:packet.name};packet.args&&packet.args.length&&(ev.args=packet.args),data=JSON.stringify(ev);break;case"json":data=JSON.stringify(packet.data);break;case"connect":packet.qs&&(data=packet.qs);break;case"ack":data=packet.ackId+(packet.args&&packet.args.length?"+"+JSON.stringify(packet.args):"")}var encoded=[type,id+("data"==ack?"+":""),endpoint];return null!==data&&void 0!==data&&encoded.push(data),encoded.join(":")},parser.encodePayload=function(packets){var decoded="";if(1==packets.length)return packets[0];for(var i=0,l=packets.length;l>i;i++){var packet=packets[i];decoded+=""+packet.length+""+packets[i]}return decoded};var regexp=/([^:]+):([0-9]+)?(\+)?:([^:]+)?:?([\s\S]*)?/;parser.decodePacket=function(data){var pieces=data.match(regexp);if(!pieces)return{};var id=pieces[2]||"",data=pieces[5]||"",packet={type:packets[pieces[1]],endpoint:pieces[4]||""};switch(id&&(packet.id=id,pieces[3]?packet.ack="data":packet.ack=!0),packet.type){case"error":var pieces=data.split("+");packet.reason=reasons[pieces[0]]||"",packet.advice=advice[pieces[1]]||"";break;case"message":packet.data=data||"";break;case"event":try{var opts=JSON.parse(data);packet.name=opts.name,packet.args=opts.args}catch(e){}packet.args=packet.args||[];break;case"json":try{packet.data=JSON.parse(data)}catch(e){}break;case"connect":packet.qs=data||"";break;case"ack":var pieces=data.match(/^([0-9]+)(\+)?(.*)/);if(pieces&&(packet.ackId=pieces[1],packet.args=[],pieces[3]))try{packet.args=pieces[3]?JSON.parse(pieces[3]):[]}catch(e){}break;case"disconnect":case"heartbeat":}return packet},parser.decodePayload=function(data){if(""==data.charAt(0)){for(var ret=[],i=1,length="";i<data.length;i++)""==data.charAt(i)?(ret.push(parser.decodePacket(data.substr(i+1).substr(0,length))),i+=Number(length)+1,length=""):length+=data.charAt(i);return ret}return[parser.decodePacket(data)]}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(exports,io){function Transport(socket,sessid){this.socket=socket,this.sessid=sessid}exports.Transport=Transport,io.util.mixin(Transport,io.EventEmitter),Transport.prototype.heartbeats=function(){return!0},Transport.prototype.onData=function(data){if(this.clearCloseTimeout(),(this.socket.connected||this.socket.connecting||this.socket.reconnecting)&&this.setCloseTimeout(),""!==data){var msgs=io.parser.decodePayload(data);if(msgs&&msgs.length)for(var i=0,l=msgs.length;l>i;i++)this.onPacket(msgs[i])}return this},Transport.prototype.onPacket=function(packet){return this.socket.setHeartbeatTimeout(),"heartbeat"==packet.type?this.onHeartbeat():("connect"==packet.type&&""==packet.endpoint&&this.onConnect(),"error"==packet.type&&"reconnect"==packet.advice&&(this.isOpen=!1),this.socket.onPacket(packet),this)},Transport.prototype.setCloseTimeout=function(){if(!this.closeTimeout){var self=this;this.closeTimeout=setTimeout(function(){self.onDisconnect()},this.socket.closeTimeout)}},Transport.prototype.onDisconnect=function(){return this.isOpen&&this.close(),this.clearTimeouts(),this.socket.onDisconnect(),this},Transport.prototype.onConnect=function(){return this.socket.onConnect(),this},Transport.prototype.clearCloseTimeout=function(){this.closeTimeout&&(clearTimeout(this.closeTimeout),this.closeTimeout=null)},Transport.prototype.clearTimeouts=function(){this.clearCloseTimeout(),this.reopenTimeout&&clearTimeout(this.reopenTimeout)},Transport.prototype.packet=function(packet){this.send(io.parser.encodePacket(packet))},Transport.prototype.onHeartbeat=function(heartbeat){this.packet({type:"heartbeat"})},Transport.prototype.onOpen=function(){this.isOpen=!0,this.clearCloseTimeout(),this.socket.onOpen()},Transport.prototype.onClose=function(){this.isOpen=!1,this.socket.onClose(),this.onDisconnect()},Transport.prototype.prepareUrl=function(){var options=this.socket.options;return this.scheme()+"://"+options.host+":"+options.port+"/"+options.resource+"/"+io.protocol+"/"+this.name+"/"+this.sessid},Transport.prototype.ready=function(socket,fn){fn.call(this)}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(exports,io,global){function Socket(options){if(this.options={port:80,secure:!1,document:"document"in global?document:!1,resource:"socket.io",transports:io.transports,"connect timeout":1e4,"try multiple transports":!0,reconnect:!0,"reconnection delay":500,"reconnection limit":1/0,"reopen delay":3e3,"max reconnection attempts":10,"sync disconnect on unload":!1,"auto connect":!0,"flash policy port":10843,manualFlush:!1},io.util.merge(this.options,options),this.connected=!1,this.open=!1,this.connecting=!1,this.reconnecting=!1,this.namespaces={},this.buffer=[],this.doBuffer=!1,this.options["sync disconnect on unload"]&&(!this.isXDomain()||io.util.ua.hasCORS)){var self=this;io.util.on(global,"beforeunload",function(){self.disconnectSync()},!1)}this.options["auto connect"]&&this.connect()}function empty(){}exports.Socket=Socket,io.util.mixin(Socket,io.EventEmitter),Socket.prototype.of=function(name){return this.namespaces[name]||(this.namespaces[name]=new io.SocketNamespace(this,name),""!==name&&this.namespaces[name].packet({type:"connect"})),this.namespaces[name]},Socket.prototype.publish=function(){this.emit.apply(this,arguments);var nsp;for(var i in this.namespaces)this.namespaces.hasOwnProperty(i)&&(nsp=this.of(i),nsp.$emit.apply(nsp,arguments))},Socket.prototype.handshake=function(fn){function complete(data){data instanceof Error?(self.connecting=!1,self.onError(data.message)):fn.apply(null,data.split(":"))}var self=this,options=this.options,url=["http"+(options.secure?"s":"")+":/",options.host+":"+options.port,options.resource,io.protocol,io.util.query(this.options.query,"t="+ +new Date)].join("/");if(this.isXDomain()&&!io.util.ua.hasCORS){var insertAt=document.getElementsByTagName("script")[0],script=document.createElement("script");script.src=url+"&jsonp="+io.j.length,insertAt.parentNode.insertBefore(script,insertAt),io.j.push(function(data){complete(data),script.parentNode.removeChild(script)})}else{var xhr=io.util.request();xhr.open("GET",url,!0),this.isXDomain()&&(xhr.withCredentials=!0),xhr.onreadystatechange=function(){4==xhr.readyState&&(xhr.onreadystatechange=empty,200==xhr.status?complete(xhr.responseText):403==xhr.status?self.onError(xhr.responseText):(self.connecting=!1,!self.reconnecting&&self.onError(xhr.responseText)))},xhr.send(null)}},Socket.prototype.getTransport=function(override){for(var transport,transports=override||this.transports,i=0;transport=transports[i];i++)if(io.Transport[transport]&&io.Transport[transport].check(this)&&(!this.isXDomain()||io.Transport[transport].xdomainCheck(this)))return new io.Transport[transport](this,this.sessionid);return null},Socket.prototype.connect=function(fn){if(this.connecting)return this;var self=this;return self.connecting=!0,this.handshake(function(sid,heartbeat,close,transports){function connect(transports){return self.transport&&self.transport.clearTimeouts(),self.transport=self.getTransport(transports),self.transport?void self.transport.ready(self,function(){self.connecting=!0,self.publish("connecting",self.transport.name),self.transport.open(),self.options["connect timeout"]&&(self.connectTimeoutTimer=setTimeout(function(){if(!self.connected&&(self.connecting=!1,self.options["try multiple transports"])){for(var remaining=self.transports;remaining.length>0&&remaining.splice(0,1)[0]!=self.transport.name;);remaining.length?connect(remaining):self.publish("connect_failed")}},self.options["connect timeout"]))}):self.publish("connect_failed")}self.sessionid=sid,self.closeTimeout=1e3*close,self.heartbeatTimeout=1e3*heartbeat,self.transports||(self.transports=self.origTransports=transports?io.util.intersect(transports.split(","),self.options.transports):self.options.transports),self.setHeartbeatTimeout(),connect(self.transports),self.once("connect",function(){clearTimeout(self.connectTimeoutTimer),fn&&"function"==typeof fn&&fn()})}),this},Socket.prototype.setHeartbeatTimeout=function(){if(clearTimeout(this.heartbeatTimeoutTimer),!this.transport||this.transport.heartbeats()){var self=this;this.heartbeatTimeoutTimer=setTimeout(function(){self.transport.onClose()},this.heartbeatTimeout)}},Socket.prototype.packet=function(data){return this.connected&&!this.doBuffer?this.transport.packet(data):this.buffer.push(data),this},Socket.prototype.setBuffer=function(v){this.doBuffer=v,!v&&this.connected&&this.buffer.length&&(this.options.manualFlush||this.flushBuffer())},Socket.prototype.flushBuffer=function(){this.transport.payload(this.buffer),this.buffer=[]},Socket.prototype.disconnect=function(){return(this.connected||this.connecting)&&(this.open&&this.of("").packet({type:"disconnect"}),this.onDisconnect("booted")),this},Socket.prototype.disconnectSync=function(){var xhr=io.util.request(),uri=["http"+(this.options.secure?"s":"")+":/",this.options.host+":"+this.options.port,this.options.resource,io.protocol,"",this.sessionid].join("/")+"/?disconnect=1";xhr.open("GET",uri,!1),xhr.send(null),this.onDisconnect("booted")},Socket.prototype.isXDomain=function(){var port=global.location.port||("https:"==global.location.protocol?443:80);return this.options.host!==global.location.hostname||this.options.port!=port},Socket.prototype.onConnect=function(){this.connected||(this.connected=!0,this.connecting=!1,this.doBuffer||this.setBuffer(!1),this.emit("connect"))},Socket.prototype.onOpen=function(){this.open=!0},Socket.prototype.onClose=function(){this.open=!1,clearTimeout(this.heartbeatTimeoutTimer)},Socket.prototype.onPacket=function(packet){this.of(packet.endpoint).onPacket(packet)},Socket.prototype.onError=function(err){err&&err.advice&&"reconnect"===err.advice&&(this.connected||this.connecting)&&(this.disconnect(),this.options.reconnect&&this.reconnect()),this.publish("error",err&&err.reason?err.reason:err)},Socket.prototype.onDisconnect=function(reason){var wasConnected=this.connected,wasConnecting=this.connecting;this.connected=!1,this.connecting=!1,this.open=!1,(wasConnected||wasConnecting)&&(this.transport.close(),this.transport.clearTimeouts(),wasConnected&&(this.publish("disconnect",reason),"booted"!=reason&&this.options.reconnect&&!this.reconnecting&&this.reconnect()))},Socket.prototype.reconnect=function(){function reset(){if(self.connected){for(var i in self.namespaces)self.namespaces.hasOwnProperty(i)&&""!==i&&self.namespaces[i].packet({type:"connect"});self.publish("reconnect",self.transport.name,self.reconnectionAttempts)}clearTimeout(self.reconnectionTimer),self.removeListener("connect_failed",maybeReconnect),self.removeListener("connect",maybeReconnect),self.reconnecting=!1,delete self.reconnectionAttempts,delete self.reconnectionDelay,delete self.reconnectionTimer,delete self.redoTransports,self.options["try multiple transports"]=tryMultiple}function maybeReconnect(){return self.reconnecting?self.connected?reset():self.connecting&&self.reconnecting?self.reconnectionTimer=setTimeout(maybeReconnect,1e3):void(self.reconnectionAttempts++>=maxAttempts?self.redoTransports?(self.publish("reconnect_failed"),reset()):(self.on("connect_failed",maybeReconnect),self.options["try multiple transports"]=!0,self.transports=self.origTransports,self.transport=self.getTransport(),self.redoTransports=!0,self.connect()):(self.reconnectionDelay<limit&&(self.reconnectionDelay*=2),self.connect(),self.publish("reconnecting",self.reconnectionDelay,self.reconnectionAttempts),self.reconnectionTimer=setTimeout(maybeReconnect,self.reconnectionDelay))):void 0}this.reconnecting=!0,this.reconnectionAttempts=0,this.reconnectionDelay=this.options["reconnection delay"];var self=this,maxAttempts=this.options["max reconnection attempts"],tryMultiple=this.options["try multiple transports"],limit=this.options["reconnection limit"];this.options["try multiple transports"]=!1,this.reconnectionTimer=setTimeout(maybeReconnect,this.reconnectionDelay),this.on("connect",maybeReconnect)}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports,this),function(exports,io){function SocketNamespace(socket,name){this.socket=socket,this.name=name||"",this.flags={},this.json=new Flag(this,"json"),this.ackPackets=0,this.acks={}}function Flag(nsp,name){this.namespace=nsp,this.name=name}exports.SocketNamespace=SocketNamespace,io.util.mixin(SocketNamespace,io.EventEmitter),SocketNamespace.prototype.$emit=io.EventEmitter.prototype.emit,SocketNamespace.prototype.of=function(){return this.socket.of.apply(this.socket,arguments)},SocketNamespace.prototype.packet=function(packet){return packet.endpoint=this.name,this.socket.packet(packet),this.flags={},this},SocketNamespace.prototype.send=function(data,fn){var packet={type:this.flags.json?"json":"message",data:data};return"function"==typeof fn&&(packet.id=++this.ackPackets,packet.ack=!0,this.acks[packet.id]=fn),this.packet(packet)},SocketNamespace.prototype.emit=function(name){var args=Array.prototype.slice.call(arguments,1),lastArg=args[args.length-1],packet={type:"event",name:name};return"function"==typeof lastArg&&(packet.id=++this.ackPackets,packet.ack="data",this.acks[packet.id]=lastArg,args=args.slice(0,args.length-1)),packet.args=args,this.packet(packet)},SocketNamespace.prototype.disconnect=function(){return""===this.name?this.socket.disconnect():(this.packet({type:"disconnect"}),this.$emit("disconnect")),this},SocketNamespace.prototype.onPacket=function(packet){function ack(){self.packet({type:"ack",args:io.util.toArray(arguments),ackId:packet.id})}var self=this;switch(packet.type){case"connect":this.$emit("connect");break;case"disconnect":""===this.name?this.socket.onDisconnect(packet.reason||"booted"):this.$emit("disconnect",packet.reason);break;case"message":case"json":var params=["message",packet.data];"data"==packet.ack?params.push(ack):packet.ack&&this.packet({type:"ack",ackId:packet.id}),this.$emit.apply(this,params);break;case"event":var params=[packet.name].concat(packet.args);"data"==packet.ack&&params.push(ack),this.$emit.apply(this,params);break;case"ack":this.acks[packet.ackId]&&(this.acks[packet.ackId].apply(this,packet.args),delete this.acks[packet.ackId]);break;case"error":packet.advice?this.socket.onError(packet):"unauthorized"==packet.reason?this.$emit("connect_failed",packet.reason):this.$emit("error",packet.reason)}},Flag.prototype.send=function(){this.namespace.flags[this.name]=!0,this.namespace.send.apply(this.namespace,arguments)},Flag.prototype.emit=function(){this.namespace.flags[this.name]=!0,this.namespace.emit.apply(this.namespace,arguments)}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(exports,io,global){function WS(socket){io.Transport.apply(this,arguments)}exports.websocket=WS,io.util.inherit(WS,io.Transport),WS.prototype.name="websocket",WS.prototype.open=function(){var Socket,query=io.util.query(this.socket.options.query),self=this;return Socket||(Socket=global.MozWebSocket||global.WebSocket),this.websocket=new Socket(this.prepareUrl()+query),this.websocket.onopen=function(){self.onOpen(),self.socket.setBuffer(!1)},this.websocket.onmessage=function(ev){self.onData(ev.data)},this.websocket.onclose=function(){self.onClose(),self.socket.setBuffer(!0)},this.websocket.onerror=function(e){self.onError(e)},this},io.util.ua.iDevice?WS.prototype.send=function(data){var self=this;return setTimeout(function(){self.websocket.send(data)},0),this}:WS.prototype.send=function(data){return this.websocket.send(data),this},WS.prototype.payload=function(arr){for(var i=0,l=arr.length;l>i;i++)this.packet(arr[i]);return this},WS.prototype.close=function(){return this.websocket.close(),this},WS.prototype.onError=function(e){this.socket.onError(e)},WS.prototype.scheme=function(){return this.socket.options.secure?"wss":"ws"},WS.check=function(){return"WebSocket"in global&&!("__addTask"in WebSocket)||"MozWebSocket"in global},WS.xdomainCheck=function(){return!0},io.transports.push("websocket")}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this),function(exports,io){function Flashsocket(){io.Transport.websocket.apply(this,arguments)}exports.flashsocket=Flashsocket,io.util.inherit(Flashsocket,io.Transport.websocket),Flashsocket.prototype.name="flashsocket",Flashsocket.prototype.open=function(){var self=this,args=arguments;return WebSocket.__addTask(function(){io.Transport.websocket.prototype.open.apply(self,args)}),this},Flashsocket.prototype.send=function(){var self=this,args=arguments;return WebSocket.__addTask(function(){io.Transport.websocket.prototype.send.apply(self,args)}),this},Flashsocket.prototype.close=function(){return WebSocket.__tasks.length=0,io.Transport.websocket.prototype.close.call(this),this},Flashsocket.prototype.ready=function(socket,fn){function init(){var options=socket.options,port=options["flash policy port"],path=["http"+(options.secure?"s":"")+":/",options.host+":"+options.port,options.resource,"static/flashsocket","WebSocketMain"+(socket.isXDomain()?"Insecure":"")+".swf"];Flashsocket.loaded||("undefined"==typeof WEB_SOCKET_SWF_LOCATION&&(WEB_SOCKET_SWF_LOCATION=path.join("/")),843!==port&&WebSocket.loadFlashPolicyFile("xmlsocket://"+options.host+":"+port),WebSocket.__initialize(),Flashsocket.loaded=!0),fn.call(self)}var self=this;return document.body?init():void io.util.load(init)},Flashsocket.check=function(){return"undefined"!=typeof WebSocket&&"__initialize"in WebSocket&&swfobject?swfobject.getFlashPlayerVersion().major>=10:!1},Flashsocket.xdomainCheck=function(){return!0},"undefined"!=typeof window&&(WEB_SOCKET_DISABLE_AUTO_INITIALIZATION=!0),io.transports.push("flashsocket")}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports),"undefined"!=typeof window)var swfobject=function(){function f(){if(!J){try{var Z=j.getElementsByTagName("body")[0].appendChild(C("span"));Z.parentNode.removeChild(Z)}catch(aa){return}J=!0;for(var X=U.length,Y=0;X>Y;Y++)U[Y]()}}function K(X){J?X():U[U.length]=X}function s(Y){if(typeof O.addEventListener!=D)O.addEventListener("load",Y,!1);else if(typeof j.addEventListener!=D)j.addEventListener("load",Y,!1);else if(typeof O.attachEvent!=D)i(O,"onload",Y);else if("function"==typeof O.onload){var X=O.onload;O.onload=function(){X(),Y()}}else O.onload=Y}function h(){T?V():H()}function V(){var X=j.getElementsByTagName("body")[0],aa=C(r);aa.setAttribute("type",q);var Z=X.appendChild(aa);if(Z){var Y=0;!function(){if(typeof Z.GetVariable!=D){var ab=Z.GetVariable("$version");ab&&(ab=ab.split(" ")[1].split(","),M.pv=[parseInt(ab[0],10),parseInt(ab[1],10),parseInt(ab[2],10)])}else if(10>Y)return Y++,void setTimeout(arguments.callee,10);X.removeChild(aa),Z=null,H()}()}else H()}function H(){var ag=o.length;if(ag>0)for(var af=0;ag>af;af++){var Y=o[af].id,ab=o[af].callbackFn,aa={success:!1,id:Y};if(M.pv[0]>0){var ae=c(Y);if(ae)if(!F(o[af].swfVersion)||M.wk&&M.wk<312)if(o[af].expressInstall&&A()){var ai={};ai.data=o[af].expressInstall,ai.width=ae.getAttribute("width")||"0",ai.height=ae.getAttribute("height")||"0",ae.getAttribute("class")&&(ai.styleclass=ae.getAttribute("class")),ae.getAttribute("align")&&(ai.align=ae.getAttribute("align"));for(var ah={},X=ae.getElementsByTagName("param"),ac=X.length,ad=0;ac>ad;ad++)"movie"!=X[ad].getAttribute("name").toLowerCase()&&(ah[X[ad].getAttribute("name")]=X[ad].getAttribute("value"));P(ai,ah,Y,ab)}else p(ae),ab&&ab(aa);else w(Y,!0),ab&&(aa.success=!0,aa.ref=z(Y),ab(aa))}else if(w(Y,!0),ab){var Z=z(Y);Z&&typeof Z.SetVariable!=D&&(aa.success=!0,aa.ref=Z),ab(aa)}}}function z(aa){var X=null,Y=c(aa);if(Y&&"OBJECT"==Y.nodeName)if(typeof Y.SetVariable!=D)X=Y;else{var Z=Y.getElementsByTagName(r)[0];Z&&(X=Z)}return X}function A(){return!a&&F("6.0.65")&&(M.win||M.mac)&&!(M.wk&&M.wk<312)}function P(aa,ab,X,Z){a=!0,E=Z||null,B={success:!1,id:X};var ae=c(X);if(ae){"OBJECT"==ae.nodeName?(l=g(ae),Q=null):(l=ae,Q=X),aa.id=R,(typeof aa.width==D||!/%$/.test(aa.width)&&parseInt(aa.width,10)<310)&&(aa.width="310"),(typeof aa.height==D||!/%$/.test(aa.height)&&parseInt(aa.height,10)<137)&&(aa.height="137"),j.title=j.title.slice(0,47)+" - Flash Player Installation";var ad=M.ie&&M.win?["Active"].concat("").join("X"):"PlugIn",ac="MMredirectURL="+O.location.toString().replace(/&/g,"%26")+"&MMplayerType="+ad+"&MMdoctitle="+j.title;if(typeof ab.flashvars!=D?ab.flashvars+="&"+ac:ab.flashvars=ac,M.ie&&M.win&&4!=ae.readyState){var Y=C("div");X+="SWFObjectNew",Y.setAttribute("id",X),ae.parentNode.insertBefore(Y,ae),ae.style.display="none",function(){4==ae.readyState?ae.parentNode.removeChild(ae):setTimeout(arguments.callee,10)}()}u(aa,ab,X)}}function p(Y){if(M.ie&&M.win&&4!=Y.readyState){var X=C("div");Y.parentNode.insertBefore(X,Y),X.parentNode.replaceChild(g(Y),X),Y.style.display="none",function(){4==Y.readyState?Y.parentNode.removeChild(Y):setTimeout(arguments.callee,10)}()}else Y.parentNode.replaceChild(g(Y),Y)}function g(ab){var aa=C("div");if(M.win&&M.ie)aa.innerHTML=ab.innerHTML;else{var Y=ab.getElementsByTagName(r)[0];if(Y){var ad=Y.childNodes;if(ad)for(var X=ad.length,Z=0;X>Z;Z++)1==ad[Z].nodeType&&"PARAM"==ad[Z].nodeName||8==ad[Z].nodeType||aa.appendChild(ad[Z].cloneNode(!0))}}return aa}function u(ai,ag,Y){var X,aa=c(Y);if(M.wk&&M.wk<312)return X;if(aa)if(typeof ai.id==D&&(ai.id=Y),M.ie&&M.win){var ah="";for(var ae in ai)ai[ae]!=Object.prototype[ae]&&("data"==ae.toLowerCase()?ag.movie=ai[ae]:"styleclass"==ae.toLowerCase()?ah+=' class="'+ai[ae]+'"':"classid"!=ae.toLowerCase()&&(ah+=" "+ae+'="'+ai[ae]+'"'));var af="";for(var ad in ag)ag[ad]!=Object.prototype[ad]&&(af+='<param name="'+ad+'" value="'+ag[ad]+'" />');aa.outerHTML='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"'+ah+">"+af+"</object>",
N[N.length]=ai.id,X=c(ai.id)}else{var Z=C(r);Z.setAttribute("type",q);for(var ac in ai)ai[ac]!=Object.prototype[ac]&&("styleclass"==ac.toLowerCase()?Z.setAttribute("class",ai[ac]):"classid"!=ac.toLowerCase()&&Z.setAttribute(ac,ai[ac]));for(var ab in ag)ag[ab]!=Object.prototype[ab]&&"movie"!=ab.toLowerCase()&&e(Z,ab,ag[ab]);aa.parentNode.replaceChild(Z,aa),X=Z}return X}function e(Z,X,Y){var aa=C("param");aa.setAttribute("name",X),aa.setAttribute("value",Y),Z.appendChild(aa)}function y(Y){var X=c(Y);X&&"OBJECT"==X.nodeName&&(M.ie&&M.win?(X.style.display="none",function(){4==X.readyState?b(Y):setTimeout(arguments.callee,10)}()):X.parentNode.removeChild(X))}function b(Z){var Y=c(Z);if(Y){for(var X in Y)"function"==typeof Y[X]&&(Y[X]=null);Y.parentNode.removeChild(Y)}}function c(Z){var X=null;try{X=j.getElementById(Z)}catch(Y){}return X}function C(X){return j.createElement(X)}function i(Z,X,Y){Z.attachEvent(X,Y),I[I.length]=[Z,X,Y]}function F(Z){var Y=M.pv,X=Z.split(".");return X[0]=parseInt(X[0],10),X[1]=parseInt(X[1],10)||0,X[2]=parseInt(X[2],10)||0,Y[0]>X[0]||Y[0]==X[0]&&Y[1]>X[1]||Y[0]==X[0]&&Y[1]==X[1]&&Y[2]>=X[2]?!0:!1}function v(ac,Y,ad,ab){if(!M.ie||!M.mac){var aa=j.getElementsByTagName("head")[0];if(aa){var X=ad&&"string"==typeof ad?ad:"screen";if(ab&&(n=null,G=null),!n||G!=X){var Z=C("style");Z.setAttribute("type","text/css"),Z.setAttribute("media",X),n=aa.appendChild(Z),M.ie&&M.win&&typeof j.styleSheets!=D&&j.styleSheets.length>0&&(n=j.styleSheets[j.styleSheets.length-1]),G=X}M.ie&&M.win?n&&typeof n.addRule==r&&n.addRule(ac,Y):n&&typeof j.createTextNode!=D&&n.appendChild(j.createTextNode(ac+" {"+Y+"}"))}}}function w(Z,X){if(m){var Y=X?"visible":"hidden";J&&c(Z)?c(Z).style.visibility=Y:v("#"+Z,"visibility:"+Y)}}function L(Y){var Z=/[\\\"<>\.;]/,X=null!=Z.exec(Y);return X&&typeof encodeURIComponent!=D?encodeURIComponent(Y):Y}var l,Q,E,B,n,G,D="undefined",r="object",S="Shockwave Flash",W="ShockwaveFlash.ShockwaveFlash",q="application/x-shockwave-flash",R="SWFObjectExprInst",x="onreadystatechange",O=window,j=document,t=navigator,T=!1,U=[h],o=[],N=[],I=[],J=!1,a=!1,m=!0,M=function(){var aa=typeof j.getElementById!=D&&typeof j.getElementsByTagName!=D&&typeof j.createElement!=D,ah=t.userAgent.toLowerCase(),Y=t.platform.toLowerCase(),ae=Y?/win/.test(Y):/win/.test(ah),ac=Y?/mac/.test(Y):/mac/.test(ah),af=/webkit/.test(ah)?parseFloat(ah.replace(/^.*webkit\/(\d+(\.\d+)?).*$/,"$1")):!1,X=!1,ag=[0,0,0],ab=null;if(typeof t.plugins!=D&&typeof t.plugins[S]==r)ab=t.plugins[S].description,!ab||typeof t.mimeTypes!=D&&t.mimeTypes[q]&&!t.mimeTypes[q].enabledPlugin||(T=!0,X=!1,ab=ab.replace(/^.*\s+(\S+\s+\S+$)/,"$1"),ag[0]=parseInt(ab.replace(/^(.*)\..*$/,"$1"),10),ag[1]=parseInt(ab.replace(/^.*\.(.*)\s.*$/,"$1"),10),ag[2]=/[a-zA-Z]/.test(ab)?parseInt(ab.replace(/^.*[a-zA-Z]+(.*)$/,"$1"),10):0);else if(typeof O[["Active"].concat("Object").join("X")]!=D)try{var ad=new(window[["Active"].concat("Object").join("X")])(W);ad&&(ab=ad.GetVariable("$version"),ab&&(X=!0,ab=ab.split(" ")[1].split(","),ag=[parseInt(ab[0],10),parseInt(ab[1],10),parseInt(ab[2],10)]))}catch(Z){}return{w3:aa,pv:ag,wk:af,ie:X,win:ae,mac:ac}}();(function(){M.w3&&((typeof j.readyState!=D&&"complete"==j.readyState||typeof j.readyState==D&&(j.getElementsByTagName("body")[0]||j.body))&&f(),J||(typeof j.addEventListener!=D&&j.addEventListener("DOMContentLoaded",f,!1),M.ie&&M.win&&(j.attachEvent(x,function(){"complete"==j.readyState&&(j.detachEvent(x,arguments.callee),f())}),O==top&&!function(){if(!J){try{j.documentElement.doScroll("left")}catch(X){return void setTimeout(arguments.callee,0)}f()}}()),M.wk&&!function(){return J?void 0:/loaded|complete/.test(j.readyState)?void f():void setTimeout(arguments.callee,0)}(),s(f)))})(),function(){M.ie&&M.win&&window.attachEvent("onunload",function(){for(var ac=I.length,ab=0;ac>ab;ab++)I[ab][0].detachEvent(I[ab][1],I[ab][2]);for(var Z=N.length,aa=0;Z>aa;aa++)y(N[aa]);for(var Y in M)M[Y]=null;M=null;for(var X in swfobject)swfobject[X]=null;swfobject=null})}();return{registerObject:function(ab,X,aa,Z){if(M.w3&&ab&&X){var Y={};Y.id=ab,Y.swfVersion=X,Y.expressInstall=aa,Y.callbackFn=Z,o[o.length]=Y,w(ab,!1)}else Z&&Z({success:!1,id:ab})},getObjectById:function(X){return M.w3?z(X):void 0},embedSWF:function(ab,ah,ae,ag,Y,aa,Z,ad,af,ac){var X={success:!1,id:ah};M.w3&&!(M.wk&&M.wk<312)&&ab&&ah&&ae&&ag&&Y?(w(ah,!1),K(function(){ae+="",ag+="";var aj={};if(af&&typeof af===r)for(var al in af)aj[al]=af[al];aj.data=ab,aj.width=ae,aj.height=ag;var am={};if(ad&&typeof ad===r)for(var ak in ad)am[ak]=ad[ak];if(Z&&typeof Z===r)for(var ai in Z)typeof am.flashvars!=D?am.flashvars+="&"+ai+"="+Z[ai]:am.flashvars=ai+"="+Z[ai];if(F(Y)){var an=u(aj,am,ah);aj.id==ah&&w(ah,!0),X.success=!0,X.ref=an}else{if(aa&&A())return aj.data=aa,void P(aj,am,ah,ac);w(ah,!0)}ac&&ac(X)})):ac&&ac(X)},switchOffAutoHideShow:function(){m=!1},ua:M,getFlashPlayerVersion:function(){return{major:M.pv[0],minor:M.pv[1],release:M.pv[2]}},hasFlashPlayerVersion:F,createSWF:function(Z,Y,X){return M.w3?u(Z,Y,X):void 0},showExpressInstall:function(Z,aa,X,Y){M.w3&&A()&&P(Z,aa,X,Y)},removeSWF:function(X){M.w3&&y(X)},createCSS:function(aa,Z,Y,X){M.w3&&v(aa,Z,Y,X)},addDomLoadEvent:K,addLoadEvent:s,getQueryParamValue:function(aa){var Z=j.location.search||j.location.hash;if(Z){if(/\?/.test(Z)&&(Z=Z.split("?")[1]),null==aa)return L(Z);for(var Y=Z.split("&"),X=0;X<Y.length;X++)if(Y[X].substring(0,Y[X].indexOf("="))==aa)return L(Y[X].substring(Y[X].indexOf("=")+1))}return""},expressInstallCallback:function(){if(a){var X=c(R);X&&l&&(X.parentNode.replaceChild(l,X),Q&&(w(Q,!0),M.ie&&M.win&&(l.style.display="block")),E&&E(B)),a=!1}}}}();!function(){if("undefined"!=typeof window&&!window.WebSocket){var console=window.console;if(console&&console.log&&console.error||(console={log:function(){},error:function(){}}),!swfobject.hasFlashPlayerVersion("10.0.0"))return void console.error("Flash Player >= 10.0.0 is required.");"file:"==location.protocol&&console.error("WARNING: web-socket-js doesn't work in file:///... URL unless you set Flash Security Settings properly. Open the page via Web server i.e. http://..."),WebSocket=function(url,protocols,proxyHost,proxyPort,headers){var self=this;self.__id=WebSocket.__nextId++,WebSocket.__instances[self.__id]=self,self.readyState=WebSocket.CONNECTING,self.bufferedAmount=0,self.__events={},protocols?"string"==typeof protocols&&(protocols=[protocols]):protocols=[],setTimeout(function(){WebSocket.__addTask(function(){WebSocket.__flash.create(self.__id,url,protocols,proxyHost||null,proxyPort||0,headers||null)})},0)},WebSocket.prototype.send=function(data){if(this.readyState==WebSocket.CONNECTING)throw"INVALID_STATE_ERR: Web Socket connection has not been established";var result=WebSocket.__flash.send(this.__id,encodeURIComponent(data));return 0>result?!0:(this.bufferedAmount+=result,!1)},WebSocket.prototype.close=function(){this.readyState!=WebSocket.CLOSED&&this.readyState!=WebSocket.CLOSING&&(this.readyState=WebSocket.CLOSING,WebSocket.__flash.close(this.__id))},WebSocket.prototype.addEventListener=function(type,listener,useCapture){type in this.__events||(this.__events[type]=[]),this.__events[type].push(listener)},WebSocket.prototype.removeEventListener=function(type,listener,useCapture){if(type in this.__events)for(var events=this.__events[type],i=events.length-1;i>=0;--i)if(events[i]===listener){events.splice(i,1);break}},WebSocket.prototype.dispatchEvent=function(event){for(var events=this.__events[event.type]||[],i=0;i<events.length;++i)events[i](event);var handler=this["on"+event.type];handler&&handler(event)},WebSocket.prototype.__handleEvent=function(flashEvent){"readyState"in flashEvent&&(this.readyState=flashEvent.readyState),"protocol"in flashEvent&&(this.protocol=flashEvent.protocol);var jsEvent;if("open"==flashEvent.type||"error"==flashEvent.type)jsEvent=this.__createSimpleEvent(flashEvent.type);else if("close"==flashEvent.type)jsEvent=this.__createSimpleEvent("close");else{if("message"!=flashEvent.type)throw"unknown event type: "+flashEvent.type;var data=decodeURIComponent(flashEvent.message);jsEvent=this.__createMessageEvent("message",data)}this.dispatchEvent(jsEvent)},WebSocket.prototype.__createSimpleEvent=function(type){if(document.createEvent&&window.Event){var event=document.createEvent("Event");return event.initEvent(type,!1,!1),event}return{type:type,bubbles:!1,cancelable:!1}},WebSocket.prototype.__createMessageEvent=function(type,data){if(document.createEvent&&window.MessageEvent&&!window.opera){var event=document.createEvent("MessageEvent");return event.initMessageEvent("message",!1,!1,data,null,null,window,null),event}return{type:type,data:data,bubbles:!1,cancelable:!1}},WebSocket.CONNECTING=0,WebSocket.OPEN=1,WebSocket.CLOSING=2,WebSocket.CLOSED=3,WebSocket.__flash=null,WebSocket.__instances={},WebSocket.__tasks=[],WebSocket.__nextId=0,WebSocket.loadFlashPolicyFile=function(url){WebSocket.__addTask(function(){WebSocket.__flash.loadManualPolicyFile(url)})},WebSocket.__initialize=function(){if(!WebSocket.__flash){if(WebSocket.__swfLocation&&(window.WEB_SOCKET_SWF_LOCATION=WebSocket.__swfLocation),!window.WEB_SOCKET_SWF_LOCATION)return void console.error("[WebSocket] set WEB_SOCKET_SWF_LOCATION to location of WebSocketMain.swf");var container=document.createElement("div");container.id="webSocketContainer",container.style.position="absolute",WebSocket.__isFlashLite()?(container.style.left="0px",container.style.top="0px"):(container.style.left="-100px",container.style.top="-100px");var holder=document.createElement("div");holder.id="webSocketFlash",container.appendChild(holder),document.body.appendChild(container),swfobject.embedSWF(WEB_SOCKET_SWF_LOCATION,"webSocketFlash","1","1","10.0.0",null,null,{hasPriority:!0,swliveconnect:!0,allowScriptAccess:"always"},null,function(e){e.success||console.error("[WebSocket] swfobject.embedSWF failed")})}},WebSocket.__onFlashInitialized=function(){setTimeout(function(){WebSocket.__flash=document.getElementById("webSocketFlash"),WebSocket.__flash.setCallerUrl(location.href),WebSocket.__flash.setDebug(!!window.WEB_SOCKET_DEBUG);for(var i=0;i<WebSocket.__tasks.length;++i)WebSocket.__tasks[i]();WebSocket.__tasks=[]},0)},WebSocket.__onFlashEvent=function(){return setTimeout(function(){try{for(var events=WebSocket.__flash.receiveEvents(),i=0;i<events.length;++i)WebSocket.__instances[events[i].webSocketId].__handleEvent(events[i])}catch(e){console.error(e)}},0),!0},WebSocket.__log=function(message){console.log(decodeURIComponent(message))},WebSocket.__error=function(message){console.error(decodeURIComponent(message))},WebSocket.__addTask=function(task){WebSocket.__flash?task():WebSocket.__tasks.push(task)},WebSocket.__isFlashLite=function(){if(!window.navigator||!window.navigator.mimeTypes)return!1;var mimeType=window.navigator.mimeTypes["application/x-shockwave-flash"];return mimeType&&mimeType.enabledPlugin&&mimeType.enabledPlugin.filename&&mimeType.enabledPlugin.filename.match(/flashlite/i)?!0:!1},window.WEB_SOCKET_DISABLE_AUTO_INITIALIZATION||(window.addEventListener?window.addEventListener("load",function(){WebSocket.__initialize()},!1):window.attachEvent("onload",function(){WebSocket.__initialize()}))}}(),function(exports,io,global){function XHR(socket){socket&&(io.Transport.apply(this,arguments),this.sendBuffer=[])}function empty(){}exports.XHR=XHR,io.util.inherit(XHR,io.Transport),XHR.prototype.open=function(){return this.socket.setBuffer(!1),this.onOpen(),this.get(),this.setCloseTimeout(),this},XHR.prototype.payload=function(payload){for(var msgs=[],i=0,l=payload.length;l>i;i++)msgs.push(io.parser.encodePacket(payload[i]));this.send(io.parser.encodePayload(msgs))},XHR.prototype.send=function(data){return this.post(data),this},XHR.prototype.post=function(data){function stateChange(){4==this.readyState&&(this.onreadystatechange=empty,self.posting=!1,200==this.status?self.socket.setBuffer(!1):self.onClose())}function onload(){this.onload=empty,self.socket.setBuffer(!1)}var self=this;this.socket.setBuffer(!0),this.sendXHR=this.request("POST"),global.XDomainRequest&&this.sendXHR instanceof XDomainRequest?this.sendXHR.onload=this.sendXHR.onerror=onload:this.sendXHR.onreadystatechange=stateChange,this.sendXHR.send(data)},XHR.prototype.close=function(){return this.onClose(),this},XHR.prototype.request=function(method){var req=io.util.request(this.socket.isXDomain()),query=io.util.query(this.socket.options.query,"t="+ +new Date);if(req.open(method||"GET",this.prepareUrl()+query,!0),"POST"==method)try{req.setRequestHeader?req.setRequestHeader("Content-type","text/plain;charset=UTF-8"):req.contentType="text/plain"}catch(e){}return req},XHR.prototype.scheme=function(){return this.socket.options.secure?"https":"http"},XHR.check=function(socket,xdomain){try{var request=io.util.request(xdomain),usesXDomReq=global.XDomainRequest&&request instanceof XDomainRequest,socketProtocol=socket&&socket.options&&socket.options.secure?"https:":"http:",isXProtocol=global.location&&socketProtocol!=global.location.protocol;if(request&&(!usesXDomReq||!isXProtocol))return!0}catch(e){}return!1},XHR.xdomainCheck=function(socket){return XHR.check(socket,!0)}}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this),function(exports,io){function HTMLFile(socket){io.Transport.XHR.apply(this,arguments)}exports.htmlfile=HTMLFile,io.util.inherit(HTMLFile,io.Transport.XHR),HTMLFile.prototype.name="htmlfile",HTMLFile.prototype.get=function(){this.doc=new(window[["Active"].concat("Object").join("X")])("htmlfile"),this.doc.open(),this.doc.write("<html></html>"),this.doc.close(),this.doc.parentWindow.s=this;var iframeC=this.doc.createElement("div");iframeC.className="socketio",this.doc.body.appendChild(iframeC),this.iframe=this.doc.createElement("iframe"),iframeC.appendChild(this.iframe);var self=this,query=io.util.query(this.socket.options.query,"t="+ +new Date);this.iframe.src=this.prepareUrl()+query,io.util.on(window,"unload",function(){self.destroy()})},HTMLFile.prototype._=function(data,doc){data=data.replace(/\\\//g,"/"),this.onData(data);try{var script=doc.getElementsByTagName("script")[0];script.parentNode.removeChild(script)}catch(e){}},HTMLFile.prototype.destroy=function(){if(this.iframe){try{this.iframe.src="about:blank"}catch(e){}this.doc=null,this.iframe.parentNode.removeChild(this.iframe),this.iframe=null,CollectGarbage()}},HTMLFile.prototype.close=function(){return this.destroy(),io.Transport.XHR.prototype.close.call(this)},HTMLFile.check=function(socket){if("undefined"!=typeof window&&["Active"].concat("Object").join("X")in window)try{var a=new(window[["Active"].concat("Object").join("X")])("htmlfile");return a&&io.Transport.XHR.check(socket)}catch(e){}return!1},HTMLFile.xdomainCheck=function(){return!1},io.transports.push("htmlfile")}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports),function(exports,io,global){function XHRPolling(){io.Transport.XHR.apply(this,arguments)}function empty(){}exports["xhr-polling"]=XHRPolling,io.util.inherit(XHRPolling,io.Transport.XHR),io.util.merge(XHRPolling,io.Transport.XHR),XHRPolling.prototype.name="xhr-polling",XHRPolling.prototype.heartbeats=function(){return!1},XHRPolling.prototype.open=function(){var self=this;return io.Transport.XHR.prototype.open.call(self),!1},XHRPolling.prototype.get=function(){function stateChange(){4==this.readyState&&(this.onreadystatechange=empty,200==this.status?(self.onData(this.responseText),self.get()):self.onClose())}function onload(){this.onload=empty,this.onerror=empty,self.retryCounter=1,self.onData(this.responseText),self.get()}function onerror(){self.retryCounter++,!self.retryCounter||self.retryCounter>3?self.onClose():self.get()}if(this.isOpen){var self=this;this.xhr=this.request(),global.XDomainRequest&&this.xhr instanceof XDomainRequest?(this.xhr.onload=onload,this.xhr.onerror=onerror):this.xhr.onreadystatechange=stateChange,this.xhr.send(null)}},XHRPolling.prototype.onClose=function(){if(io.Transport.XHR.prototype.onClose.call(this),this.xhr){this.xhr.onreadystatechange=this.xhr.onload=this.xhr.onerror=empty;try{this.xhr.abort()}catch(e){}this.xhr=null}},XHRPolling.prototype.ready=function(socket,fn){var self=this;io.util.defer(function(){fn.call(self)})},io.transports.push("xhr-polling")}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this),function(exports,io,global){function JSONPPolling(socket){io.Transport["xhr-polling"].apply(this,arguments),this.index=io.j.length;var self=this;io.j.push(function(msg){self._(msg)})}var indicator=global.document&&"MozAppearance"in global.document.documentElement.style;exports["jsonp-polling"]=JSONPPolling,io.util.inherit(JSONPPolling,io.Transport["xhr-polling"]),JSONPPolling.prototype.name="jsonp-polling",JSONPPolling.prototype.post=function(data){function complete(){initIframe(),self.socket.setBuffer(!1)}function initIframe(){self.iframe&&self.form.removeChild(self.iframe);try{iframe=document.createElement('<iframe name="'+self.iframeId+'">')}catch(e){iframe=document.createElement("iframe"),iframe.name=self.iframeId}iframe.id=self.iframeId,self.form.appendChild(iframe),self.iframe=iframe}var self=this,query=io.util.query(this.socket.options.query,"t="+ +new Date+"&i="+this.index);if(!this.form){var iframe,form=document.createElement("form"),area=document.createElement("textarea"),id=this.iframeId="socketio_iframe_"+this.index;form.className="socketio",form.style.position="absolute",form.style.top="0px",form.style.left="0px",form.style.display="none",form.target=id,form.method="POST",form.setAttribute("accept-charset","utf-8"),area.name="d",form.appendChild(area),document.body.appendChild(form),this.form=form,this.area=area}this.form.action=this.prepareUrl()+query,initIframe(),this.area.value=io.JSON.stringify(data);try{this.form.submit()}catch(e){}this.iframe.attachEvent?iframe.onreadystatechange=function(){"complete"==self.iframe.readyState&&complete()}:this.iframe.onload=complete,this.socket.setBuffer(!0)},JSONPPolling.prototype.get=function(){var self=this,script=document.createElement("script"),query=io.util.query(this.socket.options.query,"t="+ +new Date+"&i="+this.index);this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),script.async=!0,script.src=this.prepareUrl()+query,script.onerror=function(){self.onClose()};var insertAt=document.getElementsByTagName("script")[0];insertAt.parentNode.insertBefore(script,insertAt),this.script=script,indicator&&setTimeout(function(){var iframe=document.createElement("iframe");document.body.appendChild(iframe),document.body.removeChild(iframe)},100)},JSONPPolling.prototype._=function(msg){return this.onData(msg),this.isOpen&&this.get(),this},JSONPPolling.prototype.ready=function(socket,fn){var self=this;return indicator?void io.util.load(function(){fn.call(self)}):fn.call(this)},JSONPPolling.check=function(){return"document"in global},JSONPPolling.xdomainCheck=function(){return!0},io.transports.push("jsonp-polling")}("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this),__WEBPACK_AMD_DEFINE_ARRAY__=[],__WEBPACK_AMD_DEFINE_RESULT__=function(){return io}.apply(exports,__WEBPACK_AMD_DEFINE_ARRAY__),!(void 0!==__WEBPACK_AMD_DEFINE_RESULT__&&(module.exports=__WEBPACK_AMD_DEFINE_RESULT__))}()}).call(exports,__webpack_require__(15)(module))},function(module,exports){module.exports=function(module){return module.webpackPolyfill||(module.deprecate=function(){},module.paths=[],module.children=[],module.webpackPolyfill=1),module}},function(module,exports,__webpack_require__){!function(root,factory){module.exports=factory()}(this,function(){function UrlTemplate(){}return UrlTemplate.prototype.encodeReserved=function(str){return str.split(/(%[0-9A-Fa-f]{2})/g).map(function(part){return/%[0-9A-Fa-f]/.test(part)||(part=encodeURI(part)),part}).join("")},UrlTemplate.prototype.encodeValue=function(operator,value,key){return value="+"===operator||"#"===operator?this.encodeReserved(value):encodeURIComponent(value),key?encodeURIComponent(key)+"="+value:value},UrlTemplate.prototype.isDefined=function(value){return void 0!==value&&null!==value},UrlTemplate.prototype.isKeyOperator=function(operator){return";"===operator||"&"===operator||"?"===operator},UrlTemplate.prototype.getValues=function(context,operator,key,modifier){var value=context[key],result=[];if(this.isDefined(value)&&""!==value)if("string"==typeof value||"number"==typeof value||"boolean"==typeof value)value=value.toString(),modifier&&"*"!==modifier&&(value=value.substring(0,parseInt(modifier,10))),result.push(this.encodeValue(operator,value,this.isKeyOperator(operator)?key:null));else if("*"===modifier)Array.isArray(value)?value.filter(this.isDefined).forEach(function(value){result.push(this.encodeValue(operator,value,this.isKeyOperator(operator)?key:null))},this):Object.keys(value).forEach(function(k){this.isDefined(value[k])&&result.push(this.encodeValue(operator,value[k],k))},this);else{var tmp=[];Array.isArray(value)?value.filter(this.isDefined).forEach(function(value){tmp.push(this.encodeValue(operator,value))},this):Object.keys(value).forEach(function(k){this.isDefined(value[k])&&(tmp.push(encodeURIComponent(k)),tmp.push(this.encodeValue(operator,value[k].toString())))},this),this.isKeyOperator(operator)?result.push(encodeURIComponent(key)+"="+tmp.join(",")):0!==tmp.length&&result.push(tmp.join(","))}else";"===operator?result.push(encodeURIComponent(key)):""!==value||"&"!==operator&&"?"!==operator?""===value&&result.push(""):result.push(encodeURIComponent(key)+"=");return result},UrlTemplate.prototype.parse=function(template){var that=this,operators=["+","#",".","/",";","?","&"];return{expand:function(context){return template.replace(/\{([^\{\}]+)\}|([^\{\}]+)/g,function(_,expression,literal){if(expression){var operator=null,values=[];if(-1!==operators.indexOf(expression.charAt(0))&&(operator=expression.charAt(0),expression=expression.substr(1)),expression.split(/,/g).forEach(function(variable){var tmp=/([^:\*]*)(?::(\d+)|(\*))?/.exec(variable);values.push.apply(values,that.getValues(context,operator,tmp[1],tmp[2]||tmp[3]))}),operator&&"+"!==operator){var separator=",";return"?"===operator?separator="&":"#"!==operator&&(separator=operator),(0!==values.length?operator:"")+values.join(separator)}return values.join(",")}return that.encodeReserved(literal)})}}},new UrlTemplate})},function(module,exports,__webpack_require__){var Q=__webpack_require__(6),respoke=__webpack_require__(1),log=respoke.log;module.exports=function(params){"use strict";function listenDataChannel(evt){dataChannel=evt.channel,dataChannel.onerror=onDataChannelError,dataChannel.onmessage=onDataChannelMessage,"open"===dataChannel.readyState?(dataChannel.onopen=null,onDataChannelOpen()):dataChannel.onopen=onDataChannelOpen}function saveParameters(params){that.listen("open",params.onOpen),that.listen("close",params.onClose),that.listen("message",params.onMessage),that.listen("start",params.onStart),that.listen("error",params.onError),pc.listen("direct-connection",listenDataChannel,!0),pc.listen("stats",function(evt){that.fire("stats",{stats:evt.stats})},!0)}function onDataChannelError(error){that.fire("error",{error:error}),that.close()}function onDataChannelMessage(evt){var message;try{message=JSON.parse(evt.data)}catch(e){message=evt.data}that.call.remoteEndpoint.fire("message",{message:message,directConnection:that}),that.fire("message",{message:message,endpoint:that.call.remoteEndpoint})}function onDataChannelOpen(evt){that.fire("open")}function createDataChannel(){dataChannel=pc.createDataChannel("respokeDataChannel"),dataChannel.binaryType="arraybuffer",dataChannel.onerror=onDataChannelError,dataChannel.onmessage=onDataChannelMessage,dataChannel.onopen=onDataChannelOpen,that.fire("start")}params=params||{};var instanceId=params.instanceId,that=respoke.EventEmitter(params);delete that.instanceId,that.className="respoke.DirectConnection",that.id=respoke.makeGUID(),that.call.caller||(that.call.caller=!1);var dataChannel=null,pc=(respoke.getClient(instanceId),params.pc);return delete params.pc,saveParameters(params),delete that.onOpen,delete that.onClose,delete that.onMessage,that.getStats=function(params){return pc&&pc.getStats?(that.listen("stats",params.onStats),delete params.onStats,pc.getStats(params)):null},respoke.MediaStats||delete that.getStats,that.accept=function(params){params=params||{},log.debug("DirectConnection.accept"),saveParameters(params),log.debug("I am "+(pc.state.caller?"":"not ")+"the caller."),pc.state.caller===!0&&createDataChannel(),that.call.answer(),that.fire("accept")},that.close=function(params){params=params||{},log.debug("DirectConnection.close"),that.call&&that.call.remoteEndpoint&&(that.call.remoteEndpoint.directConnection=null),dataChannel&&dataChannel.close(),that.fire("close"),that.ignore(),that.call&&params.skipRemove!==!0&&that.call.removeDirectConnection(),dataChannel=null,that.call=null,pc=null},that.sendMessage=function(params){var deferred=Q.defer(),retVal=respoke.handlePromise(deferred.promise,params.onSuccess,params.onError);return that.isActive()?(dataChannel.send(JSON.stringify(params.object||{message:params.message})),deferred.resolve()):deferred.reject(new Error("dataChannel not in an open state.")),retVal},that.reject=that.close,that.isActive=function(){return dataChannel&&"open"===dataChannel.readyState},that}},function(module,exports,__webpack_require__){var Q=__webpack_require__(6),respoke=__webpack_require__(1),log=respoke.log;module.exports=function(params){"use strict";function signalCandidate(params){pc&&(params.iceCandidates=[params.candidate],signalCandidateOrig(params),that.report.candidatesSent.push({candidate:params.candidate}))}function initOffer(){pc&&(that.state.receiveOnly&&makeOptionsReceiveOnly(offerOptions),that.state.sendOnly&&makeOptionsSendOnly(offerOptions),log.info("creating offer",offerOptions),pc.createOffer(saveOfferAndSend,function(p){log.error("createOffer failed")},offerOptions))}function makeOptionsReceiveOnly(options){navigator.webkitGetUserMedia?options.mandatory={OfferToReceiveVideo:!0,OfferToReceiveAudio:!0,OfferToSendVideo:!1,OfferToSendAudio:!1}:(options.offerToReceiveVideo=!0,options.offerToReceiveAudio=!0,options.offerToSendVideo=!1,options.offerToSendAudio=!1)}function makeOptionsSendOnly(options){navigator.webkitGetUserMedia?options.mandatory={OfferToSendVideo:!0,OfferToSendAudio:!0,OfferToReceiveVideo:!1,OfferToReceiveAudio:!1}:(options.offerToSendVideo=!0,options.offerToSendAudio=!0,options.offerToReceiveVideo=!1,options.offerToReceiveAudio=!1)}function getStats(params){function onConnect(){var stats=respoke.MediaStatsParser({peerConnection:pc,interval:params.interval,onStats:function(stats){pc&&that.fire("stats",{stats:stats})}});that.listen("close",function(evt){stats.stopStats()},!0),deferred.resolve()}var deferred=Q.defer(),retVal=respoke.handlePromise(deferred.promise,params.onSuccess,params.onError);return respoke.MediaStats?(pc?onConnect():that.once("stream-received",onConnect),retVal):(deferred.reject(new Error("Statistics module is not loaded.")),retVal)}function onIceCandidate(oCan){var candidate=oCan.candidate;if(pc&&candidate&&candidate.candidate)return that.forceTurn===!0&&-1===candidate.candidate.indexOf("typ relay")?void log.debug("Dropping candidate because forceTurn is on."):that.disableTurn===!0&&-1!==candidate.candidate.indexOf("typ relay")?void log.debug("Dropping candidate because disableTurn is on."):void candidateSendingQueue.push(candidate)}function onIceConnectionStateChange(evt){pc&&"connected"===pc.iceConnectionState&&that.fire("connect")}function onNegotiationNeeded(){log.warn("Negotiation needed.")}function processSendingQueue(){candidateSendingQueue.trigger(function(can){pc&&signalCandidate({candidate:can,call:that.call})})}function processReceivingQueue(){candidateReceivingQueue.trigger(function(can){pc&&pc.addIceCandidate(new RTCIceCandidate(can.candidate),function(){log.debug(that.state.caller?"caller":"callee","got a remote candidate.",can.candidate),that.report.candidatesReceived.push(can.candidate)},function(e){log.error("Couldn't add ICE candidate: "+e.message,can.candidate)})})}function saveOfferAndSend(oSession){oSession.type="offer",pc&&(log.debug("setting and sending offer",oSession),that.report.sdpsSent.push(oSession),pc.setLocalDescription(oSession,function(p){oSession.type="offer",signalOffer({call:that.call,sessionDescription:oSession,onSuccess:function(){that.state.sentSDP=!0,processSendingQueue()},onError:function(err){log.error("offer could not be sent",err),that.call.hangup({signal:!1})}})},function(p){var err=new Error("Error calling setLocalDescription on offer I created.");that.call.fire("error",{message:err.message})}))}function saveAnswerAndSend(oSession){pc&&(that.state.caller||(that.report.callerconnection=that.call.connectionId),oSession.type="answer",log.debug("setting and sending answer",oSession),that.report.sdpsSent.push(oSession),pc.setLocalDescription(oSession,function(p){oSession.type="answer",signalAnswer({sessionDescription:oSession,call:that.call,onSuccess:processSendingQueue}),that.state.sentSDP=!0},function(p){var err=new Error("Error calling setLocalDescription on answer I created.");that.call.fire("error",{message:err.message})}))}function listenAnswer(evt){pc&&(log.debug("got answer",evt.signal),that.report.sdpsReceived.push(evt.signal.sessionDescription),that.state.sendOnly=respoke.sdpHasReceiveOnly(evt.signal.sessionDescription.sdp),that.sdpExpectedStreamCount=respoke.sdpStreamCount(evt.signal.sessionDescription.sdp),that.report.lastSDPString=evt.signal.sessionDescription.sdp,that.state.caller&&(that.report.calleeconnection=evt.signal.fromConnection),that.call.connectionId=evt.signal.fromConnection,signalConnected({call:that.call}),pc.setRemoteDescription(new RTCSessionDescription(evt.signal.sessionDescription),function(){processReceivingQueue(),that.state.dispatch("receiveAnswer")},function(p){var newErr=new Error("Exception calling setRemoteDescription on answer I received.");that.report.callStoppedReason=newErr.message,that.call.fire("error",{message:newErr.message}),log.error("set remote desc of answer failed",evt.signal.sessionDescription,p),that.report.callStoppedReason="setRemoteDescription failed at answer.",that.close()}))}function listenConnected(evt){evt.signal.connectionId!==client.connectionId&&(log.debug("Hanging up because I didn't win the call.",evt.signal,client),that.call.hangup({signal:!1}))}function listenModify(evt){var err;return log.debug("PC.listenModify",evt.signal),"accept"===evt.signal.action?void(defModify.promise.isPending()&&(defModify.resolve(),that.fire("modify-accept",{signal:evt.signal}))):"reject"===evt.signal.action?void(defModify.promise.isPending()&&(err=new Error("Remote party cannot negotiate."),log.debug(err.message),defModify.reject(err),that.fire("modify-reject",{err:err}))):defModify&&defModify.promise.isPending()?(err=new Error("Got modify in a negotiating state."),log.debug(err.message),defModify.reject(err),that.fire("modify-reject",{err:err}),void signalModify({action:"reject",call:that.call})):(defModify=Q.defer(),!that.state.sentSDP||that.state.isState("idle")?(err=new Error("Got modify in a precall state."),that.fire("modify-reject",{err:err}),signalModify({action:"reject",call:that.call}),void defModify.reject(err)):(that.fire("modify-accept",{signal:evt.signal}),signalModify({action:"accept",call:that.call}),void defModify.resolve()))}params=params||{};var instanceId=params.instanceId,that=respoke.EventEmitter(params);delete that.instanceId,that.className="respoke.PeerConnection";var toSendHangup,defModify,pc=null,candidateSendingQueue=("function"==typeof params.previewLocalMedia?params.previewLocalMedia:void 0,respoke.queueFactory()),candidateReceivingQueue=respoke.queueFactory(),client=respoke.getClient(instanceId),signalOffer=params.signalOffer,signalConnected=params.signalConnected,signalModify=params.signalModify,signalAnswer=params.signalAnswer,signalHangup=respoke.callOnce(params.signalHangup),signalReport=params.signalReport,signalCandidateOrig=params.signalCandidate,digitSender=null,cancellingTones=!1;
that.sdpExpectedStreamCount=0;var offerOptions=params.offerOptions||{},pcOptions=params.pcOptions||{optional:[{DtlsSrtpKeyAgreement:!0},{RtpDataChannels:!1}]};return that.report={callStarted:0,callStopped:0,callerendpoint:that.call.caller?client.name:that.call.remoteEndpoint.id,callerconnection:that.call.caller?client.id:that.call.connectionId,calleeendpoint:that.call.caller?that.call.remoteEndpoint.id:client.id,calleeconnection:that.call.caller?that.call.connectionId:client.connectionId,sessionId:that.call.id,lastSDPString:"",sdpsSent:[],sdpsReceived:[],candidatesSent:[],candidatesReceived:[],userAgent:navigator.userAgent,os:navigator.platform},that.processOffer=function(oOffer){if(pc){log.debug("processOffer",oOffer),that.report.sdpsReceived.push(oOffer),that.report.lastSDPString=oOffer.sdp,that.sdpExpectedStreamCount=respoke.sdpStreamCount(oOffer.sdp),that.call.hasDataChannel=respoke.sdpHasDataChannel(oOffer.sdp);try{pc.setRemoteDescription(new RTCSessionDescription(oOffer),function(){pc&&(processReceivingQueue(),log.debug("set remote desc of offer succeeded"),pc.createAnswer(function(oSession){that.state.processedRemoteSDP=!0,saveAnswerAndSend(oSession)},function(err){err=new Error("Error creating SDP answer."+err.message),that.report.callStoppedReason=err.message,that.call.fire("error",{message:err.message}),log.error("create answer failed"),that.report.callStoppedReason="setRemoteDescription failed at answer.",that.close()}))},function(err){err=new Error("Error calling setRemoteDescription on offer I received."+err.message),that.report.callStoppedReason=err.message,that.call.fire("error",{message:err.message})})}catch(err){var newErr=new Error("Exception calling setRemoteDescription on offer I received."+err.message);that.report.callStoppedReason=newErr.message,that.call.fire("error",{message:newErr.message})}}},respoke.MediaStats&&(that.getStats=getStats),that.init=function(){log.debug("PC.init"),pc||(that.report.callStarted=(new Date).getTime(),pc=new RTCPeerConnection(that.servers,pcOptions),pc.onicecandidate=onIceCandidate,pc.onnegotiationneeded=onNegotiationNeeded,pc.oniceconnectionstatechange=onIceConnectionStateChange,pc.onaddstream=function(evt){that.fire("remote-stream-received",{stream:evt.stream})},pc.onremovestream=function(evt){that.fire("remote-stream-removed",{stream:evt.stream})},pc.ondatachannel=function(evt){that.fire("direct-connection",{channel:evt.channel})},that.state.listen("offering:entry",function(evt){that.state.caller&&initOffer()}))},that.getRemoteStreams=function(){return pc?pc.getRemoteStreams.apply(pc,Array.prototype.slice.call(arguments)):[]},that.getLocalStreams=function(){return pc?pc.getLocalStreams.apply(pc,Array.prototype.slice.call(arguments)):[]},that.createDataChannel=function(){return pc?pc.createDataChannel.apply(pc,Array.prototype.slice.call(arguments)):void 0},that.addStream=function(stream){return pc?void pc.addStream(stream):void that.call.fire("error",{message:"Got local stream in a precall state."})},that.sendTones=function(params){var deferred=Q.defer(),retVal=respoke.handlePromise(deferred.promise,params.onSuccess,params.onError);params="object"==typeof params?params:{},params.duration=params.duration||100,params.gap=params.gap||50;var err;if(pc||(err=new Error("No Peer Connection available")),params.tones||(err=new Error("Unable to send tones as none passed in")),(params.duration>6e3||params.duration<40)&&(err=new Error("Unable to send tones as duration needs to be between 40 and 6000 milliseconds")),params.gap<50&&(err=new Error("Unable to send tones as gap needs to be greater than 50 milliseconds")),params.tones&&!params.tones.match(/^([A-D0-9,#*])+$/gi)&&(err=new Error("Unable to send tones as tones passed in were not in correct format")),pc&&!pc.createDTMFSender&&(err=new Error("Unable to send tones in this browser")),err)return log.warn(err),deferred.reject(err),retVal;if(digitSender)return err=new Error("Unable to queue tones on audio track as a digitSender already exists"),log.warn(err),deferred.reject(err),retVal;var audioTracks=that.call.outgoingMedia.getAudioTracks();if(!audioTracks||audioTracks.length<1)return err=new Error('Could not send tones "'+params.tones+'" because not audio sent yet'),log.warn(err),deferred.reject(err),retVal;if(digitSender=pc.createDTMFSender(audioTracks[0]),digitSender.ontonechange=function(evt){var eventData={tone:evt.tone,duration:digitSender.duration,gap:digitSender.interToneGap};""!==evt.tone&&that.call.fire("tone-sent",eventData),""===evt.tone&&(digitSender=null,cancellingTones?(cancellingTones=!1,deferred.reject(new Error("Tone playback cancelled"))):(deferred.resolve(),that.call.fire("tone-sending-complete")))},!digitSender.canInsertDTMF)return err=new Error("Unable to insert tones into audio track"),log.warn(err),deferred.reject(err),retVal;try{digitSender.insertDTMF(params.tones,params.duration,params.gap)}catch(e){return err=new Error("Unable to queue tones on audio track due to an error"),log.warn(err,params,e),deferred.reject(err),retVal}return log.debug("successfully queued playback of tones",{tones:digitSender.toneBuffer,duration:digitSender.duration,gap:digitSender.interToneGap}),retVal},that.cancelTones=function(params){var err,deferred=Q.defer(),retVal=respoke.handlePromise(deferred.promise,params.onSuccess,params.onError);if(!pc)return err=new Error("No Peer Connection available"),log.warn(err),deferred.reject(err),retVal;if(!digitSender)return err=new Error("Unable to queue tones on audio track as a digitSender does not exist"),log.warn(err),deferred.reject(err),retVal;if(!digitSender.canInsertDTMF)return err=new Error("Unable to cancel playback of tones as cannot change tones on audio track"),log.warn(err),deferred.reject(err),retVal;cancellingTones=!0;var tonesToCancel=digitSender.toneBuffer;try{digitSender.insertDTMF("")}catch(e){return err=new Error("Unable to cancel playback of tones"),log.warn(err,e),deferred.reject(err),retVal}return deferred.resolve(),that.call.fire("tone-sending-cancelled",{cancelledTones:tonesToCancel}),retVal},that.close=function(params){params=params||{},toSendHangup=!0,that.state.caller===!0&&(that.state.sentSDP||(toSendHangup=!1)),toSendHangup="boolean"==typeof params.signal?params.signal:toSendHangup,toSendHangup&&(log.info("sending hangup"),signalHangup({call:that.call})),that.report.callStopped=(new Date).getTime(),that.fire("close",{sentSignal:toSendHangup}),that.ignore(),pc&&that.report&&pc.close(),pc=null,that.call.enableCallDebugReport&&signalReport({report:that.report}),that.report=null},that.close=respoke.callOnce(that.close),that.isActive=function(){return!!(pc&&["completed","connected","new","checking"].indexOf(pc.iceConnectionState)>-1)},that.startModify=function(params){defModify=Q.defer(),signalModify({action:"initiate",call:that.call,constraints:params.constraints,directConnection:params.directConnection})},that.addRemoteCandidate=function(params){return pc||!that.state.sentSDP&&!that.state.receivedSDP?params&&params.candidate&&params.candidate.hasOwnProperty("sdpMLineIndex")?void candidateReceivingQueue.push(params):void log.warn("addRemoteCandidate got wrong format!",params):void 0},that.call.listen("signal-answer",listenAnswer,!0),that.call.listen("signal-connected",listenConnected,!0),that.call.listen("signal-modify",listenModify,!0),that}},function(module,exports,__webpack_require__){var respoke=__webpack_require__(1),log=respoke.log,Statechart=__webpack_require__(20);__webpack_require__(6);module.exports=function(params){"use strict";function assert(condition){if(!condition)throw new Error("Assertion failed.")}function rejectModify(){modifyTimer&&modifyTimer.clear()}function clearReceiveAnswerTimer(){that.processedRemoteSDP=!0,receiveAnswerTimer&&receiveAnswerTimer.clear()}function needToObtainMedia(){return that.needDirectConnection!==!0&&that.receiveOnly!==!0&&that.hasLocalMedia!==!0}function needToApproveDirectConnection(params){return that.needDirectConnection===!0&&"function"==typeof params.previewLocalMedia}function automaticOffering(params){return that.caller!==!0?!1:!that.needDirectConnection&&that.receiveOnly||that.hasLocalMedia?!0:that.needDirectConnection===!0&&"function"!=typeof params.previewLocalMedia}function hasListener(){return client.hasListeners("call")&&!that.needDirectConnection||client.hasListeners("direct-connection")&&that.needDirectConnection?!0:!1}function createTimer(func,name,time){var id=setTimeout(function(){id=null,log.error(that.caller?"caller's":"callee's",name,"timer expired."),func()},time);log.debug("setting timer",name,"for",time/1e3,"secs");var timer={name:name,clear:function(){null!==id&&(log.debug("clearing",that.caller?"caller's":"callee's","timer",name),clearTimeout(id),id=null)}};return allTimers.push(timer),timer}params=params||{};var fsm,instanceId=params.instanceId,that=respoke.EventEmitter(params);that.className="respoke.CallState",delete that.instanceId;var answerTimer,receiveAnswerTimer,connectionTimer,modifyTimer,oldRole,client=respoke.getClient(instanceId),allTimers=[],answerTimeout=params.answerTimeout||1e4,receiveAnswerTimeout=params.receiveAnswerTimeout||6e4,connectionTimeout=params.connectionTimeout||1e4,modifyTimeout=params.modifyTimeout||6e4,nontransitionEvents=["receiveLocalMedia","receiveRemoteMedia","approve","answer","sentOffer","receiveAnswer"];that.hasLocalMediaApproval=!1,that.hasLocalMedia=!1,that.receivedBye=!1,that.isAnswered=!1,that.sentSDP=!1,that.receivedSDP=!1,that.processedRemoteSDP=!1,that.needDirectConnection=!!that.needDirectConnection,that.sendOnly=!!that.sendOnly,that.receiveOnly=!!that.receiveOnly;var rejectEvent=[{target:"connected",guard:function(params){return"boolean"==typeof oldRole&&(that.caller=oldRole),modifyTimer&&modifyTimer.clear(),that.hasMedia()}},{target:"terminated",guard:function(params){return params=params||{},that.hangupReason=params.reason||"no media",[answerTimer,receiveAnswerTimer,connectionTimer,modifyTimer].forEach(function(timer){timer&&timer.clear()}),!that.hasMedia()}}],hangupEvent={target:"terminated",action:function(params){params=params||{},that.signalBye=params.signal,that.hangupReason=that.hangupReason||params.reason||"none"}},stateParams={initialState:"idle",states:{idle:{exit:function(){that.fire("idle:exit")},initiate:[{target:"negotiatingContainer",guard:function(params){return assert("boolean"==typeof params.caller),params.caller===!0||hasListener()}},{target:"terminated",guard:function(params){return params.caller!==!0&&!hasListener()}}],receiveLocalMedia:function(){that.hasLocalMedia=!0},receiveOffer:{action:function(params){that.receivedSDP=!0}},hangup:hangupEvent},negotiatingContainer:{init:"preparing",hangup:hangupEvent,modify:rejectModify,receiveLocalMedia:function(){that.hasLocalMedia=!0},states:{preparing:{entry:{action:function(){that.hasLocalMediaApproval=!1,that.hasLocalMedia=!1,that.sentSDP=!1,that.receivedSDP=!1,that.processedRemoteSDP=!1,that.isAnswered=!1,that.isModifying()||(answerTimer=createTimer(function(){that.dispatch("reject",{reason:"answer own call timer "+that.caller})},"answer own call",that.caller?answerTimeout:receiveAnswerTimeout)),that.fire("preparing:entry")}},exit:function(){that.fire("preparing:exit"),answerTimer&&answerTimer.clear()},reject:rejectEvent,receiveOffer:{action:function(params){that.receivedSDP=!0,that.isAnswered&&setTimeout(function(){that.dispatch("answer",params)})}},answer:[{action:function(params){assert(!params.previewLocalMedia||"function"==typeof params.previewLocalMedia),that.isAnswered=!0,"function"!=typeof params.previewLocalMedia&&(that.hasLocalMediaApproval=!0)}},{target:"approvingDeviceAccess",guard:needToObtainMedia},{target:"approvingContent",guard:needToApproveDirectConnection},{target:"offering",guard:automaticOffering},{target:"connecting",guard:function(params){return that.receivedSDP?needToObtainMedia()||needToApproveDirectConnection(params)||automaticOffering(params)?!1:((!params.previewLocalMedia||that.receiveOnly)&&setTimeout(function(){params.approve()}),that.receiveOnly===!0||that.needDirectConnection===!0):!1}}]},gettingMedia:{reject:rejectEvent,receiveLocalMedia:[{action:function(){that.hasLocalMedia=!0}},{target:"offering",guard:function(params){return that.caller===!0&&that.hasLocalMediaApproval===!0&&that.hasLocalMedia===!0}},{target:"connecting",guard:function(params){return that.caller===!1&&that.hasLocalMediaApproval===!0&&that.hasLocalMedia===!0}}],states:{approvingDeviceAccess:{entry:function(){that.fire("approving-device-access:entry")},approve:[{target:"approvingContent",guard:function(params){return"function"==typeof params.previewLocalMedia}},{target:"connecting",guard:function(params){return that.caller===!1&&(that.hasLocalMedia===!0||that.needDirectConnection===!0)&&"function"!=typeof params.previewLocalMedia}},{target:"offering",guard:function(params){return that.caller===!0&&that.hasLocalMedia===!0&&"function"!=typeof params.previewLocalMedia}}]},approvingContent:{entry:function(){that.fire("approving-content:entry")},exit:function(){that.fire("approving-content:exit")},approve:[function(params){that.hasLocalMediaApproval=!0},{target:"offering",guard:function(params){return that.caller===!0&&that.hasLocalMedia===!0}},{target:"connecting",guard:function(params){return that.caller===!1&&that.hasLocalMedia===!0}}]}}},offeringContainer:{init:"offering",reject:rejectEvent,sentOffer:function(){receiveAnswerTimer=createTimer(function(){that.dispatch("reject",{reason:"receive answer timer"})},"receive answer",receiveAnswerTimeout)},states:{offering:{entry:function(){that.fire("offering:entry")},exit:function(){that.fire("offering:exit")},receiveLocalMedia:[function(){that.hasLocalMedia=!0},{target:"connected",guard:function(params){return that.needDirectConnection===!0}}],receiveRemoteMedia:{target:"connected"},receiveAnswer:[clearReceiveAnswerTimer,{target:"connecting"}]}}},connectingContainer:{init:"connecting",reject:rejectEvent,receiveAnswer:clearReceiveAnswerTimer,states:{connecting:{entry:function(){that.fire("connecting:entry"),connectionTimer=createTimer(function(){that.dispatch("reject",{reason:"connection timer"})},"connection",connectionTimeout)},exit:function(){connectionTimer&&connectionTimer.clear(),modifyTimer&&modifyTimer.clear(),that.fire("connecting:exit")},receiveLocalMedia:[{action:function(){that.hasLocalMedia=!0}},{target:"connected",guard:function(params){return that.needDirectConnection===!0&&that.caller===!1}}],receiveRemoteMedia:{target:"connected"}}}}}},modifyingContainer:{init:"modifying",reject:rejectEvent,modify:rejectModify,hangup:hangupEvent,states:{modifying:{entry:function(){modifyTimer=createTimer(function(){that.dispatch("reject",{reason:"modify timer"})},"modify for caller",modifyTimeout),that.fire("modifying:entry")},accept:[function(){that.caller=!0},{target:"preparing"}],exit:function(){that.fire("modifying:exit")}}}},connectedContainer:{init:"connected",reject:{target:"terminated",action:function(params){that.hangupReason=params.reason||"got reject while connected"}},receiveAnswer:clearReceiveAnswerTimer,hangup:hangupEvent,states:{connected:{entry:function(){oldRole=that.caller,that.needDirectConnection=!1,that.fire("connected:entry")},exit:function(){that.fire("connected:exit")},modify:[{target:"preparing",guard:function(params){return params=params||{},params.receive===!0?(that.caller=!1,modifyTimer=createTimer(function(){that.dispatch("reject",{reason:"modify timer"})},"modify",modifyTimeout),!0):void 0}},{target:"modifying",guard:function(params){return params=params||{},params.receive!==!0}}]}}},terminatedContainer:{init:"terminated",states:{terminated:{entry:{action:function(){that.fire("terminated:entry"),allTimers.forEach(function(timer){timer.clear()}),setTimeout(function(){fsm=null,that.ignore()})}}}}}}};return stateParams.that=Object.create(Statechart),fsm=respoke.Class(stateParams),fsm.run({debugOff:function(){var args=Array.prototype.slice.call(arguments);args.splice(0,0,that.caller),log.debug.apply(log,args)}}),that.getState=function(){return fsm?fsm.currentState().name:"terminated"},that.dispatch=function(evt,args){var oldState,newState;if(fsm){oldState=that.getState();try{fsm.dispatch(evt,args)}catch(err){throw log.debug("error dispatching",evt,"from",oldState,"with",args,err),err}newState=that.getState(),oldState===newState&&-1===nontransitionEvents.indexOf(evt)&&log.debug(that.caller,"Possible bad event "+evt+", no transition occured."),log.debug(that.caller,"dispatching",evt,"moving from ",oldState,"to",newState,args)}},that.isModifying=function(){var modifyingStates=["preparing","modifying","approvingDeviceAccess","approvingMedia","offering"];return modifyingStates.indexOf(that.getState())>-1&&that.hasMedia()},that.isState=function(name){return that.getState()===name},assert("function"==typeof that.hasMedia),assert("boolean"==typeof that.caller),that}},function(module,exports,__webpack_require__){!function(root,factory){"use strict";module.exports=factory()}(this,function(){"use strict";function QState(fsm,name){this.fsm=fsm,this.name=name}function QEvent(type,args){this.type=type,this.args=args}var assert=function(assertion){if(!assertion)throw new Error("Assertion failed.")},Statechart={run:function(opt){opt=opt||{},this.debug=opt.debug?opt.debug:function(){},this.construct(this.initialState),this.init(null)},construct:function(initialState){this.myState=this.top(),this.mySource=this.state("Initial"),this.states.Initial={empty:function(){this.newInitialState(initialState)}};var handled=function(){return null};this.states.TOP={entry:handled,exit:handled,init:handled,empty:handled},this.flatten()},init:function(anEventOrNull){assert(this.myState===this.top()&&null!==this.mySource);var s=this.myState;for(this.mySource.trigger(anEventOrNull),assert(s.equals(this.myState.superstate())),s=this.myState,s.enter();null===s.init();)assert(s.equals(this.myState.superstate())),s=this.myState,s.enter()},state:function(stateOrName){return stateOrName&&stateOrName instanceof QState?stateOrName:new QState(this,stateOrName)},top:function(stateOrName){return this._topState||(this._topState=new QState(this,"TOP"))},currentState:function(){return this.myState},flatten:function(){this.statesTable=this.statesTable||{},this._flatten(this.states,this.top().name)},_flatten:function(states,parent){if(states)for(var state in states)states.hasOwnProperty(state)&&(this.statesTable[state]=states[state],this.statesTable[state].parent=parent,this._flatten(states[state].states,state))},selectState:function(stateName){return this.statesTable[stateName]},dispatchEvent:function(anEvent,state,act){if(act=act||state[anEvent.type],act instanceof Array)for(var i=0;i<act.length;i++)this.dispatchEvent(anEvent,state,act[i]);if("init"===anEvent.type&&"string"==typeof act)return this.newInitialState(act),null;if(act instanceof Function)return act.call(this,anEvent.args),null;if(act){if(!act.guard||act.guard&&act.guard.call(this,anEvent.args))return act.action&&act.action.call(this,anEvent.args),act.target&&this.newState(act.target),null}else if(state===this.selectState("TOP"))return this.handleUnhandledEvent(anEvent),null;return this.state(state.parent)},handleUnhandledEvent:function(anEvent){return this.debug("Unhandled event: "+anEvent.type),null},dispatch:function(anEvent,args){for(anEvent&&anEvent instanceof QEvent||(anEvent=new QEvent(anEvent,args)),this.mySource=this.myState;this.mySource;)this.mySource=this.mySource.trigger(anEvent)},newState:function(aStateName){this.transition(this.state(aStateName))},newInitialState:function(aStateOrName){return this.myState=this.state(aStateOrName),null},transition:function(target){assert(!target.equals(this.top()));var entry=[],mySource=this.mySource,s=this.myState;for(assert(null!==s),assert(null!==mySource);!s.equals(mySource);)s=s.exit()||s.superstate();if(entry.push(target),mySource.equals(target))return mySource.exit(),this.enterVia(target,entry);var p=target.superstate();if(mySource.equals(p))return this.enterVia(target,entry);assert(null!==mySource);var q=mySource.superstate();if(q.equals(p))return mySource.exit(),this.enterVia(target,entry);if(q.equals(target))return mySource.exit(),entry.pop(),this.enterVia(target,entry);for(entry.push(p),s=p.superstate();null!==s;){if(mySource.equals(s))return this.enterVia(target,entry);entry.push(s),s=s.superstate()}mySource.exit();var lca,entryLength=entry.length;for(lca=entryLength-1;lca>=0;lca-=1)if(q.equals(entry[lca]))return this.enterVia(target,entry.slice(0,lca));for(s=q;null!==s;){for(lca=entryLength-1;lca>=0;lca-=1)if(s.equals(entry[lca]))return this.enterVia(target,entry.slice(0,lca));s.exit(),s=s.superstate()}},enterVia:function(target,entry){for(var idx=entry.length;idx>0;)idx--,entry[idx].enter();for(this.myState=target;null===target.init();)assert(target.equals(this.myState.superstate())),target=this.myState,target.enter()}};QState.prototype={equals:function(state){return this.name===state.name&&this.fsm===state.fsm},dispatchEvent:function(anEvent,state){return this.fsm.dispatchEvent(anEvent,state)},trigger:function(anEvent){var evt=anEvent||QEventEmpty,state=this.fsm.selectState(this.name);return this.dispatchEvent(evt,state)},enter:function(){return this.fsm.debug("["+this.name+"] enter"),this.trigger(QEventEntry)},exit:function(){return this.fsm.debug("["+this.name+"] exit"),this.trigger(QEventExit)},init:function(){return this.fsm.debug("["+this.name+"] init"),this.trigger(QEventInit)},superstate:function(){var superstate=this.trigger(QEventEmpty);return superstate&&superstate instanceof QState?superstate:(superstate=this.fsm.top(),this.name===superstate.name?null:superstate)}};var QEventEntry=new QEvent("entry"),QEventExit=new QEvent("exit"),QEventInit=new QEvent("init"),QEventEmpty=new QEvent("empty");return Statechart})},function(module,exports,__webpack_require__){var Q=__webpack_require__(6),respoke=__webpack_require__(1),log=respoke.log;module.exports=function(params){"use strict";function init(){log.debug("Call.init"),void 0!==defModify&&(defMedia=Q.defer()),pc.init(),void 0===defModify&&pc.state.needDirectConnection===!0&&actuallyAddDirectConnection(params)}function saveParameters(params){pc&&(that.listen("local-stream-received",params.onLocalMedia),that.listen("connect",params.onConnect),that.listen("hangup",params.onHangup),that.listen("allow",params.onAllow),that.listen("answer",params.onAnswer),that.listen("approve",params.onApprove),that.listen("mute",params.onMute),that.listen("requesting-media",params.onRequestingMedia),that.listen("tone-sent",params.onToneSent),that.listen("tone-sending-started",params.onToneSendingStarted),that.listen("tone-sending-cancelled",params.onToneSendingCancelled),previewLocalMedia="function"==typeof params.previewLocalMedia?params.previewLocalMedia:previewLocalMedia,pc.state.receiveOnly="boolean"==typeof params.receiveOnly?params.receiveOnly:pc.state.receiveOnly,pc.state.sendOnly="boolean"==typeof params.sendOnly?params.sendOnly:pc.state.sendOnly,pc.state.needDirectConnection="boolean"==typeof params.needDirectConnection?params.needDirectConnection:pc.state.needDirectConnection,pc.disableTurn="boolean"==typeof params.disableTurn?params.disableTurn:!!pc.disableTurn,pc.forceTurn="boolean"==typeof params.forceTurn?params.forceTurn:!!pc.forceTurn,that.videoLocalElement=params.videoLocalElement?params.videoLocalElement:that.videoLocalElement,that.videoRemoteElement=params.videoRemoteElement?params.videoRemoteElement:that.videoRemoteElement,pc.state.receiveOnly?(that.outgoingMediaStreams.length=0,that.constraints=[]):params.constraints&&(that.constraints=respoke.convertConstraints(params.constraints),updateOutgoingMediaEstimate({constraints:that.constraints[0],source:params.source})),pc.state.sendOnly?that.incomingMediaStreams.length=0:params.constraints&&pc.state.caller===!0&&0===that.incomingMediaStreams.length&&(that.constraints=respoke.convertConstraints(params.constraints),updateIncomingMediaEstimate({constraints:params.constraints[0]})),pc.listen("stats",function(evt){that.fire("stats",{stats:evt.stats})},!0),delete that.signalOffer,delete that.signalConnected,delete that.signalAnswer,delete that.signalHangup,delete that.signalReport,delete that.signalCandidate)}function buildLocalMedia(constraint){var localMedia;return pc.state.receiveOnly?Q.reject(new Error("Shouldn't have requested local media when receiveOnly is true.")):("respoke.LocalMedia"===constraint.className?localMedia=constraint:(localMedia=respoke.LocalMedia({hasScreenShare:respoke.constraintsHasScreenShare(constraint),constraints:constraint,source:params.source}),that.outgoingMediaStreams.push(localMedia)),respoke.constraintsHasVideo(localMedia.constraints)&&that.videoLocalElement&&!that.videoLocalElement.used&&(that.videoLocalElement.used=!0,localMedia.element=that.videoLocalElement),localMedia.listen("requesting-media",function(evt){pc&&that.fire("requesting-media")},!0),localMedia.listen("allow",function(evt){pc&&(that.fire("allow"),pc.state.dispatch("approve",{previewLocalMedia:previewLocalMedia}))},!0),localMedia.start().then(function(){streamReceivedHandler(localMedia)}))}function onRemoteStreamRemoved(evt){log.debug("pc event: remote stream removed")}function onRemoteStreamAdded(evt){var remoteMedia,useEl,hasAudio=!1,hasVideo=!1,hasScreenShare=!1;pc&&(log.debug("received remote media",evt),1===that.incomingMediaStreams.length&&that.incomingMediaStreams[0].temporary===!0&&(that.incomingMediaStreams.length=0),hasAudio=evt.stream.getAudioTracks().length>0,hasVideo=evt.stream.getVideoTracks().length>0,hasScreenShare=hasVideo&&"screenshare"===that.target,that.videoRemoteElement&&!that.videoRemoteElement.used&&(that.videoRemoteElement.used=!0,useEl=that.videoRemoteElement),remoteMedia=respoke.RemoteMedia({element:useEl,stream:evt.stream,hasScreenShare:hasScreenShare,constraints:{audio:hasAudio,video:hasVideo}}),that.incomingMediaStreams.push(remoteMedia),that.incomingMediaStreams.length<pc.sdpExpectedStreamCount||(pc.state.dispatch("receiveRemoteMedia"),that.fire("connect",{stream:remoteMedia.stream,element:remoteMedia.element})))}function getStats(params){return pc&&pc.getStats?(that.listen("stats",params.onStats),pc.getStats(params)):null}function streamReceivedHandler(localMedia){pc&&(pc.addStream(localMedia.stream),"function"==typeof previewLocalMedia&&localMedia.element&&previewLocalMedia(localMedia.element,that),localMedia.listen("stop",function(){var idx=that.outgoingMediaStreams.indexOf(localMedia);idx>-1&&that.outgoingMediaStreams.splice(idx,1),that.outgoingMediaStreams.length||that.incomingMediaStreams.length||that.hangup({reason:"last stream ended"})}),that.fire("local-stream-received",{element:localMedia.element,stream:localMedia}),localMedia.listen("mute",function(evt){that.fire("mute",{type:evt.type,muted:evt.muted})}))}function doAddVideo(params){log.debug("Call.doAddVideo"),saveParameters(params)}function actuallyAddDirectConnection(params){return log.debug("Call.actuallyAddDirectConnection",params),params=params||{},defMedia.promise.then(params.onSuccess,params.onError),directConnection&&directConnection.isActive()?(defMedia.promise.isPending()?defMedia.resolve(directConnection):log.warn("Not creating a new direct connection."),defMedia.promise):(params.instanceId=instanceId,params.pc=pc,params.call=that,directConnection=respoke.DirectConnection(params),directConnection.listen("close",function(){that.hasMedia()?that.removeDirectConnection({skipModify:!0}):(log.debug("Hanging up because there are no local streams."),that.hangup())},!0),directConnection.listen("accept",function(){pc.state.caller===!1?log.debug("Answering as a result of approval."):defMedia.resolve(directConnection)},!0),directConnection.listen("open",function(){pc.state.dispatch("receiveRemoteMedia")},!0),directConnection.listen("error",function(err){defMedia.reject(new Error(err))},!0),that.remoteEndpoint.directConnection=directConnection,that.fire("direct-connection",{directConnection:directConnection,endpoint:that.remoteEndpoint}),client.fire("direct-connection",{directConnection:directConnection,endpoint:that.remoteEndpoint}),pc.state.caller===!0&&directConnection.accept(),defMedia.promise)}function listenAnswer(evt){log.debug("listenAnswer",evt.signal),that.hasDataChannel=respoke.sdpHasDataChannel(evt.signal.sessionDescription.sdp),updateIncomingMediaEstimate({sdp:evt.signal.sessionDescription})}function updateIncomingMediaEstimate(params){if(pc.state.sendOnly)return void(that.incomingMediaStreams.length=0);if(!params.sdp&&!params.constraints)throw new Error("Can't estimate incoming media without sdp or constraints");0===that.incomingMediaStreams.length&&that.incomingMediaStreams.push(respoke.RemoteMedia({hasScreenShare:"screenshare"===that.target,temporary:!0})),params.sdp&&that.incomingMediaStreams[0]&&that.incomingMediaStreams[0].temporary&&that.incomingMediaStreams[0].setSDP(params.sdp),params.constraints&&that.incomingMediaStreams[0]&&that.incomingMediaStreams[0].temporary&&that.incomingMediaStreams[0].setConstraints(params.constraints)}function updateOutgoingMediaEstimate(params){if(pc.state.receiveOnly)return that.outgoingMediaStreams.length=0,void(that.constraints=[]);if(!params.sdp&&!params.constraints)throw new Error("Can't estimate outgoing media without sdp or constraints");0===that.outgoingMediaStreams.length&&that.outgoingMediaStreams.push(respoke.LocalMedia({instanceId:instanceId,temporary:!0,source:params.source})),params.sdp&&that.outgoingMediaStreams[0]&&that.outgoingMediaStreams[0].temporary&&that.outgoingMediaStreams[0].setSDP(params.sdp),params.constraints&&that.outgoingMediaStreams[0]&&that.outgoingMediaStreams[0].temporary&&that.outgoingMediaStreams[0].setConstraints(params.constraints)}function listenOffer(evt){log.debug("listenOffer",evt.signal);var info={};that.sessionId=evt.signal.sessionId,pc.state.receiveOnly=respoke.sdpHasSendOnly(evt.signal.sessionDescription.sdp),pc.state.sendOnly=respoke.sdpHasReceiveOnly(evt.signal.sessionDescription.sdp),pc.state.listen("connecting:entry",function(){pc.state.caller||pc.processOffer(evt.signal.sessionDescription)}),updateIncomingMediaEstimate({sdp:evt.signal.sessionDescription}),updateOutgoingMediaEstimate(pc.state.sendOnly?{constraints:{audio:!0,video:!0}}:{sdp:evt.signal.sessionDescription}),that.outgoingMedia&&log.info("Default outgoingMedia constraints",that.outgoingMedia.constraints),pc.state.isModifying()&&(pc.state.needDirectConnection===!0?info.directConnection=directConnection:pc.state.needDirectConnection===!1||(info.call=that),that.fire("modify",info)),pc.state.dispatch("receiveOffer",{previewLocalMedia:previewLocalMedia,approve:that.approve})}function listenModify(evt){log.debug("Call.listenModify",evt),"initiate"===evt.signal.action&&(defModify=Q.defer(),pc.state.dispatch("modify",{receive:!0}))}function onModifyAccept(evt){return pc.state.dispatch("accept"),"initiate"!==evt.signal.action?(defModify.resolve(),void(defModify=void 0)):(evt.signal.directConnection===!0?actuallyAddDirectConnection().done(function(dc){directConnection=dc,directConnection.accept()}):evt.signal.directConnection===!1&&directConnection&&(that.removeDirectConnection({skipModify:!0}),defMedia.resolve(!1)),pc.state.needDirectConnection="boolean"==typeof evt.signal.directConnection?evt.signal.directConnection:null,void(that.outgoingMedia.constraints=evt.signal.constraints||that.outgoingMedia.constraints))}function onModifyReject(evt){"initiate"!==evt.signal.action&&(defMedia.reject(evt.err),defModify.reject(evt.err),defModify=void 0)}function listenHangup(evt){pc&&(pc.report.callStoppedReason=evt.signal.reason||"Remote side hung up",pc.state.receivedBye=!0,pc.state.dispatch("hangup",{signal:!1,reason:pc.report.callStoppedReason}))}params=params||{};var instanceId=params.instanceId,that=respoke.EventEmitter(params);if(delete that.instanceId,delete that.outgoingMedia,that.className="respoke.Call",that.caller=!!that.caller,Object.defineProperty(that,"initiator",{
configurable:!0,enumerable:!0,get:function(){return log.warn("The call.initiator flag is deprecated. Please use call.caller instead."),that.caller},set:function(){}}),that.caller||(delete params.constraints,that.constraints=[]),that.id=that.caller?respoke.makeGUID():that.id,console.log("[Respoke] Creating call. id='"+that.id+"'"),!that.id)throw new Error("Can't start a new call without a call id.");var defModify,defMedia=Q.defer(),previewLocalMedia=params.previewLocalMedia,client=respoke.getClient(instanceId),signalingChannel=params.signalingChannel;that.enableCallDebugReport=params.signalingChannel.isSendingReport();var pc=respoke.PeerConnection({instanceId:instanceId,state:respoke.CallState({instanceId:instanceId,caller:that.caller,needDirectConnection:params.needDirectConnection,sendOnly:params.sendOnly,receiveOnly:params.receiveOnly,hasMedia:function(){return that.hasMedia()}}),forceTurn:!!params.forceTurn,call:that,pcOptions:{optional:[{DtlsSrtpKeyAgreement:!0},{RtpDataChannels:!1}]},offerOptions:params.offerOptions||null,signalOffer:function(args){pc&&(params.signalOffer(args),pc.state.dispatch("sentOffer"))},signalConnected:params.signalConnected,signalAnswer:params.signalAnswer,signalModify:params.signalModify,signalHangup:params.signalHangup,signalReport:params.signalReport,signalCandidate:params.signalCandidate});that.outgoingMediaStreams=[],that.outgoingMediaStreams.hasAudio=function(){return 0===that.outgoingMediaStreams.length?!1:!that.outgoingMediaStreams.every(function(stream){return 0===stream.getAudioTracks().length})},that.outgoingMediaStreams.hasVideo=function(){return 0===that.outgoingMediaStreams.length?!1:!that.outgoingMediaStreams.every(function(stream){return 0===stream.getVideoTracks().length})},params.outgoingMedia&&that.outgoingMediaStreams.push(params.outgoingMedia),Object.defineProperty(that,"outgoingMedia",{configurable:!1,enumerable:!0,get:function(){return that.outgoingMediaStreams[0]},set:function(){}}),that.incomingMediaStreams=[],that.incomingMediaStreams.hasAudio=function(){return 0===that.incomingMediaStreams.length?!1:!that.incomingMediaStreams.every(function(stream){return 0===stream.getAudioTracks().length})},that.incomingMediaStreams.hasVideo=function(){return 0===that.incomingMediaStreams.length?!1:!that.incomingMediaStreams.every(function(stream){return 0===stream.getVideoTracks().length})},Object.defineProperty(that,"incomingMedia",{configurable:!1,enumerable:!0,get:function(){return that.incomingMediaStreams[0]},set:function(){}}),Object.defineProperty(that,"hasAudio",{configurable:!1,enumerable:!0,get:that.incomingMediaStreams.hasAudio,set:function(){}}),Object.defineProperty(that,"hasVideo",{configurable:!1,enumerable:!0,get:that.incomingMediaStreams.hasVideo,set:function(){}}),delete params.signalingChannel,delete that.signalingChannel;var videoIsMuted=!1,audioIsMuted=!1,directConnection=null;that.answer=function(params){params=params||{},log.debug("Call.answer",params),saveParameters(params),pc.listen("remote-stream-received",onRemoteStreamAdded,!0),pc.listen("remote-stream-removed",onRemoteStreamRemoved,!0),pc.state.once("approving-device-access:entry",function(evt){doAddVideo(params)}),pc.state.dispatch("answer",{previewLocalMedia:previewLocalMedia,approve:that.approve}),that.fire("answer")},that.accept=that.answer,that.approve=function(){log.debug("Call.approve"),that.fire("approve"),pc.state.dispatch("approve",{previewLocalMedia:previewLocalMedia}),defModify&&defModify.promise.isPending()&&(defModify.resolve(!0),defModify=void 0)},respoke.MediaStats&&(that.getStats=getStats),that.getLocalElement=function(){return that.outgoingMediaStreams[0]?that.outgoingMediaStreams[0].element:void 0},that.getRemoteElement=function(){return that.incomingMediaStreams[0]?that.incomingMediaStreams[0].element:void 0},that.addVideo=function(params){return log.debug("Call.addVideo"),params=params||{},params.constraints&&params.constraints.length||(params.constraints=[{video:!0,audio:!0}]),params.instanceId=instanceId,defMedia.promise.isFulfilled()?(pc.startModify({constraints:params.constraints}),defModify=Q.defer(),defModify.promise.then(function(){doAddVideo(params)})):doAddVideo(params),defModify.promise},that.addAudio=function(params){return params=params||{},params.constraints&&params.constraints.length||(params.constraints=[{video:!1,audio:!0}]),that.addVideo(params)},that.getDirectConnection=function(){return directConnection||null},that.removeDirectConnection=function(params){return params=params||{},log.debug("Call.removeDirectConnection"),directConnection&&directConnection.close({skipRemove:!0}),that.hasMedia()?void(params.skipModify!==!0&&(pc.startModify({directConnection:!1}),defModify=Q.defer(),defModify.promise.done(function(){defMedia.resolve(),defModify=void 0}))):(log.debug("Hanging up because there are no local streams."),void that.hangup())},that.addDirectConnection=function(params){return log.debug("Call.addDirectConnection"),pc.startModify({directConnection:!0}),defModify=Q.defer(),defModify.promise.then(function(){return actuallyAddDirectConnection(params)},function(err){throw err})},that.closeDirectConnection=function(){directConnection&&(directConnection.close(),directConnection=null)},that.hangup=function(params){pc&&(params=params||{},params.reason=params.reason||"hangup method called.",pc.state.dispatch("hangup",params))},that.hangup=respoke.callOnce(that.hangup);var doHangup=function(){log.debug("hangup",that.caller),that.outgoingMediaStreams.forEach(function(stream){stream!==params.outgoingMedia&&stream.stop()}),directConnection&&(directConnection.close(),directConnection=null),pc&&pc.close({signal:pc.state.receivedBye?!1:pc.state.signalBye}),that.fire("hangup",{reason:pc.state.hangupReason||"No reason specified."}),pc.state.ignore(),pc.ignore(),that.ignore(),pc=null};return doHangup=respoke.callOnce(doHangup),that.reject=function(){pc&&pc.state.dispatch("reject",{reason:"call.reject() called"})},that.isActive=function(){return!!(pc&&pc.isActive()&&(that.outgoingMediaStreams.length>0||that.incomingMediaStreams.length>0||directConnection&&directConnection.isActive()))},that.toggleVideo=function(){that.isActive()&&(videoIsMuted?that.unmuteVideo():that.muteVideo())},that.toggleAudio=function(){that.isActive()&&(audioIsMuted?that.unmuteAudio():that.muteAudio())},that.hasMedia=function(){var local,remote;return pc&&pc.getLocalStreams?(local=pc.getLocalStreams(),remote=pc.getRemoteStreams(),directConnection&&directConnection.isActive()?!0:local.length>0||remote.length>0):!1},that.muteVideo=function(){videoIsMuted||(that.outgoingMedia.muteVideo(),videoIsMuted=!0)},that.unmuteVideo=function(){videoIsMuted&&(that.outgoingMedia.unmuteVideo(),videoIsMuted=!1)},that.muteAudio=function(){audioIsMuted||(that.outgoingMedia.muteAudio(),audioIsMuted=!0)},that.unmuteAudio=function(){audioIsMuted&&(that.outgoingMedia.unmuteAudio(),audioIsMuted=!1)},that.sendTones=function(params){return pc.sendTones(params)},that.cancelTones=function(params){return pc.cancelTones(params)},pc.state.once("terminated:entry",function(evt){doHangup()},!0),that.listen("signal-answer",listenAnswer),that.listen("signal-offer",function(evt){"idle"===pc.state.getState()?pc.state.once("preparing:entry",function(){listenOffer(evt)}):listenOffer(evt)},!0),that.listen("signal-hangup",listenHangup,!0),that.listen("signal-modify",listenModify,!0),pc.listen("modify-reject",onModifyReject,!0),pc.listen("modify-accept",onModifyAccept,!0),that.listen("signal-icecandidates",function(evt){pc&&evt.signal.iceCandidates&&evt.signal.iceCandidates.length&&evt.signal.iceCandidates.forEach(function(candidate){pc&&pc.addRemoteCandidate({candidate:candidate})})},!0),that.listen("answer",function(evt){var mediaPromises=[];if(pc.state.receiveOnly||pc.state.needDirectConnection)return void(that.outgoingMediaStreams.length=0);if(pc.state.receiveOnly)return that.outgoingMediaStreams.length=0,void(that.constraints=[]);if(0===that.constraints.length?that.outgoingMediaStreams[0].temporary=void 0:that.outgoingMediaStreams.length>0&&that.outgoingMediaStreams[0].temporary&&that.outgoingMediaStreams.shift(),!params.outgoingMedia){if(that.constraints.length>0)that.outgoingMediaStreams.length=0,that.constraints.forEach(function(constraint){mediaPromises.push(buildLocalMedia(constraint))});else{if(!(that.outgoingMediaStreams.length>0))throw new Error("I have no idea what type of media I am supposed to build.");that.outgoingMediaStreams.forEach(function(stream){mediaPromises.push(buildLocalMedia(stream))})}Q.all(mediaPromises).done(function(){pc.state.dispatch("receiveLocalMedia")},function(err){pc.state.dispatch("reject",{reason:"media stream error"}),pc.report.callStoppedReason=err.message,that.fire("error",{reason:err.message})})}},!0),pc.state.needDirectConnection!==!0&&pc.state.once("preparing:entry",function(){client.fire("call",{endpoint:that.remoteEndpoint,call:that})},!0),pc.state.listen("idle:exit",function(evt){saveParameters(params)}),pc.state.listen("preparing:entry",function(evt){init(),params.outgoingMedia&&(streamReceivedHandler(params.outgoingMedia),pc.state.dispatch("receiveLocalMedia")),pc.state.caller===!0&&that.answer()},!0),pc.state.listen("connecting:entry",function(){pc.state.sendOnly&&(that.fire("connect"),pc.state.dispatch("receiveRemoteMedia"))}),signalingChannel.getTurnCredentials().then(function(result){if(!pc)throw new Error("Already hung up.");result?pc.servers={iceServers:result}:(log.warn("Relay service not available."),pc.servers={iceServers:[]})}).fin(function(){if(!pc)throw new Error("Already hung up.");pc.state.dispatch("initiate",{caller:that.caller})}).done(null,function(err){"Already hung up."!==err.message&&log.debug("Unexpected exception",err)}),that}},function(module,exports,__webpack_require__){var respoke=__webpack_require__(1),log=respoke.log,Q=respoke.Q;module.exports=function(params){"use strict";function getStream(theConstraints){for(var i=0;i<respoke.streams.length;i++){var s=respoke.streams[i],sConstraints=respoke.clone(s.constraints);if(sConstraints.video&&sConstraints.video.mandatory&&sConstraints.video.mandatory.chromeMediaSourceId&&delete sConstraints.video.mandatory.chromeMediaSourceId,respoke.isEqual(sConstraints,theConstraints))return s.stream}return null}function removeStream(theConstraints){for(var toRemoveIndex,i=0;i<respoke.streams.length;i++){var s=respoke.streams[i];if(respoke.isEqual(s.constraints,theConstraints)){toRemoveIndex=i;break}}void 0!==toRemoveIndex&&respoke.streams.splice(toRemoveIndex,1)}function onReceiveUserMedia(theStream){that.stream=theStream,clearTimeout(allowTimer),that.fire("allow"),log.debug("User gave permission to use media."),log.debug("onReceiveUserMedia"),that.element=that.element||document.createElement("video");var aStream=getStream(that.constraints);aStream?(aStream.numPc+=1,attachMediaStream(that.element,that.stream),that.element.muted=!0,that.element.autoplay=!0,aStream.addEventListener("ended",that.stop,!1),deferred.resolve()):(that.stream.numPc=1,respoke.streams.push({stream:that.stream,constraints:that.constraints}),attachMediaStream(that.element,that.stream),that.element.muted=!0,that.element.autoplay=!0,that.stream.addEventListener("ended",that.stop,!1),deferred.resolve())}function requestMedia(){var theStream;return that.constraints?(respoke.useFakeMedia===!0&&(that.constraints.fake=!0),(theStream=getStream(that.constraints))?(log.debug("using old stream"),void onReceiveUserMedia(theStream)):(allowTimer=setTimeout(function(){that.fire("requesting-media")},500),respoke.constraintsHasScreenShare(that.constraints)?respoke.isNwjs||respoke.needsChromeExtension&&respoke.hasChromeExtension?void respoke.chooseDesktopMedia({source:screenShareSource},function(params){return params.sourceId?(that.constraints.video.mandatory.chromeMediaSourceId=params.sourceId,log.debug("Running getUserMedia with constraints",that.constraints),void getUserMedia(that.constraints,onReceiveUserMedia,onUserMediaError)):void deferred.reject(new Error("Error trying to get screensharing source: "+params.error))}):respoke.needsFirefoxExtension&&respoke.hasFirefoxExtension?(log.debug("Running getUserMedia with constraints",that.constraints),void getUserMedia(that.constraints,onReceiveUserMedia,onUserMediaError)):void deferred.reject(new Error("Screen sharing not implemented on this platform yet.")):(log.debug("Running getUserMedia with constraints",that.constraints),void getUserMedia(that.constraints,onReceiveUserMedia,onUserMediaError)))):void deferred.reject(new Error("No constraints."))}function onUserMediaError(p){log.debug("Local media error.",p);var errorMessage=1===p.code?"Permission denied.":"Unknown.";deferred.reject(new Error("Error getting user media: "+errorMessage))}params=params||{};var that=respoke.EventEmitter(params);that.className="respoke.LocalMedia",that.id=respoke.makeGUID(),that.element=params.element;var hasScreenShare=params.hasScreenShare;delete params.hasScreenShare;var screenShareSource=params.source;delete params.source;var sdpHasAudio=!1,sdpHasVideo=!1,sdpHasDataChannel=!1,allowTimer=0;that.stream=null;var deferred=Q.defer();return that.getAudioTracks=function(){return that.stream?that.stream.getAudioTracks():[]},that.getVideoTracks=function(){return that.stream?that.stream.getVideoTracks():[]},that.isVideoMuted=function(){return that.stream&&that.stream.getVideoTracks().length?that.stream.getVideoTracks().every(function(track){return!track.enabled}):void 0},that.muteVideo=function(){that.isVideoMuted()||(that.stream.getVideoTracks().forEach(function(track){track.enabled=!1}),that.fire("mute",{type:"video",muted:!0}))},that.unmuteVideo=function(){that.isVideoMuted()&&(that.stream.getVideoTracks().forEach(function(track){track.enabled=!0}),that.fire("mute",{type:"video",muted:!1}))},that.isAudioMuted=function(){return that.stream&&that.stream.getAudioTracks().length?that.stream.getAudioTracks().every(function(track){return!track.enabled}):void 0},that.muteAudio=function(){that.isAudioMuted()||(that.stream.getAudioTracks().forEach(function(track){track.enabled=!1}),that.fire("mute",{type:"audio",muted:!0}))},that.unmuteAudio=function(){that.isAudioMuted()&&(that.stream.getAudioTracks().forEach(function(track){track.enabled=!0}),that.fire("mute",{type:"audio",muted:!1}))},that.stop=function(){that.stream&&(that.stream.numPc-=1,0===that.stream.numPc&&(that.stream.stop(),removeStream(that.constraints)),that.stream=null,that.fire("stop"))},that.hasScreenShare=function(){return that.stream?that.stream.getVideoTracks().length>0&&hasScreenShare:hasScreenShare},that.hasVideo=function(){return that.stream?that.stream.getVideoTracks().length>0:sdpHasVideo},that.hasAudio=function(){return that.stream?that.stream.getAudioTracks().length>0:sdpHasAudio},that.hasMedia=function(){return!!that.stream},that.setSDP=function(oSession){sdpHasVideo=respoke.sdpHasVideo(oSession.sdp),sdpHasAudio=respoke.sdpHasAudio(oSession.sdp),sdpHasDataChannel=respoke.sdpHasDataChannel(oSession.sdp),that.temporary&&(that.constraints={video:sdpHasVideo,audio:sdpHasAudio,mandatory:{},optional:[]})},that.setConstraints=function(constraints){that.constraints=constraints,sdpHasVideo=respoke.constraintsHasVideo(that.constraints),sdpHasAudio=respoke.constraintsHasAudio(that.constraints)},that.start=function(params){var retVal;return params=params||{},that.temporary?deferred.reject(new Error("Temporary local media started!")):requestMedia(),retVal=respoke.handlePromise(deferred.promise,params.onSuccess,params.onError)},that}},function(module,exports,__webpack_require__){var respoke=__webpack_require__(1);module.exports=function(params){"use strict";params=params||{};var that=respoke.EventEmitter(params);that.className="respoke.RemoteMedia",that.id=respoke.makeGUID(),that.element=params.element||document.createElement("video");var hasScreenShare=params.hasScreenShare;delete params.hasScreenShare;var sdpHasAudio=!1,sdpHasVideo=!1,sdpHasDataChannel=!1;params.pc;return delete that.pc,that.stream=params.stream,that.temporary||(attachMediaStream(that.element,that.stream),that.element.autoplay=!0,setTimeout(that.element.play.bind(that.element))),that.hasScreenShare=function(){return that.stream?that.stream.getVideoTracks().length>0&&hasScreenShare:hasScreenShare},that.hasVideo=function(){return that.stream?that.stream.getVideoTracks().length>0:sdpHasVideo},that.hasAudio=function(){return that.stream?that.stream.getAudioTracks().length>0:sdpHasAudio},that.hasMedia=function(){return!!that.stream},that.setSDP=function(oSession){sdpHasVideo=respoke.sdpHasVideo(oSession.sdp),sdpHasAudio=respoke.sdpHasAudio(oSession.sdp),sdpHasDataChannel=respoke.sdpHasDataChannel(oSession.sdp)},that.setConstraints=function(constraints){that.constraints=constraints,sdpHasVideo=respoke.constraintsHasVideo(that.constraints),sdpHasAudio=respoke.constraintsHasAudio(that.constraints)},that.getAudioTracks=function(){return that.stream?that.stream.getAudioTracks():[]},that.getVideoTracks=function(){return that.stream?that.stream.getVideoTracks():[]},that.stop=function(){that.stream&&(that.stream.numPc-=1,0===that.stream.numPc&&that.stream.stop(),that.stream=null,that.fire("stop"))},that.isVideoMuted=function(){return that.stream?that.stream.getVideoTracks().every(function(track){return!track.enabled}):!1},that.muteVideo=function(){that.isVideoMuted()||(that.stream.getVideoTracks().forEach(function(track){track.enabled=!1}),that.fire("mute",{type:"video",muted:!0}))},that.unmuteVideo=function(){that.isVideoMuted()&&(that.stream.getVideoTracks().forEach(function(track){track.enabled=!0}),that.fire("mute",{type:"video",muted:!1}))},that.isAudioMuted=function(){return that.stream?that.stream.getAudioTracks().every(function(track){return!track.enabled}):!1},that.muteAudio=function(){that.isAudioMuted()||(that.stream.getAudioTracks().forEach(function(track){track.enabled=!1}),that.fire("mute",{type:"audio",muted:!0}))},that.unmuteAudio=function(){that.isAudioMuted()&&(that.stream.getAudioTracks().forEach(function(track){track.enabled=!0}),that.fire("mute",{type:"audio",muted:!1}))},that}},function(module,exports,__webpack_require__){var respoke=(__webpack_require__(6),__webpack_require__(1));module.exports=function(params){"use strict";params=params||{};var instanceId=params.instanceId,signalingChannel=params.signalingChannel,that=respoke.EventEmitter({id:params.id});that.listen("join",params.onJoin),that.listen("leave",params.onLeave),that.listen("message",params.onMessage),that.listen("mute",params.onMute),that.listen("topic",params.onTopic),that.listen("presenter",params.onPresenter),delete params.onJoin,delete params.onLeave,delete params.onMessage,delete params.onMute,delete params.onTopic,delete params.onPresenter,params.caller=!0,params.conferenceId=params.id,delete params.id,params.remoteEndpoint=that,that.call=respoke.Call(params),["mute","hangup","connect","stats","error","local-stream-received","remote-stream-received","requesting-media","approve","allow"].forEach(function(eventName){that.call.listen(eventName,function(evt){evt.call=that.call,that.fire(eventName,evt)})}),delete that.instanceId,that.className="respoke.Conference";respoke.getClient(instanceId);return that.leave=that.call.hangup,that.muteAudio=that.call.muteAudio,respoke.MediaStats&&(that.getStats=that.call.getStats),that.getParticipants=function(){return signalingChannel.getConferenceParticipants({id:that.id})},that.removeParticipant=function(params){return params=params||{},params.conferenceId=that.id,signalingChannel.removeConferenceParticipant(params)},that.destroy=function(params){return signalingChannel.destroyConference({conferenceId:that.id})},that}}])});
//# sourceMappingURL=respoke.min.map